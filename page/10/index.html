

<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 10 页 | 帅羊羊的博客</title>
  
  <meta name="google-site-verification" content="hLu-CnRbqpthWxa76MJ-vpnGr7yMChNtTW6KA0pRMQo" />  
  <meta name="baidu-site-verification" content="WTddywKheI" />  
  
  
  <meta name="author" content="Shuai yy">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="帅羊羊的博客"/>

  
    <meta property="og:image" content=""/>
  
  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="http://shuaiyy.cn/atom.xml" title="帅羊羊的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//libs.baidu.com/jquery/1.8.0/jquery.min.js"></script>
  
  
  
    


<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<script>
	var _hmt = _hmt || [];
	(function() {
		var hm = document.createElement("script");
		hm.src = "https://hm.baidu.com/hm.js?02f792017724a2c2af494ece7edc5fd1";
		var s = document.getElementsByTagName("script")[0]; 
		s.parentNode.insertBefore(hm, s);
	})();
</script>





  
    
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-107525911-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  
</head>



<body>
  <header id="header" class="inner">
<div class= "header-nav">

			<div class='avatar'>
				<img src = "http://img.shuaiyy.cn/blog/171005/FFHDJd20A4.jpeg?imageslim">
              </div>
		
<div class="header-div">
  
  <h1><a href="/">帅羊羊的博客</a></h1>
  <h2><a href="/">坚持学习,努力学习...</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
	  
    
      <li><a href="/archives"><i class="fa fa-archive"></i>归档</a></li>
	  
    
      <li><a href="/resume"><i class="fa fa-user"></i>关于</a></li>
	  
    
      <li><a href="/books"><i class="fa fa-book"></i>阅读</a></li>
	  
    
      <li><a href="/movies"><i class="fa fa-play-circle"></i>电影</a></li>
	  
    
      <li><a href="/games"><i class="fa fa-fa-gamepad"></i>游戏</a></li>
	  
    
	<li> <a href="/atom.xml"><i class="fa fa-rss"></i>RSS</a> </li>
<li> <a title="把这个链接拖到你的Chrome收藏夹工具栏中" href='javascript:(function() {
	function c() {
		var e = document.createElement("link");
		e.setAttribute("type", "text/css");
		e.setAttribute("rel", "stylesheet");
		e.setAttribute("href", f);
		e.setAttribute("class", l);
		document.body.appendChild(e)
	}
 
	function h() {
		var e = document.getElementsByClassName(l);
		for (var t = 0; t < e.length; t++) {
			document.body.removeChild(e[t])
		}
	}
 
	function p() {
		var e = document.createElement("div");
		e.setAttribute("class", a);
		document.body.appendChild(e);
		setTimeout(function() {
			document.body.removeChild(e)
		}, 100)
	}
 
	function d(e) {
		return {
			height : e.offsetHeight,
			width : e.offsetWidth
		}
	}
 
	function v(i) {
		var s = d(i);
		return s.height > e && s.height < n && s.width > t && s.width < r
	}
 
	function m(e) {
		var t = e;
		var n = 0;
		while (!!t) {
			n += t.offsetTop;
			t = t.offsetParent
		}
		return n
	}
 
	function g() {
		var e = document.documentElement;
		if (!!window.innerWidth) {
			return window.innerHeight
		} else if (e && !isNaN(e.clientHeight)) {
			return e.clientHeight
		}
		return 0
	}
 
	function y() {
		if (window.pageYOffset) {
			return window.pageYOffset
		}
		return Math.max(document.documentElement.scrollTop, document.body.scrollTop)
	}
 
	function E(e) {
		var t = m(e);
		return t >= w && t <= b + w
	}
 
	function S() {
		var e = document.createElement("audio");
		e.setAttribute("class", l);
		e.src = i;
		e.loop = false;
		e.addEventListener("canplay", function() {
			setTimeout(function() {
				x(k)
			}, 500);
			setTimeout(function() {
				N();
				p();
				for (var e = 0; e < O.length; e++) {
					T(O[e])
				}
			}, 15500)
		}, true);
		e.addEventListener("ended", function() {
			N();
			h()
		}, true);
		e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
		document.body.appendChild(e);
		e.play()
	}
 
	function x(e) {
		e.className += " " + s + " " + o
	}
 
	function T(e) {
		e.className += " " + s + " " + u[Math.floor(Math.random() * u.length)]
	}
 
	function N() {
		var e = document.getElementsByClassName(s);
		var t = new RegExp("\\b" + s + "\\b");
		for (var n = 0; n < e.length; ) {
			e[n].className = e[n].className.replace(t, "")
		}
	}
 
	var e = 30;
	var t = 30;
	var n = 350;
	var r = 350;
	var i = "//ojp9dzqic.bkt.clouddn.com/high_background.mp3";
	var s = "mw-harlem_shake_me";
	var o = "im_first";
	var u = ["im_drunk", "im_baked", "im_trippin", "im_blown"];
	var a = "mw-strobe_light";
	var f = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";
	var l = "mw_added_css";
	var b = g();
	var w = y();
	var C = document.getElementsByTagName("*");
	var k = null;
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (v(A)) {
			if (E(A)) {
				k = A;
				break
			}
		}
	}
	if (A === null) {
		console.warn("Could not find a node of the right size. Please try a different page.");
		return
	}
	c();
	S();
	var O = [];
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (v(A)) {
			O.push(A)
		}
	}
})()    '>High一下</a> </li>

  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-10-23T16:00:00.000Z"><a href="/2016/10/24/折腾/meilan3s-imei-change/">2016-10-24</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/10/24/折腾/meilan3s-imei-change/">魅蓝3s移动版刷机+修改串号</a></h1>
  

    </header>
    <div class="entry">
      
        <blockquote>
<p>最近魅蓝3s移动版，但是移动定制版，开机logo，系统软件，功能限制，网络限制，很恶心，果断刷机。</p>
</blockquote>
<hr>
<h3 id="刷机教程"><a href="#刷机教程" class="headerlink" title="刷机教程"></a>刷机教程</h3><p>刷机教程魅族论坛有。</p>
<ul>
<li>移动定制版的系统recovery会验证固件，因此直接刷全网通版的固件会提示固件损坏，无法写入固件。</li>
<li>使用flashfire刷入全网通的update.zip，<ul>
<li>首先获取root权限，安装superSU，并重启。</li>
<li>然后flashfire写入，等待系统自动重启。这时的系统并不是clean的，会有各种问题，相当于只是从移动版升级到全网通，绕过系统的rom检测。</li>
<li>开机后，使用系统自带的recovery再刷一次全网通的固件，刷时选择清除数据。这是最后一步，然后就是全网通版的魅蓝3s啦。如果还是有相机图库无法使用的情况，恢复出厂设置，或再刷一次全网通固件，记得选清除数据。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="修改串号"><a href="#修改串号" class="headerlink" title="修改串号"></a>修改串号</h3><ol>
<li>在拔号按<em>#</em>#3646633#<em>#</em>–&gt; 进入connectivity</li>
<li>选 cds information –&gt; radioinformation</li>
<li>选 phone1(SIM1)</li>
<li>在command (有A+的位置)列按入”AT +EGMR = 1,7,”你的IMEI””(在输入sim2时改为”AT +EGMR = 1,10, “你的IMEI”)</li>
<li>按 “SEND ATCOMMAND”</li>
<li>完成后重启手机</li>
</ol>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2016/10/24/折腾/meilan3s-imei-change/#more" class="more-link">阅读全文</a>
          </div>
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-09-21T16:00:00.000Z"><a href="/2016/09/22/技术/Git-server-on-centos/">2016-09-22</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/09/22/技术/Git-server-on-centos/">搭建Git服务器</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="cent-os-搭建git-server-gitolite"><a href="#cent-os-搭建git-server-gitolite" class="headerlink" title="cent os 搭建git server + gitolite"></a>cent os 搭建git server + gitolite</h1><blockquote>
<p>爬了很久的坑，终于爬出来了，真累。说说走的弯路，最初打算配置gitlab（有和github一样漂亮的web界面），然后下源码编译，失败。后来发现gitlab有中文站，提供二进制包，可能是centos32位的原因，为了少浪费生命，果断放弃，转而采用git-core + gitolite。<br>后来，git服务器搭好了，但是没人用，实验室还是在用SVN。估计是迁移和学习成本吧，不愿意改变。</p>
</blockquote>
<h3 id="1、安装git"><a href="#1、安装git" class="headerlink" title="1、安装git"></a>1、安装git</h3><h4 id="1-1、创建git用户"><a href="#1-1、创建git用户" class="headerlink" title="1.1、创建git用户"></a>1.1、创建git用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum update</span></div><div class="line"><span class="comment"># yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel perl-devel</span></div><div class="line"><span class="comment"># mkdir -p /home/git  //创建git用户的目录</span></div><div class="line"><span class="comment"># groupadd git  //创建git用户组</span></div><div class="line"><span class="comment"># useradd -g git -d /home/git -s /bin/bash git  // 添加linux用户git</span></div><div class="line"><span class="comment"># passwd git    //设置git用户密码</span></div><div class="line"></div><div class="line"><span class="comment"># passwd -d git  //在所有工作完成后禁用git用户的密码，这样git无法ssh远程登录主机</span></div></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2016/09/22/技术/Git-server-on-centos/#more" class="more-link">阅读全文</a>
          </div>
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-08-21T16:00:00.000Z"><a href="/2016/08/22/技术/Django 部署(Nginx + Uwsgi)/">2016-08-22</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/08/22/技术/Django 部署(Nginx + Uwsgi)/">Nginx + Uwsgi + Django 部署web服务</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、环境准备"><span class="toc-text">1、环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装Nginx"><span class="toc-text">安装Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装uwsgi"><span class="toc-text">安装uwsgi</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试uwsgi"><span class="toc-text">测试uwsgi</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试Django"><span class="toc-text">测试Django</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、部署web"><span class="toc-text">2、部署web</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#上传django项目到服务器"><span class="toc-text">上传django项目到服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Django项目收集静态文件"><span class="toc-text">Django项目收集静态文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改settings文件"><span class="toc-text">修改settings文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置Nginx服务器"><span class="toc-text">配置Nginx服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置uwsgi"><span class="toc-text">配置uwsgi</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#最后，运行项目"><span class="toc-text">最后，运行项目</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、高级部分"><span class="toc-text">3、高级部分</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#配置Memcache"><span class="toc-text">配置Memcache</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Django的缓存框架"><span class="toc-text">Django的缓存框架</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#如何开启Memcached"><span class="toc-text">如何开启Memcached</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置管理员邮箱接收异常报告"><span class="toc-text">配置管理员邮箱接收异常报告</span></a></li></ol></li></ol>
    </div>

      
        <p> <strong>Nginx + Uwsgi + Django 部署web</strong></p>
<blockquote>
<p>坑真多，折腾了一天</p>
</blockquote>
<h3 id="1、环境准备"><a href="#1、环境准备" class="headerlink" title="1、环境准备"></a>1、环境准备</h3><h4 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get install nginx</div></pre></td></tr></table></figure>
<p>ubantu安装完Nginx后，文件结构大致为：<br>　　所有的配置文件都在 /etc/nginx下；<br>　　启动程序文件在 /usr/sbin/nginx下；<br>　　日志文件在 /var/log/nginx/下，分别是access.log和error.log；<br>　　并且在 /etc/init.d下创建了启动脚本nginx。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo /etc/init.d/nginx start    # 启动</div><div class="line">sudo /etc/init.d/nginx stop     # 停止</div><div class="line">sudo /etc/init.d/nginx restart  # 重启</div></pre></td></tr></table></figure>
<p>或者使用service命令</p>
<h4 id="安装uwsgi"><a href="#安装uwsgi" class="headerlink" title="安装uwsgi"></a>安装uwsgi</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apt-get install python-dev</div><div class="line">pip install uwsgi</div></pre></td></tr></table></figure>
<p>至于为什么要使用uwsgi,可以参见这篇博客：<a href="http://developer.51cto.com/art/201010/229615.htm" target="_blank" rel="external">快速部署Python应用：Nginx+uWSGI配置详解(1)</a>。<br>这样大体的流程是：nginx作为服务器最前端，可以实现端口复用，反向代理（根据域名转发请求），负载均衡等功能。由nginx负责接收client的所有请求，统一管理。静态资源请求由Nginx处理，非静态请求通过uwsgi转发给Django后端，由Django来进行处理后返回结果给Nginx，从而完成一次WEB请求的响应。<br>请求流程：<br><code>user client --&gt; web frontend (nginx) --socket--&gt; uwsgi --&gt; web backend(Django)</code></p>
<h4 id="测试uwsgi"><a href="#测试uwsgi" class="headerlink" title="测试uwsgi"></a>测试uwsgi</h4><p>在Django项目下新建test.py文件，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># test.py</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(env, start_response)</span>:</span></div><div class="line">    start_response(<span class="string">'200 OK'</span>, [(<span class="string">'Content-Type'</span>,<span class="string">'text/html'</span>)])</div><div class="line">    <span class="keyword">return</span> [<span class="string">"Hello World"</span>] <span class="comment"># python2</span></div><div class="line">    <span class="comment">#return [b"Hello World"] # python3</span></div></pre></td></tr></table></figure>
<p>然后执行shell命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uwsgi --http :8001 --plugin python --wsgi-file test.py</div></pre></td></tr></table></figure>
<p>加上–plugin python是告诉uWSGI在使用python插件，不然很有可能会出现类似这样的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">uwsgi: unrecognized option &apos;--wsgi-file&apos;</div><div class="line">getopt_long() error</div></pre></td></tr></table></figure>
<p>执行成功在浏览器中打开：<a href="http://localhost:8001%E6%98%BE%E7%A4%BAHello/" target="_blank" rel="external">http://localhost:8001</a> 显示Hello World说明uwsgi正常运行。</p>
<h4 id="测试Django"><a href="#测试Django" class="headerlink" title="测试Django"></a>测试Django</h4><p>首先得保证Django项目没有问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py runserver 0.0.0.0:8001</div></pre></td></tr></table></figure>
<p>访问<a href="http://localhost:8001,项目运行正常。然后链接Django和uwsgi，实现简单的web服务器，到Django项目目录下执行" target="_blank" rel="external">http://localhost:8001,项目运行正常。然后链接Django和uwsgi，实现简单的web服务器，到Django项目目录下执行</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uwsgi --http :8001 --plugin python --module blog.wsgi</div></pre></td></tr></table></figure>
<p>blog为你的项目名。访问<a href="http://localhost:8001，项目正常。注意这时项目的静态文件是不会被加载的，需要用nginx做静态文件代理。" target="_blank" rel="external">http://localhost:8001，项目正常。注意这时项目的静态文件是不会被加载的，需要用nginx做静态文件代理。</a></p>
<h3 id="2、部署web"><a href="#2、部署web" class="headerlink" title="2、部署web"></a>2、部署web</h3><h4 id="上传django项目到服务器"><a href="#上传django项目到服务器" class="headerlink" title="上传django项目到服务器"></a>上传django项目到服务器</h4><p>我的项目目录，有几个文件和目录是上传后在服务器上创建的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">$ tree -d -L <span class="number">2</span></div><div class="line">ikindlebook</div><div class="line">├── book</div><div class="line">│   ├── admin.py</div><div class="line">│   ├── book <span class="comment">#是个app</span></div><div class="line">├── booklist</div><div class="line">│   ├── admin.py</div><div class="line">│   ├── booklist <span class="comment">#也是个app</span></div><div class="line">├── ikindlebook</div><div class="line">│   ├── __init__.py</div><div class="line">│   ├── settings.py  <span class="comment"># 项目配置文件</span></div><div class="line">│   ├── urls.py</div><div class="line">│   ├── wsgi.py      <span class="comment"># wsgi模块</span></div><div class="line">├── manage.py        </div><div class="line">├── requirements.txt <span class="comment"># python依赖库</span></div><div class="line">├── static</div><div class="line">├── static_root      <span class="comment"># 这个目录通过 collectstatic生成，Nginx服务器提供静态文件使用的</span></div><div class="line">│   ├── admin</div><div class="line">│   ├── css</div><div class="line">│   ├── fonts</div><div class="line">│   ├── images</div><div class="line">│   ├── img</div><div class="line">│   └── js</div><div class="line">├── uwsgi.ini   <span class="comment"># uwsgi配置文件</span></div><div class="line">└── uwsgi_params  <span class="comment"># 从uwsgi模块中copy过来的，/etc/nginx/uwsgi_params</span></div></pre></td></tr></table></figure>
<h4 id="Django项目收集静态文件"><a href="#Django项目收集静态文件" class="headerlink" title="Django项目收集静态文件"></a>Django项目收集静态文件</h4><p>在settings中设置<code>STATIC_ROOT</code>， 然后运行<code>manage.py collectstatic</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">STATIC_URL = <span class="string">'/static/'</span></div><div class="line">STATICFILES_DIRS = [</div><div class="line">    os.path.join(BASE_DIR, <span class="string">"static"</span>)</div><div class="line">]</div><div class="line">STATIC_ROOT = os.path.normpath(os.path.join(BASE_DIR, <span class="string">'static_root'</span>))</div><div class="line"><span class="comment"># 注意此处有坑， STATIC_ROOT路径可以随意指定，但一定不能是STATICFILES_DIRS中的目录，</span></div></pre></td></tr></table></figure>
<p>然后你就会看到<code>STATIC_ROOT</code>路径下已经收集到了项目所有的静态文件。我们把这个路径提供给Nginx。</p>
<h4 id="修改settings文件"><a href="#修改settings文件" class="headerlink" title="修改settings文件"></a>修改settings文件</h4><p>1、修改时区</p>
<p><code>TIME_ZONE = &#39;Asia/Shanghai&#39;</code></p>
<p>2、关闭debug模式</p>
<p>在settings中设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DEBUG = <span class="keyword">False</span></div><div class="line"></div><div class="line">ALLOWED_HOSTS = [<span class="string">'*'</span>]</div></pre></td></tr></table></figure>
<p>可以根据hostname来决定是否开启debug</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">if</span> socket.gethostname() == <span class="string">'develop_mechine'</span>:</div><div class="line">    DEBUG = TEMPLATE_DEBUG = <span class="keyword">True</span></div><div class="line">    DATABASE_NAME = <span class="string">'develop_db'</span></div><div class="line"><span class="keyword">else</span>:</div><div class="line">    DEBUG = TEMPLATE_DEBUG = <span class="keyword">False</span></div><div class="line">    DATABASE_NAME = <span class="string">'production_db'</span></div></pre></td></tr></table></figure>
<p>3、<strong>配置错误提示页面</strong></p>
<p>设置出错模版</p>
<p>必须配置的最常用出错模版</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">404.</span>html : [page <span class="keyword">not</span> found] 页面未找到……</div><div class="line"></div><div class="line"><span class="number">500.</span>html : [server error] 内部错误……</div><div class="line"></div><div class="line"><span class="number">403.</span>html : [HTTP Forbidden] 禁止访问……</div><div class="line"></div><div class="line"><span class="number">400.</span>html : [bad request] 页面已删除、更名、过期或暂不可用……</div></pre></td></tr></table></figure>
<p>Django配置出错模版: 这两种方式都只在DEBUG=False时起作用，最方便的方式是采用第二种方式，而如果有特殊的需求，例如当页面出错时想自己处理，那么也可以自己定义handler view来处理。</p>
<ol>
<li>在URLconf下重新定义Django内置的handler函数：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">handler404 = <span class="string">'mysite.views.my_custom_page_not_found_view'</span></div><div class="line"></div><div class="line">HttpResponseNotFound,</div><div class="line"></div><div class="line">handler500 = <span class="string">'mysite.views.my_custom_error_view'</span></div><div class="line"></div><div class="line">HttpResponseServerError,</div><div class="line"></div><div class="line">handler403 = <span class="string">'mysite.views.my_custom_permission_denied_view'</span></div><div class="line"></div><div class="line">HttpResponseForbidden,</div><div class="line"></div><div class="line">handler400 = <span class="string">'mysite.views.my_custom_bad_request_view'</span></div><div class="line"></div><div class="line">HttpResponseBadRequest</div></pre></td></tr></table></figure>
<ol>
<li>自己建立404.html,500.html等放到公共Templates目录下</li>
</ol>
<h4 id="配置Nginx服务器"><a href="#配置Nginx服务器" class="headerlink" title="配置Nginx服务器"></a>配置Nginx服务器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> sudo cat /etc/nginx/sites-enabled/default </div><div class="line">server &#123;</div><div class="line">	listen 8080; # web服务器对外提供服务的端口</div><div class="line">	index index.html index.htm;</div><div class="line">        charset utf-8;</div><div class="line">	server_name 123.207.253.201; # web服务器访问地址，如果你是本地测试，可以设置为127.0.0.1</div><div class="line"></div><div class="line">	location /static &#123; # 定位static静态文件路径</div><div class="line">		alias /home/ubuntu/ikindlebook/static_root; # 这是上一步生成的</div><div class="line">                &#125;</div><div class="line">    location / &#123;</div><div class="line">           uwsgi_pass 127.0.0.1:8001; # 配置和uwsgi的转发，和下一步的uwsgi配置相关</div><div class="line">           include /home/ubuntu/ikindlebook/uwsgi_params;</div><div class="line">         &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要注意static静态文件的路径，如果有media文件夹，也要用location命令为Nginx指定路径。</p>
<h4 id="配置uwsgi"><a href="#配置uwsgi" class="headerlink" title="配置uwsgi"></a>配置uwsgi</h4><p>注意第一行的[uwsgi]不能漏掉，不然运行uwsgi会出错。</p>
<p>socket地址和Nginx default配置文件中的<code>uwsgi_pass 127.0.0.1:8001</code>保持一致。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="section">[uwsgi]</span></div><div class="line"><span class="comment"># Django-related settings</span></div><div class="line"></div><div class="line"><span class="attr">socket</span> = :<span class="number">8001</span></div><div class="line"></div><div class="line"><span class="comment"># the base directory (full path)</span></div><div class="line"><span class="attr">chdir</span>           = /home/ubuntu/ikindlebook</div><div class="line"><span class="comment"># Django s wsgi file</span></div><div class="line"><span class="attr">module</span>          = ikindlebook.wsgi</div><div class="line"></div><div class="line"><span class="comment"># process-related settings</span></div><div class="line"><span class="comment"># master</span></div><div class="line"><span class="attr">master</span>          = <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># maximum number of worker processes</span></div><div class="line"><span class="attr">processes</span>       = <span class="number">4</span></div><div class="line"></div><div class="line"><span class="comment"># ... with appropriate permissions - may be needed</span></div><div class="line"><span class="comment"># chmod-socket    = 664</span></div><div class="line"><span class="comment"># clear environment on exit</span></div><div class="line"><span class="attr">vacuum</span>          = <span class="literal">true</span></div></pre></td></tr></table></figure>
<h4 id="最后，运行项目"><a href="#最后，运行项目" class="headerlink" title="最后，运行项目"></a>最后，运行项目</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> sudo service nginx restart</div><div class="line"><span class="meta">$</span> sudo uwsgi --ini uwsgi.ini</div></pre></td></tr></table></figure>
<p>然后访问<code>http://server_name:listen_port</code>,就可以啦。</p>
<p>原理：用户收发的所有请求都交给Nginx web专用服务器处理。</p>
<ul>
<li><p>静态内容</p>
<p>Nginx可以直接处理静态文件，比如css、js、img等。</p>
</li>
<li><p>动态内容</p>
<p>动态生成的页面Nginx无法直接提供，因此转发给uwsgi处理，uwsgi协同django的wsgi程序根据请求生成页面内容后交给Nginx。</p>
</li>
</ul>
<h3 id="3、高级部分"><a href="#3、高级部分" class="headerlink" title="3、高级部分"></a>3、高级部分</h3><h4 id="配置Memcache"><a href="#配置Memcache" class="headerlink" title="配置Memcache"></a>配置Memcache</h4><h5 id="Django的缓存框架"><a href="#Django的缓存框架" class="headerlink" title="Django的缓存框架"></a><strong>Django的缓存框架</strong></h5><p>当我们访问一个Django网站页面时，大部分页面都需要经过数据库、VIEW里的运算还有模版渲染等才能得到最终的页面，如果能把这些运算结果缓存起来，下次请求直接返回，将能提升用户访问体验。</p>
<p>要点：</p>
<p>一、缓存机制对小型网站提升并不多，一般应用于规模中等以上的网站。</p>
<p>二、缓存机制只是提升服务器性能的途径之一，不要企图用缓存来掩饰自己代码的低效。</p>
<p>三、Django支持以下缓存系统：</p>
<ol>
<li><p>文件系统缓存。</p>
</li>
<li><p>数据库缓存。</p>
</li>
<li><p>内存缓存(Memcached)</p>
<p>其中，Memcached是最快的，因为所有的缓存数据都放在内存，没有文件系统和数据库访问的开销。但是要注意的是，正因为缓存数据放在内存，如果服务器死机，缓存里的数据将会丢失。</p>
</li>
</ol>
<h5 id="如何开启Memcached"><a href="#如何开启Memcached" class="headerlink" title="如何开启Memcached"></a><strong>如何开启Memcached</strong></h5><p>首先，由于memcached依赖于libevent，到libevent和memcached 的官网下载安装包，安装；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">cd ~/Downloads</div><div class="line">wget https://sourceforge.net/projects/levent/files/libevent/libevent-2.0/libevent-2.0.22-stable.tar.gz --no-check-certificate</div><div class="line">tar zxvf libevent-2.0.22-stable.tar.gz</div><div class="line">cd libevent-2.0.22-stable</div><div class="line">./configure --prefix=/usr</div><div class="line">make</div><div class="line">make install</div><div class="line"></div><div class="line">cd ..</div><div class="line">wget http://www.memcached.org/files/memcached-1.4.24.tar.gz</div><div class="line">tar zxvf memcached-1.4.24.tar.gz</div><div class="line">cd memcached-1.4.24</div><div class="line">./configure --with-libevent=/usr</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<p> 然后，安装 python-memcached： <a href="https://pypi.python.org/pypi/python-memcached" target="_blank" rel="external">https://pypi.python.org/pypi/python-memcached</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pip install python-memcached</div><div class="line">/usr/local/bin/memcached -u root -d  -p 11211 -c 256 -P /tmp/memcached.pid</div><div class="line">ps -ef |grep memcached</div></pre></td></tr></table></figure>
<p> 最后，配置好settings.py里CACHES 的配置项：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">CACHES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.memcached.MemcachedCache'</span>,</div><div class="line">        <span class="string">'LOCATION'</span>: <span class="string">'127.0.0.1:11211'</span>,</div><div class="line">            <span class="comment">#['172.19.26.240:11211',</span></div><div class="line">            <span class="comment">#'172.19.26.242:11211',]</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">MIDDLEWARE_CLASSES = (</div><div class="line">    <span class="string">'django.middleware.cache.UpdateCacheMiddleware'</span>,</div><div class="line"></div><div class="line">	<span class="string">'django.middleware.common.CommonMiddleware'</span>,</div><div class="line">...</div><div class="line">    <span class="string">'django.middleware.cache.FetchFromCacheMiddleware'</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
<p>  并在MIDDLEWARE_CLASSES 里面的最前面加上：</p>
<p>​             <code>django.middleware.cache.UpdateCacheMiddleware</code>,</p>
<p>  在最后面加上：</p>
<p>​             <code>django.middleware.cache.FetchFromCacheMiddleware</code>,</p>
<h4 id="配置管理员邮箱接收异常报告"><a href="#配置管理员邮箱接收异常报告" class="headerlink" title="配置管理员邮箱接收异常报告"></a>配置管理员邮箱接收异常报告</h4><p>首先在settings中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ADMINS = (</div><div class="line">	(<span class="string">'Shawn'</span>,<span class="string">'shawn.huang@xxx.com'</span>),) </div><div class="line"><span class="comment"># 管理员邮箱，用来接收代码异常的报告</span></div><div class="line"></div><div class="line">MANAGERS = (</div><div class="line">	(<span class="string">'Shawn'</span>, &gt;<span class="string">'shawn@example.com'</span>),) </div><div class="line"><span class="comment"># 管理者邮箱，接收用户访问引发的404错误报告</span></div><div class="line"></div><div class="line"><span class="comment"># debug设为false，且MIDDLEWARE_CLASSES中加入下面一行才会生效</span></div><div class="line">MIDDLEWARE_CLASSES=(</div><div class="line"> <span class="string">'django.middleware.common.BrokenLinkEmailsMiddleware'</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
<p>然后修改django的global_settings.py文件，配置发送邮件服务器</p>
<p>首先找到global_settings.py文件所在位置</p>
<p><code>python -c &#39;import django;print django.__path__&#39;</code></p>
<p><code>sudo vim python2.7/site-packages/django/conf/global_settings.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">SERVER_EMAIL = <span class="string">'shawn@example.qq.com'</span>  </div><div class="line">EMAIL_HOST = <span class="string">'smtp.exmail.qq.com'</span>  </div><div class="line">EMAIL_PORT = <span class="number">25</span>  </div><div class="line"><span class="comment"># 设置发件邮箱用户名和密码</span></div><div class="line">EMAIL_HOST_USER = <span class="string">''</span></div><div class="line">EMAIL_HOST_PASSWORD = <span class="string">''</span></div><div class="line">EMAIL_USE_TLS = <span class="keyword">False</span></div><div class="line">EMAIL_USE_SSL = <span class="keyword">False</span></div><div class="line">EMAIL_SSL_CERTFILE = <span class="keyword">None</span></div><div class="line">EMAIL_SSL_KEYFILE = <span class="keyword">None</span></div><div class="line">EMAIL_TIMEOUT = <span class="keyword">None</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-08-18T16:00:00.000Z"><a href="/2016/08/19/技术/Django和Xadmin/">2016-08-19</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/08/19/技术/Django和Xadmin/">Django后台管理系统 第三发插件 Xadmin</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Django和Xadmin"><span class="toc-text">Django和Xadmin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Xadmin"><span class="toc-text">安装Xadmin</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、安装数据库驱动"><span class="toc-text">1、安装数据库驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、设置中配置数据库连接"><span class="toc-text">2、设置中配置数据库连接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库设计"><span class="toc-text">数据库设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、根据功能设计APP"><span class="toc-text">1、根据功能设计APP</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#users"><span class="toc-text">users</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#courses"><span class="toc-text">courses</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、APP-models-设计"><span class="toc-text">2、APP models 设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、数据库表的生成与修改"><span class="toc-text">3、数据库表的生成与修改</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后台管理系统"><span class="toc-text">后台管理系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、Django自带的admin管理"><span class="toc-text">1、Django自带的admin管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-、xadmin"><span class="toc-text">2 、xadmin</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#models注册"><span class="toc-text">models注册</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Xadmin个性化设置"><span class="toc-text">Xadmin个性化设置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端功能-users-APP"><span class="toc-text">前端功能  users APP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、登录"><span class="toc-text">1、登录</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#重载认证方法，实现邮箱-用户名认证"><span class="toc-text">重载认证方法，实现邮箱/用户名认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#form表单预处理"><span class="toc-text">form表单预处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Session和Cookie机制"><span class="toc-text">Session和Cookie机制</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、注册"><span class="toc-text">2、注册</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#验证码模块"><span class="toc-text">验证码模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#发送邮箱链接"><span class="toc-text">发送邮箱链接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#注册用户激活"><span class="toc-text">注册用户激活</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#用户密码找回"><span class="toc-text">用户密码找回</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、某页面访问前验证用户是否登录"><span class="toc-text">3、某页面访问前验证用户是否登录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端功能-Organization-APP"><span class="toc-text">前端功能  Organization APP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、html模板继承和base页面"><span class="toc-text">1、html模板继承和base页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、后端功能"><span class="toc-text">2、后端功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#访问上传文件静态资源"><span class="toc-text">访问上传文件静态资源</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#实现内容分页"><span class="toc-text">实现内容分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#内容筛选-排序"><span class="toc-text">内容筛选 排序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ModelForm表单提交"><span class="toc-text">ModelForm表单提交</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#由外键获取数据"><span class="toc-text">由外键获取数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#实现收藏功能"><span class="toc-text">实现收藏功能</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端功能-Course-APP"><span class="toc-text">前端功能 Course APP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、课程列表"><span class="toc-text">1、课程列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、课程详情"><span class="toc-text">2、课程详情</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、评论"><span class="toc-text">3、评论</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4、资源下载"><span class="toc-text">4、资源下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5、用户购买推荐"><span class="toc-text">5、用户购买推荐</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6、视频播放"><span class="toc-text">6、视频播放</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端功能-Teacher-APP"><span class="toc-text">前端功能 Teacher APP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端功能-搜索"><span class="toc-text">前端功能 搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端功能-个人中心"><span class="toc-text">前端功能 个人中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、修改头像"><span class="toc-text">1、修改头像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、修改密码"><span class="toc-text">2、修改密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、修改邮箱"><span class="toc-text">3、修改邮箱</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4、其他用户信息修改"><span class="toc-text">4、其他用户信息修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5、我的收藏"><span class="toc-text">5、我的收藏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6、我的消息"><span class="toc-text">6、我的消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7、退出登录"><span class="toc-text">7、退出登录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能-用户权限"><span class="toc-text">功能  用户权限</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、XAdmin注册自定义的UserProfile"><span class="toc-text">1、XAdmin注册自定义的UserProfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、当前登录用户修改密码"><span class="toc-text">2、当前登录用户修改密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、通过Form修改密码"><span class="toc-text">3、通过Form修改密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4、用户权限管理"><span class="toc-text">4、用户权限管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5、xadmin-model图标，只读字段，默认排序设置"><span class="toc-text">5、xadmin model图标，只读字段，默认排序设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6、浏览器强制刷新"><span class="toc-text">6、浏览器强制刷新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7、model-管理器-配置"><span class="toc-text">7、model 管理器 配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能-Xadmin插件开发"><span class="toc-text">功能 Xadmin插件开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、使用富文本编辑器"><span class="toc-text">1、使用富文本编辑器</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>

      
        <h1 id="Django和Xadmin"><a href="#Django和Xadmin" class="headerlink" title="Django和Xadmin"></a>Django和Xadmin</h1><h3 id="安装Xadmin"><a href="#安装Xadmin" class="headerlink" title="安装Xadmin"></a>安装Xadmin</h3><h4 id="1、安装数据库驱动"><a href="#1、安装数据库驱动" class="headerlink" title="1、安装数据库驱动"></a>1、安装数据库驱动</h4><p>​    安装mysql驱动  <code>pip install mysql-python</code></p>
<p>​    windows下在<a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python" target="_blank" rel="external">http://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python</a>下载对    应的包版本，然后在命令行执行pip install MySQL_python-1.2.5-cp27-none-win_amd64.whl</p>
<h4 id="2、设置中配置数据库连接"><a href="#2、设置中配置数据库连接" class="headerlink" title="2、设置中配置数据库连接"></a>2、设置中配置数据库连接</h4><ul>
<li><p>数据库要先创建，表可由django自动创建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">DATABASES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'imooc_django'</span>, </div><div class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</div><div class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'roottest'</span>,</div><div class="line">        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>models类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserMessage</span><span class="params">(models.Model)</span>:</span></div><div class="line">    object_id = models.CharField(max_length=<span class="number">50</span>, default=<span class="string">""</span>, primary_key=<span class="keyword">True</span>, verbose_name=<span class="string">"主键"</span>) <span class="comment"># 设置为主键</span></div><div class="line">    name = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">"用户名"</span>)</div><div class="line">    email = models.EmailField(verbose_name=<span class="string">"邮箱"</span>)</div><div class="line">    address = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">"联系地址"</span>)</div><div class="line">    message = models.CharField(max_length=<span class="number">500</span>, verbose_name=<span class="string">"留言信息"</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">"用户留言信息"</span></div><div class="line">        verbose_name_plural = verbose_name <span class="comment"># 复数形式， 默认是在verbose_name后加s</span></div><div class="line">        db_table = <span class="string">"user_messaage"</span> <span class="comment"># 默认在数据库生成的表命名为app_modelclassname</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h3><h4 id="1、根据功能设计APP"><a href="#1、根据功能设计APP" class="headerlink" title="1、根据功能设计APP"></a>1、根据功能设计APP</h4><h5 id="users"><a href="#users" class="headerlink" title="users"></a>users</h5><ul>
<li><p>user用户管理</p>
<p>创建新的user model，继承扩展原有的model AbstractUser。AbstractUser已经定义了一些字段。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span><span class="params">(AbstractUser)</span>:</span></div><div class="line">    nick_name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">"昵称"</span>, default=<span class="string">""</span>)</div><div class="line">    birday = models.DateField(verbose_name=<span class="string">"生日"</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</div><div class="line">    <span class="comment"># choice选项</span></div><div class="line">    gender = models.CharField(max_length=<span class="number">10</span>, choices=((<span class="string">"male"</span>, <span class="string">"男"</span>), (<span class="string">"female"</span>, <span class="string">"女"</span>)), default=<span class="string">"female"</span>)</div><div class="line">    address = models.CharField(max_length=<span class="number">100</span>, default=<span class="string">""</span>)</div><div class="line">    mobile = models.CharField(max_length=<span class="number">11</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</div><div class="line">    <span class="comment"># ImageField</span></div><div class="line">    image = models.ImageField(upload_to=<span class="string">"image/%Y/%m"</span>, default=<span class="string">"image/default.png"</span>, max_length=<span class="number">100</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">"用户信息"</span></div><div class="line">        verbose_name_plural = verbose_name</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.username</div><div class="line"></div><div class="line">    <span class="comment"># 获取用户未读消息数量</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unread_nums</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">from</span> operation.models <span class="keyword">import</span> UserMessage</div><div class="line">        <span class="keyword">return</span> UserMessage.objects.filter(user=self.id, has_read=<span class="keyword">False</span>).count()</div></pre></td></tr></table></figure>
</li>
<li><p>settings中添加新建的app，和<code>AUTH_USER_MODEL = &quot;user.UserProfile&quot;</code>,注意不是models.UserProfile</p>
</li>
</ul>
<h5 id="courses"><a href="#courses" class="headerlink" title="courses"></a>courses</h5><ul>
<li><p>相关model</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="comment"># from DjangoUeditor.models import UEditorField</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"><span class="keyword">from</span> organization.models <span class="keyword">import</span> CourseOrg, Teacher</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(models.Model)</span>:</span></div><div class="line">    course_org = models.ForeignKey(CourseOrg, verbose_name=<span class="string">"课程机构"</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</div><div class="line">    name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">"课程名称"</span>)</div><div class="line">    desc = models.CharField(max_length=<span class="number">300</span>, verbose_name=<span class="string">"课程描述"</span>)</div><div class="line">    detail = models.TextField(verbose_name=<span class="string">"课程详情"</span>)</div><div class="line"></div><div class="line">    <span class="comment"># Python 3 中无法使用 Ueditor</span></div><div class="line">    <span class="comment"># detail = UEditorField(verbose_name="课程详情", width=600, height=300, imagePath="course/ueditor/",</span></div><div class="line">    <span class="comment">#                         filePath="course/ueditor/", default="")</span></div><div class="line"></div><div class="line">    is_banner = models.BooleanField(default=<span class="keyword">False</span>, verbose_name=<span class="string">"是否轮播"</span>)</div><div class="line">    degree = models.CharField(verbose_name=<span class="string">"课程难度"</span>, choices=((<span class="string">"cj"</span>, <span class="string">"初级"</span>), (<span class="string">"zj"</span>, <span class="string">"中级"</span>), (<span class="string">"gj"</span>, <span class="string">"高级"</span>)), max_length=<span class="number">2</span>)</div><div class="line">    learn_times = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">"学习时长(分钟数)"</span>)</div><div class="line">    teacher = models.ForeignKey(Teacher, verbose_name=<span class="string">"讲师"</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</div><div class="line">    students = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">"学习人数"</span>)</div><div class="line">    fav_nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">"收藏人数"</span>)</div><div class="line">    image = models.ImageField(upload_to=<span class="string">"course/%Y/%m"</span>, verbose_name=<span class="string">"封面图片"</span>, max_length=<span class="number">100</span>)</div><div class="line">    click_nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">"点击数"</span>)</div><div class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">"添加时间"</span>)</div><div class="line">    tag = models.CharField(default=<span class="string">''</span>, verbose_name=<span class="string">"课程标签"</span>, max_length=<span class="number">10</span>)</div><div class="line">    category = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">"课程类别"</span>, default=<span class="string">"后端开发"</span>)</div><div class="line">    you_need_know = models.CharField(max_length=<span class="number">300</span>, verbose_name=<span class="string">"课程须知"</span>, default=<span class="string">''</span>)</div><div class="line">    teacher_tell = models.CharField(max_length=<span class="number">300</span>, verbose_name=<span class="string">"老师告诉你"</span>, default=<span class="string">''</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">"课程"</span></div><div class="line">        verbose_name_plural = verbose_name</div><div class="line"></div><div class="line">    <span class="comment"># 获取课程章节数</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_zj_nums</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.lesson_set.all().count()</div><div class="line">    <span class="comment"># 修改后台列名的显示，否则该列显示为 get_zj_nums</span></div><div class="line">    get_zj_nums.short_description = <span class="string">"章节数"</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment"># def go_to(self):</span></div><div class="line">    <span class="comment">#     from django.utils.safestring import mark_safe</span></div><div class="line">    <span class="comment">#     return mark_safe("&lt;a href='http://www.baidu.com'&gt;跳转&lt;/a&gt;")</span></div><div class="line">    <span class="comment"># go_to.short_description = "跳转"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_learn_users</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.usercourse_set.all()[:<span class="number">5</span>]</div><div class="line"></div><div class="line">    <span class="comment"># 获取课程所有章节</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_course_lesson</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.lesson_set.all()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.name</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 只是为了在 admin 中注册不同的数据，不要再生成一张新表，但具有 model 的功能</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BannerCourse</span><span class="params">(Course)</span>:</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">"轮播课程"</span></div><div class="line">        verbose_name_plural = verbose_name</div><div class="line">        proxy = <span class="keyword">True</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lesson</span><span class="params">(models.Model)</span>:</span></div><div class="line">    course = models.ForeignKey(Course, verbose_name=<span class="string">"课程"</span>)</div><div class="line">    name = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">"章节名"</span>)</div><div class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">"添加时间"</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">"章节"</span></div><div class="line">        verbose_name_plural = verbose_name</div><div class="line"></div><div class="line">    <span class="comment"># 获取章节视频</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_lesson_video</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.video_set.all()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.name</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Video</span><span class="params">(models.Model)</span>:</span></div><div class="line">    lesson = models.ForeignKey(Lesson, verbose_name=<span class="string">"章节"</span>)</div><div class="line">    name = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">"视频名"</span>)</div><div class="line">    url = models.CharField(max_length=<span class="number">200</span>, verbose_name=<span class="string">"访问地址"</span>, default=<span class="string">''</span>)</div><div class="line">    learn_times = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">"学习时长(分钟数)"</span>)</div><div class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">"添加时间"</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">"视频"</span></div><div class="line">        verbose_name_plural = verbose_name</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.name</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseResource</span><span class="params">(models.Model)</span>:</span></div><div class="line">    course = models.ForeignKey(Course, verbose_name=<span class="string">"课程"</span>)</div><div class="line">    name = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">"名称"</span>)</div><div class="line">    download = models.FileField(upload_to=<span class="string">"course/resource/%Y/%m"</span>, verbose_name=<span class="string">"资源文件"</span>, max_length=<span class="number">100</span>)</div><div class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">"添加时间"</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">"课程资源"</span></div><div class="line">        verbose_name_plural = verbose_name</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.name</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2、APP-models-设计"><a href="#2、APP-models-设计" class="headerlink" title="2、APP models 设计"></a>2、APP models 设计</h4><p>app model 分层设计，避免循环import。</p>
<h4 id="3、数据库表的生成与修改"><a href="#3、数据库表的生成与修改" class="headerlink" title="3、数据库表的生成与修改"></a>3、数据库表的生成与修改</h4><h3 id="后台管理系统"><a href="#后台管理系统" class="headerlink" title="后台管理系统"></a>后台管理系统</h3><ul>
<li>权限管理</li>
<li>没必要使用过多的前端样式</li>
<li>前期快速开发</li>
<li>是对数据库中表的管理</li>
</ul>
<h4 id="1、Django自带的admin管理"><a href="#1、Django自带的admin管理" class="headerlink" title="1、Django自带的admin管理"></a>1、Django自带的admin管理</h4><ul>
<li><p>在admin中注册models，每个app创建后都有一个admin.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</div><div class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> UserProfile</div><div class="line"><span class="comment"># Register your models here.</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># model管理器的命名是在model名的后面加上Admin</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfileAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line">admin.site.register(UserProfile, UserProfileAdmin)</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2-、xadmin"><a href="#2-、xadmin" class="headerlink" title="2 、xadmin"></a>2 、xadmin</h4><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><ul>
<li><p>安装 <a href="https://github.com/sshwsfc/xadmin" target="_blank" rel="external">github 地址</a> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">django~=<span class="number">1.9</span><span class="number">.0</span></div><div class="line">django-crispy-forms~=<span class="number">1.6</span><span class="number">.0</span></div><div class="line">django-reversion~=<span class="number">2.0</span><span class="number">.0</span></div><div class="line">django-formtools==<span class="number">1.0</span></div><div class="line">future==<span class="number">0.15</span><span class="number">.2</span></div><div class="line">httplib2==<span class="number">0.9</span><span class="number">.2</span></div><div class="line">six==<span class="number">1.10</span><span class="number">.0</span></div><div class="line">pip install xadmin</div><div class="line">pip install django-xadmin</div><div class="line">pip install git+git://github.com/sshwsfc/xadmin.git <span class="comment"># 源码安装最新版本</span></div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>修改setting.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">INSTALLED_APPS = [</div><div class="line">    <span class="string">'xadmin'</span>,</div><div class="line">    <span class="string">'crispy_forms'</span>,</div><div class="line">    <span class="string">'reversion'</span>,</div><div class="line">]</div></pre></td></tr></table></figure>
</li>
<li><p><code>urls.py</code>指向xadmin </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> xadmin</div><div class="line">urlpatterns = [ url(<span class="string">r'^admin/'</span>, xadmin.site.urls),]</div></pre></td></tr></table></figure>
</li>
<li><p>migrate一下</p>
<p>xadmin会自动注册UserProfile这个model</p>
</li>
</ul>
<h5 id="models注册"><a href="#models注册" class="headerlink" title="models注册"></a>models注册</h5><ul>
<li><p>注册model需要新建一个文件<code>adminx.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> xadmin</div><div class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> EmailVerifyRecord, Banner</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># xadmin的model管理器继承的对象是object</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailVerifyRecordAdmin</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="comment"># 显示表里的哪些列</span></div><div class="line">    <span class="comment"># course是个外键，重载Unicode方法以显示可读名字，不然在后台显示的对象名字是“course object”</span></div><div class="line">    list_display = [<span class="string">'code'</span>, <span class="string">'email'</span>, <span class="string">'send_type'</span>, <span class="string">'send_time'</span>, <span class="string">'course'</span>]</div><div class="line">    <span class="comment"># 哪些field可以被搜索查找</span></div><div class="line">    search_fields = [<span class="string">'code'</span>, <span class="string">'email'</span>, <span class="string">'send_type'</span>]</div><div class="line">    <span class="comment"># 过滤器，可以根据条件筛选、搜索</span></div><div class="line">    <span class="comment"># course是个外键，通过"__"指定要过滤的course对象的字段</span></div><div class="line">    list_filter = [<span class="string">'code'</span>, <span class="string">'email'</span>, <span class="string">'send_type'</span>, <span class="string">'course__name'</span>]</div><div class="line">    <span class="comment"># 数据item按code字段倒序排序</span></div><div class="line">    ordering = [<span class="string">'-code'</span>]</div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># xadmin管理页面显示的顺序和注册的顺序一致</span></div><div class="line">xadmin.site.register(EmailVerifyRecord, EmailVerifyRecordAdmin)</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="Xadmin个性化设置"><a href="#Xadmin个性化设置" class="headerlink" title="Xadmin个性化设置"></a>Xadmin个性化设置</h5><ul>
<li><p>使用xadmin主题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># users/adminx.py</span></div><div class="line"><span class="keyword">from</span> xadmin <span class="keyword">import</span> views</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSetting</span><span class="params">(object)</span>:</span></div><div class="line">    enable_themes = <span class="keyword">True</span></div><div class="line">    use_bootswatch = <span class="keyword">True</span></div><div class="line">    </div><div class="line">    </div><div class="line">xadmin.site.register(views.BaseAdminView, BaseSetting)</div></pre></td></tr></table></figure>
</li>
<li><p>修改title,页面logo和site_footer</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># users/adminx.py</span></div><div class="line"><span class="keyword">from</span> xadmin <span class="keyword">import</span> views</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobalSettings</span><span class="params">(object)</span>:</span></div><div class="line">    site_title = <span class="string">"暮雪后台管理系统"</span></div><div class="line">    site_footer = <span class="string">"暮雪在线网"</span></div><div class="line">    menu_style = <span class="string">"accordion"</span> <span class="comment"># 自动折叠每个app下面的models列表</span></div><div class="line">    </div><div class="line">xadmin.site.register(views.CommAdminView, GlobalSettings)</div></pre></td></tr></table></figure>
</li>
<li><p>显示app的中文名</p>
<p>修改<strong>users/apps.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> AppConfig</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersConfig</span><span class="params">(AppConfig)</span>:</span></div><div class="line">    name = <span class="string">'users'</span></div><div class="line">    verbose_name = <span class="string">u"用户信息"</span></div></pre></td></tr></table></figure>
</li>
<li><p>修改<strong>users/init.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">default_app_config = <span class="string">"users.apps.UsersConfig"</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="前端功能-users-APP"><a href="#前端功能-users-APP" class="headerlink" title="前端功能  users APP"></a>前端功能  users APP</h3><h4 id="1、登录"><a href="#1、登录" class="headerlink" title="1、登录"></a>1、登录</h4><ul>
<li>设置STATICFILES_DIRS</li>
<li>将前端页面和static静态文件放入项目中</li>
<li>修改html中静态资源的引用</li>
<li>实现views和url转发</li>
<li>post表单时CSRF Token</li>
</ul>
<p>实现自定义认证方式，默认的认证方式只能通过username和password认证。</p>
<h5 id="重载认证方法，实现邮箱-用户名认证"><a href="#重载认证方法，实现邮箱-用户名认证" class="headerlink" title="重载认证方法，实现邮箱/用户名认证"></a>重载认证方法，实现邮箱/用户名认证</h5><ul>
<li><p>修改view</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># users/views.py</span></div><div class="line"><span class="keyword">from</span> django.contrib.auth.backends <span class="keyword">import</span> ModelBackend</div><div class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</div><div class="line"></div><div class="line"><span class="comment"># 继承 django.contrib.auth.backends 的 ModelBackend，并重写，实现使用可以同时使用 用户名 或者 邮箱 登录的功能</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomBackend</span><span class="params">(ModelBackend)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, username=None, password=None, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="comment"># 用 Q 实现并集查询,“|”表示或，“,”表示且</span></div><div class="line">            user = UserProfile.objects.get(Q(username=username) | Q(email=username))</div><div class="line">            <span class="keyword">if</span> user.check_password(password):</div><div class="line">                <span class="keyword">return</span> user</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure>
</li>
<li><p>settings.py中设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">AUTHENTICATION_BACKENDS = (</div><div class="line">    <span class="string">'users.views.CustomBackend'</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
</li>
<li><p><strong>user_login</strong> 视图函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 用户登录</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>, &#123;&#125;)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        login_form = LoginForm(request.POST)</div><div class="line">        <span class="comment"># 验证 POST 的每个参数是否合法</span></div><div class="line">        <span class="keyword">if</span> login_form.is_valid():</div><div class="line">            user_name = request.POST.get(<span class="string">'username'</span>, <span class="string">''</span>)</div><div class="line">            password = request.POST.get(<span class="string">'password'</span>, <span class="string">''</span>)</div><div class="line">            <span class="comment"># 使用 authenticate() 方法进行验证</span></div><div class="line">            user = authenticate(username=user_name, password=password)</div><div class="line"></div><div class="line">            <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">if</span> user.is_active:</div><div class="line">                    <span class="comment"># 使用 login() 方法进行登录</span></div><div class="line">                    login(request, user)</div><div class="line">                    <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">"index"</span>))</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>, &#123;<span class="string">'msg'</span>: <span class="string">'用户未激活'</span>&#125;)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>, &#123;<span class="string">'msg'</span>: <span class="string">'用户名或者密码错误！'</span>&#125;)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>, &#123;<span class="string">"login_form"</span>: login_form&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>前端html页面</p>
<p>login.html的form表单，csrf token和登录错误提示</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">  &#123;% raw %&#125;</div><div class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&#123;% url 'login' %&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">autocomplete</span>=<span class="string">"off"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group marb20 &#123;% if login_form.errors.username %&#125; errorput &#123;% endif %&#125;"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">label</span>&gt;</span>用&amp;nbsp;户&amp;nbsp;名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">id</span>=<span class="string">"account_l"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"手机号/邮箱"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group marb8 &#123;% if login_form.errors.password %&#125; errorput &#123;% endif %&#125;"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">label</span>&gt;</span>密&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">id</span>=<span class="string">"password_l"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"请输入您的密码"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error btns login-form-tips"</span> <span class="attr">id</span>=<span class="string">"jsLoginTips"</span>&gt;</span></div><div class="line">      &#123;% for key,error in login_form.errors.items %&#125;</div><div class="line">      &#123;&#123; error &#125;&#125;</div><div class="line">      &#123;% endfor %&#125;</div><div class="line">      &#123;&#123; msg &#125;&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"auto-box marb38"</span>&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"fr"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'forget_pwd' %&#125;"</span>&gt;</span>忘记密码？<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"btn btn-green"</span> <span class="attr">id</span>=<span class="string">"jsLoginBtn"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"立即登录 &gt; "</span> /&gt;</span></div><div class="line"></div><div class="line">    &#123;% csrf_token %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">  &#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>index.html 判断是否是登录的状态</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125;</div><div class="line">&#123;% if request.user.is_authenticated %&#125;</div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"top"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wp"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"fl"</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>服务电话：<span class="tag">&lt;<span class="name">b</span>&gt;</span>33333333<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="comment">&lt;!--登录后跳转--&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"personal"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">dl</span> <span class="attr">class</span>=<span class="string">"user fr"</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">dd</span>&gt;</span>&#123;&#123; request.user.username &#125;&#125;<span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"down fr"</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/top_down.png' %&#125;"</span>/&gt;</span><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">dt</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">"20"</span> <span class="attr">height</span>=<span class="string">"20"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; MEDIA_URL &#125;&#125;&#123;&#123; request.user.image &#125;&#125;"</span>/&gt;</span><span class="tag">&lt;/<span class="name">dt</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"userdetail"</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">dl</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">dt</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">"80"</span> <span class="attr">height</span>=<span class="string">"80"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; MEDIA_URL &#125;&#125;&#123;&#123; request.user.image &#125;&#125;"</span>/&gt;</span><span class="tag">&lt;/<span class="name">dt</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">dd</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123; request.user.nick_name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; request.user.username &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;/<span class="name">dd</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn"</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"personcenter fl"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'users:user_info' %&#125;"</span>&gt;</span>进入个人中心<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"fr"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'logout' %&#125;"</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'users:mymessage' %&#125;"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"msg-num"</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"MsgNum"</span>&gt;</span>&#123;&#123; request.user.unread_nums &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    &#123;% else %&#125;</div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"top"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wp"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"fl"</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>服务电话：<span class="tag">&lt;<span class="name">b</span>&gt;</span>33333333<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">"color:white"</span> <span class="attr">class</span>=<span class="string">"fr registerbtn"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'register' %&#125;"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">"color:white"</span> <span class="attr">class</span>=<span class="string">"fr loginbtn"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'login' %&#125;"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    &#123;% endif %&#125;</div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="form表单预处理"><a href="#form表单预处理" class="headerlink" title="form表单预处理"></a><strong>form</strong>表单预处理</h5><ul>
<li><p><code>forms.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 用于验证提交的表单，预处理表单</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    username = forms.CharField(required=<span class="keyword">True</span>)</div><div class="line">    password = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>)</div><div class="line">    </div><div class="line"><span class="comment"># -----views.py</span></div><div class="line">login_form = LoginForm(request.POST)</div><div class="line"><span class="keyword">if</span> login_form.is_valid():</div><div class="line">    do login</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    do error</div><div class="line">    <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>, &#123;<span class="string">"login_form"</span>: login_form&#125;)</div><div class="line"><span class="comment"># ------ login.html</span></div><div class="line">&#123;% <span class="keyword">if</span> login_form.errors.username %&#125; 高亮username输入框&#123;% endif %&#125;</div><div class="line">&#123;% <span class="keyword">if</span> login_form.errors.password %&#125; 高亮password输入框&#123;% endif %&#125;</div><div class="line"></div><div class="line">&#123;% <span class="keyword">for</span> key, value <span class="keyword">in</span> login_form.errors.items %&#125; xxx &#123;% endfor %&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="Session和Cookie机制"><a href="#Session和Cookie机制" class="headerlink" title="Session和Cookie机制"></a><strong>Session</strong>和<strong>Cookie</strong>机制</h5><p>cookie，服务器生成的一系列键值对，交给客户端本地保存。浏览器每次访问都会自动带上cookies。</p>
<p>session是存储在服务器端的数据，有过期时间，服务器只把session的id发给客户端。</p>
<p>将密码保存到cookies中是不安全的。</p>
<p>django验证用户登录后，会生成一个session，session中的数据是加密的，存储在django_session表中，并把session id作为cookie发给浏览器。</p>
<p><code>django.contrib.sessions</code>这个APP可以从session中实现request.user操作</p>
<h4 id="2、注册"><a href="#2、注册" class="headerlink" title="2、注册"></a>2、注册</h4><h5 id="验证码模块"><a href="#验证码模块" class="headerlink" title="验证码模块"></a>验证码模块</h5><p><a href="https://github.com/mbi/django-simple-captcha" target="_blank" rel="external">网址</a>  <a href="http://django-simple-captcha.readthedocs.io/en/latest/usage.html#installation" target="_blank" rel="external">文档</a></p>
<ul>
<li><p>安装 <code>pip install  django-simple-captcha==0.4.6</code>,需要pillow模块</p>
</li>
<li><p>将captcha 加入到instll app， 然后配置url路由<code>url(r&#39;^captcha/&#39;, include(&#39;captcha.urls&#39;))</code></p>
</li>
<li><p><strong>makemigratations</strong></p>
</li>
<li><p>判断用户邮箱是否已使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># --- forms.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    email = forms.EmailField(required=<span class="keyword">True</span>)</div><div class="line">    password = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>)</div><div class="line">    captcha = CaptchaField(error_messages=&#123;<span class="string">"invalid"</span>: <span class="string">"验证码错误"</span>&#125;)</div><div class="line">    </div><div class="line"><span class="comment"># ---- views.py</span></div><div class="line"><span class="comment"># 注意密码是密文存取的</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">        register_from = RegisterForm()</div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">"register.html"</span>, &#123;<span class="string">'register_form'</span>: register_from&#125;)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        register_from = RegisterForm(request.POST)</div><div class="line">        <span class="keyword">if</span> register_from.is_valid():</div><div class="line">            user_name = request.POST.get(<span class="string">'email'</span>, <span class="string">''</span>)</div><div class="line">            <span class="keyword">if</span> UserProfile.objects.filter(email=user_name):</div><div class="line">                <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>, &#123;<span class="string">"register_form"</span>: register_from, <span class="string">"msg"</span>: <span class="string">"用户已经存在"</span>&#125;)</div><div class="line">            password = request.POST.get(<span class="string">'password'</span>, <span class="string">''</span>)</div><div class="line">            user_profile = UserProfile()</div><div class="line">            user_profile.username = user_name</div><div class="line">            user_profile.email = user_name</div><div class="line">            user_profile.is_active = <span class="keyword">False</span></div><div class="line">            user_profile.password = make_password(password)</div><div class="line">            user_profile.save()</div><div class="line"></div><div class="line">            <span class="comment"># 写入欢迎注册消息</span></div><div class="line">            user_message = UserMessage()</div><div class="line">            user_message.user = user_profile.id</div><div class="line">            user_message.message = <span class="string">"欢迎注册暮雪在线网"</span></div><div class="line">            user_message.save()</div><div class="line"></div><div class="line">            send_register_email(user_name, <span class="string">"register"</span>)</div><div class="line">            <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>, &#123;<span class="string">"register_form"</span>: register_from&#125;)</div><div class="line">        </div><div class="line"> <span class="comment"># ---- register.html</span></div><div class="line">&#123;% raw %&#125;</div><div class="line"><span class="comment"># 注意form的method和active，以及CSRF token</span></div><div class="line">&lt;div class="form-group marb8 captcha1 &#123;% if register_form.errors.captcha %&#125; errorput &#123;% endif %&#125;"&gt;</div><div class="line">     &lt;label&gt;验&amp;nbsp;证&amp;nbsp;码&lt;/label&gt;</div><div class="line">     &#123;&#123; register_form.captcha &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="发送邮箱链接"><a href="#发送邮箱链接" class="headerlink" title="发送邮箱链接"></a>发送邮箱链接</h5><ul>
<li><p>激活账户或修改密码，更换邮箱</p>
<p>实现一个发送email的功能,和生成随机字符串的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># utils/email_send.py</span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</div><div class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mail</div><div class="line"></div><div class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> EmailVerifyRecord</div><div class="line"><span class="keyword">from</span> MxOnline.settings <span class="keyword">import</span> EMAIL_FROM  <span class="comment"># 发件人email</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_str</span><span class="params">(randomlength=<span class="number">16</span>)</span>:</span></div><div class="line">    code = <span class="string">''</span></div><div class="line">    chars = <span class="string">'AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz0123456789'</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(randomlength):</div><div class="line">        code += random.choice(chars)</div><div class="line">    <span class="keyword">return</span> code</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_register_email</span><span class="params">(email, send_type=<span class="string">"register"</span>)</span>:</span></div><div class="line">    email_record = EmailVerifyRecord()</div><div class="line">    <span class="keyword">if</span> send_type == <span class="string">"update_email"</span>:</div><div class="line">        code = random_str(<span class="number">4</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        code = random_str(<span class="number">16</span>)</div><div class="line">    email_record.code = code</div><div class="line">    email_record.email = email</div><div class="line">    email_record.send_type = send_type</div><div class="line">    email_record.save()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> send_type == <span class="string">"register"</span>:</div><div class="line">        email_title = <span class="string">"暮雪在线网注册激活链接"</span></div><div class="line">        email_body = <span class="string">"请点击下边的链接，激活你的账号：http://127.0.0.1:8000/active/&#123;0&#125;"</span>.format(code)</div><div class="line"></div><div class="line">        send_status = send_mail(email_title, email_body, EMAIL_FROM, [email])</div><div class="line">        <span class="keyword">if</span> send_status:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">    <span class="keyword">elif</span> send_type == <span class="string">"forget"</span>:</div><div class="line">        email_title = <span class="string">"暮雪在线网密码重置链接"</span></div><div class="line">        email_body = <span class="string">"请点击下边的链接重置密码：http://127.0.0.1:8000/reset/&#123;0&#125;"</span>.format(code)</div><div class="line"></div><div class="line">        send_status = send_mail(email_title, email_body, EMAIL_FROM, [email])</div><div class="line">        <span class="keyword">if</span> send_status:</div><div class="line">            <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="keyword">elif</span> send_type == <span class="string">"update_email"</span>:</div><div class="line">        email_title = <span class="string">"慕学在线邮箱修改验证码"</span></div><div class="line">        email_body = <span class="string">"你的邮箱验证码为: &#123;0&#125;"</span>.format(code[:<span class="number">4</span>])</div><div class="line">        send_status = send_mail(email_title, email_body, EMAIL_FROM, [email])</div><div class="line"></div><div class="line">        <span class="keyword">if</span> send_status:</div><div class="line">            <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="comment"># ----- settings.py 配置邮件相关参数</span></div><div class="line">EMAIL_HOST = <span class="string">"smtp.sina.com"</span></div><div class="line">EMAIL_PORT = <span class="number">25</span></div><div class="line">EMAIL_HOST_USER = <span class="string">"mydjangotest@sina.com"</span></div><div class="line">EMAIL_HOST_PASSWORD = <span class="string">"django666666"</span></div><div class="line">EMAIL_USE_TLS = <span class="keyword">False</span></div><div class="line">EMAIL_FROM = <span class="string">"mydjangotest@sina.com"</span></div><div class="line"></div><div class="line"><span class="comment"># ---- views.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="comment"># 如果参数ok，则创建一个未激活的user，并发送激活链接到用户邮箱，然后提示用户前往激活账户</span></div><div class="line">    <span class="comment"># 如果参数有错，返回注册页面，并提示错误，将用户填写的数据回填到html form中。</span></div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="注册用户激活"><a href="#注册用户激活" class="headerlink" title="注册用户激活"></a>注册用户激活</h5><ul>
<li><p>相关逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ---- urls.py</span></div><div class="line">url(<span class="string">r'^active/(?P&lt;active_code&gt;.*)/$'</span>, ActiveUserView.as_view(), name=<span class="string">'user_active'</span>)</div><div class="line"></div><div class="line"><span class="comment"># ---- users/views.py</span></div><div class="line"><span class="comment"># url参数提取，使用正则表达式的命名分组</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActiveUserView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, active_code)</span>:</span></div><div class="line">        <span class="comment"># 为什么用 filter ？ 很低的概率一个code可能会对应多个用户，</span></div><div class="line">        <span class="comment"># 在用户的激活链接中加入邮箱信息，应该是极好的。</span></div><div class="line">        all_records = EmailVerifyRecord.objects.filter(code=active_code)</div><div class="line">        <span class="keyword">if</span> all_records:</div><div class="line">            <span class="keyword">for</span> records <span class="keyword">in</span> all_records:</div><div class="line">                email = records.email</div><div class="line">                user = UserProfile.objects.get(email=email)</div><div class="line">                user.is_active = <span class="keyword">True</span></div><div class="line">                user.save()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> render(request, <span class="string">"active_file.html"</span>)</div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>)</div><div class="line">        <span class="comment"># return render(request, 'active_fail.html')</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="用户密码找回"><a href="#用户密码找回" class="headerlink" title="用户密码找回"></a>用户密码找回</h5><ul>
<li><p>点击忘记密码，输入用户名和密码，发送邮箱链接，提示发送成功。</p>
</li>
<li><p>修改密码后跳转到登录页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># --- users/forms.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForgetForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    email = forms.EmailField(required=<span class="keyword">True</span>)</div><div class="line">    captcha = CaptchaField(error_messages=&#123;<span class="string">"invalid"</span>: <span class="string">"验证码错误"</span>&#125;)</div><div class="line">    </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModifyPwdForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    password1 = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>)</div><div class="line">    password2 = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>)</div><div class="line">    </div><div class="line">    </div><div class="line"><span class="comment">#  ---- users/views.py</span></div><div class="line"><span class="comment"># 忘记密码</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForgetView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">        forget_from = ForgetForm()</div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'forgetpwd.html'</span>, &#123;<span class="string">"forget_form"</span>: forget_from&#125;)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        forget_form = ForgetForm(request.POST)</div><div class="line">        <span class="keyword">if</span> forget_form.is_valid():</div><div class="line">            email = request.POST.get(<span class="string">"email"</span>, <span class="string">""</span>)</div><div class="line">            <span class="comment"># 发送激活的邮箱链接</span></div><div class="line">            send_register_email(email, <span class="string">"forget"</span>)</div><div class="line">            <span class="keyword">return</span> render(request, <span class="string">'send_success.html'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> render(request, <span class="string">'forgetpwd.html'</span>, &#123;<span class="string">"forget_form"</span>: forget_form&#125;)</div><div class="line">        </div><div class="line"><span class="comment"># 用户激活</span></div><div class="line"><span class="comment"># 用户进入到重置密码页面</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResetView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, active_code)</span>:</span></div><div class="line">        all_records = EmailVerifyRecord.objects.filter(code=active_code)</div><div class="line">        <span class="keyword">if</span> all_records:</div><div class="line">            <span class="keyword">for</span> records <span class="keyword">in</span> all_records:</div><div class="line">                email = records.email</div><div class="line">                <span class="keyword">return</span> render(request, <span class="string">'password_reset.html'</span>, &#123;<span class="string">'email'</span>: email&#125;)</div><div class="line">        <span class="comment"># return render(request, 'active_fail.html')</span></div><div class="line"></div><div class="line"><span class="comment"># 用户在重置密码页面提交新密码</span></div><div class="line"><span class="comment"># 使用2个class，因为url路由的问题。xx.com/reset/active_code 和 xx.com/reset。</span></div><div class="line"><span class="comment"># html form的active执行时，会跳转到对应的url</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModifyPwdView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        modify_form = ModifyPwdForm(request.POST)</div><div class="line">        email = request.POST.get(<span class="string">'email'</span>, <span class="string">''</span>)</div><div class="line">        <span class="keyword">if</span> modify_form.is_valid():</div><div class="line">            pwd1 = request.POST.get(<span class="string">'password1'</span>, <span class="string">''</span>)</div><div class="line">            pwd2 = request.POST.get(<span class="string">'password2'</span>, <span class="string">''</span>)</div><div class="line">            <span class="keyword">if</span> pwd1 != pwd2:</div><div class="line">                <span class="keyword">return</span> render(request, <span class="string">'password_reset.html'</span>, &#123;<span class="string">'email'</span>: email, <span class="string">'msg'</span>: <span class="string">'密码不一致！'</span>&#125;)</div><div class="line">            user = UserProfile.objects.get(email=email)</div><div class="line">            user.password = make_password(pwd2)</div><div class="line">            user.save()</div><div class="line">            <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>)</div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'password_reset.html'</span>, &#123;<span class="string">'email'</span>: email, <span class="string">'modify_form'</span>: modify_form&#125;)</div><div class="line">        </div><div class="line">        </div><div class="line"><span class="comment"># --- forgetpwd.html</span></div><div class="line"><span class="comment"># 如果表单填写错误，返回时高亮选中出错框。特效是有class errorput实现的。</span></div><div class="line">&#123;% raw %&#125;</div><div class="line">&lt;div class="form-group marb20 &#123;% if forget_form.errors.email %&#125; errorput &#123;% endif %&#125;"&gt;</div><div class="line">     &lt;label&gt;帐&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;号&lt;/label&gt;</div><div class="line">     &lt;input type=<span class="string">"text"</span> id=<span class="string">"account"</span> name=<span class="string">"email"</span> value=<span class="string">"&#123;&#123; forget_form.email.value &#125;&#125;"</span> placeholder=<span class="string">"邮箱"</span> /&gt;</div><div class="line"> &lt;/div&gt;</div><div class="line"><span class="comment"># 提示出错信息。</span></div><div class="line">&lt;div class="error btns" id="jsForgetTips"&gt;</div><div class="line">     &#123;% <span class="keyword">for</span> key,error <span class="keyword">in</span> forget_form.errors.items %&#125;</div><div class="line">        &#123;&#123; error &#125;&#125;</div><div class="line">      &#123;% endfor %&#125;</div><div class="line">       &#123;&#123; msg &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3、某页面访问前验证用户是否登录"><a href="#3、某页面访问前验证用户是否登录" class="headerlink" title="3、某页面访问前验证用户是否登录"></a>3、某页面访问前验证用户是否登录</h4><p>有3种方法，view函数内判断，使用装饰器，和使用类的方法装饰器。</p>
<ul>
<li><p>request.user.is_authenticated</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> request.user.is_authenticated():</div><div class="line">    <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">"login"</span>))</div></pre></td></tr></table></figure>
</li>
<li><p>login_required函数装饰器, View类中无法使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@login_required</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_center</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">return</span> render(request, <span class="string">'user-center.html'</span>, &#123;&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>类的方法装饰器</p>
<p>参考<a href="https://stackoverflow.com/questions/29673549/method-decorator-with-login-required-and-permission-required" target="_blank" rel="external">stackoverflow</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ---- utils.py</span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</div><div class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginRequiredMixin</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">    @method_decorator(login_required(login_url='/login/'))</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">      <span class="keyword">return</span> super(LoginRequiredMixin, self).dispatch(request, *args, **kwargs)</div><div class="line"><span class="string">"""用户个人信息"""</span>   </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoView</span><span class="params">(LoginRequiredMixin, View)</span>:</span>    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">      <span class="keyword">return</span> render(request, <span class="string">'usercenter-info.html'</span>, &#123;&#125;)</div><div class="line"></div><div class="line">  	<span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(user_info_form.errors), content_type=<span class="string">'application/json'</span>)</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="前端功能-Organization-APP"><a href="#前端功能-Organization-APP" class="headerlink" title="前端功能  Organization APP"></a>前端功能  Organization APP</h3><h4 id="1、html模板继承和base页面"><a href="#1、html模板继承和base页面" class="headerlink" title="1、html模板继承和base页面"></a>1、html模板继承和base页面</h4><ul>
<li><p>每个页面的haeder和 footer部分基本不变， 中间的content</p>
</li>
<li><p>django的页面继承和include机制。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125;</div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">&#123;% load staticfiles %&#125;</div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;% block title %&#125;首页&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    &#123;% block custom_css %&#125;&#123;% endblock %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"headerwrap "</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">header</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">div</span>  <span class="attr">class</span>=<span class="string">" header"</span>&gt;</span></div><div class="line">    &#123;% if request.user.is_authenticated %&#125;</div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"top"</span>&gt;</span></div><div class="line">            用户名 个人中心 退出登录</div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    &#123;% else %&#125;</div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"top"</span>&gt;</span></div><div class="line">            注册 登录</div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    &#123;% endif %&#125;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"middle"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wp"</span>&gt;</span></div><div class="line">              logo index_url</div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"searchbox fr"</span>&gt;</span> 搜索框 <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">nav</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"nav"</span>&gt;</span>顶部导航栏  首页 公开课  讲师 机构<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">header</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></div><div class="line"><span class="comment">&lt;!--crumbs start--&gt;</span></div><div class="line"></div><div class="line">&#123;% block custom_bread %&#125;</div><div class="line"><span class="tag">&lt;<span class="name">section</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>  面包屑导航  首页 &gt; 课程中心 &gt; 讲师<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></div><div class="line">&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block content %&#125;</div><div class="line">  网站中间内容</div><div class="line">&#123;% endblock %&#125;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">footer</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"footer"</span>&gt;</span></div><div class="line">			联系方式，网站信息，copyright等</div><div class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">section</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"sidebar"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"qq"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">a</span> &gt;</span> QQ聊天咨询<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"totop"</span> 返回顶部&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></div><div class="line">&#123;% block custom_js %&#125;自定义js&#123;% endblock %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"> </div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
<h4 id="2、后端功能"><a href="#2、后端功能" class="headerlink" title="2、后端功能"></a>2、后端功能</h4><h5 id="访问上传文件静态资源"><a href="#访问上传文件静态资源" class="headerlink" title="访问上传文件静态资源"></a>访问上传文件静态资源</h5></li>
<li><p>文件上传路径配置</p>
<p>​<code>MEDIA_URL = &#39;/media/&#39;</code></p>
<p>​<code>MEDIA_ROOT = os.path.join(BASE_DIR, &#39;media&#39;)</code> 在项目根目录创建一个media文件夹，用来保存上传的资源。</p>
<p>​modeld对象course的image是ImageField，如何引用它呢？</p>
<p>​<code>image = models.ImageField(upload_to=&quot;course/%Y/%m&quot;, verbose_name=&quot;封面&quot;, max_length=100)</code></p>
<p>​从Image field返回图片url相对路径，需要补全 MEDIA_URL, 即<code>&lt;img src=&quot;&quot;&gt;</code></p>
</li>
<li><p>必须添加模板处理器，才能在html中使用MEDIA_URL变量。</p>
</li>
<li><p>url中配置静态文件访问路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  -----settings.py</span></div><div class="line">TEMPLATES = [&#123;</div><div class="line">    	<span class="comment"># ....</span></div><div class="line">        <span class="string">'OPTIONS'</span>: &#123;</div><div class="line">            <span class="string">'context_processors'</span>: [</div><div class="line">           <span class="comment"># 配置了这个之后，就会把最底下的  MEDIA_URL 注册到 html ，这样 html 就能用 MEDIA_URL 变量</span></div><div class="line">               <span class="string">'django.template.context_processors.media'</span>,</div><div class="line">            ],&#125;,&#125;,]</div><div class="line"></div><div class="line"><span class="comment"># ---- urls.py</span></div><div class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve <span class="comment">#处理静态文件</span></div><div class="line"><span class="keyword">from</span> .settings <span class="keyword">import</span> MEDIA_ROOT</div><div class="line"><span class="comment"># 配置上传文件的访问处理函数</span></div><div class="line">    url(<span class="string">r'^media/(?P&lt;path&gt;.*)$'</span>, serve, &#123;<span class="string">'document_root'</span>: MEDIA_ROOT&#125;),</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="实现内容分页"><a href="#实现内容分页" class="headerlink" title="实现内容分页"></a>实现内容分页</h5><p>第三方库 <a href="https://github.com/jamespacileo/django-pure-pagination/" target="_blank" rel="external">django-pure-pagination</a></p>
<ul>
<li><p>安装 <code>pip install django-pure-pagination</code></p>
</li>
<li><p>配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ----- settings.py</span></div><div class="line">INSTALLED_APPS = (</div><div class="line">    <span class="comment"># ...</span></div><div class="line">    <span class="string">'pure_pagination'</span>,</div><div class="line">)</div><div class="line"></div><div class="line">PAGINATION_SETTINGS = &#123;</div><div class="line">    <span class="string">'PAGE_RANGE_DISPLAYED'</span>: <span class="number">10</span>,</div><div class="line">    <span class="string">'MARGIN_PAGES_DISPLAYED'</span>: <span class="number">2</span>,</div><div class="line">    <span class="string">'SHOW_FIRST_PAGE_WHEN_INVALID'</span>: <span class="keyword">True</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>使用,参考官方文档</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># views.py</span></div><div class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</div><div class="line"><span class="keyword">from</span> pure_pagination <span class="keyword">import</span> Paginator, EmptyPage, PageNotAnInteger</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="comment"># 对课程进行分页</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        page = request.GET.get(<span class="string">'page'</span>, <span class="number">1</span>)</div><div class="line">    <span class="keyword">except</span> PageNotAnInteger:</div><div class="line">    	page = <span class="number">1</span></div><div class="line">    p = Paginator(all_courses, <span class="number">3</span>, request=request)</div><div class="line">    courses = p.page(page)</div><div class="line">    <span class="keyword">return</span> render(request, <span class="string">'course-list.html'</span>, &#123;</div><div class="line">                <span class="string">'all_courses'</span>: courses,</div><div class="line">                <span class="string">'sort'</span>: sort,</div><div class="line">                <span class="string">'hot_courses'</span>: hot_courses,</div><div class="line">    &#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>分页的url使用page.querystring，页面url会带上原来的请求参数，对查询结果分页会很方便</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 在html中引用 --&gt;</span></div><div class="line"><span class="comment">&lt;!-- 展示内容 --&gt;</span></div><div class="line">&#123;% raw %&#125;</div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"group_list"</span>&gt;</span></div><div class="line"> &#123;% for course in all_courses.object_list %&#125;</div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'course:course_detail' course.id %&#125;"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"s"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; MEDIA_URL &#125;&#125;&#123;&#123; course.image &#125;&#125;"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"des"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'course:course_detail' course.id %&#125;"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123; course.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">   &#123;% endfor %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 分页器 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pageturn"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagelist"</span>&gt;</span></div><div class="line">    &#123;% if all_courses.has_previous %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"long"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?&#123;&#123; all_courses.previous_page_number.querystring &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"prev"</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    &#123;% endif %&#125;</div><div class="line">    &#123;% for page in all_courses.pages %&#125;</div><div class="line">        &#123;% if page %&#125;</div><div class="line">        	&#123;% ifequal page all_courses.number %&#125;</div><div class="line">     <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?&#123;&#123; page.querystring &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"page"</span>&gt;</span>&#123;&#123; page &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">             &#123;% else %&#125;</div><div class="line">     <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?&#123;&#123; page.querystring &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"page"</span>&gt;</span>&#123;&#123; page &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">             &#123;% endifequal %&#125;</div><div class="line">         &#123;% else %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"none"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>...<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">        &#123;% endif %&#125;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">    &#123;% if all_courses.has_next %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"long"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?&#123;&#123; all_courses.next_page_number.querystring &#125;&#125;"</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    &#123;% endif %&#125;</div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  &#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="内容筛选-排序"><a href="#内容筛选-排序" class="headerlink" title="内容筛选 排序"></a>内容筛选 排序</h5><ul>
<li><p>根据url中的参数获取符合条件的objects，返回给前端，同时返回关键词，前端实现高亮选中某个类别的特效。</p>
</li>
<li><p>object有个字段object_id。</p>
</li>
<li><p>点击排序时，仍然保持前面的筛选条件，在排序url里加上筛选用到的参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># --- org/views.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrgView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line"><span class="string">    课程机构列表功能</span></div><div class="line"><span class="string">    """</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="comment"># 课程机构</span></div><div class="line">        all_orgs = CourseOrg.objects.all()</div><div class="line"></div><div class="line">        <span class="comment"># 提取热门机构</span></div><div class="line">        hot_orgs = all_orgs.order_by(<span class="string">"-click_nums"</span>)[:<span class="number">3</span>]</div><div class="line"></div><div class="line">        <span class="comment"># 城市</span></div><div class="line">        all_citys = CityDict.objects.all()</div><div class="line"></div><div class="line">        <span class="comment"># 机构搜索</span></div><div class="line">        serach_keywords = request.GET.get(<span class="string">'keywords'</span>, <span class="string">""</span>)</div><div class="line">        <span class="keyword">if</span> serach_keywords:</div><div class="line">            all_orgs = all_orgs.filter(</div><div class="line">                Q(name__icontains=serach_keywords) | Q(desc__icontains=serach_keywords))</div><div class="line"></div><div class="line">        <span class="comment"># 取出筛选城市</span></div><div class="line">        city_id = request.GET.get(<span class="string">'city'</span>, <span class="string">""</span>)</div><div class="line">        <span class="keyword">if</span> city_id:</div><div class="line">            <span class="comment"># 筛选出当前城市的结果集</span></div><div class="line">            all_orgs = all_orgs.filter(city_id=int(city_id))</div><div class="line"></div><div class="line">        <span class="comment"># 类别筛选</span></div><div class="line">        category = request.GET.get(<span class="string">'ct'</span>, <span class="string">""</span>)</div><div class="line">        <span class="keyword">if</span> category:</div><div class="line">            <span class="comment"># 筛选出当前城市的结果集</span></div><div class="line">            all_orgs = all_orgs.filter(category=category)</div><div class="line"></div><div class="line">        sort = request.GET.get(<span class="string">'sort'</span>, <span class="string">""</span>)</div><div class="line">        <span class="keyword">if</span> sort:</div><div class="line">            <span class="keyword">if</span> sort == <span class="string">"students"</span>:</div><div class="line">                all_orgs = all_orgs.order_by(<span class="string">"-students"</span>)</div><div class="line">            <span class="keyword">elif</span> sort == <span class="string">"courses"</span>:</div><div class="line">                all_orgs = all_orgs.order_by(<span class="string">"-courses_nums"</span>)</div><div class="line"></div><div class="line">        org_nums = all_orgs.count()</div><div class="line"></div><div class="line">        <span class="comment"># 对课程机构进行分页</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            page = request.GET.get(<span class="string">'page'</span>, <span class="number">1</span>)</div><div class="line">        <span class="keyword">except</span> PageNotAnInteger:</div><div class="line">            page = <span class="number">1</span></div><div class="line">            </div><div class="line">        p = Paginator(all_orgs, <span class="number">5</span>, request=request)</div><div class="line"></div><div class="line">        orgs = p.page(page)</div><div class="line"></div><div class="line">        current_nav = <span class="string">'org'</span></div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'org-list.html'</span>, &#123;</div><div class="line">            <span class="string">"all_orgs"</span>: orgs,</div><div class="line">            <span class="string">"all_citys"</span>: all_citys,</div><div class="line">            <span class="string">"org_nums"</span>: org_nums,</div><div class="line">            <span class="string">"city_id"</span>: city_id,</div><div class="line">            <span class="string">"category"</span>: category,</div><div class="line">            <span class="string">"hot_orgs"</span>: hot_orgs,</div><div class="line">            <span class="string">"sort"</span>: sort,</div><div class="line">            <span class="string">'current_nav'</span>: current_nav,</div><div class="line">        &#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>前端页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"&#123;% ifequal category '' %&#125;active2&#123;% endifequal %&#125;"</span>&gt;</span>&#123;% endraw %&#125;</div><div class="line"></div><div class="line">&#123;% raw %&#125;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"&#123;% ifequal city_id city.id|stringformat:"</span><span class="attr">i</span>" %&#125;<span class="attr">active2</span>&#123;% <span class="attr">endifequal</span> %&#125;"&gt;</span>&#123;% endraw %&#125; </div><div class="line">  int 转string的过滤器</div><div class="line">forloop.counter</div><div class="line">  </div><div class="line">  &#123;% raw %&#125;</div><div class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>机构类别<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"cont"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?city=&#123;&#123; city_id &#125;&#125;"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"&#123;% ifequal category '' %&#125;active2&#123;% endifequal %&#125;"</span>&gt;</span>全部<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </div><div class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?ct=pxjg&amp;city=&#123;&#123; city_id &#125;&#125;"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"&#123;% ifequal category 'pxjg' %&#125;active2&#123;% endifequal %&#125;"</span>&gt;</span>培训机构<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?ct=gx&amp;city=&#123;&#123; city_id &#125;&#125;"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"&#123;% ifequal category 'gx' %&#125;active2&#123;% endifequal %&#125;"</span>&gt;</span>高校<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">					</div><div class="line"> <span class="tag">&lt;<span class="name">h2</span>&gt;</span>所在地区<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"cont"</span>&gt;</span></div><div class="line">   &#123;% comment %&#125;当未做城市筛选的时候，"全部" 的状态为 active &#123;% endcomment %&#125;</div><div class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?ct=&#123;&#123; category &#125;&#125;"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"&#123;% ifequal city_id '' %&#125;active2&#123;% endifequal %&#125;"</span>&gt;</span>全部<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    &#123;% for city in all_citys %&#125;</div><div class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?city=&#123;&#123; city.id &#125;&#125;&amp;ct=&#123;&#123; category &#125;&#125;"</span>&gt;</span></div><div class="line">      &#123;% comment %&#125;通过 "|" 过滤器将 str 类型的 city.id 转换为 int 类型&#123;% endcomment %&#125;</div><div class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"&#123;% ifequal city_id city.id|stringformat:"</span><span class="attr">i</span>" %&#125;<span class="attr">active2</span>&#123;% <span class="attr">endifequal</span> %&#125;"&gt;</span>&#123;&#123; city &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">      &#123;% endfor %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">				</div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"all"</span>&gt;</span>共<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>&#123;&#123; org_nums &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>家<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"right companyrank layout"</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"head"</span>&gt;</span>授课机构排名<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  &#123;% for current_org in hot_orgs %&#125;</div><div class="line">  <span class="tag">&lt;<span class="name">dl</span> <span class="attr">class</span>=<span class="string">"des"</span>&gt;</span></div><div class="line">      &#123;% comment %&#125; forloop.counter 用于计数 &#123;% endcomment %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">dt</span> <span class="attr">class</span>=<span class="string">"num fl"</span>&gt;</span>&#123;&#123; forloop.counter &#125;&#125;<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">dd</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/company/2/"</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; current_org.name &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; current_org.address &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">dd</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></div><div class="line">  &#123;% endfor %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">&#123;% endraw %&#125;</div><div class="line">`forloop.counter`</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="ModelForm表单提交"><a href="#ModelForm表单提交" class="headerlink" title="ModelForm表单提交"></a>ModelForm表单提交</h5><p>ModelForm将定义好的model转换为form， </p>
<ul>
<li><p>指定要转换的model和要继承的字段</p>
</li>
<li><p>还可以新增自定义字段。</p>
</li>
<li><p>定义字段的验证方法，函数命名必须以clean_开头<code>clean_fieldName</code></p>
</li>
<li><p>该对象有save方法，是调用的model的save。即验证完表单可以直接save</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ----forms.py</span></div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</div><div class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserAsk</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAskForm</span><span class="params">(forms.ModelForm)</span>:</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = UserAsk</div><div class="line">        fields = [<span class="string">'name'</span>, <span class="string">'mobile'</span>, <span class="string">'course_name'</span>]</div><div class="line"></div><div class="line">    <span class="comment"># 使用 re 检验 mobile 是否合法</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_mobile</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 手机号验证，先取出mobile字段</span></div><div class="line">        mobile = self.cleaned_data[<span class="string">'mobile'</span>]</div><div class="line">        p = re.compile(<span class="string">'^0\d&#123;2,3&#125;\d&#123;7,8&#125;$|^1[358]\d&#123;9&#125;$|^147\d&#123;8&#125;'</span>)</div><div class="line">        <span class="keyword">if</span> p.match(mobile):</div><div class="line">            <span class="comment"># 这里还能返回外键</span></div><div class="line">            <span class="keyword">return</span> mobile</div><div class="line">        <span class="keyword">raise</span> forms.ValidationError(<span class="string">'手机号码格式不对'</span>, code=<span class="string">'mobile_inval'</span>)</div><div class="line">        </div><div class="line"> <span class="comment"># 普通的Form对象，要指定每个Feild的参数，和model定义重复且容易导致不一致</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAskForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    name = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">2</span>, max_length=<span class="number">20</span>)</div><div class="line">    phone = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">11</span>, max_length=<span class="number">11</span>)</div><div class="line">    course_name = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>, max_length=<span class="number">50</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>URL路由的namespace可以解决url命名冲突, 在模板中引用时， <code>% url &#39;namespace:url1&#39; %</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">url(<span class="string">r'^status/$'</span>, include(<span class="string">'status.urls'</span>), namespace=<span class="string">'status'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>在views中使用ModelForm</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddUserAskView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        user_ask_form = UserAskForm(request.POST)</div><div class="line">        res = dict()</div><div class="line">        <span class="keyword">if</span> user_ask_form.is_valid():</div><div class="line">            <span class="comment"># save方法的commit参数为True，则直接保存到数据库</span></div><div class="line">            user_ask_form.save(commit=<span class="keyword">True</span>)</div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'success'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'fail'</span></div><div class="line">            res[<span class="string">'msg'</span>] = <span class="string">'添加出错'</span></div><div class="line">        <span class="comment"># 返回的json字符串，前端使用的ajax异步请求。</span></div><div class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(res), content_type=<span class="string">'application/json'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>前端使用js向后端post数据</p>
</li>
<li><p>用户点击按钮后执行js代码</p>
</li>
<li><p>将form表单的数据序列化，作为data</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">  $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    $(<span class="string">'#jsStayBtn'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      $.ajax(&#123;</div><div class="line">        cache: <span class="literal">false</span>,</div><div class="line">        type: <span class="string">"POST"</span>,</div><div class="line">        dataType: <span class="string">"json"</span>,</div><div class="line">        url: <span class="string">"&#123;% url 'org:add_ask' %&#125;"</span>,</div><div class="line">        <span class="comment">//表单提交可以用 serialize 方法把 csrf token 一块序列化过来</span></div><div class="line">        data: $(<span class="string">'#jsStayForm'</span>).serialize(),</div><div class="line">        <span class="keyword">async</span>: <span class="literal">true</span>,</div><div class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">          <span class="keyword">if</span> (data.status == <span class="string">'success'</span>) &#123;</div><div class="line">            $(<span class="string">'#jsStayForm'</span>)[<span class="number">0</span>].reset();</div><div class="line">            alert(<span class="string">"提交成功"</span>)</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.status == <span class="string">'fail'</span>) &#123;</div><div class="line">            $(<span class="string">'#jsCompanyTips'</span>).html(data.msg)</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">//error: function(error) &#123;</span></div><div class="line">          <span class="comment">// console.log('error')</span></div><div class="line">          <span class="comment">// console.log(error.responseText.msg)</span></div><div class="line">        <span class="comment">//&#125;</span></div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;)</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="由外键获取数据"><a href="#由外键获取数据" class="headerlink" title="由外键获取数据"></a>由外键获取数据</h5><ul>
<li><p>mysql表的外键关联</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">c_org = Course_org.objects.get(id=c_id)</div><div class="line"><span class="comment"># Course_org对象的course是外键，链接到Course对象， </span></div><div class="line"><span class="comment"># django会自动根据外键为model对象创建一个属性course_set，</span></div><div class="line"><span class="comment"># 调用该属性会自动获得Course对象的objects实例</span></div><div class="line">all_course = c_org.course_set.all()</div><div class="line">all_teacher = c_org.teacher_set.all()[:<span class="number">3</span>]</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="实现收藏功能"><a href="#实现收藏功能" class="headerlink" title="实现收藏功能"></a>实现收藏功能</h5><ul>
<li><p>收藏课程、讲师，授课机构，models中有一个id字段表明收藏的类型</p>
</li>
<li><p>使用AJAX post数据，实现收藏和取消收藏</p>
</li>
<li><p>如果未登录，返回错误，并跳转到登录页面</p>
</li>
<li><p>如果已收藏，则再次点击取消</p>
</li>
<li><p>在js中csrf token 验证  <code></code></p>
</li>
<li><p>页面中传递一个值，来指明用户是否已经收藏</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ---- operatation/models.py</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavorite</span><span class="params">(models.Model)</span>:</span></div><div class="line">    user = models.ForeignKey(UserProfile, verbose_name=<span class="string">'用户'</span>)</div><div class="line">    <span class="comment"># ID 是课程 或者是 讲师、课程机构的 ID</span></div><div class="line">    fav_id = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">'收藏数据 Id'</span>)</div><div class="line">    fav_type = models.IntegerField(choices=((<span class="number">1</span>, <span class="string">'课程'</span>), (<span class="number">2</span>, <span class="string">'课程机构'</span>), (<span class="number">3</span>, <span class="string">'讲师'</span>)), default=<span class="number">1</span>, verbose_name=<span class="string">'收藏类型'</span>)</div><div class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">'添加时间'</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">'用户收藏'</span></div><div class="line">        verbose_name_plural = verbose_name</div><div class="line">        </div><div class="line"><span class="comment"># ---- organization/views.py</span></div><div class="line"><span class="comment"># 机构介绍页,判断用户是否已经收藏</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrgDescView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, org_id)</span>:</span></div><div class="line">        course_org = CourseOrg.objects.get(id=int(org_id))</div><div class="line">        current_page = <span class="string">"desc"</span>  <span class="comment"># 前端进行 selected 样式的</span></div><div class="line">        has_fav = <span class="keyword">False</span></div><div class="line">        <span class="keyword">if</span> request.user.is_authenticated():</div><div class="line">            <span class="keyword">if</span> UserFavorite.objects.filter(user=request.user, fav_id=course_org.id, fav_type=<span class="number">2</span>):</div><div class="line">                has_fav = <span class="keyword">True</span></div><div class="line">                </div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'org-detail-desc.html'</span>, &#123;</div><div class="line">            <span class="string">'course_org'</span>: course_org,</div><div class="line">            <span class="string">'current_page'</span>: current_page,</div><div class="line">            <span class="string">'has_fav'</span>: has_fav,</div><div class="line"></div><div class="line">        &#125;)</div><div class="line">    </div><div class="line"><span class="comment"># 用户收藏，用户取消收藏</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddFavView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="comment"># 用户收藏、取消收藏 课程机构</span></div><div class="line">    <span class="comment"># def set_fav_nums(self, fav_type, fav_id, num=1):</span></div><div class="line">    <span class="comment">#     if fav_type == 1:</span></div><div class="line">    <span class="comment">#         course = Course.objects.get(id=fav_id)</span></div><div class="line">    <span class="comment">#         course.fav_nums += num</span></div><div class="line">    <span class="comment">#         course.save()</span></div><div class="line">    <span class="comment">#     elif fav_type == 2:</span></div><div class="line">    <span class="comment">#         course_org = CourseOrg.objects.get(id=fav_id)</span></div><div class="line">    <span class="comment">#         course_org.fav_nums += num</span></div><div class="line">    <span class="comment">#         course_org.save()</span></div><div class="line">    <span class="comment">#     elif fav_type == 3:</span></div><div class="line">    <span class="comment">#         teacher = Teacher.objects.get(id=fav_id)</span></div><div class="line">    <span class="comment">#         teacher.fav_nums += num</span></div><div class="line">    <span class="comment">#         teacher.save()</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        fav_id = int(request.POST.get(<span class="string">'fav_id'</span>, <span class="number">0</span>))</div><div class="line">        fav_type = int(request.POST.get(<span class="string">'fav_type'</span>, <span class="number">0</span>))</div><div class="line">        res = dict()</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.user.is_authenticated():</div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'fail'</span></div><div class="line">            res[<span class="string">'msg'</span>] = <span class="string">'用户未登录'</span></div><div class="line">            <span class="keyword">return</span> HttpResponse(json.dumps(res), content_type=<span class="string">'application/json'</span>)</div><div class="line">        <span class="comment"># 查询收藏记录</span></div><div class="line">        exist_records = UserFavorite.objects.filter(user=request.user, fav_id=fav_id, fav_type=fav_type)</div><div class="line">        <span class="keyword">if</span> exist_records:</div><div class="line">            exist_records.delete()</div><div class="line">            <span class="keyword">if</span> int(fav_type) == <span class="number">1</span>:</div><div class="line">                course = Course.objects.get(id=int(fav_id))</div><div class="line">                course.fav_nums -= <span class="number">1</span></div><div class="line">                <span class="keyword">if</span> course.fav_nums &lt; <span class="number">0</span>:</div><div class="line">                    course.fav_nums = <span class="number">0</span></div><div class="line">                course.save()</div><div class="line"></div><div class="line">            <span class="keyword">elif</span> int(fav_type) == <span class="number">2</span>:</div><div class="line">                course_org = CourseOrg.objects.get(id=int(fav_id))</div><div class="line">                course_org.fav_nums -= <span class="number">1</span></div><div class="line">                <span class="keyword">if</span> course_org.fav_nums &lt; <span class="number">0</span>:</div><div class="line">                    course_org.fav_nums = <span class="number">0</span></div><div class="line">                course_org.save()</div><div class="line"></div><div class="line">            <span class="keyword">elif</span> int(fav_type) == <span class="number">3</span>:</div><div class="line">                teacher = Teacher.objects.get(id=int(fav_id))</div><div class="line">                teacher.fav_nums -= <span class="number">1</span></div><div class="line">                <span class="keyword">if</span> teacher.fav_nums &lt; <span class="number">0</span>:</div><div class="line">                    teacher.fav_nums = <span class="number">0</span></div><div class="line">                teacher.save()</div><div class="line"></div><div class="line">            <span class="comment"># self.set_fav_nums(fav_type, fav_id, -1)</span></div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'success'</span></div><div class="line">            res[<span class="string">'msg'</span>] = <span class="string">'收藏'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            user_fav = UserFavorite()</div><div class="line">            <span class="keyword">if</span> fav_id <span class="keyword">and</span> fav_type:</div><div class="line">                user_fav.user = request.user</div><div class="line">                user_fav.fav_id = fav_id</div><div class="line">                user_fav.fav_type = fav_type</div><div class="line">                user_fav.save()</div><div class="line"></div><div class="line">                <span class="keyword">if</span> int(fav_type) == <span class="number">1</span>:</div><div class="line">                    course = Course.objects.get(id=int(fav_id))</div><div class="line">                    course.fav_nums += <span class="number">1</span></div><div class="line">                    course.save()</div><div class="line">                <span class="keyword">elif</span> int(fav_type) == <span class="number">2</span>:</div><div class="line">                    course_org = CourseOrg.objects.get(id=int(fav_id))</div><div class="line">                    course_org.fav_nums += <span class="number">1</span></div><div class="line">                    course_org.save()</div><div class="line">                <span class="keyword">elif</span> int(fav_type) == <span class="number">3</span>:</div><div class="line">                    teacher = Teacher.objects.get(id=int(fav_id))</div><div class="line">                    teacher.fav_nums += <span class="number">1</span></div><div class="line">                    teacher.save()</div><div class="line"></div><div class="line">                <span class="comment"># self.set_fav_nums(fav_type, fav_id, 1)</span></div><div class="line">                res[<span class="string">'status'</span>] = <span class="string">'success'</span></div><div class="line">                res[<span class="string">'msg'</span>] = <span class="string">'已收藏'</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                res[<span class="string">'status'</span>] = <span class="string">'fail'</span></div><div class="line">                res[<span class="string">'msg'</span>] = <span class="string">'收藏出错'</span></div><div class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(res), content_type=<span class="string">'application/json'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>前端用AJAX post数据，如果返回用户未登录，则跳转到登录界面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//收藏分享</span></div><div class="line">&#123;% raw %&#125;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add_fav</span>(<span class="params">current_elem, fav_id, fav_type</span>) </span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">      cache: <span class="literal">false</span>,</div><div class="line">      type: <span class="string">"POST"</span>,</div><div class="line">      url: <span class="string">"&#123;% url 'org:add_fav' %&#125;"</span>,</div><div class="line">      data: &#123;<span class="attr">fav_id</span>: fav_id, <span class="attr">fav_type</span>: fav_type&#125;,</div><div class="line">      <span class="keyword">async</span>: <span class="literal">true</span>,</div><div class="line">      beforeSend: <span class="function"><span class="keyword">function</span> (<span class="params">xhr, settings</span>) </span>&#123;</div><div class="line">        xhr.setRequestHeader(<span class="string">"X-CSRFToken"</span>, <span class="string">"&#123;&#123; csrf_token &#125;&#125;"</span>);</div><div class="line">      &#125;,</div><div class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (data.status == <span class="string">'fail'</span>) &#123;</div><div class="line">          <span class="keyword">if</span> (data.msg == <span class="string">'用户未登录'</span>) &#123;</div><div class="line">            alert(<span class="string">'用户未登录'</span>)</div><div class="line">            <span class="built_in">window</span>.location.href = <span class="string">"/login/"</span>;</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            alert(data.msg)</div><div class="line">          &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.status == <span class="string">'success'</span>) &#123;</div><div class="line">          current_elem.text(data.msg)</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      error: <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</div><div class="line">        alert(<span class="string">'ajax 请求失败！'</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">$(<span class="string">'.collectionbtn'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// this, fav_id,  fav_type (课程机构对应的 fav_type 是 2)</span></div><div class="line">    add_fav($(<span class="keyword">this</span>), &#123;&#123; course_org.id &#125;&#125;, <span class="number">2</span>);</div><div class="line">  &#125;);</div><div class="line"> </div><div class="line"> &#123;%endraw%&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>html中显示收藏</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># org_base,html</div><div class="line">&#123;% raw %&#125;</div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn fr collectionbtn  notlogin"</span> <span class="attr">data-favid</span>=<span class="string">"22"</span> <span class="attr">data-fav-type</span>=<span class="string">"1"</span> &gt;</span></div><div class="line">    &#123;% if has_fav %&#125;已收藏&#123;% else %&#125;收藏&#123;% endif %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">&#123;% endraw%&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="前端功能-Course-APP"><a href="#前端功能-Course-APP" class="headerlink" title="前端功能 Course APP"></a>前端功能 Course APP</h3><h4 id="1、课程列表"><a href="#1、课程列表" class="headerlink" title="1、课程列表"></a>1、课程列表</h4><ul>
<li><p>分页</p>
</li>
<li><p>排序，前端页面 selected 样式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 课程列表页</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseListView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">        all_courses = Course.objects.all().order_by(<span class="string">"-add_time"</span>)</div><div class="line">        <span class="comment"># 热门课程推荐</span></div><div class="line">        hot_courses = Course.objects.all().order_by(<span class="string">"-click_nums"</span>)[:<span class="number">3</span>]</div><div class="line"></div><div class="line">        <span class="comment"># 课程搜索</span></div><div class="line">        serach_keywords = request.GET.get(<span class="string">'keywords'</span>, <span class="string">""</span>)</div><div class="line">        <span class="keyword">if</span> serach_keywords:</div><div class="line">            all_courses = all_courses.filter(Q(name__icontains=serach_keywords) | Q(desc__icontains=serach_keywords) | Q(detail__icontains=serach_keywords))</div><div class="line"></div><div class="line">        <span class="comment"># 课程排序</span></div><div class="line">        sort = request.GET.get(<span class="string">'sort'</span>, <span class="string">""</span>)</div><div class="line">        <span class="keyword">if</span> sort:</div><div class="line">            <span class="keyword">if</span> sort == <span class="string">"students"</span>:</div><div class="line">                all_courses = all_courses.order_by(<span class="string">"-students"</span>)</div><div class="line">            <span class="keyword">elif</span> sort == <span class="string">"hot"</span>:</div><div class="line">                all_courses = all_courses.order_by(<span class="string">"-click_nums"</span>)</div><div class="line"></div><div class="line">        <span class="comment"># 对课程进行分页</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            page = request.GET.get(<span class="string">'page'</span>, <span class="number">1</span>)</div><div class="line">        <span class="keyword">except</span> PageNotAnInteger:</div><div class="line">            page = <span class="number">1</span></div><div class="line"></div><div class="line">        p = Paginator(all_courses, <span class="number">3</span>, request=request)</div><div class="line"></div><div class="line">        courses = p.page(page)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'course-list.html'</span>, &#123;</div><div class="line">            <span class="string">'all_courses'</span>: courses,</div><div class="line">            <span class="string">'sort'</span>: sort,</div><div class="line">            <span class="string">'hot_courses'</span>: hot_courses,</div><div class="line"></div><div class="line">        &#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>models 的Field是choice的，前端如何引用变量？ <code>obj.get_FieldName_display</code>，通过外键访问obj也可以。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ----- models.py</span></div><div class="line"><span class="comment"># cj是数据库存储的值， “初级”用于显示的可读名</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(models.Model)</span>:</span></div><div class="line">    degree = models.CharField(verbose_name=<span class="string">"课程难度"</span>, choices=((<span class="string">"cj"</span>, <span class="string">"初级"</span>), (<span class="string">"zj"</span>, <span class="string">"中级"</span>), (<span class="string">"gj"</span>, <span class="string">"高级"</span>)), max_length=<span class="number">2</span>)</div><div class="line">    </div><div class="line"><span class="comment"># ---- index.html</span></div><div class="line">&#123;&#123; my_course.get_degree_display &#125;&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2、课程详情"><a href="#2、课程详情" class="headerlink" title="2、课程详情"></a>2、课程详情</h4><ul>
<li><p>前端直接调用model对象的方法</p>
<p>Django的模板语法支持在前端html中使用model_obj.func，但是不能加括号和参数</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ----- models.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestModel</span><span class="params">(models.Model)</span>:</span></div><div class="line">    <span class="comment">#...</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        <span class="comment"># ...</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_nums</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="number">100</span></div><div class="line">    </div><div class="line"><span class="comment"># ------ html页面</span></div><div class="line">  &#123;&#123; testmodel.get_nums&#125;&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>点击链接数</p>
<p>当访问某个链接时，对应的view函数中，对应的model object中的click计数器加1</p>
</li>
</ul>
<h4 id="3、评论"><a href="#3、评论" class="headerlink" title="3、评论"></a>3、评论</h4><ul>
<li><p>ajax 发表评论，成功后刷新页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 用户添加课程评论</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddCommentView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="comment"># 判断用户登录状态</span></div><div class="line">        res = dict()</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.user.is_authenticated():</div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'fail'</span></div><div class="line">            res[<span class="string">'msg'</span>] = <span class="string">u'用户未登录'</span></div><div class="line">            <span class="keyword">return</span> HttpResponse(json.dumps(res), content_type=<span class="string">'application/json'</span>)</div><div class="line"></div><div class="line">        course_id = int(request.POST.get(<span class="string">'course_id'</span>, <span class="number">0</span>))</div><div class="line">        comments = request.POST.get(<span class="string">'comments'</span>, <span class="string">''</span>)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> course_id <span class="keyword">and</span> comments:</div><div class="line">            course_comments = CourseComments()</div><div class="line">            course_comments.course = Course.objects.get(id=course_id)</div><div class="line">            course_comments.comments = comments</div><div class="line">            course_comments.user = request.user</div><div class="line">            course_comments.save()</div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'success'</span></div><div class="line">            res[<span class="string">'msg'</span>] = <span class="string">u'添加成功'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'fail'</span></div><div class="line">            res[<span class="string">'msg'</span>] = <span class="string">u'添加失败'</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(res), content_type=<span class="string">'application/json'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>js代码</p>
<p>如果评论内容为空，弹窗警告。如果未登录，跳转登录。如果成功了，则刷新当前页面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125;</div><div class="line">&lt;script&gt;</div><div class="line">//添加评论</div><div class="line">$(<span class="string">'#js-pl-submit'</span>).on(<span class="string">'click'</span>, function () &#123;</div><div class="line">    var comments = $(<span class="string">"#js-pl-textarea"</span>).val()</div><div class="line">    <span class="keyword">if</span> (comments == <span class="string">""</span>) &#123;</div><div class="line">        alert(<span class="string">"评论不能为空"</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    $.ajax(&#123;</div><div class="line">        cache: false,</div><div class="line">        type: <span class="string">"POST"</span>,</div><div class="line">        url: <span class="string">"&#123;% url 'course:add_comment' %&#125;"</span>,</div><div class="line">        data: &#123;course_id: &#123;&#123; course.id &#125;&#125;, comments: comments&#125;,</div><div class="line">        <span class="keyword">async</span>: true,</div><div class="line">        beforeSend: function (xhr, settings) &#123;</div><div class="line">            xhr.setRequestHeader(<span class="string">"X-CSRFToken"</span>, <span class="string">"&#123;&#123; csrf_token &#125;&#125;"</span>);</div><div class="line">        &#125;,</div><div class="line">        success: function (data) &#123;</div><div class="line">            <span class="keyword">if</span> (data.status == <span class="string">'fail'</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (data.msg == <span class="string">'用户未登录'</span>) &#123;</div><div class="line">                  window.location.href = <span class="string">"&#123;% url 'login' %&#125;"</span>;</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  alert(data.msg)</div><div class="line">              &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.status == <span class="string">'success'</span>) &#123;</div><div class="line">                alert(<span class="string">'评论成功！'</span>)</div><div class="line">                window.location.reload();//刷新当前页面.</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        error: function(error) &#123;</div><div class="line">          alert(<span class="string">'ajax 失败!'</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line">&lt;/script&gt;</div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>HTML页面</p>
<p>最前面是输入框和评论按钮，下面是评论列表。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125; </div><div class="line"><span class="comment">&lt;!--发布评论--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"js-pub-container"</span> <span class="attr">class</span>=<span class="string">"issques clearfix js-form"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wgt-ipt-wrap pub-editor-wrap "</span> <span class="attr">id</span>=<span class="string">"js-pl-input-fake"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"js-pl-textarea"</span> <span class="attr">class</span>=<span class="string">""</span> <span class="attr">placeholder</span>=<span class="string">"扯淡、吐槽、表扬、鼓励……想说啥就说啥！"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"js-pl-submit"</span> <span class="attr">class</span>=<span class="string">"pub-btn"</span> <span class="attr">data-cid</span>=<span class="string">"452"</span> <span class="attr">value</span>=<span class="string">"发表评论"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"global-errortip js-global-error"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"course_note"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"mod-post"</span> <span class="attr">id</span>=<span class="string">"comment-list"</span>&gt;</span></div><div class="line">    &#123;% for user_comment in all_comments %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"post-row"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"media"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">'&#123;&#123; MEDIA_URL &#125;&#125;&#123;&#123; user_comment.user.image &#125;&#125;'</span> <span class="attr">width</span>=<span class="string">'40'</span> <span class="attr">height</span>=<span class="string">'40'</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"bd"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tit"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span>&#123;&#123; user_comment.user.nick_name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"cnt"</span>&gt;</span>&#123;&#123; user_comment.comments &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"footer clearfix"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">title</span>=<span class="string">"创建时间"</span> <span class="attr">class</span>=<span class="string">"l timeago"</span>&gt;</span>&#123;&#123; user_comment.add_time &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    &#123;% endfor %&#125;</div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4、资源下载"><a href="#4、资源下载" class="headerlink" title="4、资源下载"></a>4、资源下载</h4><ul>
<li><p>将model.FileField的url添加到前端模板即可。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125;</div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box mb40"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">h4</span>&gt;</span>资料下载<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"downlist"</span>&gt;</span></div><div class="line">    &#123;% for course_resource in course_resources %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">span</span> &gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"aui-iconfont aui-icon-file"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>&amp;nbsp;&amp;nbsp;&#123;&#123; course_resource.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; MEDIA_URL &#125;&#125;&#123;&#123; course_resource.download &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"downcode"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">download</span>=<span class="string">""</span> <span class="attr">data-id</span>=<span class="string">"274"</span> <span class="attr">title</span>=<span class="string">""</span>&gt;</span>下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    &#123;% endfor %&#125;</div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5、用户购买推荐"><a href="#5、用户购买推荐" class="headerlink" title="5、用户购买推荐"></a>5、用户购买推荐</h4><p>根据某个课程，推荐学过该课程的同学还学过的课程。</p>
<p><code>1-course_id -&gt;  1-Course -&gt;  n-UserCourse -&gt; n-User -&gt; m-UserCourse</code></p>
<ul>
<li><p>首先由course_id获取课程Course</p>
</li>
<li><p>然后获取所有的学习课程关系对象UserCourse</p>
</li>
<li><p>UserCourse拿到所有的User的id， 接着拿到所有的UserCousre</p>
</li>
<li><p>然后所有的Course id， 取相关度最高的n个课程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># User——Course关联</span></div><div class="line"><span class="comment"># -----courses/views.py</span></div><div class="line"><span class="comment"># 当用户参加课程时，查询UserCourse对象是否存在，不存在则添加并保存</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserStudy</span><span class="params">(LoginRequiredMixin, View)</span>:</span>  <span class="comment"># 实现了登录验证</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(request)</span>:</span></div><div class="line">         <span class="comment"># 查询用户是否已经关联了该课程</span></div><div class="line">        user_courses = UserCourse.objects.filter(user=request.user, course=course)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_courses:</div><div class="line">            user_course = UserCourse(user=request.user, course=course)</div><div class="line">            user_course.save()</div><div class="line">        </div><div class="line">        <span class="comment"># 1个用户1个课程 - 该课程下所有用户的所有课程</span></div><div class="line">        user_courses = UserCourse.objects.filter(course=course)</div><div class="line">        user_ids = [user_course.user.id <span class="keyword">for</span> user_course <span class="keyword">in</span> user_courses]</div><div class="line">        all_user_courses = UserCourse.objects.filter(user_id__in=user_ids)</div><div class="line">        <span class="comment"># 取出所有课程 id</span></div><div class="line">        course_ids = [user_course.course.id <span class="keyword">for</span> user_course <span class="keyword">in</span> all_user_courses]</div><div class="line">        <span class="comment"># 获取学过该课程用户，学过其他所有课程的前五名</span></div><div class="line">        relate_courses = Course.objects.filter(id__in=course_ids).order_by(<span class="string">"-click_nums"</span>)[:<span class="number">5</span>]</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="6、视频播放"><a href="#6、视频播放" class="headerlink" title="6、视频播放"></a>6、视频播放</h4><ul>
<li><p>使用video.js 播放插件，视频使用七牛云存储。首先导入js和css文件。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:950px;height:675px; margin-left: 340px"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">"example_video_1"</span> <span class="attr">class</span>=<span class="string">"video-js vjs-default-skin"</span> <span class="attr">controls</span> <span class="attr">preload</span>=<span class="string">"none"</span> <span class="attr">width</span>=<span class="string">"1200"</span></span></div><div class="line"><span class="tag">           <span class="attr">poster</span>=<span class="string">"http://video-js.zencoder.com/oceans-clip.png"</span></span></div><div class="line"><span class="tag">           <span class="attr">data-setup</span>=<span class="string">"&#123;&#125;"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">"http://video.mp4"</span> <span class="attr">type</span>=<span class="string">'video/mp4'</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="前端功能-Teacher-APP"><a href="#前端功能-Teacher-APP" class="headerlink" title="前端功能 Teacher APP"></a>前端功能 Teacher APP</h3><ul>
<li>讲师列表页 （分页，排序）</li>
<li>讲师的个人信息</li>
<li>讲师所属的机构信息</li>
<li>讲师课程</li>
<li>讲师受欢迎排行榜</li>
<li>收藏和取消收藏</li>
</ul>
<h3 id="前端功能-搜索"><a href="#前端功能-搜索" class="headerlink" title="前端功能 搜索"></a>前端功能 搜索</h3><p>搜索 课程 公开课 或讲师。</p>
<p><strong>选中状态的实现</strong></p>
<ul>
<li><p>一种是view传递一个标识参数，来表明当前页面哪个tag被选中，前端页面在该tag的class中使用if判断。</p>
</li>
<li><p>另一种 直接在前端中使用 request.path，即url中的某些特性来实现高亮</p>
<p>request.path是不含域名的相对路径</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> request.path|slice: <span class="string">'7'</span> == <span class="string">'/course'</span></div></pre></td></tr></table></figure>
</li>
<li><p>搜索使用search_keywords实现，然后使用<code>model.objects.filter(name__icontains=search_keywords)</code> icontains包含字符，不区分字符串。使用Q实现多条件查询。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 课程搜索</span></div><div class="line">serach_keywords = request.GET.get(<span class="string">'keywords'</span>, <span class="string">""</span>)</div><div class="line"><span class="keyword">if</span> serach_keywords:</div><div class="line">    all_courses = all_courses.filter(Q(name__icontains=serach_keywords) | Q(desc__icontains=serach_keywords) | Q(detail__icontains=serach_keywords))</div></pre></td></tr></table></figure>
</li>
<li><p>前端JS实现点击按钮发起搜索</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//顶部搜索栏搜索方法</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">search_click</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> type = $(<span class="string">'#jsSelectOption'</span>).attr(<span class="string">'data-value'</span>),</div><div class="line">        keywords = $(<span class="string">'#search_keywords'</span>).val(),</div><div class="line">        request_url = <span class="string">''</span>;</div><div class="line">    <span class="keyword">if</span>(keywords == <span class="string">""</span>)&#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(type == <span class="string">"course"</span>)&#123;</div><div class="line">        request_url = <span class="string">"/course/list?keywords="</span>+keywords</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">"teacher"</span>)&#123;</div><div class="line">        request_url = <span class="string">"/org/teacher/list?keywords="</span>+keywords</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">"org"</span>)&#123;</div><div class="line">        request_url = <span class="string">"/org/list?keywords="</span>+keywords</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">window</span>.location.href = request_url</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="前端功能-个人中心"><a href="#前端功能-个人中心" class="headerlink" title="前端功能 个人中心"></a>前端功能 个人中心</h3><ul>
<li><p>个人资料，我的课程，我的收藏，我的消息</p>
</li>
<li><p>个人资料修改邮箱要验证</p>
<p>过滤器 <code>user.phone|default_if_none: &#39;无号码&#39;</code></p>
</li>
<li><p>头像上传</p>
</li>
<li><p>修改密码</p>
</li>
</ul>
<h4 id="1、修改头像"><a href="#1、修改头像" class="headerlink" title="1、修改头像"></a>1、修改头像</h4><ul>
<li><p>配置图片上传的URL，实现一个保存图片的View，使用含ImageField的Form来保存图片。</p>
</li>
<li><p>request.FILES必须指明，instance为ModelForm对象绑定model实例，就可以用save方法修改对应的model实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ----- users/urls.py</span></div><div class="line"><span class="comment"># 用户头像修改</span></div><div class="line">    url(<span class="string">r'^image/upload/$'</span>, UploadImageView.as_view(), name=<span class="string">'image_upload'</span>),</div><div class="line"></div><div class="line"><span class="comment"># ----- users/forms.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadImageForm</span><span class="params">(forms.ModelForm)</span>:</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = UserProfile</div><div class="line">        fields = [<span class="string">'image'</span>, ]</div><div class="line">        </div><div class="line"><span class="comment"># ------ users/views.py</span></div><div class="line"><span class="comment"># 用户修改头像</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadImageView</span><span class="params">(LoginRequiredMixin, View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        image_form = UploadImageForm(request.POST, request.FILES, instance=request.user)</div><div class="line">        res = dict()</div><div class="line">        <span class="keyword">if</span> image_form.is_valid():</div><div class="line">            image_form.save()</div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'success'</span></div><div class="line">            <span class="comment"># image = image_form.cleaned_data['image']</span></div><div class="line">            <span class="comment"># request.user.image = image</span></div><div class="line">            <span class="comment"># request.user.save()</span></div><div class="line">            <span class="comment"># pass</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            res[<span class="string">'status'</span>] = <span class="string">'fail'</span></div><div class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(res), content_type=<span class="string">'application/json'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>前端页面,注意<code>&lt; form enctype=&quot;multipart/form-data&quot;&gt;</code>，和<code>&lt;input type=&quot;file&quot; name=&quot;image&quot; /&gt;</code>  </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125;</div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"clearfix"</span> <span class="attr">id</span>=<span class="string">"jsAvatarForm"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span> <span class="attr">autocomplete</span>=<span class="string">"off"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"&#123;% url 'users:image_upload' %&#125;"</span> <span class="attr">target</span>=<span class="string">'frameFile'</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"changearea"</span> <span class="attr">for</span>=<span class="string">"avatarUp"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"avatardiv"</span> <span class="attr">class</span>=<span class="string">"pic"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">class</span>=<span class="string">"js-img-show"</span> <span class="attr">id</span>=<span class="string">"avatarShow"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; MEDIA_URL &#125;&#125;&#123;&#123; request.user.image &#125;&#125;"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"fl upload-inp-box"</span> <span class="attr">style</span>=<span class="string">"margin-left:70px;"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"button btn-green btn-w100"</span> <span class="attr">id</span>=<span class="string">"jsAvatarBtn"</span>&gt;</span>修改头像<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"image"</span> <span class="attr">id</span>=<span class="string">"avatarUp"</span> <span class="attr">class</span>=<span class="string">"js-img-up"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">  &#123;% csrf_token %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2、修改密码"><a href="#2、修改密码" class="headerlink" title="2、修改密码"></a>2、修改密码</h4><ul>
<li><p>用户已经登录，从request.user获取用户信息，使用ajax提交修改请求。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">//个人资料修改密码</span></div><div class="line">    $(<span class="string">'#jsUserResetPwd'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        Dml.fun.showDialog(<span class="string">'#jsResetDialog'</span>, <span class="string">'#jsResetPwdTips'</span>);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    $(<span class="string">'#jsResetPwdBtn'</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        $.ajax(&#123;</div><div class="line">            cache: <span class="literal">false</span>,</div><div class="line">            type: <span class="string">"POST"</span>,</div><div class="line">            dataType:<span class="string">'json'</span>,</div><div class="line">            url:<span class="string">"/users/update/pwd/"</span>,</div><div class="line">            data:$(<span class="string">'#jsResetPwdForm'</span>).serialize(),</div><div class="line">            <span class="keyword">async</span>: <span class="literal">true</span>,</div><div class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span>(data.password1)&#123;</div><div class="line">                    Dml.fun.showValidateError($(<span class="string">"#pwd"</span>), data.password1);</div><div class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.password2)&#123;</div><div class="line">                    Dml.fun.showValidateError($(<span class="string">"#repwd"</span>), data.password2);</div><div class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.status == <span class="string">"success"</span>)&#123;</div><div class="line">                    Dml.fun.showTipsDialog(&#123;</div><div class="line">                        title:<span class="string">'提交成功'</span>,</div><div class="line">                        h2:<span class="string">'修改密码成功，请重新登录!'</span>,</div><div class="line">                    &#125;);</div><div class="line">                    Dml.fun.winReload();</div><div class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.msg)&#123;</div><div class="line">                    Dml.fun.showValidateError($(<span class="string">"#pwd"</span>), data.msg);</div><div class="line">                    Dml.fun.showValidateError($(<span class="string">"#repwd"</span>), data.msg);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3、修改邮箱"><a href="#3、修改邮箱" class="headerlink" title="3、修改邮箱"></a>3、修改邮箱</h4><p>用户提交新邮箱，后台向新邮箱发送验证码，用户填写验证码，更新邮箱成功或失败</p>
<ul>
<li><p>发送邮箱验证码的接口</p>
<p>如果邮箱已被注册，提示用户。发送的验证码会保存到数据库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 发送邮箱验证码</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendEmailCodeView</span><span class="params">(LoginRequiredMixin, View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">        email = request.GET.get(<span class="string">'email'</span>, <span class="string">''</span>)</div><div class="line"></div><div class="line">        res = dict()</div><div class="line">        <span class="keyword">if</span> UserProfile.objects.filter(email=email):</div><div class="line">            res[<span class="string">'email'</span>] = <span class="string">'邮箱已注册'</span></div><div class="line">            <span class="keyword">return</span> HttpResponse(json.dumps(res), content_type=<span class="string">'application/json'</span>)</div><div class="line">        send_register_email(email, <span class="string">'update_email'</span>)</div><div class="line">        res[<span class="string">'status'</span>] = <span class="string">'success'</span></div><div class="line">        res[<span class="string">'email'</span>] = <span class="string">'发送验证码成功'</span></div><div class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(res), content_type=<span class="string">'application/json'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>更新邮件的前端模块</p>
<p>js代码，csrf_token在html的form中设置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//修改个人中心邮箱验证码</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendCodeChangeEmail</span>(<span class="params">$btn</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> verify = verifyDialogSubmit(</div><div class="line">        [</div><div class="line">          &#123;<span class="attr">id</span>: <span class="string">'#jsChangeEmail'</span>, <span class="attr">tips</span>: Dml.Msg.epMail, <span class="attr">errorTips</span>: Dml.Msg.erMail, <span class="attr">regName</span>: <span class="string">'email'</span>, <span class="attr">require</span>: <span class="literal">true</span>&#125;</div><div class="line">        ]</div><div class="line">    );</div><div class="line">    <span class="keyword">if</span>(!verify)&#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    $.ajax(&#123;</div><div class="line">        cache: <span class="literal">false</span>,</div><div class="line">        type: <span class="string">"get"</span>,</div><div class="line">        dataType:<span class="string">'json'</span>,</div><div class="line">        url:<span class="string">"/users/sendemail_code/"</span>,</div><div class="line">        data:$(<span class="string">'#jsChangeEmailForm'</span>).serialize(),</div><div class="line">        <span class="keyword">async</span>: <span class="literal">true</span>,</div><div class="line">        beforeSend:<span class="function"><span class="keyword">function</span>(<span class="params">XMLHttpRequest</span>)</span>&#123;</div><div class="line">            $btn.val(<span class="string">"发送中..."</span>);</div><div class="line">            $btn.attr(<span class="string">'disabled'</span>,<span class="literal">true</span>);</div><div class="line">        &#125;,</div><div class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(data.email)&#123;</div><div class="line">                Dml.fun.showValidateError($(<span class="string">'#jsChangeEmail'</span>), data.email);</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.status == <span class="string">'success'</span>)&#123;</div><div class="line">                Dml.fun.showErrorTips($(<span class="string">'#jsChangeEmailTips'</span>), <span class="string">"邮箱验证码已发送"</span>);</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.status == <span class="string">'failure'</span>)&#123;</div><div class="line">                 Dml.fun.showValidateError($(<span class="string">'#jsChangeEmail'</span>), <span class="string">"邮箱验证码发送失败"</span>);</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.status == <span class="string">'success'</span>)&#123;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        complete: <span class="function"><span class="keyword">function</span>(<span class="params">XMLHttpRequest</span>)</span>&#123;</div><div class="line">            $btn.val(<span class="string">"获取验证码"</span>);</div><div class="line">            $btn.removeAttr(<span class="string">"disabled"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>判断验证码是否正确</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 修改个人邮箱</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateEmailView</span><span class="params">(LoginRequiredMixin, View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        email = request.POST.get(<span class="string">'email'</span>, <span class="string">''</span>)</div><div class="line">        code = request.POST.get(<span class="string">'code'</span>, <span class="string">''</span>)</div><div class="line"></div><div class="line">        existed_records = EmailVerifyRecord.objects.filter(email=email, code=code, send_type=<span class="string">'update_email'</span>)</div><div class="line">        <span class="keyword">if</span> existed_records:</div><div class="line">            user = request.user</div><div class="line">            user.email = email</div><div class="line">            user.save()</div><div class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status":"success"&#125;'</span>, content_type=<span class="string">'application/json'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"email":"验证码出错"&#125;'</span>, content_type=<span class="string">'application/json'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>JS post提交验证码和邮箱</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//个人资料邮箱修改</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">changeEmailSubmit</span>(<span class="params">$btn</span>)</span>&#123;</div><div class="line"><span class="keyword">var</span> verify = verifyDialogSubmit(</div><div class="line">        [</div><div class="line">          &#123;<span class="attr">id</span>: <span class="string">'#jsChangeEmail'</span>, <span class="attr">tips</span>: Dml.Msg.epMail, <span class="attr">errorTips</span>: Dml.Msg.erMail, <span class="attr">regName</span>: <span class="string">'email'</span>, <span class="attr">require</span>: <span class="literal">true</span>&#125;,</div><div class="line">        ]</div><div class="line">    );</div><div class="line">    <span class="keyword">if</span>(!verify)&#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    $.ajax(&#123;</div><div class="line">        cache: <span class="literal">false</span>,</div><div class="line">        type: <span class="string">'post'</span>,</div><div class="line">        dataType:<span class="string">'json'</span>,</div><div class="line">        url:<span class="string">"/users/update_email/ "</span>,</div><div class="line">        data:$(<span class="string">'#jsChangeEmailForm'</span>).serialize(),</div><div class="line">        <span class="keyword">async</span>: <span class="literal">true</span>,</div><div class="line">        beforeSend:<span class="function"><span class="keyword">function</span>(<span class="params">XMLHttpRequest</span>)</span>&#123;</div><div class="line">            $btn.val(<span class="string">"发送中..."</span>);</div><div class="line">            $btn.attr(<span class="string">'disabled'</span>,<span class="literal">true</span>);</div><div class="line">            $(<span class="string">"#jsChangeEmailTips"</span>).html(<span class="string">"验证中..."</span>).show(<span class="number">500</span>);</div><div class="line">        &#125;,</div><div class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(data.email)&#123;</div><div class="line">                Dml.fun.showValidateError($(<span class="string">'#jsChangeEmail'</span>), data.email);</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.status == <span class="string">"success"</span>)&#123;</div><div class="line">                Dml.fun.showErrorTips($(<span class="string">'#jsChangePhoneTips'</span>), <span class="string">"邮箱信息更新成功"</span>);</div><div class="line">                setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;location.reload();&#125;,<span class="number">1000</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                 Dml.fun.showValidateError($(<span class="string">'#jsChangeEmail'</span>), <span class="string">"邮箱信息更新失败"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        complete: <span class="function"><span class="keyword">function</span>(<span class="params">XMLHttpRequest</span>)</span>&#123;</div><div class="line">            $btn.val(<span class="string">"完成"</span>);</div><div class="line">            $btn.removeAttr(<span class="string">"disabled"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4、其他用户信息修改"><a href="#4、其他用户信息修改" class="headerlink" title="4、其他用户信息修改"></a>4、其他用户信息修改</h4><ul>
<li><p>昵称，性别，生日，地址，联系方式等</p>
</li>
<li><p>可以共用info的view，如果是POST，则修改对应用户的字段</p>
<p>使用ModelForm，绑定user实例后，使用save方法更新。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 用户个人信息</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoView</span><span class="params">(LoginRequiredMixin, View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="comment"># 。。。。</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></div><div class="line">        user_info_form = UserInfoForm(request.POST, instance=request.user)</div><div class="line">        <span class="keyword">if</span> user_info_form.is_valid():</div><div class="line">            user_info_form.save()</div><div class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status":"success"&#125;'</span>, content_type=<span class="string">'application/json'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> HttpResponse(json.dumps(user_info_form.errors), content_type=<span class="string">'application/json'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>提交仍然是ajax方式提交，CSRF_TOKEN</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//保存个人资料</span></div><div class="line">    $(<span class="string">'#jsEditUserBtn'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> _self = $(<span class="keyword">this</span>),</div><div class="line">            $jsEditUserForm = $(<span class="string">'#jsEditUserForm'</span>)</div><div class="line">            verify = verifySubmit(</div><div class="line">            [</div><div class="line">                &#123;<span class="attr">id</span>: <span class="string">'#nick_name'</span>, <span class="attr">tips</span>: Dml.Msg.epNickName, <span class="attr">require</span>: <span class="literal">true</span>&#125;</div><div class="line">            ]</div><div class="line">        );</div><div class="line">        <span class="keyword">if</span>(!verify)&#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        $.ajax(&#123;</div><div class="line">            cache: <span class="literal">false</span>,</div><div class="line">            type: <span class="string">'post'</span>,</div><div class="line">            dataType:<span class="string">'json'</span>,</div><div class="line">            url:<span class="string">"/users/info/"</span>,</div><div class="line">            data:$jsEditUserForm.serialize(),</div><div class="line">            <span class="keyword">async</span>: <span class="literal">true</span>,</div><div class="line">            beforeSend:<span class="function"><span class="keyword">function</span>(<span class="params">XMLHttpRequest</span>)</span>&#123;</div><div class="line">                _self.val(<span class="string">"保存中..."</span>);</div><div class="line">                _self.attr(<span class="string">'disabled'</span>,<span class="literal">true</span>);</div><div class="line">            &#125;,</div><div class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span>(data.nick_name)&#123;</div><div class="line">                    _showValidateError($(<span class="string">'#nick_name'</span>), data.nick_name);</div><div class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.birday)&#123;</div><div class="line">                   _showValidateError($(<span class="string">'#birth_day'</span>), data.birday);</div><div class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.address)&#123;</div><div class="line">                   _showValidateError($(<span class="string">'#address'</span>), data.address);</div><div class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.status == <span class="string">"failure"</span>)&#123;</div><div class="line">                     Dml.fun.showTipsDialog(&#123;</div><div class="line">                        title: <span class="string">'保存失败'</span>,</div><div class="line">                        h2: data.msg</div><div class="line">                    &#125;);</div><div class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.status == <span class="string">"success"</span>)&#123;</div><div class="line">                    Dml.fun.showTipsDialog(&#123;</div><div class="line">                        title: <span class="string">'保存成功'</span>,</div><div class="line">                        h2: <span class="string">'个人信息修改成功！'</span></div><div class="line">                    &#125;);</div><div class="line">                    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">window</span>.location.href = <span class="built_in">window</span>.location.href;&#125;,<span class="number">1500</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            complete: <span class="function"><span class="keyword">function</span>(<span class="params">XMLHttpRequest</span>)</span>&#123;</div><div class="line">                _self.val(<span class="string">"保存"</span>);</div><div class="line">                _self.removeAttr(<span class="string">"disabled"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5、我的收藏"><a href="#5、我的收藏" class="headerlink" title="5、我的收藏"></a>5、我的收藏</h4><ul>
<li><p>收藏的机构，讲师，课程。三个页面是一样的页面结构</p>
</li>
<li><p>取消收藏的按钮，js实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'.jsDeleteFav_course'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> _this = $(<span class="keyword">this</span>),</div><div class="line">            favid = _this.attr(<span class="string">'data-favid'</span>);</div><div class="line">        alert(favid)</div><div class="line">        $.ajax(&#123;</div><div class="line">                cache: <span class="literal">false</span>,</div><div class="line">                type: <span class="string">"POST"</span>,</div><div class="line">                url: <span class="string">"/org/add_fav/"</span>,</div><div class="line">                data: &#123;</div><div class="line">                    fav_type: <span class="number">1</span>,</div><div class="line">                    fav_id: favid,</div><div class="line">                    csrfmiddlewaretoken: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span></div><div class="line">                &#125;,</div><div class="line">                <span class="keyword">async</span>: <span class="literal">true</span>,</div><div class="line">                success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">                    Dml.fun.winReload();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="6、我的消息"><a href="#6、我的消息" class="headerlink" title="6、我的消息"></a>6、我的消息</h4><ul>
<li><p>用户注册后，可以写入欢迎注册的消息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">u_m = UserMesage()</div><div class="line">u_m.user = request.user</div><div class="line">u_m.message = <span class="string">u"黄莺注册"</span></div><div class="line">u_m.save()</div></pre></td></tr></table></figure>
</li>
<li><p>消息展示</p>
</li>
<li><p>全局通知器，未读消息数目</p>
<p>request里有user对象，因此在user的model中实现一个方法，读取全部未读消息。</p>
<p><code>import UserMessage</code>语句必须放在函数内，不能放在文件开头，不然就会2个类互相引用对方</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span><span class="params">(AbstractUser)</span>:</span></div><div class="line"><span class="comment"># 获取用户未读消息数量</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unread_nums</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">from</span> operation.models <span class="keyword">import</span> UserMessage</div><div class="line">        <span class="keyword">return</span> UserMessage.objects.filter(user=self.id, has_read=<span class="keyword">False</span>).count()</div></pre></td></tr></table></figure>
</li>
<li><p>已读，忽略，删除</p>
</li>
</ul>
<p>​       将未读的消息改为已读</p>
<h4 id="7、退出登录"><a href="#7、退出登录" class="headerlink" title="7、退出登录"></a>7、退出登录</h4><ul>
<li><p>django的auth模块提供了login和logout方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 用户注销</span></div><div class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> authenticate, login, logout</div><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect</div><div class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogoutView</span><span class="params">(View)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></div><div class="line">        logout(request)</div><div class="line">        <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">"index"</span>))</div></pre></td></tr></table></figure>
</li>
<li><p>判断循环次数是否是5的倍数</p>
<p><code> <li class="{% if forloop.counter|divisibleby:5 %}five{% endif %} &quot;&gt;</code></p>
</li>
</ul>
<h3 id=" 功能-404和500"=""><a href="#功能-404和500" class="headerlink" title="功能 404和500"></a>功能 404和500<ul>
<li><p>在urls中设置<strong>handler404</strong>和<strong>handler500</strong>变量</p>
</li>
<li><p>使用404时，要设置debug为False，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -------------- urls.py</span></div><div class="line">urlpatterns = [</div><div class="line">  <span class="comment">#  url(r'^static/(?P&lt;path&gt;.*)$', serve, &#123;'document_root': STATIC_ROOT&#125;),</span></div><div class="line">]</div><div class="line"><span class="comment"># 全局 404 页面配置</span></div><div class="line">handler404 = <span class="string">'users.views.page_not_found'</span></div><div class="line">handler500 = <span class="string">'users.views.page_error'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># -------------- views.py</span></div><div class="line"><span class="comment"># 全局 404 处理函数</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</div><div class="line">    response = render_to_response(<span class="string">'404.html'</span>, &#123;&#125;)</div><div class="line">    response.status_code = <span class="number">404</span></div><div class="line">    <span class="keyword">return</span> response</div><div class="line"><span class="comment"># 全局 500 处理函数</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_error</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</div><div class="line">    response = render_to_response(<span class="string">'500.html'</span>, &#123;&#125;)</div><div class="line">    response.status_code = <span class="number">500</span></div><div class="line">    <span class="keyword">return</span> response</div><div class="line"></div><div class="line"><span class="comment"># ---------------- settings.py</span></div><div class="line">DEBUG = <span class="keyword">False</span></div><div class="line">STATIC_ROOT = <span class="string">"/static"</span></div></pre></td></tr></table></figure>
</li>
<li><p>但是debug为False时，无法直接访问静态文件。一种方法是配置url来处理静态文件，另外一种，使用web生产服务器部署项目。</p>
<p><code>url(r&#39;^static/(?P&lt;path&gt;.*)$&#39;, serve, {&#39;document_root&#39;: STATIC_ROOT}),</code></p>
</li>
</ul>
<h3 id="功能-用户权限"><a href="#功能-用户权限" class="headerlink" title="功能  用户权限"></a>功能  用户权限</h3><blockquote>
<p> 在最新的xadmin中， 1,2两节的内容都不必去做了。</p>
</blockquote>
<h4 id="1、XAdmin注册自定义的UserProfile"><a href="#1、XAdmin注册自定义的UserProfile" class="headerlink" title="1、XAdmin注册自定义的UserProfile"></a>1、XAdmin注册自定义的UserProfile</h4><ul>
<li><p><strong>注意</strong> Xadmin现在已经通过setting里的<code>AUTH_USER_MODEL = &quot;users.UserProfile&quot;</code>参数获取到了我们自定义的User对象。因此1 2两小节的内容都没必要了。</p>
</li>
<li><p>在旧版的xadmin，可能默认将django的User注册进后台管理，我们取消注册后，重新注册一个。</p>
<p><code>xadmin.plugins.auth</code>里的UserAdmin管理器定义了User在xadmin中的显示样式，我们可以重载它。</p>
<p><code>layout  Fieldset(_(&#39;显示名称&#39;)， ‘field1’， ‘field2’)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  ----- adminx.py</span></div><div class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</div><div class="line"><span class="keyword">from</span> xadmin.plugins.auth <span class="keyword">import</span> UserAdmin</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfileAdmin</span><span class="params">(UserAdmin)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_form_layout</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.org_obj:</div><div class="line">            self.form_layout = (</div><div class="line">                Main(</div><div class="line">                    Fieldset(<span class="string">''</span>,</div><div class="line">                             <span class="string">'username'</span>, <span class="string">'password'</span>,</div><div class="line">                             css_class=<span class="string">'unsort no_title'</span></div><div class="line">                             ),</div><div class="line">                    Fieldset(_(<span class="string">'Personal info'</span>),</div><div class="line">                             Row(<span class="string">'first_name'</span>, <span class="string">'last_name'</span>),</div><div class="line">                             <span class="string">'email'</span></div><div class="line">                             ),</div><div class="line">                    Fieldset(_(<span class="string">'Permissions'</span>),</div><div class="line">                             <span class="string">'groups'</span>, <span class="string">'user_permissions'</span></div><div class="line">                             ),</div><div class="line">                    Fieldset(_(<span class="string">'Important dates'</span>),</div><div class="line">                             <span class="string">'last_login'</span>, <span class="string">'date_joined'</span></div><div class="line">                             ),</div><div class="line">                ),</div><div class="line">                Side(</div><div class="line">                    Fieldset(_(<span class="string">'Status'</span>),</div><div class="line">                             <span class="string">'is_active'</span>, <span class="string">'is_staff'</span>, <span class="string">'is_superuser'</span>,</div><div class="line">                             ),</div><div class="line">                )</div><div class="line">            )</div><div class="line">        <span class="keyword">return</span> super(UserAdmin, self).get_form_layout()</div><div class="line">    </div><div class="line"></div><div class="line">xadmin.site.unregister(User)</div><div class="line">xadmin.site.register(UserProfile, UserProfileAdmin)</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<h4 id="2、当前登录用户修改密码"><a href="#2、当前登录用户修改密码" class="headerlink" title="2、当前登录用户修改密码"></a>2、当前登录用户修改密码</h4><ul>
<li><p><code>xadmin.plugins.auth</code>里import进来的是默认的User，</p>
</li>
<li><p>如果我们实现了自定义的UserProfile，那么修改密码的功能会出错。关联出错。</p>
<p>使用这种方法的话，上一小节的修改也就不必做了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#   ----xadmin.plugins.auth.py</span></div><div class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</div><div class="line">User = get_user_model()</div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>新版的xadmin已经修复了这个bug</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 虚浮代码</span></div><div class="line"><span class="comment"># util.py</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</div><div class="line">    User = get_user_model()</div><div class="line">    username_field = User.USERNAME_FIELD</div><div class="line"><span class="keyword">except</span> Exception:</div><div class="line">    <span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</div><div class="line">    username_field = <span class="string">'username'</span></div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<h4 id="3、通过Form修改密码"><a href="#3、通过Form修改密码" class="headerlink" title="3、通过Form修改密码"></a>3、通过Form修改密码</h4><ul>
<li><p>当我们忘记密码时，可以通过后台编辑password的表单，即在数据库中修改用户的密码。</p>
</li>
<li><p>xadmin为我们提供了一个直接更改密码的视图，直接输入新密码即可覆盖旧密码。</p>
</li>
<li><p>使用自定义的UserProfile时，<code>http://127.0.0.1:8000/xadmin/users/userprofile/1/password/</code>URL不存在，</p>
</li>
<li><p>修改对应的URL映射规则即可,因为xadmin中注册的是</p>
<p><code>site.register_view(r&#39;^auth/user/(.+)/update/password/$&#39;, ChangePasswordView, name=&#39;user_change_password&#39;)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  -------  users/adminx.py</span></div><div class="line"><span class="keyword">from</span> xadmin.sites <span class="keyword">import</span> site</div><div class="line"><span class="keyword">from</span> xadmin.plugins.auth <span class="keyword">import</span> ChangePasswordView</div><div class="line"></div><div class="line"><span class="comment"># xadmin/users/userprofile/1/password/</span></div><div class="line">site.register_view(<span class="string">r'^users/userprofile/(.+)/password/$'</span>,</div><div class="line">                   ChangePasswordView, name=<span class="string">'user_change_password'</span>)</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4、用户权限管理"><a href="#4、用户权限管理" class="headerlink" title="4、用户权限管理"></a>4、用户权限管理</h4><p>哪些用户对哪些数据表拥有正删改查的操作。</p>
<p><code>auth_permission</code>数据表里为每个数据表生成了4个权限，增删改查记录。</p>
<p>用户的属性 职员状态，选中的用户才能登陆后台管理系统。</p>
<p>设置用户组权限</p>
<p>在用户信息的用户组选项卡，按住CTRL 多选和反选用户组。</p>
<h4 id="5、xadmin-model图标，只读字段，默认排序设置"><a href="#5、xadmin-model图标，只读字段，默认排序设置" class="headerlink" title="5、xadmin model图标，只读字段，默认排序设置"></a>5、xadmin model图标，只读字段，默认排序设置</h4><ul>
<li><p>model icon</p>
<p>在model注册管理器中添加字段<code>model_icon = &#39;fa fa-user&#39;</code>，参考<code>xadmin.plugins.auth.UserAdmin</code>.</p>
<p>可选的 图标有哪些，xadmin使用的<a href="http://fontawesome.io/" target="_blank" rel="external">Font Awesome</a>图标库。</p>
<p> Xadmin中font_awesome的路径<code>site-packages\xadmin\static\xadmin\vendor\font-awesome</code></p>
<p>查看css文件中的font_awesome版本。</p>
</li>
</ul>
<h4 id="6、浏览器强制刷新"><a href="#6、浏览器强制刷新" class="headerlink" title="6、浏览器强制刷新"></a>6、浏览器强制刷新</h4><p><strong>CTRL+ F5</strong>，强制同时重新刷新CSS等静态文件</p>
<h4 id="7、model-管理器-配置"><a href="#7、model-管理器-配置" class="headerlink" title="7、model 管理器 配置"></a>7、model 管理器 配置</h4><p>model管理器中</p>
<ul>
<li><p>显示哪些field</p>
</li>
<li><p>可以被搜索的field</p>
</li>
<li><p>过滤器字段  在管理页面的右侧有 Filter By 的选项列表</p>
</li>
<li><p>设置数据显示的默认排序</p>
</li>
<li><p>设置只读字段，</p>
</li>
<li><p>设置某些字段不显示（和上面的冲突，field只读时，此设置不生效）</p>
</li>
<li><p>外键的搜索模式， 通过外键关联的item以AJAX加载的方式显示，而不是一次加载完，然后下拉。</p>
</li>
<li><p>inline模式</p>
<p>课程&gt; 章节 &gt; 视频 层次关系，通过外键关联</p>
<p>可以实现在添加课程时，同时添加章节。</p>
<p>但不能进行2层嵌套，在一层中可以有多个inline的model（如果有多个外键的model）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># xadmin的model管理器继承的对象是object</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailVerifyRecordAdmin</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="comment"># 显示表里的哪些列</span></div><div class="line">    <span class="comment"># course是个外键，model要重载Unicode方法以显示可读名字，不然在后台显示的对象名字是“course object”</span></div><div class="line">    list_display = [<span class="string">'code'</span>, <span class="string">'email'</span>, <span class="string">'send_type'</span>, <span class="string">'send_time'</span>, <span class="string">'course'</span>]</div><div class="line">    <span class="comment"># 哪些field可以被搜索查找</span></div><div class="line">    search_fields = [<span class="string">'code'</span>, <span class="string">'email'</span>, <span class="string">'send_type'</span>]</div><div class="line">    <span class="comment"># 过滤器，可以根据条件筛选、搜索</span></div><div class="line">    <span class="comment"># course是个外键，通过"__"指定要过滤的course对象的字段</span></div><div class="line">    list_filter = [<span class="string">'code'</span>, <span class="string">'email'</span>, <span class="string">'send_type'</span>, <span class="string">'course__name'</span>]</div><div class="line">    <span class="comment"># 数据item按code字段倒序排序</span></div><div class="line">    ordering = [<span class="string">'-code'</span>]</div><div class="line">    <span class="comment"># 只读</span></div><div class="line">    readonly_fields = [<span class="string">'click_nums'</span>]</div><div class="line">    <span class="comment"># 不显示</span></div><div class="line">    exclude = [<span class="string">'fav_nums'</span>]</div><div class="line">    <span class="comment"># inline模式</span></div><div class="line">    inlines = [LessonInline, CourseResourceInline]</div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LessonInline</span><span class="params">(object)</span>:</span></div><div class="line">    model = Lesson</div><div class="line">    extra = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseResourceInline</span><span class="params">(object)</span>:</span></div><div class="line">    model = CourseResource</div><div class="line">    extra = <span class="number">0</span></div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<ul>
<li><p>一张表使用多个管理器，分类管理数据。</p>
<p>比如一个管理hot为True的数据，另外一个管理hot为False的字段。</p>
<p>创建新的对象继承原有的Model，在Class Meta里填写部分参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  -----models.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HotCourse</span><span class="params">(Course)</span>:</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        verbose_name = <span class="string">u"热门课程"</span></div><div class="line">        verbose_name_plural = verbose_name</div><div class="line">        proxy = <span class="keyword">True</span>  <span class="comment"># 这样就不会生成2张表</span></div><div class="line">        </div><div class="line"> </div><div class="line"><span class="comment"># ------- adminx.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HotCourseAdmin</span><span class="params">(objects)</span>:</span></div><div class="line">    list_display = [<span class="string">'code'</span>, <span class="string">'email'</span>, <span class="string">'send_type'</span>, <span class="string">'send_time'</span>, <span class="string">'course'</span>]</div><div class="line">    <span class="comment"># 。。。</span></div><div class="line">    <span class="comment"># 重载该方法以取出我们需要的数据</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queryset</span><span class="params">(self)</span>:</span></div><div class="line">        qs = super(HotCourseAdmin, self).queryset()</div><div class="line">        qs = qs.filter(is_Hot=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">return</span> qs</div><div class="line">        </div><div class="line"><span class="comment"># 注册model，绑定model管理器</span></div><div class="line">xadmin.site.register(HotCourse, HotCourseAdmin)</div></pre></td></tr></table></figure>
</li>
<li><p>list_editable</p>
<p>可以在列表页直接编辑数值</p>
<p>model管理器添加可list_edit的字段 <code>list_editable = [&#39;degree&#39;, &#39;desc&#39;, &#39;numbs&#39;, ]</code></p>
</li>
<li><p>管理器中dispaly可以传递model对象自定义的函数名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ----models.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(models.Model)</span>:</span></div><div class="line">    <span class="comment"># ....</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">course_count</span><span class="params">(self:</span></span></div><div class="line"><span class="function"><span class="params">        return <span class="number">100</span></span></span></div><div class="line"><span class="function"><span class="params">    course_count.short_description = <span class="string">u"课程总数"</span></span></span></div><div class="line"><span class="function"><span class="params">    </span></span></div><div class="line"><span class="function"><span class="params">    def go_to<span class="params">(self)</span>:</span></span></div><div class="line"><span class="function"><span class="params">        from django.utils.safestring import mark_safe</span></span></div><div class="line"><span class="function"><span class="params">        return mark_safe<span class="params">(<span class="string">"&lt;a href='http://www.baidu.com'&gt;跳转&lt;/a&gt;"</span>)</span></span></span></div><div class="line"><span class="function"><span class="params">    go_to.short_description = <span class="string">"跳转"</span></span></span></div><div class="line"><span class="function"><span class="params">    # 定时刷新列表页,页面上会有选择每<span class="number">3</span>秒或<span class="number">5</span>秒刷新一次</span></span></div><div class="line"><span class="function"><span class="params">     refresh_times = [<span class="number">3</span>, <span class="number">5</span>]</span></span></div><div class="line"><span class="function"><span class="params">    </span></span></div><div class="line"><span class="function"><span class="params"># -------admminx.py</span></span></div><div class="line"><span class="function"><span class="params">class CourseAdmin<span class="params">(objects)</span>:</span></span></div><div class="line"><span class="function"><span class="params">    display_fields = [<span class="string">"name"</span>, <span class="string">"course_count"</span>, <span class="string">"go_to"</span>]</span></span></div></pre></td></tr></table></figure>
</li>
<li><p>显示自定义HTMl代码</p>
<p>详细看上面的go_to函数,会在管理页面显示一个”跳转”的链接,不用mark_safe的话，HTML代码会被转移成字符串，显示在后台管理页面。</p>
</li>
<li><p>定时刷新后台管理的列表页</p>
<p>refresh插件实现的功能 <code>refresh_times = [3, 5]</code></p>
</li>
<li><p>数据保存时，触发操作</p>
<p>model管理重写save_models方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># adminx.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseAdmin</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># ....</span></div><div class="line">    <span class="comment"># 在保存课程的时候，统计课程机构的课程数</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_models</span><span class="params">(self)</span>:</span></div><div class="line">        obj = self.new_obj</div><div class="line">        obj.save()</div><div class="line">        <span class="keyword">if</span> obj.course_org <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            course_org = obj.course_org</div><div class="line">            course_org.course_nums = Course.objects.filter(course_org=course_org).count()</div><div class="line">            course_org.save()</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="功能-Xadmin插件开发"><a href="#功能-Xadmin插件开发" class="headerlink" title="功能 Xadmin插件开发"></a>功能 Xadmin插件开发</h3><p><a href="http://ueditor.baidu.com/website/" target="_blank" rel="external">UEditor</a>，百度提供的一款富文本编辑器。</p>
<p>xadmin插件开发<a href="http://xadmin.readthedocs.io/en/docs-chinese/make_plugin.html" target="_blank" rel="external">文档</a></p>
<p>django-ueditor <a href="https://github.com/zhangfisher/DjangoUeditor" target="_blank" rel="external">文档</a>， pip install。然后 添加installed_apps，配置url映射。</p>
<p>在xadmin中用到UeditorField后生成富文本编辑器</p>
<h4 id="1、使用富文本编辑器"><a href="#1、使用富文本编辑器" class="headerlink" title="1、使用富文本编辑器"></a>1、使用富文本编辑器</h4><ul>
<li><p>配置django_ueditor</p>
<ul>
<li>安装</li>
<li>配置settings</li>
<li>配置URL映射</li>
<li>设置Model中的UeditorField</li>
</ul>
</li>
<li><p>编写插件，参考官方文档</p>
<p>编写plugin插件，并注册到相应的视图中。</p>
<p>在model管理器中设置指定Field的style_fields，以便插件可以定位该Field并对其操作。</p>
<p>最后在init文件的PLUGINS列表中加入写好的插件，py文件名。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  ------- xadmin/plugins/ueditor.py</span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> xadmin</div><div class="line"><span class="keyword">from</span> xadmin.views <span class="keyword">import</span> BaseAdminPlugin, CreateAdminView, ModelFormAdminView, UpdateAdminView</div><div class="line"><span class="keyword">from</span> DjangoUeditor.models <span class="keyword">import</span> UEditorField</div><div class="line"><span class="keyword">from</span> DjangoUeditor.widgets <span class="keyword">import</span> UEditorWidget</div><div class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">XadminUEditorWidget</span><span class="params">(UEditorWidget)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,**kwargs)</span>:</span></div><div class="line">        self.ueditor_options = kwargs</div><div class="line">        self.Media.js = <span class="keyword">None</span></div><div class="line">        super(XadminUEditorWidget, self).__init__(kwargs)</div><div class="line">        </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UeditorPlugin</span><span class="params">(BaseAdminPlugin)</span>:</span></div><div class="line">    <span class="comment"># style_fields是在model管理器里定义的，不同的field采用何种样式</span></div><div class="line">    <span class="comment"># style_fields = &#123;"course_detail": "ueditor"&#125;</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_field_style</span><span class="params">(self, attrs, db_field, style, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">if</span> style == <span class="string">'ueditor'</span>:</div><div class="line">            <span class="keyword">if</span> isinstance(db_field, UEditorField):</div><div class="line">                widget = db_field.formfield().widget</div><div class="line">                param = &#123;&#125;</div><div class="line">                param.update(widget.ueditor_settings)</div><div class="line">                param.update(widget.attrs)</div><div class="line">                <span class="keyword">return</span> &#123;<span class="string">'widget'</span>: XadminUEditorWidget(**param)&#125;</div><div class="line">            <span class="keyword">return</span> attrs</div><div class="line"></div><div class="line">        <span class="comment"># 加入自己的静态文件</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">block_extrahead</span><span class="params">(self, context, nodes)</span>:</span></div><div class="line">            js = <span class="string">'&lt;script type="text/javascript" src="%s"&gt;&lt;/script&gt;'</span> % (settings.STATIC_URL + <span class="string">"ueditor/ueditor.config.js"</span>)         <span class="comment">#自己的静态目录</span></div><div class="line">            js += <span class="string">'&lt;script type="text/javascript" src="%s"&gt;&lt;/script&gt;'</span> % (settings.STATIC_URL + <span class="string">"ueditor/ueditor.all.min.js"</span>)   <span class="comment">#自己的静态目录</span></div><div class="line">            nodes.append(js)</div><div class="line">            xadmin.site.register_plugin(UeditorPlugin, UpdateAdminView)  <span class="comment"># 修改页面</span></div><div class="line">            xadmin.site.register_plugin(UeditorPlugin, CreateAdminView)  <span class="comment"># 新增页面</span></div></pre></td></tr></table></figure>
</li>
<li><p>在插件列表里注册我们写好的插件</p>
<p>在plugins/<strong>init</strong>.py<code>PLUGINS = (&quot;ueditor&quot;, &quot;......&quot;)</code></p>
</li>
</ul>
<p>  2、通过excel导入数据</p>
<ul>
<li><p>如何在原有的HTML页面，加入导入按钮，弹窗导入框，列表等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -----------</span></div><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"><span class="keyword">import</span> xadmin</div><div class="line"><span class="keyword">from</span> xadmin.views <span class="keyword">import</span> BaseAdminPlugin, ListAdminView</div><div class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> loader</div><div class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># excel 导入</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListImportExcelPlugin</span><span class="params">(BaseAdminPlugin)</span>:</span></div><div class="line">    import_excel = <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="comment"># 从adminx里的model管理器中获取参数import_excel，判断是否加载插件。</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_request</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> bool(self.import_excel)</div><div class="line"></div><div class="line">    <span class="comment"># 这个函数会把html加载到 top toolbar block下。</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">block_top_toolbar</span><span class="params">(self, context, nodes)</span>:</span></div><div class="line">        <span class="comment"># nodes.append(loader.render_to_string('xadmin/excel/model_list.top_toolbar.import.html', context_instance=context))</span></div><div class="line">        <span class="comment"># 加载自定义的HTML</span></div><div class="line">        nodes.append(loader.render_to_string(<span class="string">'xadmin/excel/model_list.top_toolbar.import.html'</span>, context))</div><div class="line"></div><div class="line"></div><div class="line">xadmin.site.register_plugin(ListImportExcelPlugin, ListAdminView)</div></pre></td></tr></table></figure>
</li>
<li><p>自定义的HTML</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125;</div><div class="line">&#123;% load i18n %&#125;</div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn-group export"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"dropdown-toggle btn btn-default btn-sm"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"icon-share"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 导入 <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span> <span class="attr">role</span>=<span class="string">"menu"</span> <span class="attr">aria-labelledby</span>=<span class="string">"dLabel"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#export-modal-import-excel"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"icon-circle-arrow-down"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 导入 Excel<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">fileChange</span>(<span class="params">target</span>)</span>&#123;</span></div><div class="line"><span class="javascript"><span class="comment">//检测上传文件的类型</span></span></div><div class="line"><span class="javascript">            <span class="keyword">var</span> imgName = <span class="built_in">document</span>.all.submit_upload.value;</span></div><div class="line"><span class="javascript">            <span class="keyword">var</span> ext,idx;</span></div><div class="line"><span class="javascript">            <span class="keyword">if</span> (imgName == <span class="string">''</span>)&#123;</span></div><div class="line"><span class="javascript">                <span class="built_in">document</span>.all.submit_upload_b.disabled=<span class="literal">true</span>;</span></div><div class="line"><span class="javascript">                alert(<span class="string">"请选择需要上传的 xls 文件!"</span>);</span></div><div class="line"><span class="javascript">                <span class="keyword">return</span>;</span></div><div class="line"><span class="javascript">            &#125; <span class="keyword">else</span> &#123;</span></div><div class="line"><span class="javascript">                idx = imgName.lastIndexOf(<span class="string">"."</span>);</span></div><div class="line"><span class="javascript">                <span class="keyword">if</span> (idx != <span class="number">-1</span>)&#123;</span></div><div class="line"><span class="undefined">                    ext = imgName.substr(idx+1).toUpperCase();</span></div><div class="line"><span class="undefined">                    ext = ext.toLowerCase( );</span></div><div class="line"><span class="undefined">&#123;#                    alert("ext="+ext);#&#125;</span></div><div class="line"><span class="javascript">                    <span class="keyword">if</span> (ext != <span class="string">'xls'</span> &amp;&amp; ext != <span class="string">'xlsx'</span>)&#123;</span></div><div class="line"><span class="javascript">                        <span class="built_in">document</span>.all.submit_upload_b.disabled=<span class="literal">true</span>;</span></div><div class="line"><span class="javascript">                        alert(<span class="string">"只能上传 .xls 类型的文件!"</span>);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="javascript">                        <span class="keyword">return</span>;</span></div><div class="line"><span class="undefined">                    &#125;</span></div><div class="line"><span class="javascript">                &#125; <span class="keyword">else</span> &#123;</span></div><div class="line"><span class="javascript">                    <span class="built_in">document</span>.all.submit_upload_b.disabled=<span class="literal">true</span>;</span></div><div class="line"><span class="javascript">                    alert(<span class="string">"只能上传 .xls 类型的文件!"</span>);</span></div><div class="line"><span class="javascript">                    <span class="keyword">return</span>;</span></div><div class="line"><span class="undefined">                &#125;</span></div><div class="line"><span class="undefined">            &#125;</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">        &#125;</span></div><div class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"export-modal-import-excel"</span> <span class="attr">class</span>=<span class="string">"modal fade"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></div><div class="line">              &#123;% csrf_token %&#125;</div><div class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-header"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>&amp;times;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">"modal-title"</span>&gt;</span>导入 Excel<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">onchange</span>=<span class="string">"fileChange(this)"</span> <span class="attr">name</span>=<span class="string">"excel"</span> <span class="attr">id</span>=<span class="string">"submit_upload"</span>&gt;</span></div><div class="line"></div><div class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-footer"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span>&#123;% trans "Close" %&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">id</span>=<span class="string">"submit_upload_b"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"icon-share"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 导入<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!-- /.modal-content --&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!-- /.modal-dalog --&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!-- /.modal --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>获取到excel后的逻辑</p>
<p>重载model管理器的post方法，从中提取到excel文件，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ------- adminx.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseAdmin</span><span class="params">()</span>:</span></div><div class="line">        <span class="comment"># ...</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="string">'excel'</span> <span class="keyword">in</span> request.FILES:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        <span class="comment"># 必须返回父类的post方法</span></div><div class="line">        <span class="keyword">return</span> super(CourseAdmin, self).post(request, args, kwargs)</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
</li></code></p></li></ul>
      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-08-18T16:00:00.000Z"><a href="/2016/08/19/技术/Django模板语法/">2016-08-19</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/08/19/技术/Django模板语法/">Django 模板语法</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Django模板语法"><a href="#Django模板语法" class="headerlink" title="Django模板语法"></a>Django模板语法</h2><h3 id="模板变量"><a href="#模板变量" class="headerlink" title="模板变量"></a>模板变量</h3><ul>
<li><code> {{var_name}} </code>,view视图传入参数可以为<code> Context({'name':'vale',})</code></li>
<li><code>{{dict.key}}</code>,view视图传入参数为dict字典</li>
<li><code>{{object_name.attribute 或 method}} </code>,view视图传入一个对象object。</li>
<li><code>{{list_name.N}}</code>,view视图出入一个list，可以取出list的第N个元素。</li>
</ul>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2016/08/19/技术/Django模板语法/#more" class="more-link">阅读全文</a>
          </div>
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-08-16T16:00:00.000Z"><a href="/2016/08/17/技术/python 虚拟环境 virtualenv和virtualenvwrapper (Windows)/">2016-08-17</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/08/17/技术/python 虚拟环境 virtualenv和virtualenvwrapper (Windows)/">python虚拟环境设置(win)</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows下安装virtualenv和virtualenvwrapper"><span class="toc-text">Windows下安装virtualenv和virtualenvwrapper</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装virtualenv"><span class="toc-text">安装virtualenv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装virtualenvwrapper-win"><span class="toc-text">安装virtualenvwrapper-win</span></a></li></ol></li></ol>
    </div>

      
        <blockquote>
<p>linux 或 mac下推荐使用pyenv，既可以管理虚拟环境，还能管理Python版本，以及实现系统级Python环境的自由切换。</p>
</blockquote>
<h2 id="Windows下安装virtualenv和virtualenvwrapper"><a href="#Windows下安装virtualenv和virtualenvwrapper" class="headerlink" title="Windows下安装virtualenv和virtualenvwrapper"></a>Windows下安装virtualenv和virtualenvwrapper</h2><h3 id="安装virtualenv"><a href="#安装virtualenv" class="headerlink" title="安装virtualenv"></a>安装virtualenv</h3><p><code>pip install virtualenv</code></p>
<h3 id="安装virtualenvwrapper-win"><a href="#安装virtualenvwrapper-win" class="headerlink" title="安装virtualenvwrapper-win"></a>安装virtualenvwrapper-win</h3><p><code>pip install virtualenvwrapper</code></p>
<ul>
<li><p>创建虚拟环境</p>
<p><code>makevirtualenv</code></p>
</li>
<li><p>查看进入虚拟环境</p>
<p><code>workon</code></p>
<p><code>workon test1</code></p>
</li>
<li><p>退出虚拟环境</p>
<p><code>deactivate</code></p>
</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-08-15T16:00:00.000Z"><a href="/2016/08/16/技术/Django学习笔记2/">2016-08-16</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/08/16/技术/Django学习笔记2/">Django 学习笔记(二)</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Django进阶"><a href="#Django进阶" class="headerlink" title="Django进阶"></a>Django进阶</h1><h3 id="1、用户信息扩展"><a href="#1、用户信息扩展" class="headerlink" title="1、用户信息扩展"></a>1、用户信息扩展</h3><h4 id="1-1、使用profile扩展"><a href="#1-1、使用profile扩展" class="headerlink" title="1.1、使用profile扩展"></a>1.1、使用profile扩展</h4><p>在models定义一个profile表，使用外键关联</p>
<h4 id="1-2、继承AbstractUser"><a href="#1-2、继承AbstractUser" class="headerlink" title="1.2、继承AbstractUser"></a>1.2、继承AbstractUser</h4><p>在models创建继承AbstractUser的User类，为其增加新的字段，比如QQ号，手机号。在setting里设置字段 <code>AUTH_USER_MODEL = &#39;blog.User&#39;</code><br>在admin注册自己的User。</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2016/08/16/技术/Django学习笔记2/#more" class="more-link">阅读全文</a>
          </div>
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-08-12T16:00:00.000Z"><a href="/2016/08/13/技术/Django学习笔记1/">2016-08-13</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/08/13/技术/Django学习笔记1/">Django 学习笔记(一)</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Django-学习笔记1"><a href="#Django-学习笔记1" class="headerlink" title="Django 学习笔记1"></a>Django 学习笔记1</h1><blockquote>
<p>基于python2.7和django1.10</p>
</blockquote>
<p>django工作流程：<br><img src="http://ww3.sinaimg.cn/large/af9df239gw1f8gckh77jrj20hm0c2dgy.jpg" alt=""></p>
<h3 id="1、快速开始"><a href="#1、快速开始" class="headerlink" title="1、快速开始"></a>1、快速开始</h3><h4 id="1-1、创建项目"><a href="#1-1、创建项目" class="headerlink" title="1.1、创建项目"></a>1.1、创建项目</h4><ul>
<li><p>django-admin.py startproject website</p>
</li>
<li><p>manage.py startapp blog</p>
</li>
<li><p>修改webisite下的setting.py urls.py</p>
</li>
</ul>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2016/08/13/技术/Django学习笔记1/#more" class="more-link">阅读全文</a>
          </div>
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-08-09T16:00:00.000Z"><a href="/2016/08/10/技术/PhantomJS + Selenium实现登陆网站签到/">2016-08-10</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/08/10/技术/PhantomJS + Selenium实现登陆网站签到/">PhantomJS + Selenium实现登陆网站签到</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="PhantomJS-Selenium实现登陆网站签到"><a href="#PhantomJS-Selenium实现登陆网站签到" class="headerlink" title="PhantomJS + Selenium实现登陆网站签到"></a>PhantomJS + Selenium实现登陆网站签到</h3><blockquote>
<p>js脚本是由浏览器前端加载执行的，因此爬虫要想渲染js，就要实现js引擎，或者我们分析出js发送的请求后，自己构造(很难，复杂)。</p>
<p>另外一种，就是使用selenium调用浏览器自动化处理。phantomjs是一个无头浏览器，没有界面，因此运行速度要比chrome快一点，没有弹窗干扰。</p>
<p>requests，urllib之类的http库，只能将http资源请求下来，其中的img link js标签都不会自动加载。而浏览器会请求所有的资源。</p>
</blockquote>
<h4 id="目标网站分析"><a href="#目标网站分析" class="headerlink" title="目标网站分析"></a>目标网站分析</h4>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2016/08/10/技术/PhantomJS + Selenium实现登陆网站签到/#more" class="more-link">阅读全文</a>
          </div>
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
		
          <time datetime="2016-08-08T16:00:00.000Z"><a href="/2016/08/09/技术/Python2爬虫笔记/">2016-08-09</a></time>
        
	  
      
  
    <h1 class="title"><a href="/2016/08/09/技术/Python2爬虫笔记/">爬虫笔记(基于python2)</a></h1>
  

    </header>
    <div class="entry">
      
        <blockquote>
<p>基于python2.7</p>
</blockquote>
<h3 id="urllib2库的用法"><a href="#urllib2库的用法" class="headerlink" title="urllib2库的用法"></a>urllib2库的用法</h3><h4 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h4><ul>
<li>urlopen方法打开网页</li>
</ul>
<p>传入3个参数，data和timeout不是必须的；返回网页的源码可用read方法读出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">response = urlopen(url,data,timeout)</div><div class="line">content = response.read()</div></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2016/08/09/技术/Python2爬虫笔记/#more" class="more-link">阅读全文</a>
          </div>
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
    <a href="/page/9/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/11/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  
<div>
<a href="javascript:;" class="popup-trigger">      
      <i class="menu-item-icon fa fa-search fa-fw"></i>        
   搜索
</a>
</div>


<div class="site-search">
<div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>
</div>

<script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
     
  var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';
                var str1=str                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>';
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
					else { isMatch=false; } //更新此处
					
					//更新此处
					
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ "> " + data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 20;
                            var end = first_occur + 30;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
							//console.log(match_content)
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                    }
                })
                //修改
				if (str1==str){
					str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';
					}
				
				$resultContent.innerHTML = str;
            })
        }
    })
}
    // search function;
 </script>
<script>

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
	  proceedsearch();
	  //添加的
	  document.getElementById("local-search-result").innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>';
     
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>
  
<script type="text/javascript">      
     var search_path = "search.xml";
     if (search_path.length == 0) {
     	search_path = "search.xml";
     }
     var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
</script>





  
<div class="widget tag">
  <h3 class="title" id="categories">分类</h3>
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ѧϰ/">ѧϰ</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/ѧϰ/д��/">д��</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/ѧϰ/д��/�K�/">�Ķ�</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/">学习</a><span class="category-list-count">24</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/学习/Math/">Math</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/Matlab/">Matlab</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/写作/">写作</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/学习/写作/Doc/">Doc</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/写作/Hexo/">Hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/写作/Markdown/">Markdown</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/机器学习/">机器学习</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/学习/机器学习/TensorFlow/">TensorFlow</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/机器学习/推荐系统/">推荐系统</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/求职/">求职</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/学习/求职/基础知识/">基础知识</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/求职/算法/">算法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/求职/经历/">经历</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习/求职/面试/">面试</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工具/Git/">Git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/IDEA/">IDEA</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/软件/">软件</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/工具/软件/MacOS/">MacOS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/软件/Windows/">Windows</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a><span class="category-list-count">98</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Go/">Go</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Go/标准库/">标准库</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Java/">Java</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Java/Hibernate/">Hibernate</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Java/Maven/">Maven</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Java/Mybatis/">Mybatis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Java/Spring/">Spring</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Java/SpringBoot/">SpringBoot</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Java/标准库/">标准库</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Linux/">Linux</a><span class="category-list-count">12</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Linux/Server/">Server</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Linux/日志监控/">日志监控</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/MacOS/">MacOS</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/MacOS/latex/">latex</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Python/">Python</a><span class="category-list-count">23</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Python/CGI编程/">CGI编程</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Python/PyQt5/">PyQt5</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Python/数据库连接/">数据库连接</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Python/标准库/">标准库</a><span class="category-list-count">17</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Web/">Web</a><span class="category-list-count">27</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Web/Bootstrap/">Bootstrap</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Web/Django/">Django</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Web/Flask/">Flask</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Web/HTML/">HTML</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Web/JavaScript/">JavaScript</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/并发编程/">并发编程</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/并发编程/Gevent/">Gevent</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据分析/">数据分析</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据分析/IPython/">IPython</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据分析/Matplotlib/">Matplotlib</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据分析/Numpy/">Numpy</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据分析/Pandas/">Pandas</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据分析/词云/">词云</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据库/">数据库</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据库/ElasticSearch/">ElasticSearch</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据库/MongoDB/">MongoDB</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据库/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/数据库/Redis/">Redis</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/爬虫/">爬虫</a><span class="category-list-count">10</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/爬虫/Python/">Python</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/爬虫/Scrapy/">Scrapy</a><span class="category-list-count">8</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/网络编程/">网络编程</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/网络编程/Socket/">Socket</a><span class="category-list-count">2</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/折腾/">折腾</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/折腾/手机/">手机</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/折腾/路由器/">路由器</a><span class="category-list-count">1</span></li></ul></li></ul> 
</div>
 

  <div class="widget tag">
<h3 class="title">简介</h3>
<ul class="entry">
<li>博主：帅羊羊</li>
<li>现状：武大CS在读研究生</li>
<li>Theme: <a href="https://github.com/shuaiyy/lightum">Lightum</a>
<!-- <li>想交友的朋友请<a href="http://zipperary.com/about">联系我</a>！</li> -->
<li>QQ 号：2Ol896963</li>
<li>博客: 记录个人生活学习的点滴</li>
<!-- <font color="red">Hexo 交流群：287306637</font> -->
</ul>
</div>



  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=0&uid=2946363961&verifier=371067b2&dpc=1"></iframe>

  <div class="widget tag">
<h3 class="title">打赏</h3>
<ul class="entry">
<li>支付宝扫一扫，捐助支持，谢谢！</li>
<li><a href="http://img.shuaiyy.cn/blog/171004/LikDAfKDg0.png" title="" class="fancybox" rel="gallery3"><img width="100%" src="http://img.shuaiyy.cn/blog/171004/LikDAfKDg0.png"></a></li>
</ul>
</div>

  <!--  旧的标签

<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/Android/">Android</a><small>1</small></li>
  
    <li><a href="/tags/Bootstrap/">Bootstrap</a><small>1</small></li>
  
    <li><a href="/tags/CentOS/">CentOS</a><small>1</small></li>
  
    <li><a href="/tags/Django/">Django</a><small>6</small></li>
  
    <li><a href="/tags/Docset/">Docset</a><small>1</small></li>
  
    <li><a href="/tags/ElasticSearch/">ElasticSearch</a><small>1</small></li>
  
    <li><a href="/tags/Enjoy/">Enjoy</a><small>0</small></li>
  
    <li><a href="/tags/Exam/">Exam</a><small>0</small></li>
  
    <li><a href="/tags/Flask/">Flask</a><small>19</small></li>
  
    <li><a href="/tags/Gevent/">Gevent</a><small>3</small></li>
  
    <li><a href="/tags/Git/">Git</a><small>4</small></li>
  
    <li><a href="/tags/Gitbook/">Gitbook</a><small>1</small></li>
  
    <li><a href="/tags/Go/">Go</a><small>1</small></li>
  
    <li><a href="/tags/HTML/">HTML</a><small>1</small></li>
  
    <li><a href="/tags/Hexo/">Hexo</a><small>1</small></li>
  
    <li><a href="/tags/Hibernate/">Hibernate</a><small>1</small></li>
  
    <li><a href="/tags/Html/">Html</a><small>2</small></li>
  
    <li><a href="/tags/IDEA/">IDEA</a><small>3</small></li>
  
    <li><a href="/tags/IPython/">IPython</a><small>1</small></li>
  
    <li><a href="/tags/Ipython/">Ipython</a><small>0</small></li>
  
    <li><a href="/tags/JQuery/">JQuery</a><small>1</small></li>
  
    <li><a href="/tags/Java/">Java</a><small>11</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>3</small></li>
  
    <li><a href="/tags/LaTeX/">LaTeX</a><small>3</small></li>
  
    <li><a href="/tags/LeetCode/">LeetCode</a><small>2</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>11</small></li>
  
    <li><a href="/tags/Mac/">Mac</a><small>2</small></li>
  
    <li><a href="/tags/MachineLearning/">MachineLearning</a><small>1</small></li>
  
    <li><a href="/tags/Markdown/">Markdown</a><small>1</small></li>
  
    <li><a href="/tags/Math/">Math</a><small>6</small></li>
  
    <li><a href="/tags/Matlab/">Matlab</a><small>1</small></li>
  
    <li><a href="/tags/Matplotlib/">Matplotlib</a><small>1</small></li>
  
    <li><a href="/tags/Maven/">Maven</a><small>1</small></li>
  
    <li><a href="/tags/MongoDB/">MongoDB</a><small>1</small></li>
  
    <li><a href="/tags/Mongodb/">Mongodb</a><small>0</small></li>
  
    <li><a href="/tags/MyBatis/">MyBatis</a><small>1</small></li>
  
    <li><a href="/tags/MySQL/">MySQL</a><small>1</small></li>
  
    <li><a href="/tags/Notebook/">Notebook</a><small>1</small></li>
  
    <li><a href="/tags/Numpy/">Numpy</a><small>2</small></li>
  
    <li><a href="/tags/ORM/">ORM</a><small>2</small></li>
  
    <li><a href="/tags/Openwrt/">Openwrt</a><small>1</small></li>
  
    <li><a href="/tags/Optimization/">Optimization</a><small>8</small></li>
  
    <li><a href="/tags/Pandas/">Pandas</a><small>1</small></li>
  
    <li><a href="/tags/Phantomjs/">Phantomjs</a><small>1</small></li>
  
    <li><a href="/tags/Pip/">Pip</a><small>1</small></li>
  
    <li><a href="/tags/PyQt5/">PyQt5</a><small>4</small></li>
  
    <li><a href="/tags/Pycharm/">Pycharm</a><small>1</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>32</small></li>
  
    <li><a href="/tags/RESTful/">RESTful</a><small>1</small></li>
  
    <li><a href="/tags/Redis/">Redis</a><small>3</small></li>
  
    <li><a href="/tags/Scrapy/">Scrapy</a><small>8</small></li>
  
    <li><a href="/tags/Selenium/">Selenium</a><small>1</small></li>
  
    <li><a href="/tags/Service/">Service</a><small>1</small></li>
  
    <li><a href="/tags/Socket/">Socket</a><small>2</small></li>
  
    <li><a href="/tags/Spring/">Spring</a><small>1</small></li>
  
    <li><a href="/tags/SpringBoot/">SpringBoot</a><small>1</small></li>
  
    <li><a href="/tags/Tensorflow/">Tensorflow</a><small>1</small></li>
  
    <li><a href="/tags/Web/">Web</a><small>19</small></li>
  
    <li><a href="/tags/WordCloud/">WordCloud</a><small>1</small></li>
  
    <li><a href="/tags/Zabbix/">Zabbix</a><small>1</small></li>
  
    <li><a href="/tags/Zeal/">Zeal</a><small>1</small></li>
  
    <li><a href="/tags/flask/">flask</a><small>0</small></li>
  
    <li><a href="/tags/gevent/">gevent</a><small>0</small></li>
  
    <li><a href="/tags/git/">git</a><small>0</small></li>
  
    <li><a href="/tags/gitbook/">gitbook</a><small>0</small></li>
  
    <li><a href="/tags/linux/">linux</a><small>0</small></li>
  
    <li><a href="/tags/python/">python</a><small>0</small></li>
  
    <li><a href="/tags/restful/">restful</a><small>0</small></li>
  
    <li><a href="/tags/socket/">socket</a><small>0</small></li>
  
    <li><a href="/tags/tensorflow/">tensorflow</a><small>0</small></li>
  
    <li><a href="/tags/刷题/">刷题</a><small>2</small></li>
  
    <li><a href="/tags/推荐系统/">推荐系统</a><small>1</small></li>
  
    <li><a href="/tags/数据库/">数据库</a><small>2</small></li>
  
    <li><a href="/tags/机器学习/">机器学习</a><small>3</small></li>
  
    <li><a href="/tags/框架/">框架</a><small>1</small></li>
  
    <li><a href="/tags/求职/">求职</a><small>6</small></li>
  
    <li><a href="/tags/测试/">测试</a><small>1</small></li>
  
    <li><a href="/tags/爬虫/">爬虫</a><small>9</small></li>
  
    <li><a href="/tags/经历/">经历</a><small>1</small></li>
  
    <li><a href="/tags/词云/">词云</a><small>1</small></li>
  
    <li><a href="/tags/面试/">面试</a><small>1</small></li>
  
  </ul>
</div>

-->

<!-- 使用hexo-tag-cloud 生成的-->

<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/PyQt5/" style="font-size: 16.33px; color: #b0a">PyQt5</a> <a href="/tags/Hexo/" style="font-size: 13px; color: #90f">Hexo</a> <a href="/tags/Math/" style="font-size: 17.44px; color: #c6008e">Math</a> <a href="/tags/Optimization/" style="font-size: 18.56px; color: #d20071">Optimization</a> <a href="/tags/Matlab/" style="font-size: 13px; color: #90f">Matlab</a> <a href="/tags/MachineLearning/" style="font-size: 13px; color: #90f">MachineLearning</a> <a href="/tags/Bootstrap/" style="font-size: 13px; color: #90f">Bootstrap</a> <a href="/tags/Linux/" style="font-size: 20.78px; color: #e80039">Linux</a> <a href="/tags/CentOS/" style="font-size: 13px; color: #90f">CentOS</a> <a href="/tags/Django/" style="font-size: 17.44px; color: #c6008e">Django</a> <a href="/tags/Flask/" style="font-size: 21.89px; color: #f4001c">Flask</a> <a href="/tags/Web/" style="font-size: 21.89px; color: #f4001c">Web</a> <a href="/tags/测试/" style="font-size: 13px; color: #90f">测试</a> <a href="/tags/Git/" style="font-size: 16.33px; color: #b0a">Git</a> <a href="/tags/HTML/" style="font-size: 13px; color: #90f">HTML</a> <a href="/tags/Java/" style="font-size: 20.78px; color: #e80039">Java</a> <a href="/tags/IDEA/" style="font-size: 15.22px; color: #b000c6">IDEA</a> <a href="/tags/ORM/" style="font-size: 14.11px; color: #a400e3">ORM</a> <a href="/tags/Hibernate/" style="font-size: 13px; color: #90f">Hibernate</a> <a href="/tags/Html/" style="font-size: 14.11px; color: #a400e3">Html</a> <a href="/tags/JavaScript/" style="font-size: 15.22px; color: #b000c6">JavaScript</a> <a href="/tags/Python/" style="font-size: 23px; color: #f00">Python</a> <a href="/tags/Notebook/" style="font-size: 13px; color: #90f">Notebook</a> <a href="/tags/Service/" style="font-size: 13px; color: #90f">Service</a> <a href="/tags/LaTeX/" style="font-size: 15.22px; color: #b000c6">LaTeX</a> <a href="/tags/Mac/" style="font-size: 14.11px; color: #a400e3">Mac</a> <a href="/tags/Markdown/" style="font-size: 13px; color: #90f">Markdown</a> <a href="/tags/Matplotlib/" style="font-size: 13px; color: #90f">Matplotlib</a> <a href="/tags/Maven/" style="font-size: 13px; color: #90f">Maven</a> <a href="/tags/MySQL/" style="font-size: 13px; color: #90f">MySQL</a> <a href="/tags/数据库/" style="font-size: 14.11px; color: #a400e3">数据库</a> <a href="/tags/MyBatis/" style="font-size: 13px; color: #90f">MyBatis</a> <a href="/tags/Numpy/" style="font-size: 14.11px; color: #a400e3">Numpy</a> <a href="/tags/Pandas/" style="font-size: 13px; color: #90f">Pandas</a> <a href="/tags/Android/" style="font-size: 13px; color: #90f">Android</a> <a href="/tags/框架/" style="font-size: 13px; color: #90f">框架</a> <a href="/tags/爬虫/" style="font-size: 19.67px; color: #d05">爬虫</a> <a href="/tags/Selenium/" style="font-size: 13px; color: #90f">Selenium</a> <a href="/tags/Phantomjs/" style="font-size: 13px; color: #90f">Phantomjs</a> <a href="/tags/WordCloud/" style="font-size: 13px; color: #90f">WordCloud</a> <a href="/tags/词云/" style="font-size: 13px; color: #90f">词云</a> <a href="/tags/Pip/" style="font-size: 13px; color: #90f">Pip</a> <a href="/tags/Redis/" style="font-size: 15.22px; color: #b000c6">Redis</a> <a href="/tags/Scrapy/" style="font-size: 18.56px; color: #d20071">Scrapy</a> <a href="/tags/SpringBoot/" style="font-size: 13px; color: #90f">SpringBoot</a> <a href="/tags/机器学习/" style="font-size: 15.22px; color: #b000c6">机器学习</a> <a href="/tags/Spring/" style="font-size: 13px; color: #90f">Spring</a> <a href="/tags/Zabbix/" style="font-size: 13px; color: #90f">Zabbix</a> <a href="/tags/Zeal/" style="font-size: 13px; color: #90f">Zeal</a> <a href="/tags/Gevent/" style="font-size: 15.22px; color: #b000c6">Gevent</a> <a href="/tags/IPython/" style="font-size: 13px; color: #90f">IPython</a> <a href="/tags/MongoDB/" style="font-size: 13px; color: #90f">MongoDB</a> <a href="/tags/Socket/" style="font-size: 14.11px; color: #a400e3">Socket</a> <a href="/tags/RESTful/" style="font-size: 13px; color: #90f">RESTful</a> <a href="/tags/Gitbook/" style="font-size: 13px; color: #90f">Gitbook</a> <a href="/tags/Docset/" style="font-size: 13px; color: #90f">Docset</a> <a href="/tags/Tensorflow/" style="font-size: 13px; color: #90f">Tensorflow</a> <a href="/tags/Pycharm/" style="font-size: 13px; color: #90f">Pycharm</a> <a href="/tags/JQuery/" style="font-size: 13px; color: #90f">JQuery</a> <a href="/tags/求职/" style="font-size: 17.44px; color: #c6008e">求职</a> <a href="/tags/Openwrt/" style="font-size: 13px; color: #90f">Openwrt</a> <a href="/tags/推荐系统/" style="font-size: 13px; color: #90f">推荐系统</a> <a href="/tags/ElasticSearch/" style="font-size: 13px; color: #90f">ElasticSearch</a> <a href="/tags/刷题/" style="font-size: 14.11px; color: #a400e3">刷题</a> <a href="/tags/LeetCode/" style="font-size: 14.11px; color: #a400e3">LeetCode</a>
  </div>
</div>


  <div class="widget tag">
  <h3 class="title">日历云</h3>
  <div id="calendar"></div>
</div>

  
  <div class="widget tag">
    <h3 class="title">归档</h3>
	<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">2018年11月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">2018年10月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">2018年09月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">2018年06月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">2018年05月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">2018年04月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">2018年03月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">2018年02月</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">2018年01月</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">2017年12月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">2017年11月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">2017年10月</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">2017年09月</a><span class="archive-list-count">24</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">2017年08月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">2017年05月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">2017年03月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">2017年02月</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">2016年12月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">2016年11月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">2016年10月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">2016年09月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">2016年08月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">2016年07月</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">2016年05月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">2015年09月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">2015年03月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">2015年02月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">2015年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">2014年12月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">2014年11月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">2014年09月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">2014年08月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">2014年07月</a><span class="archive-list-count">2</span></li></ul>
  </div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner">
<section>
<div class="copyright">
		
		  
		  &copy;2014&mdash; <span itemprop="copyrightYear">2018</span>
		  
  <span class="with-love">
    <i class="fa fa-heart" style="color:red"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shuaiyy</span>
</div>
主题 - <a href="https://github.com/shuaiyy/lightum">Lightum</a>, Improved from <a href="https://github.com/hexojs/hexo-theme-light">Light</a>, by <a href="/">shuaiyy</a> 
<p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>
</section>
<div class="clearfix"></div>
</footer>
  <script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<!-- add calendar widget -->

  <script src="/js/calendar.js"></script>
  <script src="/js/languages.js"></script>
  <script type="text/javascript">
    $(function() {
    
      $('#calendar').aCalendar('zh-CN',{single:true, root:'calendar/'});
    
    });
  </script>



<!-- 返回顶部 -->
<div id="toTop">
	<a href="#">▲</a>
	<a href="#footer">▼</a>
</div>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>


<a href="https://github.com/shuaiyy" target="_blank"><img style="position: absolute; top: 0; left: 0; border: 0;" src="/imgs/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>
