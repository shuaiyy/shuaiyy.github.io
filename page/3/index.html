

<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 3 页 | 帅羊羊的博客</title>
  
  <meta name="google-site-verification" content="hLu-CnRbqpthWxa76MJ-vpnGr7yMChNtTW6KA0pRMQo" />  
  
  <meta name="author" content="Shuai yy">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="帅羊羊的博客"/>

  
    <meta property="og:image" content=""/>
  
  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="http://shuaiyy.cn/atom.xml" title="帅羊羊的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//libs.baidu.com/jquery/1.8.0/jquery.min.js"></script>
  
  
</head>



<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">帅羊羊的博客</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
	  
    
      <li><a href="/archives"><i class="fa fa-archive"></i>归档</a></li>
	  
    
      <li><a href="/resume"><i class="fa fa-user"></i>关于</a></li>
	  
    
	<li> <a href="/atom.xml"><i class="fa fa-rss"></i>RSS</a> </li>
<li> <a title="把这个链接拖到你的Chrome收藏夹工具栏中" href='javascript:(function() {
	function c() {
		var e = document.createElement("link");
		e.setAttribute("type", "text/css");
		e.setAttribute("rel", "stylesheet");
		e.setAttribute("href", f);
		e.setAttribute("class", l);
		document.body.appendChild(e)
	}
 
	function h() {
		var e = document.getElementsByClassName(l);
		for (var t = 0; t < e.length; t++) {
			document.body.removeChild(e[t])
		}
	}
 
	function p() {
		var e = document.createElement("div");
		e.setAttribute("class", a);
		document.body.appendChild(e);
		setTimeout(function() {
			document.body.removeChild(e)
		}, 100)
	}
 
	function d(e) {
		return {
			height : e.offsetHeight,
			width : e.offsetWidth
		}
	}
 
	function v(i) {
		var s = d(i);
		return s.height > e && s.height < n && s.width > t && s.width < r
	}
 
	function m(e) {
		var t = e;
		var n = 0;
		while (!!t) {
			n += t.offsetTop;
			t = t.offsetParent
		}
		return n
	}
 
	function g() {
		var e = document.documentElement;
		if (!!window.innerWidth) {
			return window.innerHeight
		} else if (e && !isNaN(e.clientHeight)) {
			return e.clientHeight
		}
		return 0
	}
 
	function y() {
		if (window.pageYOffset) {
			return window.pageYOffset
		}
		return Math.max(document.documentElement.scrollTop, document.body.scrollTop)
	}
 
	function E(e) {
		var t = m(e);
		return t >= w && t <= b + w
	}
 
	function S() {
		var e = document.createElement("audio");
		e.setAttribute("class", l);
		e.src = i;
		e.loop = false;
		e.addEventListener("canplay", function() {
			setTimeout(function() {
				x(k)
			}, 500);
			setTimeout(function() {
				N();
				p();
				for (var e = 0; e < O.length; e++) {
					T(O[e])
				}
			}, 15500)
		}, true);
		e.addEventListener("ended", function() {
			N();
			h()
		}, true);
		e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
		document.body.appendChild(e);
		e.play()
	}
 
	function x(e) {
		e.className += " " + s + " " + o
	}
 
	function T(e) {
		e.className += " " + s + " " + u[Math.floor(Math.random() * u.length)]
	}
 
	function N() {
		var e = document.getElementsByClassName(s);
		var t = new RegExp("\\b" + s + "\\b");
		for (var n = 0; n < e.length; ) {
			e[n].className = e[n].className.replace(t, "")
		}
	}
 
	var e = 30;
	var t = 30;
	var n = 350;
	var r = 350;
	var i = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake.mp3";
	var s = "mw-harlem_shake_me";
	var o = "im_first";
	var u = ["im_drunk", "im_baked", "im_trippin", "im_blown"];
	var a = "mw-strobe_light";
	var f = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";
	var l = "mw_added_css";
	var b = g();
	var w = y();
	var C = document.getElementsByTagName("*");
	var k = null;
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (v(A)) {
			if (E(A)) {
				k = A;
				break
			}
		}
	}
	if (A === null) {
		console.warn("Could not find a node of the right size. Please try a different page.");
		return
	}
	c();
	S();
	var O = [];
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (v(A)) {
			O.push(A)
		}
	}
})()    '>High一下</a> </li>

  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-09-17T08:45:30.910Z"><a href="/2017/09/17/科研/2014-09-11-Matlab-tips/">2017-09-17</a></time>
      
      
  
    <h1 class="title"><a href="/2017/09/17/科研/2014-09-11-Matlab-tips/">Matlab科研小贴士</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Clear"><span class="toc-text">Clear</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Random-Seed"><span class="toc-text">Random Seed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NaN"><span class="toc-text">NaN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SaveAs"><span class="toc-text">SaveAs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#矩阵规范化"><span class="toc-text">矩阵规范化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装CVX"><span class="toc-text">安装CVX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分段运行程序"><span class="toc-text">%%分段运行程序</span></a></li></ol>
    </div>

      
        <p>使用MATLAB运行算法程序时，可能遇到各种各样的报错。比如，为了保护隐私数据，我在分布式矩阵补全算法中加入随机矩阵之后，某项变量在运行几百步之后会出现NaN报错。我只根据算法顺序去分析问题出现的可能原因，并修改程序。感觉并没有很好地利用MATLAB的强大功能去锁定症结所在。幸运的是，<a href="http://home.ustc.edu.cn/~shiwei00/index.html" target="_blank" rel="external">施伟</a>大师兄当时和我在一起，他非常热心地帮我分析问题，教我以后遇到类似状况应该怎么去分析与思考。和大师兄讨论了半小时，感觉自己收获不少。</p>
<p>这篇文章会陆续记录下自己使用MATLAB的体会，以及解决问题的一些技巧。</p>
<h3 id="Clear"><a href="#Clear" class="headerlink" title="Clear"></a>Clear</h3><p>运行一段代码前通常需要将工作空间里的已有数据清除掉。只需要在编辑有实际意义的代码之前写下如下代码：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clc; clear; close all;</div></pre></td></tr></table></figure>
<h3 id="Random-Seed"><a href="#Random-Seed" class="headerlink" title="Random Seed"></a>Random Seed</h3><p>为了保证程序在相同环境下运行以便测试某一个或几个改变对于算法的影响，在使用各种random命令时，需要设定固定种子。这样就不会因为每次随机产生的序列不同而影响程序运行结果。设置随机种子的代码如下：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">%% random seed</span></div><div class="line"><span class="comment">%seed=round(5000*rand);       % use this line if you set a random seed</span></div><div class="line">seed=<span class="number">3302</span>;    <span class="comment">% use this line if you set a fixed seed. 3302 can be replaced by other numbers.</span></div><div class="line">fprintf(<span class="string">'Seed = %d\n'</span>,seed);  <span class="comment">% print the current seed </span></div><div class="line"><span class="keyword">if</span> exist(<span class="string">'RandStream'</span>,<span class="string">'file'</span>)</div><div class="line">   RandStream.setGlobalStream(RandStream(<span class="string">'mt19937ar'</span>,<span class="string">'seed'</span>,seed));</div><div class="line"><span class="keyword">else</span></div><div class="line">   <span class="built_in">rand</span>(<span class="string">'state'</span>,seed); </div><div class="line">   <span class="built_in">randn</span>(<span class="string">'state'</span>,seed^<span class="number">2</span>);</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h3 id="NaN"><a href="#NaN" class="headerlink" title="NaN"></a>NaN</h3><p>NaN是Not a Number的缩写。当某变量显示NaN时，表示该变量是不明确的数值结果。比如0/0、inf/inf等运算会出现NaN报错。遇到这种情况，首先判断NaN出现在哪一步：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="built_in">isnan</span>(norres)    <span class="comment">%括号里是变量名。判断norres是否为NaN，若是，则在该步暂停程序。</span></div><div class="line">    keyboard;</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>再在命令窗里单独查看与该变量有关的其他变量，从而排除正常变量，获知究竟是哪个或哪几个变量出了问题，变为无穷大或无穷小。再检查与这些变量有关的算法。</p>
<h3 id="SaveAs"><a href="#SaveAs" class="headerlink" title="SaveAs"></a>SaveAs</h3><p>若需要比较各参数对算法性能的影响，通常是在程序中修改参数运行，得到算法收敛精度与迭代次数的曲线图。再根据曲线图反向思考修改哪些参数有效。这个过程需要保存产生的大量图片。可以使用<code>hold on</code>命令将所有虚线画在同一张图上，也可以使用<code>saveas</code>将所有图片自动保存。</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">%% plot</span></div><div class="line">figure(<span class="number">1</span>)</div><div class="line">semilogy(<span class="number">1</span>:iter,y_axis(<span class="number">1</span>:iter),<span class="string">'b-'</span>);  <span class="comment">%b：蓝色。－：线段形状</span></div><div class="line">set(gca,<span class="string">'fontsize'</span>,<span class="number">12</span>);</div><div class="line">grid on;</div><div class="line">xlabel(<span class="string">'\fontsize&#123;12&#125;\it Iteration'</span>); ylabel(<span class="string">'\fontsize&#123;12&#125;\it Normalized residual'</span>);</div><div class="line">legend(<span class="string">'\fontsize&#123;12&#125;\it text'</span>);       <span class="comment">%text：这条蓝色代表什么</span></div><div class="line">hold on</div><div class="line">saveas(gcf,<span class="string">'filename'</span>,<span class="string">'fig'</span>)           <span class="comment">%filename：将图片保存为这个名字。fig：保存为fig格式</span></div></pre></td></tr></table></figure>
<p>保存变量数据的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">save(&apos;filename&apos;)</div><div class="line">save(&apos;filename&apos;,&apos;variables&apos;)</div></pre></td></tr></table></figure>
<p>注意，在使用<code>hold on</code>命令时，应该保留上次程序运行后产生的各种数据。即不能在程序中写类似与<code>clear all</code>之类的清除语句，否则上次曲线图也将被删除。</p>
<h3 id="矩阵规范化"><a href="#矩阵规范化" class="headerlink" title="矩阵规范化"></a>矩阵规范化</h3><p>已知满秩矩阵A，进行下面操作使其所有奇异值均为1。</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[u s v]=svd(A);</div><div class="line">A=u*v';</div></pre></td></tr></table></figure>
<h3 id="安装CVX"><a href="#安装CVX" class="headerlink" title="安装CVX"></a>安装CVX</h3><ol>
<li>将cvx压缩包解压</li>
<li>将cvx文件夹拷贝至如D:\MATLAB Programs\Compressed Sensing目录下</li>
<li>在Current Folder窗口中打开cvx文件夹</li>
<li>在Command Window中输入cvx_setup</li>
<li>在MATLAB的File菜单下的set path把此路径加上。</li>
<li>把路径加进去后在file→Preferences→General的Toolbox Path Caching里点击update Toolbox Path Cache更新一下</li>
<li>完成</li>
</ol>
<h3 id="分段运行程序"><a href="#分段运行程序" class="headerlink" title="%%分段运行程序"></a>%%分段运行程序</h3><ol>
<li>选中%%分段</li>
<li>右键选择<code>evaluate current section</code></li>
</ol>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-09-17T08:45:30.910Z"><a href="/2017/09/17/科研/2014-08-31-Papers-about-average-consensus/">2017-09-17</a></time>
      
      
  
    <h1 class="title"><a href="/2017/09/17/科研/2014-08-31-Papers-about-average-consensus/">动态一致平均问题算法-EXTRA和DAC</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#EXTRA"><span class="toc-text">EXTRA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DAC"><span class="toc-text">DAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优缺点比较"><span class="toc-text">优缺点比较</span></a></li></ol>
    </div>

      
        <h3 id="EXTRA"><a href="#EXTRA" class="headerlink" title="EXTRA"></a>EXTRA</h3><p><a href="http://www.codecogs.com/eqnedit.php?latex=x_{(i)}^1=\sum_{j&space;=&space;1}^Nw_{ij}x_{(j)}^0-\alpha&space;\nabla&space;f_i(x_{(i)}^0)\\&space;\\&space;\\&space;x_{(i)}^{k&plus;2}=x_{(i)}^{k&plus;1}&plus;\sum_{j=1}^Nw_{ij}x_{(j)}^{k&plus;1}-\sum_{j=1}^N\tilde{w}_{ij}x_{(j)}^k-\alpha[\nabla&space;f_i(x_{(i)}^{k&plus;1})-\nabla&space;f_i(x_{(i)}^{k})]" target="_blank"><img src="http://latex.codecogs.com/gif.latex?x_{(i)}^1=\sum_{j&space;=&space;1}^Nw_{ij}x_{(j)}^0-\alpha&space;\nabla&space;f_i(x_{(i)}^0)\\&space;\\&space;\\&space;x_{(i)}^{k&plus;2}=x_{(i)}^{k&plus;1}&plus;\sum_{j=1}^Nw_{ij}x_{(j)}^{k&plus;1}-\sum_{j=1}^N\tilde{w}_{ij}x_{(j)}^k-\alpha[\nabla&space;f_i(x_{(i)}^{k&plus;1})-\nabla&space;f_i(x_{(i)}^{k})]" title="x_{(i)}^1=\sum_{j = 1}^Nw_{ij}x_{(j)}^0-\alpha \nabla f_i(x_{(i)}^0)\\ \\ \\ x_{(i)}^{k+2}=x_{(i)}^{k+1}+\sum_{j=1}^Nw_{ij}x_{(j)}^{k+1}-\sum_{j=1}^N\tilde{w}_{ij}x_{(j)}^k-\alpha[\nabla f_i(x_{(i)}^{k+1})-\nabla f_i(x_{(i)}^{k})]"></a></p>
<h3 id="DAC"><a href="#DAC" class="headerlink" title="DAC"></a>DAC</h3><p><a href="http://www.codecogs.com/eqnedit.php?latex=x_i(t&plus;1)=x_i(t)&plus;\sum_{j&space;\neq&space;i}a_{ij}(t)(x_i(t)-x_i(t))&plus;r_i(t)-r_i(t-1)" target="_blank"><img src="http://latex.codecogs.com/gif.latex?x_i(t&plus;1)=x_i(t)&plus;\sum_{j&space;\neq&space;i}a_{ij}(t)(x_j(t)-x_i(t))&plus;r_i(t)-r_i(t-1)" title="x_i(t+1)=x_i(t)+\sum_{j \neq i}a_{ij}(t)(x_i(t)-x_i(t))+r_i(t)-r_i(t-1)"></a></p>
<h3 id="优缺点比较"><a href="#优缺点比较" class="headerlink" title="优缺点比较"></a>优缺点比较</h3><p>其中，DAC最大的缺点在于第一次迭代时对于r(-1)时刻的依赖，在实际仿真中，如果需要对动态输入求一致平均，往往并不能获取输入在-1时刻的值。导致在矩阵补全问题中，DAC做不精确的动态一致平均的子问题效果并不好。</p>
<p>而EXTRA却有很好的效果。</p>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-09-17T08:45:30.910Z"><a href="/2017/09/17/科研/2014-08-22-Average-Consensus/">2017-09-17</a></time>
      
      
  
    <h1 class="title"><a href="/2017/09/17/科研/2014-08-22-Average-Consensus/">对于一致平均问题的理解</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        
    </div>

      
        <p>最近几个月在研究分布式低秩矩阵补全的问题，参考文章<a href="http://painterlin.com/2014/07/25/matrix-completion.html" target="_blank" rel="external">《低秩矩阵补全》</a>。</p>
<p>低秩矩阵补全问题的各类算法中，很关键的一个子问题叫做一致平均问题(Average Consensus)，而上一篇文章并没有对这个问题进行说明。那么，什么叫做“一致平均”呢？</p>
<p>###问题阐释：</p>
<div>考虑一个有<img src="http://latex.codecogs.com/gif.latex?L" title="L">个节点的网络，每个节点上存储一个关于自己的数值信息，叫做初值。一致平均问题就是使所有节点在算法停止的时候收敛到<img src="http://latex.codecogs.com/gif.latex?L" title="L">个初值的平均。<br></div>

<div>在分布式算法中，通常会存在这样一个变量<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}" title="\mathbf{X}">，它作为公有信息在网络中传递，每个节点储存自己的<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}_{(i)}" title="\mathbf{X}_{(i)}">。在总算法的每一次迭代中，每个节点<img src="http://latex.codecogs.com/gif.latex?i" title="i">接收自己邻居节点传递过来的公有信息，然后与自己的私有信息共同计算出新的公有信息，并传给自己的邻居。我们需要保证每个节点上的公有信息<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}_{(i)}=\mathbf{X}_{(j)}" title="\mathbf{X}_{(i)}=\mathbf{X}_{(j)}">，使分布的算法以某种方式交流合作，以便获得最优解。这就是分布式算法中的一致平均问题。</div>

<p>###问题分类：<br>根据节点上的数值信息是否随时间变化，又把一致平均问题分为：</p>
<ul>
<li>静态一致平均 (Static average consensus)</li>
<li>动态一致平均 (Dynamic average consensus)</li>
</ul>
<div><br>顾名思义，静态一致平均指节点上的初值不会发生变化，只需要保证最后每个节点都收敛到<img src="http://latex.codecogs.com/gif.latex?L" title="L">个初值的平均值即可；而动态一致平均则是，节点上的数值不断发生变化，即<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}_{(i)}" title="\mathbf{X}_{(i)}">在<img src="http://latex.codecogs.com/gif.latex?t" title="t">时刻的值并不一定与0时刻的值（初值）相同，我们使用不断变化的公有信息（因为公有信息不断在被更新），仍需要保证最后每个节点都收敛到<img src="http://latex.codecogs.com/gif.latex?L" title="L">个初值的平均。相比于静态一致平均，动态一致平均问题更为棘手。<br></div>

<p>###求解方法分类：<br>在文章《低秩矩阵补全》的最后，提供一种求解方法的分类概念，将方法分为：</p>
<ul>
<li>精确一致平均 (Exact average consensus)</li>
<li>不精确一致平均 (Inexact average consensus)</li>
</ul>
<p>这又是什么意思呢？</p>
<div><br>在解决分布式低秩矩阵补全问题的时候，我们将算法分解两个子问题不断求解，一是交替极小化(Alternating minimization)得到每个节点的新的<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}" title="\mathbf{X}">,<img src="http://latex.codecogs.com/gif.latex?\mathbf{Y}" title="\mathbf{Y}">；二是在网络中对<img src="http://latex.codecogs.com/gif.latex?L" title="L">个节点的<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}" title="\mathbf{X}">求一致平均。对于第二个子问题，在每一次算法总的迭代中，都去求解精确的一致平均显然能够解决问题，但是因为一致平均也需要一定次数的迭代才能被解除，如果在总算法的每一次迭代中都去求精确的一致平均，则相当耗费计算资源，增加了算法的时间复杂度。<br></div>

<p>很自然地，我们会想到，既然一致平均只是矩阵补全的一个子问题，我们是不是可以通过某种松弛，来降低算法的时间复杂度并节省计算资源，同时仍旧保证总算法的收敛呢。这样，就提出了不精确的一致平均。</p>
<div><br>不精确一致平均，就是在每一次求解一致平均子问题时，只迭代一次或者若干次，而不是迭代所有<img src="http://latex.codecogs.com/gif.latex?N" title="N">次（<img src="http://latex.codecogs.com/gif.latex?N" title="N">可以很大），使每个节点<code>近似</code>的达到它们初值的均值。<br></div>

<p>###精确一致平均与不精确一致平均优缺点比较:</p>
<ul>
<li>精确(Exact)求解：理论上容易证明，但计算代价通常比inexact方法高</li>
<li>不精确(Inexact)求解：理论分析上不好证明，除此之外具有exact不具有的所有优点，比如算法时间复杂度低，节省计算资源等等。</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-09-17T08:45:30.894Z"><a href="/2017/09/17/科研/2014-07-27-norms-of-vector-and-matrix/">2017-09-17</a></time>
      
      
  
    <h1 class="title"><a href="/2017/09/17/科研/2014-07-27-norms-of-vector-and-matrix/">各类范数</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        
    </div>

      
        <p>###向量范数<br><img src="/public/img/posts/vector_norms.JPG" alt="vector_norms"></p>
<p>###矩阵范数<br><img src="/public/img/posts/matrix_norms.JPG" alt="matrix_norms"></p>
<p>###矩阵乘积的迹<br><img src="/public/img/posts/trace.JPG" alt="trace"></p>
<p>###特殊范数</p>
<ul>
<li>矩阵W的L2-1范数：<br><img src="/public/img/posts/2_1norm.png" alt="2_1norm"></li>
</ul>
<p>###TV范数<br>||L(x)||_1。 其中L是差分算子，x是某种数字信号，在一维情况下，如下所示：</p>
<p>||L(x)||_1 = |x2-x1| + |x3-x2| + |x4-x3| + ……</p>
<p>加TV范数的目的是为了使求得的去噪信号仍然具有分段连续的性质。因为差值的1范数说明差值稀疏，从而说明求得的信号分段连续。</p>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-09-17T08:45:30.894Z"><a href="/2017/09/17/科研/2014-07-25-matrix-completion/">2017-09-17</a></time>
      
      
  
    <h1 class="title"><a href="/2017/09/17/科研/2014-07-25-matrix-completion/">低秩矩阵补全</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        
    </div>

      
        <p>###问题描述:</p>
<div>如果有这样一个矩阵<img src="http://latex.codecogs.com/gif.latex?\mathbf{W}" title="\mathbf{W}"></div>

<ul>
<li>矩阵中有部分元素缺失</li><li>矩阵的秩<img src="http://latex.codecogs.com/gif.latex?rank(\mathbf{W})" title="rank(\mathbf{W})">相较于矩阵维数来说很小，并作为先验已知</li>



</ul>
<p>我们希望恢复那些缺失的元素，这个问题就是低秩矩阵补全问题。      </p>
<p>###思考过程:</p>
<ul>
<li>需要恢复一个低秩矩阵</li><li>直接想法是极小化矩阵的秩<img src="http://latex.codecogs.com/gif.latex?\min&space;rank(\mathbf{W})" title="\min rank(\mathbf{W})"></li><br><li>但是<img src="http://latex.codecogs.com/gif.latex?\min&space;rank(\mathbf{W})" title="\min rank(\mathbf{W})">的优化问题非凸，不好求解</li><br><li>核范数<img src="http://latex.codecogs.com/gif.latex?\left&space;\|&space;\mathbf{W}\right&space;\|_{*}" title="\left \| \mathbf{W}\right \|_{*}">是秩的凸近似，所以想到<img src="http://latex.codecogs.com/gif.latex?\min&space;\left&space;\|&space;\mathbf{W}\right&space;\|_{*}" title="\min \left \| \mathbf{W}\right \|_{*}"></li>


</ul>
<p>###极小化核范数的集中式算法:</p>
<div>求解<img src="http://latex.codecogs.com/gif.latex?\min&space;\left&space;\|&space;\mathbf{W}\right&space;\|_{*}" title="\min \left \| \mathbf{W}\right \|_{*}">的集中式算法有很多，比如：</div>

<ul>
<li>singular value thresholding algorithm</li>
<li>fixed-point shrinkage algorithm</li>
<li>proximal gradient algorithm</li>
<li>ADMM</li>
</ul>
<p>但如果矩阵规模和秩增大，以上算法的计算代价也增大，因为它们都需要求解奇异值分解(SVD)。SVD中求伪逆的步骤运算量大，很耗费资源。因此需要想更好的方法，避免极小化核范数。</p>
<p>###极小化分解矩阵之积的集中式方法:</p>
<p><div>将问题写为<img src="http://latex.codecogs.com/gif.latex?\min&space;\left&space;\|&space;\mathbf{Z}-\mathbf{X}\mathbf{Y}\right&space;\|_{F}" title="\min \left \| \mathbf{Z}-\mathbf{X}\mathbf{Y}\right \|_{F}">，其中<img src="http://latex.codecogs.com/gif.latex?\mathbf{Z}" title="\mathbf{Z}">是对<img src="http://latex.codecogs.com/gif.latex?\mathbf{W}" title="\mathbf{W}">的估计，在元素没有缺失的位置上<img src="http://latex.codecogs.com/gif.latex?\mathbf{Z}" title="\mathbf{Z}">和<img src="http://latex.codecogs.com/gif.latex?\mathbf{W}" title="\mathbf{W}">的元素相同，<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}" title="\mathbf{X}">,<img src="http://latex.codecogs.com/gif.latex?\mathbf{Y}" title="\mathbf{Y}">是对<img src="http://latex.codecogs.com/gif.latex?\mathbf{W}" title="\mathbf{W}">的乘法分解。介绍两种求解该问题的方法：</div></p>
<ul>
<li>nonlinear Gauss-Seidel method</li>
<li>nonlinear SOR(Successive Over-Relaxation)-like scheme:LMaFit</li>
</ul>
<p>其中SOR方法是GS方法的拓展，区别仅在于SOR方法中对于<strong>X</strong>的更新加了权重，并对权值进行更新。</p>
<p>###去中心式算法:</p>
<p><div>当矩阵规模大到一定程度时，集中式算法在计算能力上要求过高，普通计算机也许无法计算。这时，我们需要在由许多普通计算机作为节点组成的网络中运算，这需要实现去中心式计算。去中心式计算式很容易实现的，将<img src="http://latex.codecogs.com/gif.latex?\mathbf{W}" title="\mathbf{W}">,<img src="http://latex.codecogs.com/gif.latex?\mathbf{Z}" title="\mathbf{Z}">,<img src="http://latex.codecogs.com/gif.latex?\mathbf{Y}" title="\mathbf{Y}">分别切块放在每个节点上，将<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}" title="\mathbf{X}">作为公共信息在网络各个邻居节点间交换，优化问题形式不变，但需要加上<img src="http://latex.codecogs.com/gif.latex?\mathbf{X}_{(i)}=\mathbf{X}_{(j)}" title="\mathbf{X}_{(i)}=\mathbf{X}_{(j)}">的约束。而这样一个约束就引出了另一个子问题：一致平均(average consensus)问题。</div></p>
<p>关于一致平均问题的介绍请看：</p>
<ul>
<li><a href="http://painterlin.com/2014/08/22/Average-Consensus.html" target="_blank" rel="external">《对于一致平均问题的理解》</a></li>
<li><a href="http://painterlin.com/2014/08/31/Papers-about-average-consensus.html" target="_blank" rel="external">《动态一致平均问题的4篇论文》</a></li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-05-02T16:00:00.000Z"><a href="/2017/05/03/技术/Python-pip-requirement/">2017-05-03</a></time>
      
      
  
    <h1 class="title"><a href="/2017/05/03/技术/Python-pip-requirement/">pip requirements</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#requirements-txt的作用"><span class="toc-text">requirements.txt的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查找python项目依赖并生成requirements-txt"><span class="toc-text">查找python项目依赖并生成requirements.txt</span></a></li></ol>
    </div>

      
        <h3 id="requirements-txt的作用"><a href="#requirements-txt的作用" class="headerlink" title="requirements.txt的作用"></a>requirements.txt的作用</h3><p>在很多Python项目中都包含一个requirements.txt文件，里面写的是一些包的名称和版本信息。</p>
<p>描述运行这个项目所需要的环境，包括一些库。</p>
<p>可以使用<code>pip install -r requirements.txt</code>安装这些库。</p>
<h3 id="查找python项目依赖并生成requirements-txt"><a href="#查找python项目依赖并生成requirements-txt" class="headerlink" title="查找python项目依赖并生成requirements.txt"></a>查找python项目依赖并生成requirements.txt</h3><ul>
<li><p>将整个python环境的依赖包list出来，</p>
<p><code>pip freeze &gt; requirements.txt</code></p>
</li>
<li><p>list某个项目用到的依赖包,使用工具pipreqs ，但有的时候结果会有偏差(源码分析的不准确)</p>
<p><code>pip install pipreqs</code></p>
<p><code>pipreqs ./</code></p>
</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-04-12T16:00:00.000Z"><a href="/2017/04/13/技术/dolphin-exam/">2017-04-13</a></time>
      
      
  
    <h1 class="title"><a href="/2017/04/13/技术/dolphin-exam/">海豚笔试</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、Java部分"><span class="toc-text">1、Java部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、Python部分"><span class="toc-text">2、Python部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、机器学习"><span class="toc-text">3、机器学习</span></a></li></ol>
    </div>

      
        <blockquote>
<p>今天参加了一个实习生招聘的笔试，准备的不充分，错的惨不忍睹。整理一下遇到的题目。</p>
</blockquote>
<h3 id="1、Java部分"><a href="#1、Java部分" class="headerlink" title="1、Java部分"></a>1、Java部分</h3><p>试题有java和c++两种，以前上课学的C和Java早还给老师了，python的BIF用多了，发现连个排序算法都写不好了。</p>
<ul>
<li>考察java的类继承和静态方法</li>
</ul>
<ol>
<li><p>通过类名来调用子类中的静态变量和静态方法，当父类与子类相同时是，子类会隐藏父类中与其相同的静态变量和静态方法，如果子类中没有与其父类相同的静态变量和静态方法，子类从其父类调用过来的静态变量和静态方法就会表现出来。</p>
</li>
<li><p>通过子类创建对象来用对象名调用子类中的静态变量和静态方法，除非是父类没有的静态变量和静态方法，会显示其子类的静态变量和静态方法。否则，最后显示一定是从父类哪里引用来的静态变量和静态方法。</p>
</li>
</ol>
<p><img src="http://i1.piimg.com/567571/b0d17cd4aadfd6f3.png" alt=""></p>
<p><img src="http://i2.muimg.com/567571/0209cc264f8d4a42.png" alt=""></p>
<p><img src="http://i4.buimg.com/567571/3a8a5454ac34308f.png" alt=""></p>
<p><img src="http://i2.muimg.com/567571/abfaaa03127d63dc.png" alt=""></p>
<ul>
<li><p>考察Java String变量的比较及值比较</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//"=="操作符:用于基本数据类型的比较,判断引用是否指向同一内存块</span></div><div class="line"><span class="comment">//如果String缓冲池内不存在与其指定值相同的String对象，那么此时虚拟机将为此创建新的String对象，并存放在String缓冲池内。</span></div><div class="line"><span class="keyword">import</span> java.io.*;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span>  </span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String[] args)</span> <span class="keyword">throws</span> java.lang.Exception</span></div><div class="line"><span class="function">	</span>&#123;</div><div class="line">		String s1 = <span class="string">"helloworld"</span>;</div><div class="line">		String s2 = <span class="string">"hello"</span> + <span class="string">"world"</span>;</div><div class="line">	    String s0 = <span class="string">"helloworld"</span>;</div><div class="line">	    String s3 = <span class="keyword">new</span> String(<span class="string">"helloworld"</span>);</div><div class="line">		System.out.println(s1==s0);  <span class="comment">// true</span></div><div class="line">		System.out.println(s2==s0);  <span class="comment">// true</span></div><div class="line">		System.out.println(s1==s2);  <span class="comment">// true</span></div><div class="line">		System.out.println(s1.equals(s0)); <span class="comment">// true</span></div><div class="line">		System.out.println(s1.equals(s3)); <span class="comment">// true</span></div><div class="line">		System.out.println(s1==s3);  <span class="comment">//false</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//如果String缓冲池内存在与其指定值相同的String对象，那么此时虚拟机将不为此创建新的String对象，而直接返回已存在的String对象的引用。</span></div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>简单的算法，一个32位整数的数组，返回有序排列的2个相邻元素之差的最大值。整数是32位的，时间复杂度o(n)有加分。<a href="https://oj.leetcode.com/problems/maximum-gap/" target="_blank" rel="external">LeetCode</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 写了个最蠢的方法，冒泡排序，然后遍历数组，求最大的差值。时间复杂度在排序，o(n^2);</span></div><div class="line"><span class="comment">// 数据结构书里只记得o(n*logn)的排序算法，快速排序，插入排序，堆排序，选择排序o(n^2);</span></div><div class="line"><span class="comment">// 在整数取值范围有限的情况下，计数排序、基数排序和桶排序可以实现空间复杂度O(k),时间复杂度O(n)的排序</span></div><div class="line"><span class="comment">/* 思路：使用桶排序的原理，但桶的取值设为n-1，而不是整数的取值范围。桶内数据无序，桶间，用后一个桶的min 减去 前一个桶的max即可。</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MaxGap</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maximumGap</span><span class="params">(<span class="keyword">int</span>[] num)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">int</span> maxGap = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="comment">// edge case</span></div><div class="line">        <span class="keyword">if</span> (num.length &lt; <span class="number">2</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> maxGap;</div><div class="line">        &#125;</div><div class="line">      </div><div class="line">        <span class="comment">// get maximum and minimum</span></div><div class="line">        <span class="keyword">int</span> min = num[<span class="number">0</span>];</div><div class="line">        <span class="keyword">int</span> max = num[<span class="number">0</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num.length; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (num[i] &lt; min)</div><div class="line">                min = num[i];</div><div class="line">            <span class="keyword">if</span> (num[i] &gt; max)</div><div class="line">                max = num[i];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// divide into identical gaps</span></div><div class="line">        Gap[] gaps = <span class="keyword">new</span> Gap[num.length - <span class="number">1</span>];</div><div class="line">        <span class="keyword">boolean</span>[] Engaged = <span class="keyword">new</span> <span class="keyword">boolean</span>[num.length - <span class="number">1</span>];</div><div class="line">        <span class="keyword">double</span> gap = (<span class="keyword">double</span>) (max - min) / (<span class="keyword">double</span>) (num.length - <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; gaps.length; i++)</div><div class="line">            Engaged[Math.min((<span class="keyword">int</span>) Math.floor((<span class="keyword">double</span>) (num[i] - min) / gap), gaps.length - <span class="number">1</span>)] = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// assign maximum and minimum for each gap</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; gaps.length; i++)</div><div class="line">            gaps[i] = <span class="keyword">new</span> Gap();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num.length; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> index = (<span class="keyword">int</span>) Math.floor((<span class="keyword">double</span>) (num[i] - min) / gap);</div><div class="line">            index = Math.min(index, gaps.length - <span class="number">1</span>);</div><div class="line"></div><div class="line">            <span class="comment">// lower bound</span></div><div class="line">            <span class="keyword">if</span> (gaps[index].low == -<span class="number">1</span>)</div><div class="line">                gaps[index].low = num[i];</div><div class="line">            <span class="keyword">else</span></div><div class="line">                gaps[index].low = Math.min(gaps[index].low, num[i]);</div><div class="line"></div><div class="line">            <span class="comment">// upper bound</span></div><div class="line">            <span class="keyword">if</span> (gaps[index].high == -<span class="number">1</span>)</div><div class="line">                gaps[index].high = num[i];</div><div class="line">            <span class="keyword">else</span></div><div class="line">                gaps[index].high = Math.max(gaps[index].high, num[i]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// find maximum gap</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; gaps.length; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (Engaged[i])</div><div class="line">            &#123;</div><div class="line">                <span class="comment">// check its inner gap</span></div><div class="line">                maxGap = Math.max(gaps[i].high - gaps[i].low, maxGap);</div><div class="line"></div><div class="line">                <span class="comment">// lower all the way</span></div><div class="line">                <span class="keyword">int</span> j = i;</div><div class="line">                <span class="keyword">while</span> (--j &gt;= <span class="number">0</span>)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">if</span> (Engaged[j])</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (j &gt;= <span class="number">0</span>)</div><div class="line">                    maxGap = Math.max(gaps[i].low - gaps[j].high, maxGap);</div><div class="line"></div><div class="line">                <span class="comment">// upper all the way</span></div><div class="line">                j = i;</div><div class="line">                <span class="keyword">while</span> (++j &lt; num.length - <span class="number">2</span>)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">if</span> (Engaged[j])</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (j &lt; gaps.length)</div><div class="line">                    maxGap = Math.max(gaps[j].low - gaps[i].high, maxGap);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> maxGap;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Gap</span></span></div><div class="line"><span class="class">    </span>&#123;</div><div class="line">        <span class="keyword">int</span> low;</div><div class="line">        <span class="keyword">int</span> high;</div><div class="line">        <span class="keyword">boolean</span> hasItem;</div><div class="line"></div><div class="line">        Gap()</div><div class="line">        &#123;</div><div class="line">            low = -<span class="number">1</span>;</div><div class="line">            high = -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Gap(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</div><div class="line">        &#123;</div><div class="line">            low = x;</div><div class="line">            high = y;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">int</span>[] num = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>&#125;;</div><div class="line">        System.out.println((<span class="keyword">new</span> MaxGap()).maximumGap(num));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<h3 id="2、Python部分"><a href="#2、Python部分" class="headerlink" title="2、Python部分"></a>2、Python部分</h3><ul>
<li><p>下列不能创建字典的语句是 <code>dict1 = {[1,2,3]: &#39;use&#39;}</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">a = &#123;[<span class="number">1</span>,<span class="number">2</span> ,<span class="number">3</span>]: <span class="string">"user"</span>&#125;</div><div class="line">Traceback (most recent call last):</div><div class="line">  Python Shell, prompt <span class="number">6</span>, line <span class="number">1</span></div><div class="line">TypeError: unhashable type: <span class="string">'list'</span></div><div class="line"></div><div class="line">a = &#123;<span class="number">4</span>:<span class="number">5</span>&#125;        </div><div class="line">a = &#123;&#125;</div><div class="line">a = &#123;(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>): <span class="string">'use'</span>&#125;</div><div class="line"><span class="keyword">print</span> a</div><div class="line">&#123;(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>): <span class="string">'use'</span>&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Numpy数组的切片操作</p>
</li>
</ul>
<h3 id="3、机器学习"><a href="#3、机器学习" class="headerlink" title="3、机器学习"></a>3、机器学习</h3><ul>
<li><p>研究发现，买尿布的顾客中80%的也会同时购买啤酒，这属于数据挖掘的哪种问题？关联规则。</p>
</li>
<li><p>为了防止过拟合可以采取的<a href="http://blog.csdn.net/heyongluoyao8/article/details/49429629" target="_blank" rel="external">方法</a>，正则化，early stopping，数据集扩增，Dropout(神经网络)。</p>
</li>
<li><p>分类和回归的区别，应用场景，常见的算法</p>
<p>分类和回归的区别在于输出变量的类型。</p>
<p>定量输出称为回归，或者说是连续变量预测；预测明天的气温是多少度，这是一个回归任务；<br>定性输出称为分类，或者说是离散变量预测。预测明天是阴、晴还是雨，就是一个分类任务。</p>
<p>常见算法？好像很多算法思想都既能用于回归，也能用于分类。分类和回归应该有内在联系，</p>
<p><strong>标记一下，以后深入学习后补充</strong></p>
<p><img src="http://i4.buimg.com/567571/25582df73feeb3a8.jpg" alt=""></p>
</li>
<li><p>逻辑回归中的常用激励函数</p>
<p>记得神经网络里有sigmod函数做激励函数，逻辑回归？</p>
<p>logistic回归<strong>此处留疑，后面再补充</strong></p>
</li>
<li><p>描述你熟悉的神经网络和它们的特征</p>
<p>重要的人工神经网络算法包括：感知器神经网络（Perceptron Neural Network）, 反向传递（Back Propagation）， Hopfield网络，自组织映射（Self-Organizing Map, SOM）。学习矢量量化（Learning Vector Quantization， LVQ） </p>
<p><strong>都不熟悉，先去看书了:cry:</strong></p>
<p>​</p>
</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="book">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-03-10T16:00:00.000Z"><a href="/2017/03/11/阅读/Book-List-2017-Q1/">2017-03-11</a></time>
      
      
  
    <h1 class="title"><a href="/2017/03/11/阅读/Book-List-2017-Q1/">2017年Q1阅读书单</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        
    </div>

      
        
      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-03-01T16:00:00.000Z"><a href="/2017/03/02/技术/scrapy-redis分布式爬虫入门/">2017-03-02</a></time>
      
      
  
    <h1 class="title"><a href="/2017/03/02/技术/scrapy-redis分布式爬虫入门/">scrapy-redis 分布式爬虫</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#scrapy-redis-分布式爬虫"><span class="toc-text">scrapy-redis 分布式爬虫</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装和配置"><span class="toc-text">安装和配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#作用和特点"><span class="toc-text">作用和特点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初步使用"><span class="toc-text">初步使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#settings参数"><span class="toc-text">settings参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#scrapy-redis使用方法"><span class="toc-text">scrapy-redis使用方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分布式爬取"><span class="toc-text">分布式爬取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接运行多个爬虫"><span class="toc-text">直接运行多个爬虫</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用docker部署爬虫"><span class="toc-text">利用docker部署爬虫</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#导出redis中的items"><span class="toc-text">导出redis中的items</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>

      
        <h1 id="scrapy-redis-分布式爬虫"><a href="#scrapy-redis-分布式爬虫" class="headerlink" title="scrapy-redis 分布式爬虫"></a>scrapy-redis 分布式爬虫</h1><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><h4 id="安装和配置"><a href="#安装和配置" class="headerlink" title="安装和配置"></a>安装和配置</h4><ul>
<li>安装redis数据库 </li>
<li><code>pip install scrapy redis-py scrapy-redis</code></li>
</ul>
<h4 id="作用和特点"><a href="#作用和特点" class="headerlink" title="作用和特点"></a>作用和特点</h4><blockquote>
<p>scrapy-redis是为Scrapy提供redis支持以实现分布式爬虫的组件</p>
</blockquote>
<ul>
<li>多个爬虫共享一个redis队列（分配request）</li>
<li>分布式的post处理。将爬到的items也放入redis队列，因而可以实现items的分布式处理。</li>
</ul>
<p>scrapy-redis仅仅为scrapy提供了部分基于redis的组件，可以查看源码。</p>
<ul>
<li>pipeline</li>
<li>scheluder</li>
<li>redis队列替换原有的scrapy队列</li>
<li>过滤器 Duplication</li>
</ul>
<h3 id="初步使用"><a href="#初步使用" class="headerlink" title="初步使用"></a>初步使用</h3><h4 id="settings参数"><a href="#settings参数" class="headerlink" title="settings参数"></a><strong>settings参数</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Enables scheduling storing requests queue in redis.</span></div><div class="line">SCHEDULER = <span class="string">"scrapy_redis.scheduler.Scheduler"</span></div><div class="line"></div><div class="line"><span class="comment"># Ensure all spiders share same duplicates filter through redis.</span></div><div class="line">DUPEFILTER_CLASS = <span class="string">"scrapy_redis.dupefilter.RFPDupeFilter"</span></div><div class="line"></div><div class="line"><span class="comment"># Don't cleanup redis queues, allows to pause/resume crawls.</span></div><div class="line">SCHEDULER_PERSIST = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="comment"># Schedule requests using a priority queue. (default)</span></div><div class="line">SCHEDULER_QUEUE_CLASS = <span class="string">'scrapy_redis.queue.PriorityQueue'</span></div><div class="line"><span class="comment"># Alternative queues.</span></div><div class="line"><span class="comment">#SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.FifoQueue'</span></div><div class="line"><span class="comment">#SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.LifoQueue'</span></div><div class="line"></div><div class="line"><span class="comment"># Max idle time to prevent the spider from being closed when distributed crawling.</span></div><div class="line"><span class="comment"># This only works if queue class is SpiderQueue or SpiderStack,</span></div><div class="line"><span class="comment"># and may also block the same time when your spider start at the first time (because the queue is empty).</span></div><div class="line"><span class="comment">#SCHEDULER_IDLE_BEFORE_CLOSE = 10</span></div><div class="line"></div><div class="line"><span class="comment"># Store scraped item in redis for post-processing.</span></div><div class="line">ITEM_PIPELINES = &#123;</div><div class="line">    <span class="string">'scrapy_redis.pipelines.RedisPipeline'</span>: <span class="number">300</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Specify the host and port to use when connecting to Redis (optional).</span></div><div class="line"><span class="comment">#REDIS_HOST = 'localhost'</span></div><div class="line"><span class="comment">#REDIS_PORT = 6379</span></div><div class="line"></div><div class="line"><span class="comment"># Specify the full Redis URL for connecting (optional).</span></div><div class="line"><span class="comment"># If set, this takes precedence over the REDIS_HOST and REDIS_PORT settings.</span></div><div class="line">REDIS_URL = <span class="string">'redis://user:pass@hostname:9001'</span></div><div class="line"></div><div class="line"><span class="comment"># Use other encoding than utf-8 for redis.默认utf-8</span></div><div class="line">REDIS_ENCODING = <span class="string">'latin1'</span></div></pre></td></tr></table></figure>
<h4 id="scrapy-redis使用方法"><a href="#scrapy-redis使用方法" class="headerlink" title="scrapy-redis使用方法"></a>scrapy-redis使用方法</h4><ul>
<li><p>首先用scrapy实现一个爬虫，然后在替换其中的组件为scrapy-redis</p>
<p>setting里修改：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># setting.py</span></div><div class="line">BOT_NAME = <span class="string">'moko1'</span></div><div class="line"></div><div class="line">SPIDER_MODULES = [<span class="string">'moko1.spiders'</span>]</div><div class="line">NEWSPIDER_MODULE = <span class="string">'moko1.spiders'</span></div><div class="line"></div><div class="line"><span class="comment"># 使用scrapy-redis的去重和调度器组件</span></div><div class="line">DUPEFILTER_CLASS = <span class="string">"scrapy_redis.dupefilter.RFPDupeFilter"</span></div><div class="line">SCHEDULER = <span class="string">"scrapy_redis.scheduler.Scheduler"</span></div><div class="line">SCHEDULER_PERSIST = <span class="keyword">True</span></div><div class="line"></div><div class="line">ITEM_PIPELINES = &#123;</div><div class="line"><span class="comment"># 会将items放入redis队列中</span></div><div class="line"><span class="string">'scrapy_redis.pipelines.RedisPipeline'</span>: <span class="number">400</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>spiders里修改：</p>
<p><strong>spider类</strong>从scrapy_redis.spiders导入，有RedisSpider和RedisCrawlSpider，对应scrapy原来的Spider和CrawlSpider。</p>
<p><strong>start_urls</strong>改为从redis中某个key获取，因此redis_key = ‘moko_spider:start_urls’，然后向该key push数据。</p>
<p>直接给出start_urls也是可行的，但是不太符合redis队列及分布式的逻辑，而且不能手动动态添加。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</div><div class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> Rule</div><div class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span>  Moko1Item</div><div class="line"><span class="keyword">from</span> scrapy_redis.spiders <span class="keyword">import</span> RedisCrawlSpider</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MokoSpiderSpider</span><span class="params">(RedisCrawlSpider)</span>:</span> <span class="comment"># 修改此处</span></div><div class="line">    name = <span class="string">'moko_spider'</span></div><div class="line">    allowed_domains = [<span class="string">'moko.cc'</span>]</div><div class="line">    start_urls = [<span class="string">'http://www.moko.cc/moko/post/1.html'</span>]  <span class="comment"># 修改此处</span></div><div class="line">    <span class="comment"># redis_key = 'moko_spider:start_urls'</span></div><div class="line">  </div><div class="line">    rules = (</div><div class="line">        Rule(LinkExtractor(allow=<span class="string">r'http://www\.moko\.cc/post/\d+\.html'</span>), callback=<span class="string">'parse_item'</span>, follow=<span class="keyword">True</span>),</div><div class="line">    )</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></div><div class="line">        item = Moko1Item()</div><div class="line">        item[<span class="string">'name'</span>] = response.css(<span class="string">"#workNickName::text"</span>).extract()[<span class="number">0</span>]</div><div class="line">        <span class="keyword">return</span> item</div></pre></td></tr></table></figure>
</li>
<li><p>确保redis数据库运行，清空数据库<code>flushdb</code>, “moko_spider:dupefilter”保存了我上次执行时已经爬取过的url信息。再次执行会被过滤掉，scrapy的去重机制。</p>
</li>
<li><p>然后启动scrapy爬虫，然后向redis_key = ‘moko_spider:start_urls’中push数据，在redis-cli客户端中执行<code>lpush moko_spider:start_urls https://moko.cc/1.html</code></p>
</li>
<li><p>如果启用了scrapy_redis.pipelines.RedisPipeline，items会存储在moko_spider:items中。可以将items不断的pop出来，并进行其他处理，如存储等。(感觉这种活应该交给一个pipeline干)</p>
</li>
</ul>
<h3 id="分布式爬取"><a href="#分布式爬取" class="headerlink" title="分布式爬取"></a>分布式爬取</h3><h4 id="直接运行多个爬虫"><a href="#直接运行多个爬虫" class="headerlink" title="直接运行多个爬虫"></a>直接运行多个爬虫</h4><blockquote>
<p>上面的单个爬虫默认从localhost的Redis数据库中存取request和爬到的items，</p>
<p>而实现分布式爬虫只需要为爬虫指定Redis数据库的网络位置，所有的爬虫都去redis队列里存取。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># settings.py</span></div><div class="line">REDIS_URL = <span class="string">'redis://user:mima@localhost:6379'</span> </div><div class="line"><span class="comment"># 或者不带密码的</span></div><div class="line">REDIS_HOST = <span class="string">'localhost'</span></div><div class="line">REDIS_PORT = <span class="number">6379</span></div></pre></td></tr></table></figure>
<ul>
<li><p>配置redis允许远程访问</p>
<p>修改配置文件/etc/redis.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># bind 127.0.0.1</div><div class="line">requirepass mima  # 设置密码</div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>关于<strong>主从模式</strong></p>
<p>分布式架构一般分为主从模式和P2P模式。有的人认为scrapy-redis中安装有redis数据库的节点就是master，错的！</p>
<p>scrapy-redis中的每只爬虫都是平级的，没有主从之分。每只爬虫都是主动请求任务，执行任务，爬到的数据也可以提交给redis。redis的request队列为空时，爬虫处于饥饿状态。</p>
<p>scrapy-redis仅仅是把scrapy原来得本地队列放入redis数据库中，从通信和数据传输的角度来看，redis像是一个master，而实际上redis对爬虫没做任何控制和操作，只是被动的为它们提供数据。</p>
</li>
</ul>
<h4 id="利用docker部署爬虫"><a href="#利用docker部署爬虫" class="headerlink" title="利用docker部署爬虫"></a>利用docker部署爬虫</h4><ul>
<li><p>创建一个docker镜像并配置scrapy环境，这样下次就能恢复环境直接使用了</p>
<ul>
<li>首先在daocloud申请一台胶囊主机，然后ssh登录上去，配置scrapy环境</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 使用ubuntu的docker镜像</span></div><div class="line">docker run -it  daocloud.io/ubuntu:14.04 /bin/bash</div><div class="line">apt-get update </div><div class="line">apt-get install lrzsz</div><div class="line">apt-get install python2.7 python-pip python-dev</div><div class="line">apt-get install libxml2-dev libxslt-dev  python-lxml # 安装lxml</div><div class="line">apt-get install build-essential libssl-dev  libffi-dev</div><div class="line">pip install  six --upgrade</div><div class="line">python -m pip install pyparsing appdirs</div><div class="line">pip install  cryptography</div><div class="line">pip install pymongo redis twisted scrapy scrapy-redis</div><div class="line">exit # 退出docker，记住id，docker id root@ea0d832b19bb</div></pre></td></tr></table></figure>
<ul>
<li>打包上传镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 打包镜像，docker容器的id ea0d832b19bb</span></div><div class="line">~$ docker commit -m "ubuntu with scrapy_redis" -a "author——info" ea0d832b19bb scrapy-redis</div><div class="line">sha256:53a605ccc92ab29bba70f9f026c002a9c4afa43fb9b14a9819d5859f51b0d586</div><div class="line">~$ docker images # 查看镜像</div><div class="line"><span class="meta">#</span><span class="bash"> 为镜像打上tag</span></div><div class="line">docker tag scrapy-redis syy2358/scrapy-redis:latest</div><div class="line"><span class="meta">#</span><span class="bash"> 上传至dockerhub托管</span></div><div class="line">docker login # 先注册并登录dockerhub，创建一个托管仓库scrapy-redis</div><div class="line">docker push syy2358/scrapy-redis:lastest # 将镜像上传至dockerhub</div><div class="line"><span class="meta">#</span><span class="bash"> 胶囊主机只有2小时，hub上传速度又慢，只好打包镜像文件下载到我的电脑上。</span></div><div class="line">docker save ea0d832b19bb &gt; /home/ubuntu/scrapy-redis.tar</div><div class="line"><span class="meta">#</span><span class="bash"> 可以在有docker的电脑上恢复该容器，</span></div><div class="line">docker load &lt; scrapy-redis.tar</div><div class="line"><span class="meta">#</span><span class="bash"> 或者直接拉dockerhub/daocloud上的镜像用就行了</span></div><div class="line">docker pull syy2358/scrapy-redis</div><div class="line">docker run -it xx.xx</div><div class="line"><span class="meta">#</span><span class="bash"> 导出 <span class="built_in">export</span> 和save的区别- 导入 import</span></div><div class="line"><span class="meta">#</span><span class="bash"> save保存了容器的运行状态，支持回滚，但是数据较大。</span></div></pre></td></tr></table></figure>
<ul>
<li><p>​<strong>自己配置环境各种报错，主要是下载链接超时，用daocloud就很顺利  </strong></p>
<blockquote>
<p>首先自己编译docker镜像容易遇到各种错误，而且dockerhub的镜像push、pull的速度巨慢，估计是被墙了，所以决定改用daocloud在线编译发布镜像，编译和pull的速度都很快。</p>
</blockquote>
<p>镜像制作过程：</p>
<ol>
<li>在自己 GitHub 创建新的 repository 。</li>
<li>将爬虫的代码，包含<code>Dockerfile</code> push 到自己刚创建的 repository。</li>
<li>到 <code>https://dashboard.daocloud.io/build-flows/new</code> ，项目名称 <code>scrapy</code>，选择自己刚在 GitHub 创建的 repository同步代码，开始创建，选择<code>分支：master</code>，手动执行。如果失败，可以先看下流程定义里的构建阶段，修改任务，选择云端Dockerfile。</li>
<li>到 <code>https://dashboard.daocloud.io/packages</code> 选择 <code>scrapy</code>，设置 -&gt; 镜像访问控制 -&gt; 公开,设置tag为latest。</li>
<li><code>https://dashboard.daocloud.io/packages/</code>选择scrapy后，版本 -&gt; latest 。然后可以部署到已经接入的docker或者云测试环境(右上角打开控制台，能进入web版的终端，在里面执行scrapy crawl spider即可)。</li>
<li>或者在自己的docker环境下，使用<code>docker run -it daocloud.io/blue_whale/scrapy</code>,然后就能看到爬虫在运行了</li>
</ol>
</li>
<li><p>镜像地址</p>
<p><code>daocloud.io/blue_whale/scrapy</code> : daocloud上的，速度很快</p>
<p><code>syy2358/scrapy-redis</code>: dockerhub上的，巨慢</p>
<p>​</p>
</li>
</ul>
</li>
<li><p>运行爬虫</p>
<ol>
<li><p>上传源码，并从Dockerfile build镜像，然后运行爬虫</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 项目结构</span></div><div class="line">.</div><div class="line">├── docker-compose.yml</div><div class="line">├── Dockerfile</div><div class="line">├── moko1</div><div class="line">│   ├── __init__.py</div><div class="line">│   ├── items.py</div><div class="line">│   ├── pipelines.py</div><div class="line">│   ├── settings.py</div><div class="line">│   └── spiders</div><div class="line">│       ├── __init__.py</div><div class="line">│       ├── moko_spider.py</div><div class="line">├── requirements.txt</div><div class="line">└── scrapy.cfg</div><div class="line"></div><div class="line">---------------------------</div><div class="line"></div><div class="line"><span class="comment"># docker-compose.yml</span></div><div class="line">version: '2'</div><div class="line">services:</div><div class="line">  spider:</div><div class="line">    build: .</div><div class="line">    volumes:</div><div class="line">     - .:/code</div><div class="line"></div><div class="line">------------------------</div><div class="line"></div><div class="line"><span class="comment"># Dockerfile</span></div><div class="line">FROM syy2358/scrapy-redis</div><div class="line">ENV PATH /usr/local/bin:$PATH</div><div class="line">ADD . /code</div><div class="line">WORKDIR /code</div><div class="line">RUN pip install -r requirements.txt</div><div class="line"><span class="comment"># COPY spiders.py /usr/local/lib/python3.5/site-packages/scrapy_redis</span></div><div class="line">CMD scrapy crawl moko_spider</div></pre></td></tr></table></figure>
<p>我的redis服务器是在腾讯云上的，没有使用docker。</p>
<p>如果redis在docker中运行的话，需要在<code>docker-compose.yml</code>中定义redis的container，将spider和redis link起来，同时redis需要映射端口6379，这样不同的container之间才能相互通信。</p>
<p>使用docker-compose创建container</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">pip install docker-compose</div><div class="line"> rz -E  # 上传爬虫源码</div><div class="line"> docker-compose up #从 docker-compose.yml 中创建 `container`</div><div class="line"> docker-compose scale spider=4 #将 spider 这一个服务扩展到4个container</div><div class="line"><span class="meta"> #</span><span class="bash"> 会有4个scrapy爬虫运行，处于饥饿状态，因为刚开始start_urls为空，直到我们pushurl去feed爬虫，爬虫才会开始抓取工作。</span></div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>
</li>
</ul>
<ol>
<li><p>方法二，使用已经build好的docker镜像(爬虫代码也已经copy进去了)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker run -it daocloud.io/blue_whale/scrapy</div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 或者</span></span></div><div class="line">docker run -it syy2358/scrapy-redis</div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">## Ctrl+P+Q 将当前container放入后台，回到docker界面</span></span></div><div class="line">docker ps -a ## 查看正在运行的container</div><div class="line">docker attach  id  # 连接入正在执行的container</div></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li><p>退出attach的docker container</p>
<p>用1执行爬虫时真惨，attach上container退不出去，scrapy不停地输出log内容，按啥键都不好使，只好退出ssh重连T.T，重连后发现原来的container仍在运行中。</p>
<p>正常attach上一个container，可以Ctrl+P+Q退出再后台执行，或exit终止运行并退出container。</p>
<p>使用<a href="http://lib.csdn.net/base/docker" target="_blank" rel="external">Docker</a> attach命名进入docker容器后：</p>
<p>【场景一】如果要正常退出不关闭容器，请按Ctrl+P+Q进行退出容器。</p>
<p>【场景二】如果使用exit退出，那么在退出容器后会关闭容器，如下图所示。</p>
</li>
<li><p>总结</p>
<p>只需要配置一次scrapy的docker运行环境，上传代码，然后将container打包成镜像，就可以在任何有docker的地方pull下镜像运行。</p>
<p>docker挺有意思的，项目部署非常方便，不过我这个新手对docker只是一知半解。</p>
</li>
</ul>
<h4 id="导出redis中的items"><a href="#导出redis中的items" class="headerlink" title="导出redis中的items"></a>导出redis中的items</h4><ul>
<li><p>linux下使用redis-dump <code>redis-dump -u 127.0.0.1:6379 &gt; db_full.json</code></p>
</li>
<li><p>将数据导入mongodb中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> redis</div><div class="line"><span class="keyword">import</span> pymongo</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    r = redis.Redis(host=<span class="string">'192.168.1.112'</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>)</div><div class="line">    client = pymongo.MongoClient(host=<span class="string">'localhost'</span>, port=<span class="number">27017</span>)</div><div class="line">    db = client[<span class="string">'dmoz'</span>]</div><div class="line">    sheet = db[<span class="string">'sheet'</span>]</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="comment"># 将队列里的数据逐条pop出来，并插入mongodb中</span></div><div class="line">        <span class="comment"># process queue as FIFO, change `blpop` to `brpop` to process as LIFO</span></div><div class="line">        source, data = r.blpop([<span class="string">"dmoz:items"</span>])</div><div class="line">        item = json.loads(data)</div><div class="line">        sheet.insert(item)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">u"Processing: %(name)s &lt;%(link)s&gt;"</span> % item</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">print</span> <span class="string">u"Error procesing: %r"</span> % item</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-28T16:00:00.000Z"><a href="/2017/03/01/技术/redis学习笔记/">2017-03-01</a></time>
      
      
  
    <h1 class="title"><a href="/2017/03/01/技术/redis学习笔记/">redis学习笔记</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis学习笔记"><span class="toc-text">redis学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、下载安装"><span class="toc-text">1、下载安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、客户端命令行"><span class="toc-text">2、客户端命令行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1、命令返回消息类型："><span class="toc-text">2.1、命令返回消息类型：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2、常用命令"><span class="toc-text">2.2、常用命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3、使用python-redis-py连接Redis"><span class="toc-text">2.3、使用python redis-py连接Redis</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、事务"><span class="toc-text">3、事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、缓存和Redis生存时间"><span class="toc-text">4、缓存和Redis生存时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、消息队列"><span class="toc-text">5、消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1、生产者-消费者模式"><span class="toc-text">5.1、生产者-消费者模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2、发布-订阅模式"><span class="toc-text">5.2、发布-订阅模式</span></a></li></ol></li></ol></li></ol>
    </div>

      
        <h2 id="redis学习笔记"><a href="#redis学习笔记" class="headerlink" title="redis学习笔记"></a>redis学习笔记</h2><p>no sql：redis，mongodb，Memcached</p>
<p>redis：Remote Directory Server，远程字典服务器。</p>
<p>键值数据类型支持：</p>
<p>●字符串String类型</p>
<p>set、get、getset。。。 </p>
<p>●散列Hash类型</p>
<p>类似python的字典</p>
<p>hset、hget、hdel、hgetall、hkeys、hvals</p>
<p>●列表List类型</p>
<p>lpush、rpush、lpop、rpop、llen</p>
<p>●集合Set类型</p>
<p>sadd、smembers、srem、spop、sdiff(差集)、sinter(交集)、sunion(并集)、scard(长度)、</p>
<p>●有序集合Zset类型</p>
<p> <code>ZADD key [NX|XX][CH] [INCR] score member [score member ...]</code></p>
<p>zscore、zcard、zrank、</p>
<p>一个键最多存储512MB</p>
<p><a href="redis.io">官网</a></p>
<h3 id="1、下载安装"><a href="#1、下载安装" class="headerlink" title="1、下载安装"></a>1、下载安装</h3><p>linux下安装<code>apt-get install redis-server</code>,启动<code>service redis-server start</code></p>
<ul>
<li><p>redis-server ：服务器</p>
</li>
<li><p>redis-benchmark：性能测试工具</p>
</li>
<li><p>redis-cli：命令行客户端</p>
</li>
<li><p>redis-check-dump：RDB文件检测工具</p>
</li>
<li><p>redis-check-aof：AOF文件修复工具</p>
<p>启动命令</p>
<p><code>redis-server redis.windows.conf</code></p>
<p><strong>设置Redis服务</strong></p>
<p>由于上面虽然启动了redis，但是只要一关闭cmd窗口，redis就会消失。所以要把redis设置成windows下的服务。</p>
<p><code>redis-server --service-install redis.windows-service.conf --loglevel verbose</code></p>
<p>卸载服务：redis-server –service-uninstall</p>
<p>开启服务：redis-server –service-start</p>
<p>停止服务：redis-server –service-stop</p>
<p>测试：</p>
<p><code>redis-cli -h 127.0.0.1 -p 6379</code></p>
</li>
<li><p>参数配置</p>
<ul>
<li><p>启动参数</p>
<p><code>redis-server redis.windows.conf</code> –port xxx –loglevel  notice</p>
</li>
<li><p>命令行客户端中动态修改</p>
<p>127.0.0.1:6379&gt; CONFIG get loglevel<br>1) “loglevel”<br>2) “notice”<br>127.0.0.1:6379&gt; CONFIG GET port<br>1) “port”<br>2) “6379”<br>127.0.0.1:6379&gt; CONFIG SET loglevel warning<br>OK<br>127.0.0.1:6379&gt; CONFIG GET loglevel<br>1) “loglevel”<br>2) “warning”</p>
</li>
<li><p>配置文件redis.conf</p>
<p>port 6379 默认端口</p>
<p>bind 127.0.0.1，默认绑定的主机地址</p>
<p>timeout 0，当客户端闲置多久之后关闭连接，0代表没有启动这个选项</p>
<p>loglevel notice，日志的记录级别</p>
<p># debug：很详细的信息，适合开发和测试</p>
<p># verbose ：包含很多不太有用的信息</p>
<p># notice ：比较适合生产环境</p>
<p># warning ：警告信息</p>
<p>logfile stdout代表日志的记录方式，默认为标准输出</p>
<p>databases 16代表默认数据库的数量16个,默认的数据库编号从0开始，<code>select 1</code> 选择数据库1</p>
<p>save 300 10  –300秒内将10个更改同步到磁盘</p>
<p>save  900  1</p>
<p>dbfilename dump.rdb，指定本地数据库文件名，默认为dump.rdb</p>
<p>dir ./,指定本地数据库的存放目录，默认是当前目录</p>
<p>requirepass password  设置认证</p>
<p>​</p>
<p>​</p>
</li>
</ul>
</li>
</ul>
<h3 id="2、客户端命令行"><a href="#2、客户端命令行" class="headerlink" title="2、客户端命令行"></a>2、客户端命令行</h3><h4 id="2-1、命令返回消息类型："><a href="#2-1、命令返回消息类型：" class="headerlink" title="2.1、命令返回消息类型："></a>2.1、命令返回消息类型：</h4><ul>
<li><p>状态信息</p>
<p>  127.0.0.1:6379&gt; set test “test_value”<br>  OK<br>  127.0.0.1:6379&gt; ping<br>  PONG</p>
</li>
<li><p>错误回复</p>
<p>  127.0.0.1:6379&gt; xx<br>  (error) ERR unknown command ‘xx’</p>
</li>
<li><p>整数</p>
<p>  127.0.0.1:6379&gt; DBSIZE<br>  (integer) 1</p>
</li>
<li><p>字符串</p>
<p>  127.0.0.1:6379&gt; get a<br>  “1”<br>  127.0.0.1:6379&gt; get test<br>  “test_value”</p>
<p>  127.0.0.1:6379&gt; get aa<br>  (nil)</p>
<p>  nil表示空的结果</p>
</li>
<li><p>多行字符串</p>
<p>  127.0.0.1:6379&gt; keys *<br>  1) “b”<br>  2) “test”<br>  3) “a”</p>
</li>
</ul>
<h4 id="2-2、常用命令"><a href="#2-2、常用命令" class="headerlink" title="2.2、常用命令"></a>2.2、常用命令</h4><p>‘redis-cli -h 127.0.0.1 -p 6379 -a passwd’</p>
<p>select 0  选择0号数据库</p>
<p>exit quit 断开连接</p>
<p>shutdown 同时关闭服务器</p>
<p>参考文档<a href="http://doc.redisfans.com/" target="_blank" rel="external">http://doc.redisfans.com/</a></p>
<h4 id="2-3、使用python-redis-py连接Redis"><a href="#2-3、使用python-redis-py连接Redis" class="headerlink" title="2.3、使用python redis-py连接Redis"></a>2.3、使用python redis-py连接Redis</h4><p><code>pip install redis</code></p>
<p>redis-py没有实现select</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">r = redis.Redis(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>, password=<span class="keyword">None</span>)</div><div class="line"><span class="keyword">print</span> r.set(<span class="string">'a'</span>, <span class="string">'a_value'</span>, ex=<span class="keyword">None</span>, px=<span class="keyword">None</span>, nx=<span class="keyword">False</span>, xx=<span class="keyword">False</span>)</div><div class="line"><span class="keyword">print</span> r.get(<span class="string">'a'</span>)</div><div class="line"><span class="keyword">print</span> r.config_get(<span class="string">'loglevel'</span>)</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-27/41317582-file_1490600179965_2c28.png" alt=""></p>
<p>使用pipeline提高执行效率</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">r = redis.Redis(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">1</span>)</div><div class="line">p = r.pipeline()</div><div class="line">p.set(<span class="string">'k1'</span>, <span class="string">'v1'</span>)</div><div class="line">p.set(<span class="string">'qqq'</span>, <span class="number">2</span>)</div><div class="line">p.incr(<span class="string">'num1'</span>)</div><div class="line">p.execute()</div><div class="line"><span class="keyword">print</span> r.keys(<span class="string">'*'</span>)</div></pre></td></tr></table></figure>
<h3 id="3、事务"><a href="#3、事务" class="headerlink" title="3、事务"></a>3、事务</h3><p>事务可以理解为一些列操作的集合，或一个过程。要么成功（全部执行），要么失败（全部都不被执行）。</p>
<ul>
<li><p>开启事务</p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-27/46233754-file_1490582676167_60fe.png" alt=""></p>
<p>EXEC 执行事务</p>
</li>
<li><p>事务的执行</p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-27/17320131-file_1490582766396_24af.png" alt=""></p>
</li>
<li><p>监视key</p>
<p>WATCH counter1 counter2</p>
<p>如果在执行事务之前key如果被其它命令改动，事务就被打断了，不会执行。</p>
<p>UNWATCH:取消WATCH命令对所有key的监视</p>
</li>
</ul>
<ul>
<li><p>取消事务</p>
<p>DISCARD</p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-27/41588717-file_1490582930256_52d.png" alt=""></p>
</li>
<li><p>错误处理</p>
<ul>
<li><p>语法错误</p>
<p>错误的语法不会被添加到队列中，自然也不会被执行。</p>
</li>
<li><p>运行出错</p>
<p>事务中QUEUED的语句，在运行中出错，其他的命令也会成功执行。Redis事务不支持回滚。</p>
</li>
</ul>
</li>
</ul>
<h3 id="4、缓存和Redis生存时间"><a href="#4、缓存和Redis生存时间" class="headerlink" title="4、缓存和Redis生存时间"></a>4、缓存和Redis生存时间</h3><p>redis的键值可以设置生存时间，到期后自动删除。</p>
<p>EXPIRE（设置过期的秒数）/EXPIREAT（在指定的时间戳进行删除）</p>
<p>PEXPIRE（设置过期的微秒数）/PEXPIREAT（在指定的时间戳进行删除）</p>
<p>PERSIST（永不过期，持久化）</p>
<p>TTL    （得到某个键的生存时间）</p>
<p>PTTL   （得到某个键的生存时间）</p>
<p>将近期访问过得数据保存到redis中。如果数据不在Redis中，再去数据库中取。</p>
<p>如果大量的使用这种缓存键而且生存时间设置的过长，Redis会占用大量内存。</p>
<p>如果缓存键的生存时间设置太短的话，可能会导致缓存的命中率过低，内存利用率低。</p>
<h3 id="5、消息队列"><a href="#5、消息队列" class="headerlink" title="5、消息队列"></a>5、消息队列</h3><h4 id="5-1、生产者-消费者模式"><a href="#5-1、生产者-消费者模式" class="headerlink" title="5.1、生产者-消费者模式"></a>5.1、生产者-消费者模式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding: utf-8</span></div><div class="line"><span class="keyword">import</span> redis</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.rcon = redis.Redis(db=<span class="number">5</span>)</div><div class="line">        self.queue = <span class="string">'task:prodcons:queue'</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_task</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            task = self.rcon.blpop(self.queue, <span class="number">0</span>)[<span class="number">1</span>]  <span class="comment"># blpop阻塞式的pop</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'Task: %s'</span> % task</div><div class="line"></div><div class="line"></div><div class="line">Task().process_task()</div><div class="line"><span class="comment">#  向'task:prodcons:queue'里lpush数据后，会有数据打印出来</span></div></pre></td></tr></table></figure>
<h4 id="5-2、发布-订阅模式"><a href="#5-2、发布-订阅模式" class="headerlink" title="5.2、发布-订阅模式"></a>5.2、发布-订阅模式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding: utf-8</span></div><div class="line"><span class="keyword">import</span> redis</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.rcon = redis.Redis(db=<span class="number">5</span>)</div><div class="line">        self.ps = self.rcon.pubsub()</div><div class="line">        self.ps.subscribe(<span class="string">'task:pubsub:channel'</span>)  <span class="comment"># 订阅频道</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_task</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.ps.listen():  <span class="comment"># 是个生成器</span></div><div class="line">            <span class="keyword">if</span> i[<span class="string">'type'</span>] == <span class="string">'message'</span>:</div><div class="line">                <span class="keyword">print</span> <span class="string">'Task: %s'</span> % i[<span class="string">'data'</span>]</div><div class="line"></div><div class="line"></div><div class="line">Task().process_task()</div><div class="line"><span class="comment">#  向'task:pubsub:channel'里publish数据后，每个订阅该频道的程序都会会打印打印相同的消息出来</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
    <a href="/page/2/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/4/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  
<div>
<a href="javascript:;" class="popup-trigger">      
      <i class="menu-item-icon fa fa-search fa-fw"></i>        
   搜索
</a>
</div>


<div class="site-search">
<div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>
</div>

<script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
     
  var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';
                var str1=str                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>';
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
					else { isMatch=false; } //更新此处
					
					//更新此处
					
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ "> " + data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 20;
                            var end = first_occur + 30;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
							//console.log(match_content)
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                    }
                })
                //修改
				if (str1==str){
					str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';
					}
				
				$resultContent.innerHTML = str;
            })
        }
    })
}
    // search function;
 </script>
<script>

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
	  proceedsearch();
	  //添加的
	  document.getElementById("local-search-result").innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>';
     
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>
  
<script type="text/javascript">      
     var search_path = "search.xml";
     if (search_path.length == 0) {
     	search_path = "search.xml";
     }
     var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
</script>





  
<div class="widget tag">
  <h3 class="title" id="categories">分类</h3>
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a><span class="category-list-count">43</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/django/">django</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/git/">git</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/latex/">latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/linux/">linux</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/mongodb/">mongodb</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/numpy/">numpy</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/pandas/">pandas</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/python/">python</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/python-爬虫/">python 爬虫</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/redis/">redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/scrapy/">scrapy</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/其他/">其他</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/生活/游戏/">游戏</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/读书/">读书</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/科研/">科研</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/资源/">资源</a><span class="category-list-count">3</span></li></ul> 
</div>
 

  <div class="widget tag">
<h3 class="title">简介</h3>
<ul class="entry">
<li>博主：帅羊羊</li>
<li>现状：武大CS在读研究生</li>
<li>Theme: <a href="https://github.com/shuaiyy/lightum">Lightum</a>
<!-- <li>想交友的朋友请<a href="http://zipperary.com/about">联系我</a>！</li> -->
<li>QQ 号：2Ol896963</li>
<li>博客: 记录个人生活学习的点滴</li>
<!-- <font color="red">Hexo 交流群：287306637</font> -->
</ul>
</div>



  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=0&uid=2946363961&verifier=371067b2&dpc=1"></iframe>

  <div class="widget tag">
<h3 class="title">打赏</h3>
<ul class="entry">
<li>支付宝扫一扫，捐助支持，谢谢！</li>
<li><a href="http://o8i01ajlj.bkt.clouddn.com/blog/171004/LikDAfKDg0.png" title="" class="fancybox" rel="gallery3"><img width="100%" src="http://o8i01ajlj.bkt.clouddn.com/blog/171004/LikDAfKDg0.png"></a></li>
</ul>
</div>

  <div class="widget tag">
  <h3 class="title">日历云</h3>
  <div id="calendar"></div>
</div>

  
  <div class="widget tag">
    <h3 class="title">归档</h3>
	<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">2017年09月</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">2017年05月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">2017年04月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">2017年03月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">2017年02月</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">2016年12月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">2016年11月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">2016年10月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">2016年09月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">2016年08月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">2016年07月</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">2016年05月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">2016年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">2015年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">2014年12月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">2014年09月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">2014年08月</a><span class="archive-list-count">1</span></li></ul>
  </div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><section>
Theme of <a href="https://github.com/shuaiyy/lightum">Lightum</a>, Improved from <a href="https://github.com/hexojs/hexo-theme-light">Light</a>, by <a href="/">shuaiyy</a> 
</section>
<div class="clearfix"></div>
</footer>
  <script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<!-- add calendar widget -->

  <script src="/js/calendar.js"></script>
  <script src="/js/languages.js"></script>
  <script type="text/javascript">
    $(function() {
    
      $('#calendar').aCalendar('zh-CN',{single:true, root:'calendar/'});
    
    });
  </script>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>


<a href="https://github.com/shuaiyy" target="_blank"><img style="position: absolute; top: 0; left: 0; border: 0;" src="/imgs/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>
