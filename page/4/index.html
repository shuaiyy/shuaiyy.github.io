

<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 4 页 | 帅羊羊的博客</title>
  
  <meta name="google-site-verification" content="hLu-CnRbqpthWxa76MJ-vpnGr7yMChNtTW6KA0pRMQo" />  
  
  <meta name="author" content="Shuai yy">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="帅羊羊的博客"/>

  
    <meta property="og:image" content=""/>
  
  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="http://zipperary.com/atom.xml" title="帅羊羊的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//libs.baidu.com/jquery/1.8.0/jquery.min.js"></script>
  
  
</head>



<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">帅羊羊的博客</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
	  
    
      <li><a href="/archives"><i class="fa fa-archive"></i>归档</a></li>
	  
    
      <li><a href="/resume"><i class="fa fa-user"></i>关于</a></li>
	  
    
	<li> <a href="/atom.xml"><i class="fa fa-rss"></i>RSS</a> </li>
<li> <a title="把这个链接拖到你的Chrome收藏夹工具栏中" href='javascript:(function() {
	function c() {
		var e = document.createElement("link");
		e.setAttribute("type", "text/css");
		e.setAttribute("rel", "stylesheet");
		e.setAttribute("href", f);
		e.setAttribute("class", l);
		document.body.appendChild(e)
	}
 
	function h() {
		var e = document.getElementsByClassName(l);
		for (var t = 0; t < e.length; t++) {
			document.body.removeChild(e[t])
		}
	}
 
	function p() {
		var e = document.createElement("div");
		e.setAttribute("class", a);
		document.body.appendChild(e);
		setTimeout(function() {
			document.body.removeChild(e)
		}, 100)
	}
 
	function d(e) {
		return {
			height : e.offsetHeight,
			width : e.offsetWidth
		}
	}
 
	function v(i) {
		var s = d(i);
		return s.height > e && s.height < n && s.width > t && s.width < r
	}
 
	function m(e) {
		var t = e;
		var n = 0;
		while (!!t) {
			n += t.offsetTop;
			t = t.offsetParent
		}
		return n
	}
 
	function g() {
		var e = document.documentElement;
		if (!!window.innerWidth) {
			return window.innerHeight
		} else if (e && !isNaN(e.clientHeight)) {
			return e.clientHeight
		}
		return 0
	}
 
	function y() {
		if (window.pageYOffset) {
			return window.pageYOffset
		}
		return Math.max(document.documentElement.scrollTop, document.body.scrollTop)
	}
 
	function E(e) {
		var t = m(e);
		return t >= w && t <= b + w
	}
 
	function S() {
		var e = document.createElement("audio");
		e.setAttribute("class", l);
		e.src = i;
		e.loop = false;
		e.addEventListener("canplay", function() {
			setTimeout(function() {
				x(k)
			}, 500);
			setTimeout(function() {
				N();
				p();
				for (var e = 0; e < O.length; e++) {
					T(O[e])
				}
			}, 15500)
		}, true);
		e.addEventListener("ended", function() {
			N();
			h()
		}, true);
		e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
		document.body.appendChild(e);
		e.play()
	}
 
	function x(e) {
		e.className += " " + s + " " + o
	}
 
	function T(e) {
		e.className += " " + s + " " + u[Math.floor(Math.random() * u.length)]
	}
 
	function N() {
		var e = document.getElementsByClassName(s);
		var t = new RegExp("\\b" + s + "\\b");
		for (var n = 0; n < e.length; ) {
			e[n].className = e[n].className.replace(t, "")
		}
	}
 
	var e = 30;
	var t = 30;
	var n = 350;
	var r = 350;
	var i = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake.mp3";
	var s = "mw-harlem_shake_me";
	var o = "im_first";
	var u = ["im_drunk", "im_baked", "im_trippin", "im_blown"];
	var a = "mw-strobe_light";
	var f = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";
	var l = "mw_added_css";
	var b = g();
	var w = y();
	var C = document.getElementsByTagName("*");
	var k = null;
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (v(A)) {
			if (E(A)) {
				k = A;
				break
			}
		}
	}
	if (A === null) {
		console.warn("Could not find a node of the right size. Please try a different page.");
		return
	}
	c();
	S();
	var O = [];
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (v(A)) {
			O.push(A)
		}
	}
})()    '>High一下</a> </li>

  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-28T16:00:00.000Z"><a href="/2017/03/01/技术/redis学习笔记/">2017-03-01</a></time>
      
      
  
    <h1 class="title"><a href="/2017/03/01/技术/redis学习笔记/">redis学习笔记</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis学习笔记"><span class="toc-text">redis学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、下载安装"><span class="toc-text">1、下载安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、客户端命令行"><span class="toc-text">2、客户端命令行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1、命令返回消息类型："><span class="toc-text">2.1、命令返回消息类型：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2、常用命令"><span class="toc-text">2.2、常用命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3、使用python-redis-py连接Redis"><span class="toc-text">2.3、使用python redis-py连接Redis</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、事务"><span class="toc-text">3、事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、缓存和Redis生存时间"><span class="toc-text">4、缓存和Redis生存时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、消息队列"><span class="toc-text">5、消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1、生产者-消费者模式"><span class="toc-text">5.1、生产者-消费者模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2、发布-订阅模式"><span class="toc-text">5.2、发布-订阅模式</span></a></li></ol></li></ol></li></ol>
    </div>

      
        <h2 id="redis学习笔记"><a href="#redis学习笔记" class="headerlink" title="redis学习笔记"></a>redis学习笔记</h2><p>no sql：redis，mongodb，Memcached</p>
<p>redis：Remote Directory Server，远程字典服务器。</p>
<p>键值数据类型支持：</p>
<p>●字符串String类型</p>
<p>set、get、getset。。。 </p>
<p>●散列Hash类型</p>
<p>类似python的字典</p>
<p>hset、hget、hdel、hgetall、hkeys、hvals</p>
<p>●列表List类型</p>
<p>lpush、rpush、lpop、rpop、llen</p>
<p>●集合Set类型</p>
<p>sadd、smembers、srem、spop、sdiff(差集)、sinter(交集)、sunion(并集)、scard(长度)、</p>
<p>●有序集合Zset类型</p>
<p> <code>ZADD key [NX|XX][CH] [INCR] score member [score member ...]</code></p>
<p>zscore、zcard、zrank、</p>
<p>一个键最多存储512MB</p>
<p><a href="redis.io">官网</a></p>
<h3 id="1、下载安装"><a href="#1、下载安装" class="headerlink" title="1、下载安装"></a>1、下载安装</h3><p>linux下安装<code>apt-get install redis-server</code>,启动<code>service redis-server start</code></p>
<ul>
<li><p>redis-server ：服务器</p>
</li>
<li><p>redis-benchmark：性能测试工具</p>
</li>
<li><p>redis-cli：命令行客户端</p>
</li>
<li><p>redis-check-dump：RDB文件检测工具</p>
</li>
<li><p>redis-check-aof：AOF文件修复工具</p>
<p>启动命令</p>
<p><code>redis-server redis.windows.conf</code></p>
<p><strong>设置Redis服务</strong></p>
<p>由于上面虽然启动了redis，但是只要一关闭cmd窗口，redis就会消失。所以要把redis设置成windows下的服务。</p>
<p><code>redis-server --service-install redis.windows-service.conf --loglevel verbose</code></p>
<p>卸载服务：redis-server –service-uninstall</p>
<p>开启服务：redis-server –service-start</p>
<p>停止服务：redis-server –service-stop</p>
<p>测试：</p>
<p><code>redis-cli -h 127.0.0.1 -p 6379</code></p>
</li>
<li><p>参数配置</p>
<ul>
<li><p>启动参数</p>
<p><code>redis-server redis.windows.conf</code> –port xxx –loglevel  notice</p>
</li>
<li><p>命令行客户端中动态修改</p>
<p>127.0.0.1:6379&gt; CONFIG get loglevel<br>1) “loglevel”<br>2) “notice”<br>127.0.0.1:6379&gt; CONFIG GET port<br>1) “port”<br>2) “6379”<br>127.0.0.1:6379&gt; CONFIG SET loglevel warning<br>OK<br>127.0.0.1:6379&gt; CONFIG GET loglevel<br>1) “loglevel”<br>2) “warning”</p>
</li>
<li><p>配置文件redis.conf</p>
<p>port 6379 默认端口</p>
<p>bind 127.0.0.1，默认绑定的主机地址</p>
<p>timeout 0，当客户端闲置多久之后关闭连接，0代表没有启动这个选项</p>
<p>loglevel notice，日志的记录级别</p>
<p># debug：很详细的信息，适合开发和测试</p>
<p># verbose ：包含很多不太有用的信息</p>
<p># notice ：比较适合生产环境</p>
<p># warning ：警告信息</p>
<p>logfile stdout代表日志的记录方式，默认为标准输出</p>
<p>databases 16代表默认数据库的数量16个,默认的数据库编号从0开始，<code>select 1</code> 选择数据库1</p>
<p>save 300 10  –300秒内将10个更改同步到磁盘</p>
<p>save  900  1</p>
<p>dbfilename dump.rdb，指定本地数据库文件名，默认为dump.rdb</p>
<p>dir ./,指定本地数据库的存放目录，默认是当前目录</p>
<p>requirepass password  设置认证</p>
<p>​</p>
<p>​</p>
</li>
</ul>
</li>
</ul>
<h3 id="2、客户端命令行"><a href="#2、客户端命令行" class="headerlink" title="2、客户端命令行"></a>2、客户端命令行</h3><h4 id="2-1、命令返回消息类型："><a href="#2-1、命令返回消息类型：" class="headerlink" title="2.1、命令返回消息类型："></a>2.1、命令返回消息类型：</h4><ul>
<li><p>状态信息</p>
<p>  127.0.0.1:6379&gt; set test “test_value”<br>  OK<br>  127.0.0.1:6379&gt; ping<br>  PONG</p>
</li>
<li><p>错误回复</p>
<p>  127.0.0.1:6379&gt; xx<br>  (error) ERR unknown command ‘xx’</p>
</li>
<li><p>整数</p>
<p>  127.0.0.1:6379&gt; DBSIZE<br>  (integer) 1</p>
</li>
<li><p>字符串</p>
<p>  127.0.0.1:6379&gt; get a<br>  “1”<br>  127.0.0.1:6379&gt; get test<br>  “test_value”</p>
<p>  127.0.0.1:6379&gt; get aa<br>  (nil)</p>
<p>  nil表示空的结果</p>
</li>
<li><p>多行字符串</p>
<p>  127.0.0.1:6379&gt; keys *<br>  1) “b”<br>  2) “test”<br>  3) “a”</p>
</li>
</ul>
<h4 id="2-2、常用命令"><a href="#2-2、常用命令" class="headerlink" title="2.2、常用命令"></a>2.2、常用命令</h4><p>‘redis-cli -h 127.0.0.1 -p 6379 -a passwd’</p>
<p>select 0  选择0号数据库</p>
<p>exit quit 断开连接</p>
<p>shutdown 同时关闭服务器</p>
<p>参考文档<a href="http://doc.redisfans.com/" target="_blank" rel="external">http://doc.redisfans.com/</a></p>
<h4 id="2-3、使用python-redis-py连接Redis"><a href="#2-3、使用python-redis-py连接Redis" class="headerlink" title="2.3、使用python redis-py连接Redis"></a>2.3、使用python redis-py连接Redis</h4><p><code>pip install redis</code></p>
<p>redis-py没有实现select</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">r = redis.Redis(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>, password=<span class="keyword">None</span>)</div><div class="line"><span class="keyword">print</span> r.set(<span class="string">'a'</span>, <span class="string">'a_value'</span>, ex=<span class="keyword">None</span>, px=<span class="keyword">None</span>, nx=<span class="keyword">False</span>, xx=<span class="keyword">False</span>)</div><div class="line"><span class="keyword">print</span> r.get(<span class="string">'a'</span>)</div><div class="line"><span class="keyword">print</span> r.config_get(<span class="string">'loglevel'</span>)</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-27/41317582-file_1490600179965_2c28.png" alt=""></p>
<p>使用pipeline提高执行效率</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">r = redis.Redis(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">1</span>)</div><div class="line">p = r.pipeline()</div><div class="line">p.set(<span class="string">'k1'</span>, <span class="string">'v1'</span>)</div><div class="line">p.set(<span class="string">'qqq'</span>, <span class="number">2</span>)</div><div class="line">p.incr(<span class="string">'num1'</span>)</div><div class="line">p.execute()</div><div class="line"><span class="keyword">print</span> r.keys(<span class="string">'*'</span>)</div></pre></td></tr></table></figure>
<h3 id="3、事务"><a href="#3、事务" class="headerlink" title="3、事务"></a>3、事务</h3><p>事务可以理解为一些列操作的集合，或一个过程。要么成功（全部执行），要么失败（全部都不被执行）。</p>
<ul>
<li><p>开启事务</p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-27/46233754-file_1490582676167_60fe.png" alt=""></p>
<p>EXEC 执行事务</p>
</li>
<li><p>事务的执行</p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-27/17320131-file_1490582766396_24af.png" alt=""></p>
</li>
<li><p>监视key</p>
<p>WATCH counter1 counter2</p>
<p>如果在执行事务之前key如果被其它命令改动，事务就被打断了，不会执行。</p>
<p>UNWATCH:取消WATCH命令对所有key的监视</p>
</li>
</ul>
<ul>
<li><p>取消事务</p>
<p>DISCARD</p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-27/41588717-file_1490582930256_52d.png" alt=""></p>
</li>
<li><p>错误处理</p>
<ul>
<li><p>语法错误</p>
<p>错误的语法不会被添加到队列中，自然也不会被执行。</p>
</li>
<li><p>运行出错</p>
<p>事务中QUEUED的语句，在运行中出错，其他的命令也会成功执行。Redis事务不支持回滚。</p>
</li>
</ul>
</li>
</ul>
<h3 id="4、缓存和Redis生存时间"><a href="#4、缓存和Redis生存时间" class="headerlink" title="4、缓存和Redis生存时间"></a>4、缓存和Redis生存时间</h3><p>redis的键值可以设置生存时间，到期后自动删除。</p>
<p>EXPIRE（设置过期的秒数）/EXPIREAT（在指定的时间戳进行删除）</p>
<p>PEXPIRE（设置过期的微秒数）/PEXPIREAT（在指定的时间戳进行删除）</p>
<p>PERSIST（永不过期，持久化）</p>
<p>TTL    （得到某个键的生存时间）</p>
<p>PTTL   （得到某个键的生存时间）</p>
<p>将近期访问过得数据保存到redis中。如果数据不在Redis中，再去数据库中取。</p>
<p>如果大量的使用这种缓存键而且生存时间设置的过长，Redis会占用大量内存。</p>
<p>如果缓存键的生存时间设置太短的话，可能会导致缓存的命中率过低，内存利用率低。</p>
<h3 id="5、消息队列"><a href="#5、消息队列" class="headerlink" title="5、消息队列"></a>5、消息队列</h3><h4 id="5-1、生产者-消费者模式"><a href="#5-1、生产者-消费者模式" class="headerlink" title="5.1、生产者-消费者模式"></a>5.1、生产者-消费者模式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding: utf-8</span></div><div class="line"><span class="keyword">import</span> redis</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.rcon = redis.Redis(db=<span class="number">5</span>)</div><div class="line">        self.queue = <span class="string">'task:prodcons:queue'</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_task</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            task = self.rcon.blpop(self.queue, <span class="number">0</span>)[<span class="number">1</span>]  <span class="comment"># blpop阻塞式的pop</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'Task: %s'</span> % task</div><div class="line"></div><div class="line"></div><div class="line">Task().process_task()</div><div class="line"><span class="comment">#  向'task:prodcons:queue'里lpush数据后，会有数据打印出来</span></div></pre></td></tr></table></figure>
<h4 id="5-2、发布-订阅模式"><a href="#5-2、发布-订阅模式" class="headerlink" title="5.2、发布-订阅模式"></a>5.2、发布-订阅模式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding: utf-8</span></div><div class="line"><span class="keyword">import</span> redis</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.rcon = redis.Redis(db=<span class="number">5</span>)</div><div class="line">        self.ps = self.rcon.pubsub()</div><div class="line">        self.ps.subscribe(<span class="string">'task:pubsub:channel'</span>)  <span class="comment"># 订阅频道</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_task</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.ps.listen():  <span class="comment"># 是个生成器</span></div><div class="line">            <span class="keyword">if</span> i[<span class="string">'type'</span>] == <span class="string">'message'</span>:</div><div class="line">                <span class="keyword">print</span> <span class="string">'Task: %s'</span> % i[<span class="string">'data'</span>]</div><div class="line"></div><div class="line"></div><div class="line">Task().process_task()</div><div class="line"><span class="comment">#  向'task:pubsub:channel'里publish数据后，每个订阅该频道的程序都会会打印打印相同的消息出来</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-27T16:00:00.000Z"><a href="/2017/02/28/技术/numpy-liner-skills/">2017-02-28</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/28/技术/numpy-liner-skills/">Numpy线性运算</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#线性代数"><span class="toc-text">线性代数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#描述性统计计算"><span class="toc-text">描述性统计计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线性代数运算"><span class="toc-text">线性代数运算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建掩码式数组"><span class="toc-text">创建掩码式数组</span></a></li></ol></li></ol>
    </div>

      
        <h2 id="线性代数"><a href="#线性代数" class="headerlink" title="线性代数"></a>线性代数</h2><blockquote>
<p>解方程组</p>
</blockquote>
<ul>
<li>Numpy和Scipy模块</li>
<li>Numpy进行简单的描述性统计计算</li>
<li>Numpy进行线性代数运算</li>
<li>Numpy计算特征值和特征向量</li>
<li>Numpy随机数</li>
<li>创建掩码式Numpy数组</li>
</ul>
<h3 id="描述性统计计算"><a href="#描述性统计计算" class="headerlink" title="描述性统计计算"></a>描述性统计计算</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#   计算numpy数组的平均值，中位数，最大值，最小值和标准差</span></div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> scoreatpercentile  <span class="comment"># 就算第N%的数值</span></div><div class="line">data = np.loadtxt(<span class="string">'ex1.csv'</span>, delimiter=<span class="string">','</span>, usecols=(<span class="number">1</span>,), skiprows=<span class="number">1</span>, unpack=<span class="keyword">True</span>)</div><div class="line"><span class="keyword">print</span> data</div><div class="line"><span class="keyword">print</span> <span class="string">"Max:"</span>, data.max(), np.max(data)</div><div class="line"><span class="keyword">print</span> <span class="string">"Min:"</span>, data.min(), np.min(data)</div><div class="line"><span class="keyword">print</span> <span class="string">"Mean:"</span>, data.mean(), np.mean(data)</div><div class="line"><span class="keyword">print</span> <span class="string">"Std方差:"</span>, data.std(), np.std(data)</div><div class="line"><span class="keyword">print</span> <span class="string">"Median:"</span>, np.median(data), scoreatpercentile(data, <span class="number">50</span>)</div></pre></td></tr></table></figure>
<pre><code>[  2.   6.  10.]
Max: 10.0 10.0
Min: 2.0 2.0
Mean: 6.0 6.0
Std方差: 3.26598632371 3.26598632371
Median: 6.0 6.0
</code></pre><h3 id="线性代数运算"><a href="#线性代数运算" class="headerlink" title="线性代数运算"></a>线性代数运算</h3><blockquote>
<p>numpy.linalg 或 scipy.linalg</p>
</blockquote>
<p>矩阵求逆运算，转置，计算特征值，求解线性方程组或计算行列式<br>矩阵可用numpy.ndarray的一个子类表示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 创建一个矩阵</span></div><div class="line">A = np.mat(<span class="string">"2 4 6;4 2 6;10 -4 18"</span>)</div><div class="line"><span class="keyword">print</span> A</div><div class="line"><span class="comment"># 矩阵求逆</span></div><div class="line">A_inverse = np.linalg.inv(A)</div><div class="line"><span class="keyword">print</span> A_inverse</div><div class="line"><span class="keyword">print</span> <span class="string">"如果矩阵是不可逆的，可以用pinv求伪逆矩阵"</span></div><div class="line">A_inverse = np.linalg.pinv(A)</div><div class="line"><span class="keyword">print</span> A_inverse</div><div class="line"><span class="comment"># A*A- = I</span></div><div class="line">X = A * A_inverse</div><div class="line"><span class="keyword">print</span> X</div><div class="line"><span class="comment"># 计算误差</span></div><div class="line"><span class="keyword">print</span> X - np.eye(<span class="number">3</span>)</div></pre></td></tr></table></figure>
<pre><code>[[ 2  4  6]
 [ 4  2  6]
 [10 -4 18]]
[[-0.41666667  0.66666667 -0.08333333]
 [ 0.08333333  0.16666667 -0.08333333]
 [ 0.25       -0.33333333  0.08333333]]
如果矩阵是不可逆的，可以用pinv求伪逆矩阵
[[-0.41666667  0.66666667 -0.08333333]
 [ 0.08333333  0.16666667 -0.08333333]
 [ 0.25       -0.33333333  0.08333333]]
[[  1.00000000e+00  -1.66533454e-15   4.44089210e-16]
 [  6.66133815e-16   1.00000000e+00   3.88578059e-16]
 [  1.11022302e-15  -1.88737914e-15   1.00000000e+00]]
[[  8.88178420e-16  -1.66533454e-15   4.44089210e-16]
 [  6.66133815e-16  -1.22124533e-15   3.88578059e-16]
 [  1.11022302e-15  -1.88737914e-15   8.88178420e-16]]
</code></pre><p> 求解线性方程组， solve() 和 dot()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">A = np.mat(<span class="string">"1 -2 1;0 2 -8;-4 5 9"</span>)</div><div class="line">b = np.array([<span class="number">0</span>, <span class="number">8</span>, <span class="number">9</span>])</div><div class="line"><span class="comment"># Ax=b，求x，用np.linalg.solve</span></div><div class="line">x = np.linalg.solve(A, b)</div><div class="line"><span class="keyword">print</span> x</div><div class="line"><span class="comment"># Ax=b,求解b，用np.dot</span></div><div class="line">b1 = np.dot(A, x)</div><div class="line"><span class="keyword">print</span> b1</div></pre></td></tr></table></figure>
<pre><code>[ 155.   88.   21.]
[[ 0.  8.  9.]]
</code></pre><p>若存在常数λ及n维非零向量X，使得Ax=λx，则称λ是矩阵A的特征值，x是A属于特征值λ的特征向量.<br>λ = np.linalg.eigvals(A)<br>(λ, x) = np.linalg.eig(A)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">A = np.mat(<span class="string">"3,-2;1,0"</span>)</div><div class="line">a, x = np.linalg.eig(A)</div><div class="line">b = np.linalg.eigvals(A)</div><div class="line"><span class="keyword">print</span> a, b, x</div><div class="line"><span class="comment"># 验证Ax=λx</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(x)):</div><div class="line">    <span class="keyword">print</span> <span class="string">'A*x&#123;&#125;'</span>.format(i), np.dot(A, x[:, i])</div><div class="line">    <span class="keyword">print</span> <span class="string">'a*x&#123;&#125;'</span>.format(i), a[i] * x[:, i]</div></pre></td></tr></table></figure>
<pre><code>[ 2.  1.] [ 2.  1.] [[ 0.89442719  0.70710678]
 [ 0.4472136   0.70710678]]
A*x0 [[ 1.78885438]
 [ 0.89442719]]
a*x0 [[ 1.78885438]
 [ 0.89442719]]
A*x1 [[ 0.70710678]
 [ 0.70710678]]
a*x1 [[ 0.70710678]
 [ 0.70710678]]
</code></pre><p>numpy随机数，随机相关函数位于np.random模块。<br>连续分布：正态分布和对数正态分布<br>离散分布：几何分布，超几何分布和二项分布</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  用np.random.binomial()模拟二项分布,提供相同的种子，则产生的随机结果相同</span></div><div class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</div><div class="line">%matplotlib inline</div><div class="line"></div><div class="line"><span class="comment"># B(0.5, 9) 生成执行10000次的博弈结果序列 </span></div><div class="line">outcome = np.random.binomial(<span class="number">9</span>, <span class="number">0.5</span>, size=<span class="number">10000</span>)</div><div class="line">plt.subplot(<span class="number">121</span>)</div><div class="line">plt.plot(np.arange(<span class="number">10000</span>), outcome)</div><div class="line"></div><div class="line">money = np.zeros(<span class="number">10000</span>)</div><div class="line">my_money = <span class="number">1000</span></div><div class="line">i = <span class="number">0</span></div><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> outcome:</div><div class="line">    <span class="keyword">if</span> x &lt; <span class="number">5</span>:</div><div class="line">        money[i] = my_money - <span class="number">1</span></div><div class="line">    <span class="keyword">elif</span> x &lt; <span class="number">10</span>:</div><div class="line">        money[i] = my_money + <span class="number">1</span></div><div class="line">    my_money = money[i]</div><div class="line">    i = i + <span class="number">1</span></div><div class="line">    </div><div class="line"><span class="keyword">print</span> money</div><div class="line">plt.subplot(<span class="number">122</span>)</div><div class="line">plt.plot(np.arange(<span class="number">10000</span>), money)</div><div class="line">plt.show()</div></pre></td></tr></table></figure>
<pre><code>[  999.  1000.   999. ...,   972.   971.   970.]
</code></pre><p>​    </p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/73560875-file_1489306461740_a8a.png" alt="png"></p>
<p>正态分布采样<br>np.random模块提供了很多表示连续随机分布的函数</p>
<p><strong>Draw random samples from a normal (Gaussian) distribution.</strong></p>
<p>np.random.normal(loc, scale, size)<br>loc : float,Mean (“centre”) of the distribution.<br>scale : float,Standard deviation (spread or “width”) of the distribution.<br>size : int or tuple of ints, optional,Output shape.</p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-1/71222347-file_1488353401066_ca2b.png" alt="高斯分布公式"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">N = <span class="number">10000</span></div><div class="line">normal_values = np.random.normal(size=N)</div><div class="line">dummy, bins, dummy = plt.hist(normal_values, np.sqrt(N), normed=<span class="keyword">True</span>, lw=<span class="number">1</span>)  <span class="comment"># dunmmy中文蠢货，假的；bins箱子，也就是直方图的条条</span></div><div class="line">sigma = <span class="number">1</span></div><div class="line">mu = <span class="number">0</span></div><div class="line">fx = <span class="number">1</span>/(sigma * np.sqrt(<span class="number">2</span> * np.pi)) * np.exp(- (bins - mu) ** <span class="number">2</span> / (<span class="number">2</span> * sigma ** <span class="number">2</span>))</div><div class="line">plt.plot(bins, fx, lw=<span class="number">2</span>)  <span class="comment">##  lw: linewidth</span></div><div class="line">plt.show()</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/78092391-file_1489306461612_6b3c.png" alt="png"></p>
<p>正态检测：检查样本是否符合正态分布<br>scipy.stats里实现了一些正态分布的检测方法。</p>
<h3 id="创建掩码式数组"><a href="#创建掩码式数组" class="headerlink" title="创建掩码式数组"></a>创建掩码式数组</h3><p>掩码式数组可以忽略无效的、残缺的数据。<br>如忽略负值和极值</p>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-25T16:00:00.000Z"><a href="/2017/02/26/技术/use-matplotlib/">2017-02-26</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/26/技术/use-matplotlib/">Matplotlib笔记</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#matplotlib"><span class="toc-text">matplotlib</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Figure-和Subplot"><span class="toc-text">Figure 和Subplot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#颜色、标记、线型"><span class="toc-text">颜色、标记、线型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pandas中的绘图函数"><span class="toc-text">pandas中的绘图函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#线型图"><span class="toc-text">线型图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#柱状图"><span class="toc-text">柱状图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#直方图和密度图"><span class="toc-text">直方图和密度图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#散布图"><span class="toc-text">散布图</span></a></li></ol></li></ol>
    </div>

      
        <h3 id="matplotlib"><a href="#matplotlib" class="headerlink" title="matplotlib"></a>matplotlib</h3><ul>
<li>matplotlib API</li>
<li>pandas中绘图函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%pylab</div></pre></td></tr></table></figure>
<pre><code>Using matplotlib backend: Qt5Agg
Populating the interactive namespace from numpy and matplotlib
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%matplotlib inline</div></pre></td></tr></table></figure>
<h4 id="Figure-和Subplot"><a href="#Figure-和Subplot" class="headerlink" title="Figure 和Subplot"></a>Figure 和Subplot</h4><p>创建一个figure后，还需要在上面添加子图，然后调用子图的绘图方法绘图。<br>直接使用plot绘图，图像绘制在最后一次选定的子图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> numpy.random <span class="keyword">import</span> randn</div><div class="line">fig = plt.figure()</div><div class="line">sp1 = fig.add_subplot(<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>)  <span class="comment"># 2*2布局的第一个子图</span></div><div class="line">sp1.plot(randn(<span class="number">50</span>).cumsum(), <span class="string">'k--'</span>)  <span class="comment"># k--黑色虚线图</span></div><div class="line"></div><div class="line">sp2 = fig.add_subplot(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</div><div class="line">sp2.hist(randn(<span class="number">100</span>), bins=<span class="number">20</span>, color=<span class="string">'k'</span>, alpha=<span class="number">0.3</span>) <span class="comment">## 直方图，20个箱子</span></div><div class="line"></div><div class="line">sp3 = fig.add_subplot(<span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>)</div><div class="line">sp3.scatter(np.arange(<span class="number">30</span>), np.arange(<span class="number">30</span>) + randn(<span class="number">30</span>) * <span class="number">3</span>, color = <span class="string">'b'</span>)</div><div class="line"><span class="comment"># sp4 = fig.add_subplot(2, 2, 4)</span></div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/32548773-file_1489305673034_6cf8.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用plt.subplot()创建子图</span></div><div class="line">fig, axes = plt.subplots(<span class="number">2</span>, <span class="number">2</span>) <span class="comment">## 返回画布和子图对象的数组</span></div><div class="line">axes[<span class="number">0</span>][<span class="number">0</span>].plot(range(<span class="number">10</span>), range(<span class="number">10</span>))</div><div class="line"><span class="comment">## 调整子图间的距离, wspace和hspace 子图间百分比</span></div><div class="line">fig.subplots_adjust(left=<span class="number">1</span>, right=<span class="number">2</span>, wspace=<span class="number">0</span>, hspace=<span class="number">0</span>)</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/72473159-file_1489305673146_ad2c.png" alt="png"></p>
<h4 id="颜色、标记、线型"><a href="#颜色、标记、线型" class="headerlink" title="颜色、标记、线型"></a>颜色、标记、线型</h4><p>plot函数接受一组X和y坐标，还有格式字符串。<br>表示颜色和线型的字符串,如<strong>“g–”</strong>,表示绿色的折线<br><strong>“go–”</strong>, 绿色O点折线，marker=’o’<br>也可以在plot中指定参数</p>
<ul>
<li>linestyle=’–’</li>
<li>color=’g’</li>
<li>color值可以用缩写词或RGB值，“#CECECE”</li>
<li>线形图的点可以加上标记marker，更容易看出点的位置</li>
<li>label 图线的label</li>
<li>drawstyle 绘图方式</li>
</ul>
<p>fig的方法</p>
<ul>
<li>fig.xlabel(‘xxxx’)</li>
<li>fig.ylabel(‘y’)</li>
<li>fig.xlim()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">plt.plot(randn(<span class="number">30</span>).cumsum(), <span class="string">'go--'</span>, label=<span class="string">'yyy'</span>)</div><div class="line">plt.plot(randn(<span class="number">30</span>).cumsum(), color=<span class="string">'b'</span>, marker=<span class="string">'*'</span>, linestyle=<span class="string">'--'</span>, label=<span class="string">'xxx'</span>)</div><div class="line">plt.plot(randn(<span class="number">30</span>).cumsum(), color=<span class="string">'r'</span>, drawstyle=<span class="string">'steps-post'</span>, label=<span class="string">'zzz'</span>)</div><div class="line">plt.legend(loc=<span class="string">'best'</span>)  <span class="comment"># 图例，label的位置为best</span></div><div class="line">plt.xlabel(<span class="string">'X'</span>)</div><div class="line">plt.ylabel(<span class="string">'random'</span>)</div><div class="line">plt.show()</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/78474909-file_1489305673254_5759.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">plt.xlim() <span class="comment"># 当前x轴的范围</span></div><div class="line">plt.xlim([<span class="number">-10</span>,<span class="number">10</span>]) <span class="comment"># 调整x轴的范围</span></div></pre></td></tr></table></figure>
<pre><code>(-10, 10)
</code></pre><p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/85467516-file_1489305673368_16744.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#### 注解以及在subplot上绘图</span></div><div class="line">ax = plt.subplot(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</div><div class="line">ax.plot(range(<span class="number">10</span>), range(<span class="number">3</span>, <span class="number">13</span>), <span class="string">'g*--'</span>, label=<span class="string">'line'</span>)</div><div class="line">ax.legend(<span class="string">'best'</span>)</div><div class="line">ax.text(<span class="number">2</span>, <span class="number">5</span>, <span class="string">'Here!'</span>, family=<span class="string">'monospace'</span>, fontsize=<span class="number">10</span>)</div><div class="line">ax.annotate(<span class="string">'Look Here!'</span>, xy=(<span class="number">3</span>, <span class="number">6</span>), arrowprops=dict(facecolor=<span class="string">'black'</span>))  <span class="comment">#,family='monospace', fontsize=10)</span></div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/41144219-file_1489305672107_13c9a.png" alt="png"></p>
<h3 id="pandas中的绘图函数"><a href="#pandas中的绘图函数" class="headerlink" title="pandas中的绘图函数"></a>pandas中的绘图函数</h3><h4 id="线型图"><a href="#线型图" class="headerlink" title="线型图"></a>线型图</h4><p>Series和Dataframe的plot方法默认生成的是线型图</p>
<h4 id="柱状图"><a href="#柱状图" class="headerlink" title="柱状图"></a>柱状图</h4><p>添加参数kind=bar或barh，生成柱状图和水平方向的柱状图</p>
<h4 id="直方图和密度图"><a href="#直方图和密度图" class="headerlink" title="直方图和密度图"></a>直方图和密度图</h4><p>直方图是一种可以对值频率进行离散化显示的柱状图，plot.hist()<br>密度图：计算“可能会产生观测数据的连续发布的估计”，一般是将该分布近似为一组核（如高斯正态分布）分布。</p>
<h4 id="散布图"><a href="#散布图" class="headerlink" title="散布图"></a>散布图</h4><p>观察两组一维数据之间关系的有效方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> Series, DataFrame</div><div class="line">s = Series(randn(<span class="number">10</span>).cumsum(), index=range(<span class="number">0</span>, <span class="number">100</span>, <span class="number">10</span>))</div><div class="line">s.plot()</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/2827479-file_1489305672228_c94b.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fig, axes = plt.subplots(<span class="number">2</span>, <span class="number">2</span>)</div><div class="line">s.plot(ax=axes[<span class="number">0</span>][<span class="number">0</span>])</div><div class="line">frame = DataFrame(randn(<span class="number">10</span>, <span class="number">4</span>).cumsum(<span class="number">0</span>), columns=list(<span class="string">'ABCD'</span>), index=range(<span class="number">0</span>, <span class="number">100</span>, <span class="number">10</span>))</div><div class="line">frame.plot(ax=axes[<span class="number">0</span>][<span class="number">1</span>])</div><div class="line">frame.plot(ax=axes[<span class="number">0</span>][<span class="number">1</span>])</div><div class="line"><span class="comment">### 柱状图</span></div><div class="line">s.plot(ax=axes[<span class="number">1</span>][<span class="number">0</span>], kind=<span class="string">'barh'</span>)</div><div class="line">frame.plot(ax=axes[<span class="number">1</span>][<span class="number">1</span>], kind=<span class="string">'bar'</span>)</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/58849151-file_1489305672343_537e.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fig, axes = plt.subplots(<span class="number">2</span>, <span class="number">2</span>)</div><div class="line"><span class="comment">## 堆积柱状图</span></div><div class="line">s.plot(ax=axes[<span class="number">0</span>][<span class="number">0</span>], kind=<span class="string">'bar'</span>, stacked=<span class="keyword">True</span>, alpha=<span class="number">0.3</span>) </div><div class="line">frame.plot(ax=axes[<span class="number">0</span>][<span class="number">1</span>], kind=<span class="string">'bar'</span>, stacked=<span class="keyword">True</span>, alpha=<span class="number">0.5</span>)</div><div class="line">s.value_counts().plot(ax=axes[<span class="number">1</span>][<span class="number">0</span>], kind=<span class="string">'bar'</span>, stacked=<span class="keyword">True</span>, alpha=<span class="number">0.3</span>)</div><div class="line">frame.ix[:, <span class="number">2</span>:<span class="number">8</span>].plot(ax=axes[<span class="number">1</span>][<span class="number">1</span>], kind=<span class="string">'bar'</span>, stacked=<span class="keyword">True</span>, alpha=<span class="number">0.5</span>)</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/71308396-file_1489305672462_13b8b.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fig, axes = plt.subplots(<span class="number">1</span>, <span class="number">2</span>)</div><div class="line">s = Series(randn(<span class="number">100</span>).cumsum(), index=range(<span class="number">0</span>, <span class="number">1000</span>, <span class="number">10</span>))</div><div class="line"><span class="comment"># 直方图</span></div><div class="line">s.hist(ax=axes[<span class="number">0</span>], bins=<span class="number">40</span>)</div><div class="line"><span class="comment"># 密度图</span></div><div class="line">s.plot(ax=axes[<span class="number">1</span>], kind=<span class="string">'kde'</span>, color=<span class="string">'k'</span>)</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/78764023-file_1489305672591_17531.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s.hist(bins=<span class="number">40</span>, normed=<span class="keyword">True</span>)</div><div class="line">s.plot(kind=<span class="string">'kde'</span>, style=<span class="string">'g--'</span>)</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/54224940-file_1489305672702_146df.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### 散点图</span></div><div class="line">plt.scatter(frame[<span class="string">'A'</span>], frame[<span class="string">'D'</span>])</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/84592200-file_1489305672811_2aa.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.scatter_matrix(frame, diagonal=<span class="string">'kde'</span>)</div></pre></td></tr></table></figure>
<pre><code>array([[&lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021169438&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x00000000213EB4A8&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x00000000214B22B0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021559710&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021667208&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x000000002174F978&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x000000002181B5F8&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x00000000218DDCC0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021A2D9B0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021AA00B8&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021B9DE80&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021BBE278&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021D61400&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021E70E10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000021F677F0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x0000000022036240&gt;]], dtype=object)
</code></pre><p><img src="http://o8i01ajlj.bkt.clouddn.com/17-3-12/29501980-file_1489305672921_1138.png" alt="png"></p>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-24T16:00:00.000Z"><a href="/2017/02/25/技术/Pandas-skills/">2017-02-25</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/25/技术/Pandas-skills/">Pandas学习笔记</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Pandas数据结构"><span class="toc-text">Pandas数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本功能"><span class="toc-text">基本功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#汇总和计算描述统计"><span class="toc-text">汇总和计算描述统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#处理缺失数据"><span class="toc-text">处理缺失数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#层次化索引"><span class="toc-text">层次化索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Series"><span class="toc-text">Series</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataFrame"><span class="toc-text">DataFrame</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可以用于构造DataFrame的数据"><span class="toc-text">可以用于构造DataFrame的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引对象"><span class="toc-text">索引对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引、选取和过滤"><span class="toc-text">索引、选取和过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#算数运算和数据对齐"><span class="toc-text">算数运算和数据对齐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#函数应用和映射"><span class="toc-text">函数应用和映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#排序和排名"><span class="toc-text">排序和排名</span></a></li></ol></li></ol></li></ol>
    </div>

      
        <h1 id="Pandas数据结构"><a href="#Pandas数据结构" class="headerlink" title="Pandas数据结构"></a>Pandas数据结构</h1><h3 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h3><h3 id="汇总和计算描述统计"><a href="#汇总和计算描述统计" class="headerlink" title="汇总和计算描述统计"></a>汇总和计算描述统计</h3><h3 id="处理缺失数据"><a href="#处理缺失数据" class="headerlink" title="处理缺失数据"></a>处理缺失数据</h3><h3 id="层次化索引"><a href="#层次化索引" class="headerlink" title="层次化索引"></a>层次化索引</h3><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> DataFrame, Series</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div></pre></td></tr></table></figure>
<h3 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># series类似一维数组，由一组数据和数据的标签（索引）组成</span></div><div class="line">s = Series([<span class="number">11</span>, <span class="number">32</span>, <span class="number">-223</span>, <span class="number">114</span>])</div><div class="line"><span class="keyword">print</span> s</div><div class="line"><span class="keyword">print</span> s.index</div><div class="line"><span class="keyword">print</span> s.values</div><div class="line"><span class="comment"># 索引可以直接赋值修改</span></div><div class="line">s.index = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>]</div><div class="line"><span class="keyword">print</span> s</div><div class="line">s2 = Series([<span class="number">11</span>, <span class="number">32</span>, <span class="number">-223</span>, <span class="number">114</span>], index=[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>])</div><div class="line"><span class="keyword">print</span> s2[<span class="string">'a'</span>], <span class="string">'\n'</span>, s2[[<span class="string">'a'</span>, <span class="string">'d'</span>]]</div></pre></td></tr></table></figure>
<pre><code>0     11
1     32
2   -223
3    114
dtype: int64
RangeIndex(start=0, stop=4, step=1)
[  11   32 -223  114]
a     11
b     32
c   -223
d    114
dtype: int64
11 
a     11
d    114
dtype: int64
</code></pre><p><strong>Numpy数组运算的结果会保留索引和值之间的链接</strong></p>
<p>根据布尔型数组进行过滤，标量乘法，数学函数等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> s2 &gt; <span class="number">11</span>  <span class="comment">## 得到布尔型数组</span></div><div class="line"><span class="keyword">print</span> s2[s2 &gt; <span class="number">11</span>] <span class="comment">## 根据布尔型数组筛选对应为true的元素</span></div><div class="line"></div><div class="line"><span class="comment">## 可以将series理解为定长字典，因为是key-value的对应关系，series也可以由字典对象创建</span></div><div class="line">d = &#123;<span class="string">'Alice'</span>: <span class="number">98</span>, <span class="string">'Bob'</span>: <span class="number">87</span>, <span class="string">'Cc'</span>: <span class="number">67</span>&#125;</div><div class="line">score1 = Series(d)</div><div class="line"><span class="keyword">print</span> score1</div><div class="line"><span class="keyword">print</span> <span class="string">'Alice'</span> <span class="keyword">in</span> score1</div><div class="line"><span class="comment">## 同时传入字典和index索引</span></div><div class="line">student = [<span class="string">'Alice'</span>, <span class="string">'Cc'</span>, <span class="string">'Sam'</span>, <span class="string">'Wandou'</span>]</div><div class="line">score2 = Series(d, index=student) <span class="comment"># 会根据index查找字典中相应的数据，找不到的对应index的值为NaN，表示缺失或非数字</span></div><div class="line"><span class="keyword">print</span> score2</div><div class="line"><span class="keyword">print</span> score2.isnull()</div><div class="line"><span class="keyword">print</span> score2.notnull()</div></pre></td></tr></table></figure>
<pre><code>a    False
b     True
c    False
d     True
dtype: bool
b     32
d    114
dtype: int64
Alice    98
Bob      87
Cc       67
dtype: int64
True
Alice     98.0
Cc        67.0
Sam        NaN
Wandou     NaN
dtype: float64
Alice     False
Cc        False
Sam        True
Wandou     True
dtype: bool
Alice      True
Cc         True
Sam       False
Wandou    False
dtype: bool
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 在算术运算中，会自动对其不同索引的数据</span></div><div class="line"><span class="keyword">print</span> score1, score2</div><div class="line"><span class="keyword">print</span> score1 + score2 </div><div class="line"></div><div class="line"><span class="comment">## 索引和数据都有一个name属性</span></div><div class="line">score2.name = <span class="string">'score'</span></div><div class="line">score2.index.name = <span class="string">'name'</span></div><div class="line"><span class="keyword">print</span> score2</div></pre></td></tr></table></figure>
<pre><code>Alice    98
Bob      87
Cc       67
dtype: int64 Alice     98.0
Cc        67.0
Sam        NaN
Wandou     NaN
dtype: float64
Alice     196.0
Bob         NaN
Cc        134.0
Sam         NaN
Wandou      NaN
dtype: float64
name
Alice     98.0
Cc        67.0
Sam        NaN
Wandou     NaN
Name: score, dtype: float64
</code></pre><h3 id="DataFrame"><a href="#DataFrame" class="headerlink" title="DataFrame"></a>DataFrame</h3><p>dataframe是一种表格型的数据结构，含有一组有序的列，每列的数值类型可以不同。<br>dataframe既有行索引，又有列索引，可以看做Series组成的字典。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 构建DataFrame，传入等长的列表或Numpy数组</span></div><div class="line">province = [<span class="string">'Beijing'</span>, <span class="string">'Shandong'</span>, <span class="string">'Shanghai'</span>, <span class="string">'Hubei'</span>, <span class="string">'Hunan'</span>]</div><div class="line">area = [<span class="number">50</span>, <span class="number">156</span>, <span class="number">300</span>, <span class="number">250</span>, <span class="number">260</span>]</div><div class="line">pop = [<span class="number">5000</span>, <span class="number">16000</span>, <span class="number">9000</span>, <span class="number">10000</span>, <span class="number">8000</span>]</div><div class="line">data = &#123;<span class="string">'province'</span>: province, <span class="string">'people'</span>: pop, <span class="string">'area'</span>: area&#125;</div><div class="line">frame1 = DataFrame(data)</div><div class="line"><span class="keyword">print</span> frame1</div><div class="line"><span class="comment"># 指定列的排列顺序</span></div><div class="line">frame2 = DataFrame(data, columns=[<span class="string">'province'</span>, <span class="string">'area'</span>, <span class="string">'people'</span>])</div><div class="line"><span class="keyword">print</span> frame2</div><div class="line"><span class="comment"># 加入自定义索引</span></div><div class="line">frame3 = DataFrame(data, columns=[<span class="string">'province'</span>, <span class="string">'area'</span>, <span class="string">'people'</span>], index=data[<span class="string">'province'</span>])</div><div class="line"><span class="keyword">print</span> frame3</div><div class="line"><span class="comment"># 获取列</span></div><div class="line"><span class="keyword">print</span> frame3[<span class="string">'area'</span>]</div><div class="line"><span class="keyword">print</span> frame3.area</div><div class="line"><span class="comment"># 获取行</span></div><div class="line"><span class="keyword">print</span> frame3.ix[<span class="string">'Shandong'</span>]</div><div class="line"><span class="comment"># 添加一列或修改一列，</span></div><div class="line">frame3[<span class="string">'GDP_Unit'</span>] = <span class="string">'亿元'</span>  <span class="comment"># 一列所有数据都改为该值</span></div><div class="line">frame3[<span class="string">'GDP'</span>] = [<span class="number">150</span>, <span class="number">160</span>, <span class="number">170</span>,  <span class="number">180</span>, <span class="number">190</span>] </div><div class="line"><span class="keyword">print</span> frame3</div><div class="line">frame3.GDP = Series(&#123;<span class="string">'Beijing'</span>: <span class="number">0</span>, <span class="string">'Shandong'</span>: <span class="number">-1</span>, <span class="string">'Shanghai'</span>: <span class="number">2</span>, <span class="string">'hah'</span>: <span class="number">90</span>&#125;)</div><div class="line"><span class="keyword">print</span> frame3</div><div class="line"><span class="comment"># 如果值是列表，要等长。</span></div><div class="line"><span class="comment"># 如果是Series，则严格按照Series的索引赋值该列，series中无相应index的，frame中该值改为Na</span></div></pre></td></tr></table></figure>
<pre><code>   area  people  province
0    50    5000   Beijing
1   156   16000  Shandong
2   300    9000  Shanghai
3   250   10000     Hubei
4   260    8000     Hunan
   province  area  people
0   Beijing    50    5000
1  Shandong   156   16000
2  Shanghai   300    9000
3     Hubei   250   10000
4     Hunan   260    8000
          province  area  people
Beijing    Beijing    50    5000
Shandong  Shandong   156   16000
Shanghai  Shanghai   300    9000
Hubei        Hubei   250   10000
Hunan        Hunan   260    8000
Beijing      50
Shandong    156
Shanghai    300
Hubei       250
Hunan       260
Name: area, dtype: int64
Beijing      50
Shandong    156
Shanghai    300
Hubei       250
Hunan       260
Name: area, dtype: int64
province    Shandong
area             156
people         16000
Name: Shandong, dtype: object
          province  area  people GDP_Unit  GDP
Beijing    Beijing    50    5000       亿元  150
Shandong  Shandong   156   16000       亿元  160
Shanghai  Shanghai   300    9000       亿元  170
Hubei        Hubei   250   10000       亿元  180
Hunan        Hunan   260    8000       亿元  190
          province  area  people GDP_Unit  GDP
Beijing    Beijing    50    5000       亿元  0.0
Shandong  Shandong   156   16000       亿元 -1.0
Shanghai  Shanghai   300    9000       亿元  2.0
Hubei        Hubei   250   10000       亿元  NaN
Hunan        Hunan   260    8000       亿元  NaN
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">frame3.GDP.isnull()</div></pre></td></tr></table></figure>
<pre><code>Beijing     False
Shandong    False
Shanghai    False
Hubei        True
Hunan        True
Name: GDP, dtype: bool
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 删除一列</span></div><div class="line"><span class="keyword">del</span> frame3[<span class="string">'GDP'</span>]</div><div class="line"><span class="keyword">print</span> frame3.columns</div></pre></td></tr></table></figure>
<pre><code>Index([u&apos;province&apos;, u&apos;area&apos;, u&apos;people&apos;, u&apos;GDP_Unit&apos;], dtype=&apos;object&apos;)
</code></pre><p>​    </p>
<p><strong>使用嵌套字典创建dataframe</strong></p>
<p>外层的字典key作为列索引，内层的字典key作为行索引。<br>frame可以转置。内层的字典key会被合并、排序最终成为行索引，显示指定了index的除外</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">data = &#123;<span class="string">'province'</span>: &#123;<span class="string">'Shandong'</span>: <span class="string">'Shangdong'</span>, <span class="string">'Beijing'</span>: <span class="string">'Beijing'</span>, <span class="string">'Hubei'</span>: <span class="string">'Hubei'</span>&#125;,</div><div class="line">        <span class="string">'GDP'</span>: &#123;<span class="string">'Shanghai'</span>: <span class="number">15000</span>, <span class="string">'Shandong'</span>: <span class="number">20000</span>, <span class="string">'Hubei'</span>: <span class="number">7000</span>&#125;,</div><div class="line">        <span class="string">'people'</span>: &#123;<span class="string">'Shandong'</span>: <span class="number">100000</span>, <span class="string">'Hubei'</span>: <span class="number">20000</span>&#125;</div><div class="line">       &#125;</div><div class="line">frame = DataFrame(data)  <span class="comment">## 缺省的值设为NaN</span></div><div class="line"><span class="keyword">print</span> frame</div><div class="line">frame = DataFrame(data, index=[<span class="string">'Guangzhou'</span>, <span class="string">'Beijing'</span>, <span class="string">'Shanghai'</span>, <span class="string">'Shandong'</span>])</div><div class="line"><span class="keyword">print</span> frame</div><div class="line"><span class="keyword">print</span> frame.T</div></pre></td></tr></table></figure>
<pre><code>              GDP    people   province
Beijing       NaN       NaN    Beijing
Hubei      7000.0   20000.0      Hubei
Shandong  20000.0  100000.0  Shangdong
Shanghai  15000.0       NaN        NaN
               GDP    people   province
Guangzhou      NaN       NaN        NaN
Beijing        NaN       NaN    Beijing
Shanghai   15000.0       NaN        NaN
Shandong   20000.0  100000.0  Shangdong
         Guangzhou  Beijing Shanghai   Shandong
GDP            NaN      NaN    15000      20000
people         NaN      NaN      NaN     100000
province       NaN  Beijing      NaN  Shangdong
</code></pre><h3 id="可以用于构造DataFrame的数据"><a href="#可以用于构造DataFrame的数据" class="headerlink" title="可以用于构造DataFrame的数据"></a>可以用于构造DataFrame的数据</h3><ul>
<li>二维ndarray</li>
<li>值为数组，列表或元组的字典， 每个数据序列必须等长，作为dataframe的一列</li>
<li>值为Series的字典， 每个series成为frame的一列，如果没有指定index索引，则series内的索引会成为行索引</li>
<li>嵌套字典</li>
<li>。。。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">frame3.values  <span class="comment">## frame的values是ndarray， ndarray的数据类型会选择能兼容各列数据的类型</span></div></pre></td></tr></table></figure>
<pre><code>array([[&apos;Beijing&apos;, 50L, 5000L, &apos;\xe4\xba\xbf\xe5\x85\x83&apos;],
       [&apos;Shandong&apos;, 156L, 16000L, &apos;\xe4\xba\xbf\xe5\x85\x83&apos;],
       [&apos;Shanghai&apos;, 300L, 9000L, &apos;\xe4\xba\xbf\xe5\x85\x83&apos;],
       [&apos;Hubei&apos;, 250L, 10000L, &apos;\xe4\xba\xbf\xe5\x85\x83&apos;],
       [&apos;Hunan&apos;, 260L, 8000L, &apos;\xe4\xba\xbf\xe5\x85\x83&apos;]], dtype=object)
</code></pre><h3 id="索引对象"><a href="#索引对象" class="headerlink" title="索引对象"></a>索引对象</h3><p>Index对象的值是不能不被修改的<br>包含的方法有</p>
<ul>
<li>append 连接一个index对象</li>
<li>diff 计算差集，并得到一个index</li>
<li>intersect 计算交集</li>
<li>union 计算并集</li>
<li>isin 计算index各值是否在给定的集合内，返回一个布尔型数组</li>
<li>delete 删除索引i处的元素，并得到新的index</li>
<li>drop</li>
<li>insert</li>
<li>is_monotonic 是否单调</li>
<li>is_unique  是否有重复值</li>
<li>unique  计算index中唯一值得数组</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 重新索引对象, 生成新的series或frame</span></div><div class="line"><span class="keyword">print</span> s.index</div><div class="line">q = s.reindex([<span class="string">'e'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>]) </div><div class="line"><span class="comment"># 另外一个可选参数，fill_value=0设置默认值或method='填充方法'，ffill、pad向前填充，bfill或backfill向后填充</span></div><div class="line"><span class="keyword">print</span> q</div><div class="line">p = frame3.reindex(index=[], columns=[], method=<span class="string">'ffill'</span>) <span class="comment"># 可以同时重新index和column，值填充只能按行应用</span></div></pre></td></tr></table></figure>
<pre><code>Index([u&apos;a&apos;, u&apos;b&apos;, u&apos;c&apos;, u&apos;d&apos;], dtype=&apos;object&apos;)
e      NaN
d    114.0
c   -223.0
b     32.0
a     11.0
dtype: float64
</code></pre><h3 id="索引、选取和过滤"><a href="#索引、选取和过滤" class="headerlink" title="索引、选取和过滤"></a>索引、选取和过滤</h3><ul>
<li>行列索引</li>
<li>布尔型dataframe索引</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> frame3[<span class="string">'area'</span>]</div><div class="line"><span class="keyword">print</span> frame3[:<span class="number">4</span>]  <span class="comment"># 选取的列</span></div><div class="line"><span class="keyword">print</span> frame3[frame3[<span class="string">'area'</span>] &gt; <span class="number">160</span>]  <span class="comment"># 根据布尔型选取</span></div><div class="line">frame3.ix[:<span class="number">2</span>, [<span class="string">'area'</span>, <span class="string">'people'</span>]] <span class="comment"># 同时选取行和列</span></div></pre></td></tr></table></figure>
<pre><code>Beijing      50
Shandong    156
Shanghai    300
Hubei       250
Hunan       260
Name: area, dtype: int64
          province  area  people GDP_Unit
Beijing    Beijing    50    5000       亿元
Shandong  Shandong   156   16000       亿元
Shanghai  Shanghai   300    9000       亿元
Hubei        Hubei   250   10000       亿元
          province  area  people GDP_Unit
Shanghai  Shanghai   300    9000       亿元
Hubei        Hubei   250   10000       亿元
Hunan        Hunan   260    8000       亿元
</code></pre><div><br><table border="1" class="dataframe"><br>  <thead><br>    <tr style="text-align: right;"><br>      <th></th><br>      <th>area</th><br>      <th>people</th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <th>Beijing</th><br>      <td>50</td><br>      <td>5000</td><br>    </tr><br>    <tr><br>      <th>Shandong</th><br>      <td>156</td><br>      <td>16000</td><br>    </tr><br>  </tbody><br></table><br></div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> frame3.iloc[<span class="number">1</span>,:<span class="number">2</span>] <span class="comment"># 根据位置整数选取</span></div><div class="line"><span class="keyword">print</span> frame3.loc[:, [<span class="string">'area'</span>, <span class="string">'people'</span>]] <span class="comment"># 同时根据行列lable选取</span></div></pre></td></tr></table></figure>
<pre><code>province    Shandong
area             156
Name: Shandong, dtype: object
          area  people
Beijing     50    5000
Shandong   156   16000
Shanghai   300    9000
Hubei      250   10000
Hunan      260    8000
</code></pre><h3 id="算数运算和数据对齐"><a href="#算数运算和数据对齐" class="headerlink" title="算数运算和数据对齐"></a>算数运算和数据对齐</h3><p>计算是在两个对象索引的并集上运算，相同索引的值进行运算，不重叠的索引处引入NaN值。缺省值NaN在运算中会传播。<br>在运算add、sub、div、mul中传入参数fill_value=0可以指定一个填充值。<br>DataFrame和Series进行运算时，会产生广播。</p>
<h3 id="函数应用和映射"><a href="#函数应用和映射" class="headerlink" title="函数应用和映射"></a>函数应用和映射</h3><p>Numpy的元素级函数可用于操作Pandas对象</p>
<ul>
<li>np.abs(frame) 和其他函数</li>
<li>frame.apply(funcs)</li>
<li>frame.applymap(funcs)</li>
<li>series.map()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">frame = DataFrame(np.random.randn(<span class="number">4</span>, <span class="number">3</span>), columns=list(<span class="string">'abc'</span>), index=range(<span class="number">1</span>, <span class="number">5</span>))</div><div class="line">frame2 = np.abs(frame)</div><div class="line"><span class="keyword">print</span> frame</div><div class="line"><span class="keyword">print</span> frame2</div><div class="line">f1 = <span class="keyword">lambda</span> x: x.max()</div><div class="line"><span class="keyword">print</span> frame.apply(f1)   <span class="comment"># 将函数应用到frame的列</span></div><div class="line"><span class="keyword">print</span> frame.max() <span class="comment">## 很多统计函数已被实现，没必要用apply</span></div><div class="line"><span class="keyword">print</span> frame.apply(f1, axis=<span class="number">1</span>)  <span class="comment"># 将函数应用于frame的行</span></div><div class="line"><span class="comment">## apply的函数除了返回值外，也可返回多个值组成的series，frame</span></div><div class="line">f2 = <span class="keyword">lambda</span> x: Series([x.min(), x.max()], index=[<span class="string">'min'</span>, <span class="string">'max'</span>])</div><div class="line"><span class="keyword">print</span> frame.apply(f2)</div><div class="line"><span class="comment">## 如果要在元素级上应用函数，frame使用applymap(),series使用map()</span></div><div class="line">f3 = <span class="keyword">lambda</span> x: <span class="string">'%.2f'</span> %x</div><div class="line"><span class="keyword">print</span> frame.applymap(f3)</div><div class="line"><span class="keyword">print</span> frame.a.map(f3)</div></pre></td></tr></table></figure>
<pre><code>          a         b         c
1  0.811815  0.501822  0.225176
2  0.171434 -1.446678  0.148284
3 -0.187686 -1.017413  1.145296
4 -0.596069 -0.376504 -0.298326
          a         b         c
1  0.811815  0.501822  0.225176
2  0.171434  1.446678  0.148284
3  0.187686  1.017413  1.145296
4  0.596069  0.376504  0.298326
a    0.811815
b    0.501822
c    1.145296
dtype: float64
a    0.811815
b    0.501822
c    1.145296
dtype: float64
1    0.811815
2    0.171434
3    1.145296
4   -0.298326
dtype: float64
            a         b         c
min -0.596069 -1.446678 -0.298326
max  0.811815  0.501822  1.145296
       a      b      c
1   0.81   0.50   0.23
2   0.17  -1.45   0.15
3  -0.19  -1.02   1.15
4  -0.60  -0.38  -0.30
1     0.81
2     0.17
3    -0.19
4    -0.60
Name: a, dtype: object
</code></pre><h3 id="排序和排名"><a href="#排序和排名" class="headerlink" title="排序和排名"></a>排序和排名</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s = Series(range(<span class="number">5</span>), index=list(<span class="string">'qwert'</span>))</div><div class="line"><span class="keyword">print</span> s.sort_index(ascending=<span class="keyword">False</span>)</div><div class="line"><span class="keyword">print</span> s.sort_values(ascending=<span class="keyword">False</span>)  <span class="comment"># 缺省值会排序放到最后</span></div><div class="line"><span class="keyword">print</span> frame.sort_index(axis=<span class="number">1</span>, ascending=<span class="keyword">False</span>)</div><div class="line"><span class="keyword">print</span> frame.sort_values(<span class="string">'a'</span>)</div><div class="line"><span class="keyword">print</span> frame.rank(method=<span class="string">'first'</span>)</div></pre></td></tr></table></figure>
<pre><code>w    1
t    4
r    3
q    0
e    2
dtype: int64
t    4
r    3
e    2
w    1
q    0
dtype: int64
          c         b         a
1  0.225176  0.501822  0.811815
2  0.148284 -1.446678  0.171434
3  1.145296 -1.017413 -0.187686
4 -0.298326 -0.376504 -0.596069
          a         b         c
4 -0.596069 -0.376504 -0.298326
3 -0.187686 -1.017413  1.145296
2  0.171434 -1.446678  0.148284
1  0.811815  0.501822  0.225176
     a    b    c
1  4.0  4.0  3.0
2  3.0  1.0  2.0
3  2.0  2.0  4.0
4  1.0  3.0  1.0
</code></pre><p><strong>Index索引可以是重复的</strong></p>
<p>选取了重复index的数据，返回的时series，非重复的直接返回其值<br>frame的index也是可以重复的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s = Series(range(<span class="number">5</span>), index=list(<span class="string">'qaqaz'</span>))</div><div class="line"><span class="keyword">print</span> s.a</div><div class="line"><span class="keyword">print</span> s.z</div></pre></td></tr></table></figure>
<pre><code>a    1
a    3
dtype: int64
4
</code></pre>
      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-15T16:00:00.000Z"><a href="/2017/02/16/技术/scrapy-image-download/">2017-02-16</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/16/技术/scrapy-image-download/">scrapy ImagePipeline下载gif图片和自定义图片文件名称</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#scrapy图片下载保留gif格式和自定义图片名称"><span class="toc-text">scrapy图片下载保留gif格式和自定义图片名称</span></a></li></ol>
    </div>

      
        <h3 id="scrapy图片下载保留gif格式和自定义图片名称"><a href="#scrapy图片下载保留gif格式和自定义图片名称" class="headerlink" title="scrapy图片下载保留gif格式和自定义图片名称"></a>scrapy图片下载保留gif格式和自定义图片名称</h3><p>继承ImagesPipeline并重写部分函数</p>
<ul>
<li><p><code>get_media_requests</code>  返回下载图片的Request</p>
</li>
<li><p><code>file_path</code> 返回文件名，文件名是sha1哈希image url生成的image_guid</p>
</li>
<li><p><code>convert_image</code>  该函数将图片转化成rgb 模式的jpg格式，避免重新下载近期下载过的图片</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######################## pipelines.py #######################################</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="comment"># Define your item pipelines here</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span></div><div class="line"><span class="comment"># See: http://doc.scrapy.org/en/latest/topics/item-pipeline.html</span></div><div class="line"><span class="keyword">import</span> pymongo</div><div class="line"><span class="keyword">from</span> scrapy.pipelines.images <span class="keyword">import</span> ImagesPipeline</div><div class="line"><span class="keyword">from</span> scrapy.http <span class="keyword">import</span> Request</div><div class="line"><span class="comment"># from scrapy.exceptions import DropItem</span></div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO <span class="keyword">as</span> BytesIO</div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">    <span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JokerPipeline</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    collection_name = <span class="string">'joke'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mongo_uri, mongo_db)</span>:</span></div><div class="line">        self.mongo_uri = mongo_uri</div><div class="line">        self.mongo_db = mongo_db</div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></div><div class="line">        <span class="keyword">return</span> cls(</div><div class="line">            mongo_uri=crawler.settings.get(<span class="string">'MONGO_URI'</span>),</div><div class="line">            mongo_db=crawler.settings.get(<span class="string">"MONGO_DATABASE"</span>, <span class="string">"items"</span>)</div><div class="line">        )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span><span class="params">(self, spider)</span>:</span></div><div class="line">        self.client = pymongo.MongoClient(self.mongo_uri)</div><div class="line">        self.db = self.client[self.mongo_db]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span><span class="params">(self, spider)</span>:</span></div><div class="line">        self.client.close()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></div><div class="line">        <span class="comment"># data = self.db[self.collection_name].find(&#123;&#125;, &#123;'_id': 0, 'url': 1&#125;)</span></div><div class="line">        <span class="comment"># url_finished = set(x['url'] for x in data)</span></div><div class="line">        <span class="comment"># if item['pic-url']:</span></div><div class="line">        <span class="comment">#     # raise DropItem("%s has been crawled!" % item)</span></div><div class="line">        <span class="comment">#     pic_name = item['data-id'] + '.' + item['pic-url'].plite('.')[-1]</span></div><div class="line">        <span class="comment"># else:</span></div><div class="line">        self.db[self.collection_name].insert(dict(item))</div><div class="line">        <span class="keyword">return</span> item</div><div class="line"></div><div class="line">    </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageDownloadPipeline</span><span class="params">(ImagesPipeline)</span>:</span></div><div class="line">    default_headers = &#123;</div><div class="line">      <span class="string">'accept'</span>: <span class="string">'image/webp,image/*,*/*;q=0.8'</span>,</div><div class="line">      <span class="string">'accept-encoding'</span>: <span class="string">'gzip, deflate, sdch, br'</span>,</div><div class="line">      <span class="string">'accept-language'</span>: <span class="string">'zh-CN,zh;q=0.8,en;q=0.6'</span>,</div><div class="line">      <span class="string">'cookie'</span>: <span class="string">'bid=yQdC/AzTaCw'</span>,</div><div class="line">      <span class="string">'referer'</span>: <span class="string">'https://www.douban.com/photos/photo/2370443040/'</span>,</div><div class="line">      <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36'</span>,</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_media_requests</span><span class="params">(self, item, info)</span>:</span>  <span class="comment"># 下载图片</span></div><div class="line">        <span class="keyword">for</span> image_url <span class="keyword">in</span> item[<span class="string">'pic_url'</span>]:</div><div class="line">            self.default_headers[<span class="string">'referer'</span>] = image_url</div><div class="line">            <span class="keyword">yield</span> Request(image_url, headers=self.default_headers,</div><div class="line">                          meta=&#123;<span class="string">'item'</span>: item&#125;)  <span class="comment"># # 使用meta是我想用item里的某个字段做图片的名字，</span></div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">file_path</span><span class="params">(self, request, response=None, info=None)</span>:</span></div><div class="line">        item = request.meta[<span class="string">'item'</span>]  <span class="comment"># 通过上面的meta传递过来item</span></div><div class="line">        <span class="comment"># 图片文件名，request.url.split('/')[-1].split('.')[-1]得到图片后缀jpg,png,gif</span></div><div class="line">        image_guid = item[<span class="string">'data-id'</span>] + <span class="string">'-'</span> + request.url.split(<span class="string">'/'</span>)[<span class="number">-1</span>]</div><div class="line">        <span class="comment"># 使用有中文的item字段做目录时，用path=''.join(item['no1']),否则路径会变成\u97e9\u56fd\u6c7d\u8f66\u6807\u5fd7\xxx.jpg</span></div><div class="line">        filename = <span class="string">u'full/&#123;0&#125;'</span>.format(image_guid)</div><div class="line">        <span class="keyword">return</span> filename</div><div class="line">  </div><div class="line">    <span class="comment">#  图片格式转换，如果是gif，则不转换，可能会出问题</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_image</span><span class="params">(self, image, size=None)</span>:</span></div><div class="line">        <span class="comment"># 自己添加的</span></div><div class="line">        <span class="keyword">if</span> image.format == <span class="string">'GIF'</span>:</div><div class="line">            buf = BytesIO()</div><div class="line">            image.save(buf, <span class="string">'GIF'</span>)</div><div class="line">            <span class="keyword">return</span> image, buf</div><div class="line">        <span class="comment"># 原始代码</span></div><div class="line">        <span class="keyword">if</span> image.format == <span class="string">'PNG'</span> <span class="keyword">and</span> image.mode == <span class="string">'RGBA'</span>:</div><div class="line">            background = Image.new(<span class="string">'RGBA'</span>, image.size, (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</div><div class="line">            background.paste(image, image)</div><div class="line">            image = background.convert(<span class="string">'RGB'</span>)</div><div class="line">        <span class="keyword">elif</span> image.mode != <span class="string">'RGB'</span>:</div><div class="line">            image = image.convert(<span class="string">'RGB'</span>)</div><div class="line">  </div><div class="line">        <span class="keyword">if</span> size:</div><div class="line">            image = image.copy()</div><div class="line">            image.thumbnail(size, Image.ANTIALIAS)</div><div class="line">  </div><div class="line">        buf = BytesIO()</div><div class="line">        image.save(buf, <span class="string">'JPEG'</span>)</div><div class="line">        <span class="keyword">return</span> image, buf</div><div class="line">  </div><div class="line">    <span class="comment"># 重写下载完图片的处理方法image_downloaded</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_gif</span><span class="params">(self, image)</span>:</span></div><div class="line">        <span class="keyword">if</span> image.format == <span class="string">'GIF'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">        <span class="comment"># The library reads GIF87a and GIF89a versions of the GIF file format.</span></div><div class="line">        <span class="keyword">return</span> image.info.get(<span class="string">'version'</span>) <span class="keyword">in</span> [<span class="string">'GIF89a'</span>, <span class="string">'GIF87a'</span>]</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">persist_gif</span><span class="params">(self, key, data, info)</span>:</span></div><div class="line">        root, ext = os.path.splitext(key)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> key.endswith((<span class="string">'.gif'</span>, <span class="string">'.GIF'</span>)):</div><div class="line">            key = key + <span class="string">'.gif'</span></div><div class="line">        absolute_path = self.store._get_filesystem_path(key)</div><div class="line">        self.store._mkdir(os.path.dirname(absolute_path), info)</div><div class="line">        f = open(absolute_path, <span class="string">'wb'</span>)  <span class="comment"># use 'b' to write binary data.</span></div><div class="line">        f.write(data)</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">image_downloaded</span><span class="params">(self, response, request, info)</span>:</span></div><div class="line">        checksum = <span class="keyword">None</span></div><div class="line">        <span class="keyword">for</span> key, image, buf <span class="keyword">in</span> self.get_images(response, request, info):</div><div class="line">            <span class="keyword">if</span> checksum <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                buf.seek(<span class="number">0</span>)</div><div class="line">                checksum = md5sum(buf)</div><div class="line">            <span class="keyword">if</span> key.startswith(<span class="string">'full'</span>) <span class="keyword">and</span> self.check_gif(image):</div><div class="line">                <span class="comment"># Save gif from response directly.</span></div><div class="line">                self.persist_gif(key, response.body, info)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                width, height = image.size</div><div class="line">                self.store.persist_file(</div><div class="line">                    key, buf, info,</div><div class="line">                    meta=&#123;<span class="string">'width'</span>: width, <span class="string">'height'</span>: height&#125;,</div><div class="line">                    headers=&#123;<span class="string">'Content-Type'</span>: <span class="string">'image/jpeg'</span>&#125;)</div><div class="line">                <span class="comment"># self.store.persist_image(key, image, buf, info)</span></div><div class="line">        <span class="keyword">return</span> checksum</div></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-11T16:00:00.000Z"><a href="/2017/02/12/技术/how-to-use-Linux/">2017-02-12</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/12/技术/how-to-use-Linux/">如何优雅的使用Linux</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#如何优雅的使用Linux"><span class="toc-text">如何优雅的使用Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、选择"><span class="toc-text">1、选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、卸载liboffice"><span class="toc-text">2、卸载liboffice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、更改主目录文件夹名为英文"><span class="toc-text">3、更改主目录文件夹名为英文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、美化"><span class="toc-text">4、美化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、python开发环境"><span class="toc-text">5、python开发环境</span></a></li></ol></li></ol>
    </div>

      
        <h2 id="如何优雅的使用Linux"><a href="#如何优雅的使用Linux" class="headerlink" title="如何优雅的使用Linux"></a>如何优雅的使用Linux</h2><blockquote>
<p>作为学习/开发环境使用，而不是娱乐。写这边文章是为了下次重装系统快速恢复，系统使用以为简洁、优雅、高效为目标。</p>
</blockquote>
<h3 id="1、选择"><a href="#1、选择" class="headerlink" title="1、选择"></a>1、选择</h3><ul>
<li><p>发行版选择Debian</p>
<p>之前一直使用Ubuntu，大概过那么一两个月就会出现啥问题，然后不得不重装系统，我严重Ubuntu16.04的桌面有bug，开2个软件窗口就卡的爹妈不认了。现在决定再也不用Ubuntu了，改用Debian8后稳定多了，图形桌面很少崩溃。关于centos和openSUSE，只在搭建服务器使用过，个人使用还是更习惯Debian系的。</p>
</li>
<li><p>桌面选择</p>
<p>Ubuntu的unity真tm丑，紫色的主题我也是忍了好久才适应下来。现在改用gnome3。</p>
</li>
</ul>
<h3 id="2、卸载liboffice"><a href="#2、卸载liboffice" class="headerlink" title="2、卸载liboffice"></a>2、卸载liboffice</h3><p>事实上我连wps也没装，以前是装机必备，最后发现一共使用的次数不超过10次，office那套还是交给windows吧。文档记录使用txt和markdown。</p>
<p>完全卸载<code>sudo apt-get purge libreoffice?</code></p>
<p>然后安装Typora markdown工具。参考<a href="https://typora.io/#linux" target="_blank" rel="external">官网</a>,</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys BA300B7755AFCFAE</div><div class="line"><span class="meta">#</span><span class="bash"> 添加密钥和源</span></div><div class="line">在 /etc/apt/sources.list中添加一条</div><div class="line">'deb https://typora.io ./linux/'</div><div class="line">sudo apt-get update</div><div class="line"><span class="meta">#</span><span class="bash"> 安装 typora</span></div><div class="line">sudo apt-get install typora</div></pre></td></tr></table></figure>
<h3 id="3、更改主目录文件夹名为英文"><a href="#3、更改主目录文件夹名为英文" class="headerlink" title="3、更改主目录文件夹名为英文"></a>3、更改主目录文件夹名为英文</h3><p>打开终端，在终端中输入命令:</p>
<p>$ export LANG=en_US</p>
<p>$ xdg-user-dirs-gtk-update</p>
<p>在弹出的窗口中询问是否将目录转化为英文路径,勾上不再提示并同意更改，</p>
<p>$ export LANG=zh_CN</p>
<p>$ xdg-user-dirs-gtk-update</p>
<p>关闭终端,并注销或重启.下次进入系统.主目录的中文转英文就完成了~</p>
<h3 id="4、美化"><a href="#4、美化" class="headerlink" title="4、美化"></a>4、美化</h3><p>Debian刚装上以后真是丑啊，尤其是白底黑字的shell终端，让人抓狂。</p>
<p>这里美化仅仅是设置gtk主题，gnome-shell主题，改变terminal的颜色等，以美观实用为主，花里胡哨的东西请去windows娱乐。<a href="http://pan.baidu.com/s/1bptb0q7" target="_blank" rel="external">相关文件下载</a></p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-1-13/24372984-file_1484279558800_15aef.jpg" alt=""></p>
<ul>
<li><p>安装gnome-tweak-tool</p>
<p><code>apt-get install  gnome-tweak-tool</code></p>
<p>这个工具不能用root运行。按下win，搜索tweak，点优化工具打开。</p>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-1-13/55004083-file_1484279629065_5309.jpg" alt=""></p>
<p>在扩展中启用user-themes，然后gnome shell主题才可用。下面几个插件推荐安装</p>
<p><img src="http://ww4.sinaimg.cn/large/af9df239jw1fbotcppqfkj20m80go3zt.jpg" alt=""></p>
<p><img src="http://ww2.sinaimg.cn/large/af9df239jw1fbotlgidrfj20ex07j3yr.jpg" alt=""></p>
</li>
<li><p>安装gnome主题</p>
<p>主题可以去网上下载，我直接从Kali Linux上copy出来的。将themes文件夹内容放入/usr/share/themes/下即可，操作之前先备份。</p>
</li>
<li><p>安装gnome-shell主题</p>
<p>备份替换/usr/share/gnome-shell/内容。</p>
</li>
<li><p>字体</p>
<p>备份替换 /usr/share/fonts 内容。如果使用主题后，登陆桌面崩溃，则很有可能缺少字体。</p>
</li>
<li><p>改变壁纸和锁屏、登陆背景</p>
<p>壁纸锁屏可以在设置中修改。</p>
<p>登陆背景，替换gnome-shell主题内的图片，位置 /usr/share/gnome-shell/theme/KaliLogin.png</p>
</li>
</ul>
<ul>
<li><p>安装配置terminator</p>
<p>修改终端内的文字高亮，自动代码补全。shell环境变量配置文件有</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /etc/profile  用户登陆时加载，全局配置，</span></div><div class="line"><span class="meta">#</span><span class="bash"> /etc/bash.bashrc 打开shell时配置shell变量，如果~/.bashrc文件存在则会使用其配置，</span></div><div class="line"><span class="meta">#</span><span class="bash"> ~/.bashrc，仅对该用户有效，user和root下的建议都改</span></div><div class="line"><span class="meta">#</span><span class="bash"> .bashrc文件修改</span></div><div class="line"><span class="meta">#</span><span class="bash"> If not running interactively, don<span class="string">'t do anything</span></span></div><div class="line">case $- in</div><div class="line">    *i*) ;;</div><div class="line">      *) return;;</div><div class="line">esac</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> don<span class="string">'t put duplicate lines or lines starting with space in the history.</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> See bash(1) <span class="keyword">for</span> more options</span></div><div class="line">HISTCONTROL=ignoreboth</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> append to the <span class="built_in">history</span> file, don<span class="string">'t overwrite it</span></span></div><div class="line">shopt -s histappend</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> setting <span class="built_in">history</span> length see HISTSIZE and HISTFILESIZE <span class="keyword">in</span> bash(1)</span></div><div class="line">HISTSIZE=1000</div><div class="line">HISTFILESIZE=2000</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> check the window size after each <span class="built_in">command</span> and, <span class="keyword">if</span> necessary,</span></div><div class="line"><span class="meta">#</span><span class="bash"> update the values of LINES and COLUMNS.</span></div><div class="line">shopt -s checkwinsize</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> If <span class="built_in">set</span>, the pattern <span class="string">"**"</span> used <span class="keyword">in</span> a pathname expansion context will</span></div><div class="line"><span class="meta">#</span><span class="bash"> match all files and zero or more directories and subdirectories.</span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="built_in">shopt</span> -s globstar</span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> make less more friendly <span class="keyword">for</span> non-text input files, see lesspipe(1)</span></div><div class="line"><span class="meta">#</span><span class="bash">[ -x /usr/bin/lesspipe ] &amp;&amp; <span class="built_in">eval</span> <span class="string">"<span class="variable">$(SHELL=/bin/sh lesspipe)</span>"</span></span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> variable identifying the chroot you work <span class="keyword">in</span> (used <span class="keyword">in</span> the prompt below)</span></div><div class="line">if [ -z "$&#123;debian_chroot:-&#125;" ] &amp;&amp; [ -r /etc/debian_chroot ]; then</div><div class="line">    debian_chroot=$(cat /etc/debian_chroot)</div><div class="line">fi</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> a fancy prompt (non-color, unless we know we <span class="string">"want"</span> color)</span></div><div class="line">case "$TERM" in</div><div class="line">    xterm-color) color_prompt=yes;;</div><div class="line">esac</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> uncomment <span class="keyword">for</span> a colored prompt, <span class="keyword">if</span> the terminal has the capability; turned</span></div><div class="line"><span class="meta">#</span><span class="bash"> off by default to not distract the user: the focus <span class="keyword">in</span> a terminal window</span></div><div class="line"><span class="meta">#</span><span class="bash"> should be on the output of commands, not on the prompt</span></div><div class="line">force_color_prompt=yes</div><div class="line"></div><div class="line">if [ -n "$force_color_prompt" ]; then</div><div class="line">    if [ -x /usr/bin/tput ] &amp;&amp; tput setaf 1 &gt;&amp;/dev/null; then</div><div class="line"><span class="meta">	#</span><span class="bash"> We have color support; assume it<span class="string">'s compliant with Ecma-48</span></span></div><div class="line"><span class="meta">	#</span><span class="bash"> (ISO/IEC-6429). (Lack of such support is extremely rare, and such</span></div><div class="line"><span class="meta">	#</span><span class="bash"> a <span class="keyword">case</span> would tend to support setf rather than setaf.)</span></div><div class="line">	color_prompt=yes</div><div class="line">    else</div><div class="line">	color_prompt=</div><div class="line">    fi</div><div class="line">fi</div><div class="line"></div><div class="line">if [ "$color_prompt" = yes ]; then</div><div class="line">    PS1='$&#123;debian_chroot:+($debian_chroot)&#125;\[\033[01;31m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '</div><div class="line">else</div><div class="line">    PS1='$&#123;debian_chroot:+($debian_chroot)&#125;\u@\h:\w\$ '</div><div class="line">fi</div><div class="line">unset color_prompt force_color_prompt</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> If this is an xterm <span class="built_in">set</span> the title to user@host:dir</span></div><div class="line">case "$TERM" in</div><div class="line">xterm*|rxvt*)</div><div class="line">    PS1="\[\e]0;$&#123;debian_chroot:+($debian_chroot)&#125;\u@\h: \w\a\]$PS1"</div><div class="line">    ;;</div><div class="line">*)</div><div class="line">    ;;</div><div class="line">esac</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> color support of ls and also add handy aliases</span></div><div class="line">if [ -x /usr/bin/dircolors ]; then</div><div class="line">    test -r ~/.dircolors &amp;&amp; eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"</div><div class="line">    alias ls='ls --color=auto'</div><div class="line">    #alias dir='dir --color=auto'</div><div class="line">    #alias vdir='vdir --color=auto'</div><div class="line"></div><div class="line">    #alias grep='grep --color=auto'</div><div class="line">    #alias fgrep='fgrep --color=auto'</div><div class="line">    #alias egrep='egrep --color=auto'</div><div class="line">fi</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> some more ls aliases</span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="built_in">alias</span> ll=<span class="string">'ls -l'</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="built_in">alias</span> la=<span class="string">'ls -A'</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="built_in">alias</span> l=<span class="string">'ls -CF'</span></span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> Alias definitions.</span></div><div class="line"><span class="meta">#</span><span class="bash"> You may want to put all your additions into a separate file like</span></div><div class="line"><span class="meta">#</span><span class="bash"> ~/.bash_aliases, instead of adding them here directly.</span></div><div class="line"><span class="meta">#</span><span class="bash"> See /usr/share/doc/bash-doc/examples <span class="keyword">in</span> the bash-doc package.</span></div><div class="line"></div><div class="line">if [ -f ~/.bash_aliases ]; then</div><div class="line">    . ~/.bash_aliases</div><div class="line">fi</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> programmable completion features (you don<span class="string">'t need to enable</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> this, <span class="keyword">if</span> it<span class="string">'s already enabled in /etc/bash.bashrc and /etc/profile</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> sources /etc/bash.bashrc).</span></div><div class="line">if ! shopt -oq posix; then</div><div class="line">  if [ -f /usr/share/bash-completion/bash_completion ]; then</div><div class="line">    . /usr/share/bash-completion/bash_completion</div><div class="line">  elif [ -f /etc/bash_completion ]; then</div><div class="line">    . /etc/bash_completion</div><div class="line">  fi</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>然后右键终端，修改配置文件中背景为透明。背景透明简直太爽了，可以在敲命令时，透过终端看文档或浏览器，而不用将终端窗口挪来挪去。</p>
<p>​</p>
</li>
</ul>
<h3 id="5、python开发环境"><a href="#5、python开发环境" class="headerlink" title="5、python开发环境"></a>5、python开发环境</h3><ul>
<li>安装pyenv</li>
</ul>
<p><a href="https://github.com/yyuu/pyenv-installer" target="_blank" rel="external">自动安装,不推荐</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash</span></div><div class="line"><span class="meta">$</span><span class="bash"> pyenv update</span></div></pre></td></tr></table></figure>
<p><a href="https://github.com/yyuu/pyenv#installation" target="_blank" rel="external">手动git</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 安装依赖</span></div><div class="line"><span class="meta">#</span><span class="bash"> sudo apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev xz-utils</span></div><div class="line"></div><div class="line">git clone git://github.com/yyuu/pyenv.git ~/.pyenv</div><div class="line"><span class="meta">#</span><span class="bash"> 用户和root的我都改了,使用了绝对路径，没用<span class="variable">$HOME</span></span></div><div class="line">vim ~/.bashrc</div><div class="line">export PYENV_ROOT="/home/syy/.pyenv"</div><div class="line">export PATH="/home/syy/.pyenv/bin:$PATH"</div><div class="line">eval "$(pyenv init -)"</div><div class="line">eval "$(pyenv virtualenv-init -)"</div><div class="line">source ~/.bashrc</div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exec</span> <span class="variable">$SHELL</span></span></div></pre></td></tr></table></figure>
<p>  安装virtualenv插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/yyuu/pyenv-virtualenv.git   ~/.pyenv/plugins/pyenv-virtualenv</div></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 安装</span></div><div class="line"><span class="meta">#</span><span class="bash"> pyenv install --list</span></div><div class="line"><span class="meta">#</span><span class="bash"> pyenv install -v XXX   安装位置/home/syy/.pyenv/versions/</span></div><div class="line"><span class="meta">#</span><span class="bash"> 卸载</span></div><div class="line"><span class="meta">#</span><span class="bash"> pyenv uninstall XXX</span></div><div class="line"><span class="meta">#</span><span class="bash"> pyenv versions  (查看所有版本)</span></div><div class="line"><span class="meta">#</span><span class="bash"> pyenv global 3.3.5 切换版本</span></div><div class="line"><span class="meta">#</span><span class="bash"> pyenv virtualenv 2.7.1 newvir 创建虚拟环境</span></div><div class="line"><span class="meta">#</span><span class="bash"> pyenv activate newvir   切换进入newvir</span></div><div class="line"><span class="meta">#</span><span class="bash"> pyenv deactivate  退出当前虚拟环境</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-10T16:00:00.000Z"><a href="/2017/02/11/技术/use-Numpy/">2017-02-11</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/11/技术/use-Numpy/">Numpy笔记</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Numpy数组入门"><span class="toc-text">Numpy数组入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Numpy数组对象"><span class="toc-text">1 Numpy数组对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-创建多维数组"><span class="toc-text">2 创建多维数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-选择numpy数组元素"><span class="toc-text">3 选择numpy数组元素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Numpy的数值类型"><span class="toc-text">4 Numpy的数值类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-一维数组的切片与索引"><span class="toc-text">5 一维数组的切片与索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-处理数组型状"><span class="toc-text">6 处理数组型状</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-创建数组的视图和拷贝"><span class="toc-text">7 创建数组的视图和拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-花式索引"><span class="toc-text">8 花式索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-基于位置变量的索引方法"><span class="toc-text">9 基于位置变量的索引方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-用bool型变量索引Numpy数组"><span class="toc-text">10 用bool型变量索引Numpy数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-numpy数组的广播"><span class="toc-text">11 numpy数组的广播</span></a></li></ol></li></ol>
    </div>

      
        <h2 id="Numpy数组入门"><a href="#Numpy数组入门" class="headerlink" title="Numpy数组入门"></a>Numpy数组入门</h2><h3 id="1-Numpy数组对象"><a href="#1-Numpy数组对象" class="headerlink" title="1 Numpy数组对象"></a>1 Numpy数组对象</h3><p>Numpy数组</p>
<ul>
<li>数组中的元素类型必须一致</li>
<li>数组的空间大小可以确定，可以运用向量化运算，底层c实现，速度快</li>
<li>数组下标0开始</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line">a = np.arange(<span class="number">5</span>) <span class="comment"># 创建0-4的一维数组</span></div><div class="line">b = np.array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</div><div class="line"><span class="keyword">print</span> a</div><div class="line"><span class="keyword">print</span> a.dtype   <span class="comment"># a 的数据类型</span></div><div class="line"><span class="keyword">print</span> a.dtype.itemsize <span class="comment"># 对象数据类型占的字节数</span></div><div class="line">a.shape   <span class="comment"># a的形状，输出元组为每一维的长度</span></div></pre></td></tr></table></figure>
<pre><code>[0 1 2 3 4]
int32
4
(5L,)
</code></pre><h3 id="2-创建多维数组"><a href="#2-创建多维数组" class="headerlink" title="2 创建多维数组"></a>2 创建多维数组</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">m = np.array([a, a, a])  <span class="comment"># array的参数为list或list的嵌套list</span></div><div class="line"><span class="keyword">print</span> m</div><div class="line"><span class="keyword">print</span> m.dtype</div><div class="line">m.shape</div></pre></td></tr></table></figure>
<pre><code>[[0 1 2 3 4]
 [0 1 2 3 4]
 [0 1 2 3 4]]
int32

(3L, 5L)
</code></pre><h3 id="3-选择numpy数组元素"><a href="#3-选择numpy数组元素" class="headerlink" title="3 选择numpy数组元素"></a>3 选择numpy数组元素</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> m[<span class="number">2</span>, <span class="number">4</span>], m[<span class="number">0</span>, <span class="number">0</span>], m[<span class="number">1</span>]  <span class="comment"># a[m, n]确定第m行n列的元素</span></div></pre></td></tr></table></figure>
<pre><code>4 0 [0 1 2 3 4]
</code></pre><h3 id="4-Numpy的数值类型"><a href="#4-Numpy的数值类型" class="headerlink" title="4 Numpy的数值类型"></a>4 Numpy的数值类型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> m.dtype.type</div><div class="line">n = np.array(m, dtype=<span class="string">'uint32'</span>) <span class="comment"># 定义数据类型为无符号32位</span></div><div class="line"><span class="keyword">print</span> n.dtype</div><div class="line"><span class="keyword">print</span> float(<span class="number">62</span>)  <span class="comment"># 数据类型转换</span></div><div class="line"><span class="keyword">print</span> np.sctypeDict.keys()[<span class="number">-10</span>:] <span class="comment"># 部分dtype的字符码</span></div><div class="line"><span class="keyword">print</span> n.dtype.char  <span class="comment"># n的类型的字符码</span></div></pre></td></tr></table></figure>
<pre><code>&lt;type &apos;numpy.int32&apos;&gt;
uint32
62.0
[&apos;a&apos;, &apos;short&apos;, &apos;e&apos;, &apos;i&apos;, &apos;clongfloat&apos;, &apos;m&apos;, &apos;Object0&apos;, &apos;int64&apos;, &apos;i2&apos;, &apos;int0&apos;]
L
</code></pre><h3 id="5-一维数组的切片与索引"><a href="#5-一维数组的切片与索引" class="headerlink" title="5 一维数组的切片与索引"></a>5 一维数组的切片与索引</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> a[<span class="number">1</span>:<span class="number">3</span>], a[<span class="number">2</span>::<span class="number">2</span>], a[::<span class="number">-1</span>]</div></pre></td></tr></table></figure>
<pre><code>[1 2] [2 4] [4 3 2 1 0]
</code></pre><h3 id="6-处理数组型状"><a href="#6-处理数组型状" class="headerlink" title="6 处理数组型状"></a>6 处理数组型状</h3><ul>
<li>x.shape</li>
<li>x.shape = (m, n)</li>
<li>x.rashape(s, m, n)</li>
<li>x.resize(s, m, n)</li>
<li>x.ravel()</li>
<li>x.flatten()</li>
<li>x.transpose()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">c = np.arange(<span class="number">24</span>)</div><div class="line"><span class="keyword">print</span> c.shape</div><div class="line">b = c.reshape(<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)  <span class="comment"># 生成2个3x4的新数组， c不变</span></div><div class="line">b.resize(<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)       <span class="comment"># b会改变</span></div><div class="line"><span class="keyword">print</span> b</div><div class="line">e.shape = (<span class="number">3</span>, <span class="number">8</span>) <span class="comment"># 1维数组变成形状为3x8的数组</span></div><div class="line"><span class="keyword">print</span> e, type(e)</div><div class="line">e = b.ravel() <span class="comment"># 将多维数组变为一维数组，返回的是原数组的视图</span></div><div class="line">d = b.flatten() <span class="comment"># 将多维数组变为一维数组，生成真实的数组，分配存储内存</span></div><div class="line"><span class="keyword">print</span> b, d, e</div><div class="line"><span class="keyword">print</span> b.shape, d.shape, c.shape</div><div class="line"><span class="comment"># 数组转置</span></div><div class="line">t = b.transpose()</div><div class="line"><span class="keyword">print</span> t</div></pre></td></tr></table></figure>
<pre><code>(24L,)
[[[ 0  1  2  3]
  [ 4  5  6  7]
  [ 8  9 10 11]]

 [[12 13 14 15]
  [16 17 18 19]
  [20 21 22 23]]]
[[ 0  1  2  3  4  5  6  7]
 [ 8  9 10 11 12 13 14 15]
 [16 17 18 19 20 21 22 23]] &lt;type &apos;numpy.ndarray&apos;&gt;
[[[ 0  1  2  3]
  [ 4  5  6  7]
  [ 8  9 10 11]]

 [[12 13 14 15]
  [16 17 18 19]
  [20 21 22 23]]] [ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23] [ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23]
(2L, 3L, 4L) (24L,) (24L,)
[[[ 0 12]
  [ 4 16]
  [ 8 20]]

 [[ 1 13]
  [ 5 17]
  [ 9 21]]

 [[ 2 14]
  [ 6 18]
  [10 22]]

 [[ 3 15]
  [ 7 19]
  [11 23]]]
</code></pre><p>数组堆叠</p>
<ul>
<li>x.vstack()</li>
<li>x.dstack()</li>
<li>x.hstack()</li>
<li>x.column_stack()</li>
<li>x.row_stack()</li>
<li>x.concatenate()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">a = np.arange(<span class="number">9</span>).reshape(<span class="number">3</span>, <span class="number">3</span>)</div><div class="line">b = a * <span class="number">2</span></div><div class="line"><span class="keyword">print</span> a, b</div><div class="line"></div><div class="line"><span class="comment"># 水平叠加</span></div><div class="line">x1 = np.hstack((a, b))</div><div class="line">x2 = np.concatenate((a, b), axis=<span class="number">1</span>)  <span class="comment"># axis=1,水平连接；axis=0，垂直连接;默认为0</span></div><div class="line"><span class="keyword">print</span> x1</div><div class="line"><span class="keyword">print</span> x2</div><div class="line"><span class="comment"># 垂直叠加</span></div><div class="line">x3 = np.vstack((a, b))</div><div class="line">x4 = np.concatenate((a, b), axis=<span class="number">0</span>)</div><div class="line"><span class="keyword">print</span> x3, x4</div><div class="line"></div><div class="line"><span class="comment"># 深度叠加， 沿着第三个坐标轴方向叠加一组数据</span></div><div class="line">x5 = np.dstack((a, b))</div><div class="line"><span class="keyword">print</span> x5</div><div class="line"></div><div class="line"><span class="comment"># 列式堆叠  堆叠一维数组时，按列码处理进行水平叠加，处理二维数组同水平叠加hstack()</span></div><div class="line">one1 = np.arange(<span class="number">3</span>)</div><div class="line">one2 = one1 * <span class="number">2</span></div><div class="line">x6 = np.column_stack((one1, one2))</div><div class="line">x7 = np.column_stack((a, b))</div><div class="line"><span class="keyword">print</span> x6, x7</div><div class="line"><span class="comment"># 行式堆叠 堆叠一维数组时，按行码进行垂直叠加，处理二维数组时同垂直叠加vstack()</span></div><div class="line">x8 = np.row_stack((one1, one2))</div><div class="line">x9 = np.row_stack((a, b))</div><div class="line"><span class="keyword">print</span> x8, x9</div></pre></td></tr></table></figure>
<pre><code>[[0 1 2]
 [3 4 5]
 [6 7 8]] [[ 0  2  4]
 [ 6  8 10]
 [12 14 16]]
[[ 0  1  2  0  2  4]
 [ 3  4  5  6  8 10]
 [ 6  7  8 12 14 16]]
[[ 0  1  2  0  2  4]
 [ 3  4  5  6  8 10]
 [ 6  7  8 12 14 16]]
[[ 0  1  2]
 [ 3  4  5]
 [ 6  7  8]
 [ 0  2  4]
 [ 6  8 10]
 [12 14 16]] [[ 0  1  2]
 [ 3  4  5]
 [ 6  7  8]
 [ 0  2  4]
 [ 6  8 10]
 [12 14 16]]
[[[ 0  0]
  [ 1  2]
  [ 2  4]]

 [[ 3  6]
  [ 4  8]
  [ 5 10]]

 [[ 6 12]
  [ 7 14]
  [ 8 16]]]
[[0 0]
 [1 2]
 [2 4]] [[ 0  1  2  0  2  4]
 [ 3  4  5  6  8 10]
 [ 6  7  8 12 14 16]]
[[0 1 2]
 [0 2 4]] [[ 0  1  2]
 [ 3  4  5]
 [ 6  7  8]
 [ 0  2  4]
 [ 6  8 10]
 [12 14 16]]
</code></pre><p>数组拆分，横向，纵向，深度方向</p>
<ul>
<li>hsplit()</li>
<li>vsplit()</li>
<li>dsplit()</li>
<li>split()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">a = np.arange(<span class="number">9</span>).reshape(<span class="number">3</span>,<span class="number">3</span>)</div><div class="line"><span class="keyword">print</span> a</div><div class="line"><span class="comment"># 沿着横向拆分成三个部分，也就是3列</span></div><div class="line">b = np.hsplit(a, <span class="number">3</span>)</div><div class="line"><span class="keyword">print</span> b</div><div class="line"><span class="keyword">print</span> np.split(a,<span class="number">3</span>, axis=<span class="number">1</span>)  <span class="comment"># axis=1沿着横向拆分，axis=0，沿着纵向拆分，默认为0</span></div><div class="line"><span class="comment"># 沿着纵向拆分</span></div><div class="line"><span class="keyword">print</span> np.vsplit(a, <span class="number">3</span>)</div><div class="line"><span class="keyword">print</span> np.split(a, <span class="number">3</span>, axis=<span class="number">0</span>)</div><div class="line"><span class="comment">#  沿着深度方向分割，要有一个三维数组,可以理解为面包片叠一起切条</span></div><div class="line">c = np.arange(<span class="number">36</span>).reshape(<span class="number">3</span>, <span class="number">2</span>, <span class="number">6</span>)</div><div class="line"><span class="keyword">print</span> np.dsplit(c, <span class="number">6</span>)</div></pre></td></tr></table></figure>
<pre><code>[[0 1 2]
 [3 4 5]
 [6 7 8]]
[array([[0],
       [3],
       [6]]), array([[1],
       [4],
       [7]]), array([[2],
       [5],
       [8]])]
[array([[0],
       [3],
       [6]]), array([[1],
       [4],
       [7]]), array([[2],
       [5],
       [8]])]
[array([[0, 1, 2]]), array([[3, 4, 5]]), array([[6, 7, 8]])]
[array([[0, 1, 2]]), array([[3, 4, 5]]), array([[6, 7, 8]])]
[array([[[ 0],
        [ 6]],

       [[12],
        [18]],

       [[24],
        [30]]]), array([[[ 1],
        [ 7]],

       [[13],
        [19]],

       [[25],
        [31]]]), array([[[ 2],
        [ 8]],

       [[14],
        [20]],

       [[26],
        [32]]]), array([[[ 3],
        [ 9]],

       [[15],
        [21]],

       [[27],
        [33]]]), array([[[ 4],
        [10]],

       [[16],
        [22]],

       [[28],
        [34]]]), array([[[ 5],
        [11]],

       [[17],
        [23]],

       [[29],
        [35]]])]
</code></pre><p>Numpy的属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> a.ndim, a.size, a.itemsize, a.nbytes, a.size * a.itemsize</div><div class="line"><span class="comment">#  维度，元素个数，元素占字节数，数组占字节数</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> a.shape, a.dtype</div><div class="line"><span class="keyword">print</span> a.T  <span class="comment"># a的转置数组，如果数组是一维，那么得到的是一个数组的视图</span></div><div class="line">b = np.array([<span class="number">1</span>+<span class="number">2j</span>, <span class="number">3</span><span class="number">-4j</span>])</div><div class="line"><span class="keyword">print</span> b.dtype, b.real, b.imag  <span class="comment"># 复数的实部和虚部,数组的数据类型为复数</span></div><div class="line">a.flat  <span class="comment"># 把a转成一维数组的一个迭代器对象，可以用for遍历</span></div><div class="line"><span class="keyword">print</span> a.flat[<span class="number">2</span>:<span class="number">5</span>]</div><div class="line">a.flat = <span class="number">0</span>  <span class="comment"># a中所有数据都变成0</span></div><div class="line"><span class="keyword">print</span> a</div></pre></td></tr></table></figure>
<pre><code>2 9 4 36 36
(3L, 3L) int32
[[0 0 0]
 [0 0 0]
 [0 0 0]]
complex128 [ 1.  3.] [ 2. -4.]
[0 0 0]
[[0 0 0]
 [0 0 0]
 [0 0 0]]
</code></pre><p>数组的转换</p>
<ul>
<li>tolist()</li>
<li>astype()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> a.tolist() <span class="comment"># 把np数组转化为py的列表</span></div><div class="line"><span class="keyword">print</span> a.astype(<span class="string">'float'</span>) <span class="comment"># 改变a的元素类型</span></div></pre></td></tr></table></figure>
<pre><code>[[0, 1, 2], [3, 4, 5], [6, 7, 8]]
[[ 0.  1.  2.]
 [ 3.  4.  5.]
 [ 6.  7.  8.]]
</code></pre><h3 id="7-创建数组的视图和拷贝"><a href="#7-创建数组的视图和拷贝" class="headerlink" title="7 创建数组的视图和拷贝"></a>7 创建数组的视图和拷贝</h3><ul>
<li>copy()</li>
<li>view()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> scipy.misc</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line">%matplotlib inline</div><div class="line"><span class="comment"># 显示图片</span></div><div class="line">face = scipy.misc.face()</div><div class="line">acopy = face.copy()</div><div class="line">aview = face.view()</div><div class="line">plt.subplot(<span class="number">221</span>)</div><div class="line">plt.imshow(face)</div><div class="line">plt.subplot(<span class="number">222</span>)</div><div class="line">plt.imshow(acopy)</div><div class="line">plt.subplot(<span class="number">223</span>)</div><div class="line">plt.imshow(aview)</div><div class="line">aview.flat = <span class="number">0</span></div><div class="line">plt.subplot(<span class="number">224</span>)</div><div class="line">plt.imshow(aview)</div><div class="line"><span class="comment"># 改变view视图后，原数组同样被改变，copy不受影响</span></div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-2-28/69107225-file_1488289287341_1137b.png" alt=""></p>
<h3 id="8-花式索引"><a href="#8-花式索引" class="headerlink" title="8 花式索引"></a>8 花式索引</h3><p>花式索引，通过坐标x y的迭代器序列，索引一系列的元素</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">face = scipy.misc.face()</div><div class="line">xmax = face.shape[<span class="number">0</span>] </div><div class="line">ymax = face.shape[<span class="number">1</span>]</div><div class="line"><span class="keyword">print</span> xmax, ymax</div><div class="line">face[range(xmax), range(xmax)] = <span class="number">0</span>  <span class="comment"># 对角线上的像素点值改为0，sorry，非n*n方阵</span></div><div class="line">face[range(xmax<span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>), range(xmax)] = <span class="number">0</span>  <span class="comment"># range(start, stop, step) 不包含stop，因此是n-1，-1</span></div><div class="line">plt.imshow(face)</div></pre></td></tr></table></figure>
<pre><code>768 1024
</code></pre><p><img src="http://o8i01ajlj.bkt.clouddn.com/17-2-28/31590580-file_1488289287476_17d6e.png" alt=""></p>
<h3 id="9-基于位置变量的索引方法"><a href="#9-基于位置变量的索引方法" class="headerlink" title="9 基于位置变量的索引方法"></a>9 基于位置变量的索引方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 通过位置列表索引</span></div><div class="line">x = np.arange(xmax)</div><div class="line">y = np.arange(ymax)</div><div class="line">np.random.shuffle(x)</div><div class="line">np.random.shuffle(y)</div><div class="line">plt.imshow(face[np.ix_(x, y)]) <span class="comment"># np.ix_() 输入n个1维数组，返回n个n维数组 </span></div><div class="line"><span class="comment"># a[np.ix_([1,3],[2,5])] 的结果 [[a[1,2] a[1,5]], [a[3,2] a[3,5]]]</span></div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-2-28/75202176-file_1488289287606_ebb3.png" alt=""></p>
<h3 id="10-用bool型变量索引Numpy数组"><a href="#10-用bool型变量索引Numpy数组" class="headerlink" title="10 用bool型变量索引Numpy数组"></a>10 用bool型变量索引Numpy数组</h3><p>用布尔型变量索引数组</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">x = (np.arange(xmax)%<span class="number">4</span> == <span class="number">0</span>)</div><div class="line">face = scipy.misc.face()</div><div class="line">f2 = face.copy()</div><div class="line">face[x, x] = <span class="number">0</span> <span class="comment"># 对角线上索引整除4的元素值设为0</span></div><div class="line">plt.subplot(<span class="number">121</span>)</div><div class="line">plt.imshow(face)</div><div class="line">plt.subplot(<span class="number">122</span>)</div><div class="line">f2[(face &gt; face.max()/<span class="number">4</span>) &amp; (face &lt; <span class="number">3</span>*face.max()/<span class="number">4</span>)] = <span class="number">0</span>  <span class="comment"># 数组中值大于最大值1/4小于3/4的置为0</span></div><div class="line">plt.imshow(f2)</div></pre></td></tr></table></figure>
<p><img src="http://o8i01ajlj.bkt.clouddn.com/17-2-28/71072137-file_1488289287743_54ed.png" alt=""></p>
<h3 id="11-numpy数组的广播"><a href="#11-numpy数组的广播" class="headerlink" title="11 numpy数组的广播"></a>11 numpy数组的广播</h3><p>数组要和标量相乘的话，标量要根据数组的形状进行相应的扩展</p>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-09T16:00:00.000Z"><a href="/2017/02/10/技术/use-ipython-noteboke/">2017-02-10</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/10/技术/use-ipython-noteboke/">ipython使用技巧</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ipython使用技巧"><span class="toc-text">ipython使用技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jupyter-notebook使用技巧"><span class="toc-text">jupyter notebook使用技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快捷键"><span class="toc-text">快捷键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令模式-按键-Esc-开启"><span class="toc-text">命令模式 (按键 Esc 开启)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编辑模式-Enter-键启动"><span class="toc-text">编辑模式 ( Enter 键启动)</span></a></li></ol></li></ol>
    </div>

      
        <h2 id="ipython使用技巧"><a href="#ipython使用技巧" class="headerlink" title="ipython使用技巧"></a>ipython使用技巧</h2><ul>
<li>ipython –pylab     pylab开关，ipython启动时自动导入np，sci，和matplotlib</li>
<li>ipython  –pylab inline  进入pylab模式，且图片内嵌到网页中</li>
<li>%logstart            保存会话，记录日志； %logstop关闭日志记录功能</li>
<li>!date                    !+shell命令，执行系统shell命令 c = !date</li>
<li>%hist                   显示历史命令</li>
<li>%hist -g print             在输入的历史命令中搜索print</li>
<li><code>% xx</code>                   magic function，单独一行时可以省略%</li>
</ul>
<h3 id="jupyter-notebook使用技巧"><a href="#jupyter-notebook使用技巧" class="headerlink" title="jupyter notebook使用技巧"></a>jupyter notebook使用技巧</h3><ul>
<li><p>jupyter notebook           启动nootbook</p>
</li>
<li><p>jupyter nbconvert  –to  markdown  xxxx.ipynb</p>
<p>​</p>
</li>
</ul>
<h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><h3 id="命令模式-按键-Esc-开启"><a href="#命令模式-按键-Esc-开启" class="headerlink" title="命令模式 (按键 Esc 开启)"></a>命令模式 (按键 Esc 开启)</h3><ul>
<li><strong>Enter</strong> : 转入编辑模式</li>
<li><strong>Shift-Enter</strong> : 运行本单元，选中下个单元</li>
<li><strong>Ctrl-Enter</strong> : 运行本单元</li>
<li><strong>Alt-Enter</strong> : 运行本单元，在其下插入新单元</li>
<li><strong>Y</strong> : 单元转入代码状态</li>
<li><strong>M</strong> :单元转入markdown状态</li>
<li><strong>R</strong> : 单元转入raw状态</li>
<li><strong>1</strong> : 设定 1 级标题</li>
<li><strong>2</strong> : 设定 2 级标题</li>
<li><strong>3</strong> : 设定 3 级标题</li>
<li><strong>4</strong> : 设定 4 级标题</li>
<li><strong>5</strong> : 设定 5 级标题</li>
<li><strong>6</strong> : 设定 6 级标题</li>
<li><strong>Up</strong> : 选中上方单元</li>
<li><strong>K</strong> : 选中上方单元</li>
<li><strong>Down</strong> : 选中下方单元</li>
<li><strong>J</strong> : 选中下方单元</li>
<li><strong>Shift-K</strong> : 扩大选中上方单元</li>
<li><strong>Shift-J</strong> : 扩大选中下方单元</li>
<li><strong>A</strong> : 在上方插入新单元</li>
<li><strong>B</strong> : 在下方插入新单元</li>
<li><strong>X</strong> : 剪切选中的单元</li>
<li><strong>C</strong> : 复制选中的单元</li>
<li><strong>Shift-V</strong> : 粘贴到上方单元</li>
<li><strong>V</strong> : 粘贴到下方单元</li>
<li><strong>Z</strong> : 恢复删除的最后一个单元</li>
<li><strong>D,D</strong> : 删除选中的单元</li>
<li><strong>Shift-M</strong> : 合并选中的单元</li>
<li><strong>Ctrl-S</strong> : 文件存盘</li>
<li><strong>S</strong> : 文件存盘</li>
<li><strong>L</strong> : 转换行号</li>
<li><strong>O</strong> : 转换输出</li>
<li><strong>Shift-O</strong> : 转换输出滚动</li>
<li><strong>Esc</strong> : 关闭页面</li>
<li><strong>Q</strong> : 关闭页面</li>
<li><strong>H</strong> : 显示快捷键帮助</li>
<li><strong>I,I</strong> : 中断Notebook内核</li>
<li><strong>0,0</strong> : 重启Notebook内核</li>
<li><strong>Shift</strong> : 忽略</li>
<li><strong>Shift-Space</strong> : 向上滚动</li>
<li><strong>Space</strong> : 向下滚动</li>
</ul>
<h3 id="编辑模式-Enter-键启动"><a href="#编辑模式-Enter-键启动" class="headerlink" title="编辑模式 ( Enter 键启动)"></a>编辑模式 ( Enter 键启动)</h3><ul>
<li><strong>Tab</strong> : 代码补全或缩进</li>
<li><strong>Shift-Tab</strong> : 提示</li>
<li><strong>Ctrl-]</strong> : 缩进</li>
<li><strong>Ctrl-[</strong> : 解除缩进</li>
<li><strong>Ctrl-A</strong> : 全选</li>
<li><strong>Ctrl-Z</strong> : 复原</li>
<li><strong>Ctrl-Shift-Z</strong> : 再做</li>
<li><strong>Ctrl-Y</strong> : 再做</li>
<li><strong>Ctrl-Home</strong> : 跳到单元开头</li>
<li><strong>Ctrl-Up</strong> : 跳到单元开头</li>
<li><strong>Ctrl-End</strong> : 跳到单元末尾</li>
<li><strong>Ctrl-Down</strong> : 跳到单元末尾</li>
<li><strong>Ctrl-Left</strong> : 跳到左边一个字首</li>
<li><strong>Ctrl-Right</strong> : 跳到右边一个字首</li>
<li><strong>Ctrl-Backspace</strong> : 删除前面一个字</li>
<li><strong>Ctrl-Delete</strong> : 删除后面一个字</li>
<li><strong>Esc</strong> : 进入命令模式</li>
<li><strong>Ctrl-M</strong> : 进入命令模式</li>
<li><strong>Shift-Enter</strong> : 运行本单元，选中下一单元</li>
<li><strong>Ctrl-Enter</strong> : 运行本单元</li>
<li><strong>Alt-Enter</strong> : 运行本单元，在下面插入一单元</li>
<li><strong>Ctrl-Shift–</strong> : 分割单元</li>
<li><strong>Ctrl-Shift-Subtract</strong> : 分割单元</li>
<li><strong>Ctrl-S</strong> : 文件存盘</li>
<li><strong>Shift</strong> : 忽略</li>
<li><strong>Up</strong> : 光标上移或转入上一单元</li>
<li><strong>Down</strong> :光标下移或转入下一单元  ​</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-12-18T16:00:00.000Z"><a href="/2016/12/19/技术/Scrapy学习笔记/">2016-12-19</a></time>
      
      
  
    <h1 class="title"><a href="/2016/12/19/技术/Scrapy学习笔记/">scrapy 入门学习</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Scrapy学习笔记"><span class="toc-text">Scrapy学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、安装scrapy"><span class="toc-text">1、安装scrapy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、初步使用"><span class="toc-text">2、初步使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1、命令行工具scrapy"><span class="toc-text">2.1、命令行工具scrapy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2、基本流程"><span class="toc-text">2.2、基本流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、如何解析网页"><span class="toc-text">3、如何解析网页</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1、xpath"><span class="toc-text">3.1、xpath</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2、css"><span class="toc-text">3.2、css</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3、re"><span class="toc-text">3.3、re</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4、extract"><span class="toc-text">3.4、extract</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、多级页面的爬取"><span class="toc-text">4、多级页面的爬取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1、爬取前分析"><span class="toc-text">4.1、爬取前分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2、代码示例"><span class="toc-text">4.2、代码示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、Scrapy框架解读"><span class="toc-text">5、Scrapy框架解读</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1、整体框架"><span class="toc-text">5.1、整体框架</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2、主要对象"><span class="toc-text">5.2、主要对象</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、下载图片和文件"><span class="toc-text">6、下载图片和文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1、激活Media-pipeline"><span class="toc-text">6.1、激活Media pipeline</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2、items中定义"><span class="toc-text">6.2、items中定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3、spiders编写"><span class="toc-text">6.3、spiders编写</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、设置headers"><span class="toc-text">7、设置headers</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1、设置默认headers"><span class="toc-text">7.1、设置默认headers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2、为每个download-分配随机UA和代理"><span class="toc-text">7.2、为每个download 分配随机UA和代理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8、登陆Post和Cookie"><span class="toc-text">8、登陆Post和Cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1、POST表单登陆豆瓣"><span class="toc-text">8.1、POST表单登陆豆瓣</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2、使用Cookie登陆豆瓣"><span class="toc-text">8.2、使用Cookie登陆豆瓣</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9、JS-、XHR分析"><span class="toc-text">9、JS 、XHR分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10、Scrapy-Redis分布式爬虫"><span class="toc-text">10、Scrapy Redis分布式爬虫</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-1、安装redis"><span class="toc-text">10.1、安装redis</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11、记录一些error"><span class="toc-text">11、记录一些error</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1、url相关"><span class="toc-text">11.1、url相关</span></a></li></ol></li></ol></li></ol>
    </div>

      
        <h2 id="Scrapy学习笔记"><a href="#Scrapy学习笔记" class="headerlink" title="Scrapy学习笔记"></a>Scrapy学习笔记</h2><h3 id="1、安装scrapy"><a href="#1、安装scrapy" class="headerlink" title="1、安装scrapy"></a>1、安装scrapy</h3><ul>
<li><p>windows下安装</p>
<p>如果按照网上的方法自行安装scrapy，会出现各种错误，折腾很长时间。这里安装Anaconda2程序，会自带scrapy；如果默认没带的话，打开Anaconda Prompt，执行命令：<br><code>conda list</code><br><code>conda install scrapy</code><br>安装完后，使用scrapy时如果提示openssl错误，去下载对应的<a href="http://slproweb.com/products/Win32OpenSSL.html" title="openssl下载" target="_blank" rel="external">openssl</a>，安装即可。</p>
</li>
<li><p>Linux下安装</p>
<p>比较简单，<br><code># apt-get install python-dev</code><br><code># pip install scrapy</code></p>
</li>
</ul>
<h3 id="2、初步使用"><a href="#2、初步使用" class="headerlink" title="2、初步使用"></a>2、初步使用</h3><h4 id="2-1、命令行工具scrapy"><a href="#2-1、命令行工具scrapy" class="headerlink" title="2.1、命令行工具scrapy"></a>2.1、命令行工具<code>scrapy</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># scrapy startproject my_spider		# 创建scrapy项目</span></div><div class="line">.目录结构</div><div class="line">├── scrapy.cfg		<span class="comment"># 项目配置文件</span></div><div class="line">└── my_spider		<span class="comment"># 项目python模块, 之后将在此加入代码</span></div><div class="line">    ├── __init__.py</div><div class="line">    ├── items.py 	</div><div class="line">    ├── pipelines.py</div><div class="line">    ├── settings.py</div><div class="line">    └── spiders 		<span class="comment"># 放置spider的目录</span></div><div class="line">        └── __init__.py</div><div class="line"><span class="comment"># cd my_spider</span></div><div class="line"><span class="comment"># scrapy genspider [-t template] &lt;name&gt;  &lt;domain&gt;  	# 使用模板生成spider文件，位于spiders文件夹下,默认使用basic模板</span></div><div class="line"><span class="comment"># scrapy genspider -l	 列出所有模板</span></div><div class="line"><span class="comment"># scrapy genspider -d basic   查看basic模板</span></div><div class="line"><span class="comment"># scrapy list 		列出所有的爬虫</span></div><div class="line"><span class="comment"># scrapy 			显示scrapy可用的命令</span></div><div class="line"><span class="comment"># scrapy &lt;command&gt; -h  查看command命令的详细信息</span></div><div class="line"><span class="comment"># scrapy version -v</span></div><div class="line">	Scrapy    : <span class="number">1.1</span><span class="number">.1</span></div><div class="line">	lxml      : <span class="number">3.6</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">	libxml2   : <span class="number">2.9</span><span class="number">.3</span></div><div class="line">	Twisted   : <span class="number">16.5</span><span class="number">.0</span></div><div class="line">	...</div><div class="line"><span class="comment"># scrapy bench       运行基准测试,可以测试scrapy是否正常</span></div><div class="line"><span class="comment"># scrapy runspider  spider_file.py</span></div></pre></td></tr></table></figure>
<h4 id="2-2、基本流程"><a href="#2-2、基本流程" class="headerlink" title="2.2、基本流程"></a>2.2、基本流程</h4><ul>
<li><p>startproject和genspider</p>
</li>
<li><p>首先分析要抓取的目标网站，在items.py中定义要抓取的数据对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DmozItem</span><span class="params">(scrapy.Item)</span>:</span></div><div class="line">  title = scrapy.Field()</div><div class="line">  link = scrapy.Field()</div><div class="line">  desc = scrapy.Field()</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>  <span class="comment"># ？如果想初始化某些字段</span></div><div class="line">      scrapy.Item.__init__(self)</div><div class="line">      self.title = <span class="string">''</span></div><div class="line">    </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span>  <span class="comment"># ？默认控制台会输出所有的数据，包括抓取的页面源码</span></div><div class="line">      <span class="keyword">return</span> <span class="string">'crawling %s'</span> % self.title</div></pre></td></tr></table></figure>
</li>
<li><p>编写spider，解析网页(xpath/css/re)，提取数据到item对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="keyword">from</span> tutorial.items <span class="keyword">import</span> DmozItem</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DmozSpider</span><span class="params">(scrapy.spider.Spider)</span>:</span></div><div class="line">    name = <span class="string">"dmoz"</span>    <span class="comment">#唯一标识，启动spider时即指定该名称</span></div><div class="line">    allowed_domains = [<span class="string">"dmoz.org"</span>]</div><div class="line">    start_urls = [  </div><div class="line">       <span class="string">"http://www.dmoz.org/Computers/Programming/Languages/Python/Books/"</span>,</div><div class="line">    <span class="string">"http://www.dmoz.org/Computers/Programming/Languages/Python/Resources/"</span></div><div class="line">    ]  <span class="comment"># 包含了Spider在启动时进行爬取的url列表。 因此，第一个被获取到的页面将是其中之一。 后续的URL则从初始的URL获取到的数据中提取。</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="keyword">for</span> sel <span class="keyword">in</span> response.xpath(<span class="string">'//ul/li'</span>): <span class="comment"># 使用response.selector的css或xpath解析网页</span></div><div class="line">            item = DmozItem()  <span class="comment"># 类字典对象 </span></div><div class="line">            item[<span class="string">'title'</span>] = sel.xpath(<span class="string">'a/text()'</span>).extract()</div><div class="line">            item[<span class="string">'link'</span>] = sel.xpath(<span class="string">'a/@href'</span>).extract()</div><div class="line">            item[<span class="string">'desc'</span>] = sel.xpath(<span class="string">'text()'</span>).extract()</div><div class="line">            <span class="keyword">yield</span> item  <span class="comment">## 返回item数据对象</span></div><div class="line">     <span class="string">'''</span></div><div class="line"><span class="string">     每个初始URL完成下载后生成的 Response 对象将会作为唯一的参数传递给parse()函数。 该方法负责解析返回的数据(response data)，提取数据(生成item)以及生成需要进一步处理的URL的 Request 对象。</span></div><div class="line"><span class="string">     '''</span></div></pre></td></tr></table></figure>
</li>
<li><p>保存数据</p>
<p>  在执行<code>scrapy crawl</code> 命令时加入-o xxx.csv参数可以将item保存到csv文件中。也可在settings中设置FEED_URI和FEED_FORMAT</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FEED_URI = <span class="string">'file:///tmp/export.csv'</span></div><div class="line">FEED_FORMAT = <span class="string">'CSV'</span></div></pre></td></tr></table></figure>
<p>  将spider爬取到的item进一步处理并存储到数据库，需要在pipelines.py中实现自己的pipeline对象。</p>
<ul>
<li>process_item(item, spider)   # 数据经过pipeline时，都要调用该方法，最后返回一个item。</li>
<li>open_spider(spider)  #当spider被开启时，这个方法被调用。</li>
<li><p>close_spider(spider) #当spider被关闭时，这个方法被调用，可以再爬虫关闭后进行相应的数据处理。</p>
<p>下面是存储数据到mongodb的一个实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GushiciPipeline</span><span class="params">(object)</span>:</span></div><div class="line">    </div><div class="line">    collection_name = <span class="string">'gushi'</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mongo_uri, mongo_db)</span>:</span></div><div class="line">        self.mongo_uri = mongo_uri</div><div class="line">        self.mongo_db = mongo_db</div><div class="line">    </div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></div><div class="line">        <span class="keyword">return</span> cls(</div><div class="line">            mongo_uri=crawler.settings.get(<span class="string">'MONGO_URI'</span>),</div><div class="line">            mongo_db=crawler.settings.get(<span class="string">"MONGO_DATABASE"</span>, <span class="string">"items"</span>)</div><div class="line">            )  <span class="comment"># 在settings.py中定义 MONGO_URI = 'mongodb://localhost:27017' MONGO_DATABASE = 'test2'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span><span class="params">(self, spider)</span>:</span></div><div class="line">        self.client = pymongo.MongoClient(self.mongo_uri)</div><div class="line">        self.db = self.client[self.mongo_db]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span><span class="params">(self, spider)</span>:</span></div><div class="line">        self.client.close()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></div><div class="line">        self.db[self.collection_name].insert(dict(item))</div><div class="line">        <span class="keyword">return</span> item</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>​        最后在settings.py中添加我们定义的pipeline：<code>ITEM_PIPELINES = {&#39;blog_crawl.pipelines.SQLiteStorePipeline&#39;: 1}</code> 1为优先级，越小级别越高</p>
<ul>
<li><p>执行爬虫任务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> scrapy list    查看所有的spider</span></div><div class="line"><span class="meta">#</span><span class="bash"> scrapy crawl dmoz [-o xxx.csv|json|xml]   执行dmoz爬虫,-o指定结果输出到文件</span></div></pre></td></tr></table></figure>
</li>
<li><p>通过python调用cmd命令执行爬虫</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># main.py 根目录下</span></div><div class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> cmdline</div><div class="line">cmdline.execute(<span class="string">"scrapy crawl mindjet_muban"</span>.split())</div></pre></td></tr></table></figure>
<p>这样方便用ide调试</p>
<h3 id="3、如何解析网页"><a href="#3、如何解析网页" class="headerlink" title="3、如何解析网页"></a>3、如何解析网页</h3></li>
</ul>
<blockquote>
<p>scrapy.Selector有四个基本的方法：</p>
<p>xpath()：参数是xpath表达式</p>
<p>css()：输入css表达式</p>
<p>extract()：序列化该节点为unicode字符串并返回list列表；</p>
<p>re()：输入正则表达式，返回unicode字符串list列表；注意 正则效率低，可读性差</p>
<p>这四个方法返回的都是包含所有匹配节点的list列表，可嵌套使用css和xpath</p>
</blockquote>
<h4 id="3-1、xpath"><a href="#3-1、xpath" class="headerlink" title="3.1、xpath"></a>3.1、xpath</h4><p><a href="http://www.w3school.com.cn/xpath/index.asp" target="_blank" rel="external">xpath w3school</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">/html/head/title: 选择HTML文档中 &lt;head&gt; 标签内的 &lt;title&gt; 元素</div><div class="line">/html/head/title/text(): 选择上面提到的 &lt;title&gt; 元素的文字</div><div class="line">//td: 选择所有的 &lt;td&gt; 元素</div><div class="line">//div[@class=<span class="string">"mine"</span>]: 选择所有具有 class=<span class="string">"mine"</span> 属性的 div 元素</div><div class="line">/x 是选取子节点x，//x 是递归选取全部的x</div><div class="line">.//x 从当前节点开始匹配，@是选择属性</div><div class="line">----- 路径表达式 -----</div><div class="line">/div/p[1]				#选择第一个p元素</div><div class="line">/div/p[last()]			#选择最后一个p元素</div><div class="line">/div/p[last()-2]		#选择倒数第三个p元素</div><div class="line">/div/p[position()&lt;3]	#选择前2个元素</div><div class="line">/div/p[x&gt;35.00]/name	#选择x属性大于35.00的p元素下的name元素</div><div class="line">/div/p[x&gt;35.00]/@aaa	#匹配所有属性aaa的值</div><div class="line">/div[@class]			#选择含有class属性的div</div><div class="line">//div[@class="wp-pagenavi"]/a[not(@title)]       #不含title属性的a标签</div><div class="line">/div[@class='lang']		#选择class值为lang的div</div><div class="line">/node()					#根元素下所有的节点（包括文本节点，注释节点等）</div><div class="line">/text()					#查找文档根节点下的所有文本节点</div><div class="line">----- 通配符 -----</div><div class="line">*						#匹配任意元素</div><div class="line">@*						#匹配任意属性</div><div class="line">exp1 | exp2				#返回2个表达式匹配结果的合集</div></pre></td></tr></table></figure>
<h4 id="3-2、css"><a href="#3-2、css" class="headerlink" title="3.2、css"></a>3.2、css</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.con1					#选择class为con1的全部标签</div><div class="line">div.con1				#选择class为con1的全部div标签</div><div class="line">div p					#递归选择div下的全部p标签</div><div class="line">div &gt; p					#选择div的全部子标签p</div><div class="line">a::text					#选择a标签的文本</div><div class="line">img::attr(href)			#选择img标签的href属性的值</div></pre></td></tr></table></figure>
<h4 id="3-3、re"><a href="#3-3、re" class="headerlink" title="3.3、re"></a>3.3、re</h4><p>返回unicode字符串的list，该对象无法继续使用css或xpath</p>
<h4 id="3-4、extract"><a href="#3-4、extract" class="headerlink" title="3.4、extract"></a>3.4、extract</h4><p><code>response.xpath(&quot;//div[@class=&#39;son5&#39;]/p/a&quot;).css(&quot;::attr(href)&quot;).extract()[0]</code></p>
<p>该语句执行后得到的结果是字符串‘/view_12390.aspx’</p>
<h3 id="4、多级页面的爬取"><a href="#4、多级页面的爬取" class="headerlink" title="4、多级页面的爬取"></a>4、多级页面的爬取</h3><blockquote>
<p>主要是spider中的回调函数，下面分析爬古诗词网站为例，爬取诗文的标题、作者、朝代、url、原文，翻译注释</p>
</blockquote>
<h4 id="4-1、爬取前分析"><a href="#4-1、爬取前分析" class="headerlink" title="4.1、爬取前分析"></a>4.1、爬取前分析</h4><ul>
<li><p>[a] start_url：<a href="http://so.gushiwen.org/type.aspx" target="_blank" rel="external">http://so.gushiwen.org/type.aspx</a> </p>
</li>
<li><p>[b] 不同朝代的诗文列表url：<a href="http://so.gushiwen.org/type.aspx?p=1&amp;c=先秦" target="_blank" rel="external">http://so.gushiwen.org/type.aspx?p=1&amp;c=先秦</a> ，参数p是页码，c是朝代，一共12个朝代，页码最多的有200页</p>
</li>
<li><p>[c] 诗文url：<a href="http://so.gushiwen.org/view_1.aspx" target="_blank" rel="external">http://so.gushiwen.org/view_1.aspx</a></p>
</li>
<li><p>[d] 翻译和注释url：<a href="http://so.gushiwen.org/fanyi_1.aspx" target="_blank" rel="external">http://so.gushiwen.org/fanyi_1.aspx</a></p>
</li>
<li><p>最后，abcd是递进关系，我们需要的item在bcd中都能找到一部分信息。注意b有很多页要抓，思路是“下一页”url。</p>
<p><img src="http://ww3.sinaimg.cn/large/af9df239gw1faxbjsqr23j20i70i9dhu.jpg" alt=""></p>
<p><img src="http://ww1.sinaimg.cn/large/af9df239gw1faxbkvhggsj20qp0l6762.jpg" alt=""></p>
</li>
</ul>
<h4 id="4-2、代码示例"><a href="#4-2、代码示例" class="headerlink" title="4.2、代码示例"></a>4.2、代码示例</h4><blockquote>
<p>basic爬虫继承scrapy.Spider, crawl爬虫继承scrapy.CrawlSpider</p>
</blockquote>
<ul>
<li><p>基于basic模板的爬虫</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="keyword">from</span> gushici.items <span class="keyword">import</span> GushiciItem</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TangsiSpider</span><span class="params">(scrapy.Spider)</span>:</span></div><div class="line">    name = <span class="string">"tangsi"</span></div><div class="line">    allowed_domains = [<span class="string">"gushiwen.org"</span>]</div><div class="line">    start_urls = (</div><div class="line">        <span class="string">'http://so.gushiwen.org/type.aspx'</span>,</div><div class="line">    )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="comment"># 获取不同朝代诗词的列表入口,利用meta字典传参到下一个回调函数，并调用get_lists函数</span></div><div class="line">        destinies = response.css(<span class="string">"div.cont&gt;a"</span>)</div><div class="line">        <span class="keyword">for</span> destiny <span class="keyword">in</span> destinies:</div><div class="line">            <span class="comment"># item = GushiciItem()</span></div><div class="line">            <span class="comment"># item['destiny'] = destiny.css("::text").extract()</span></div><div class="line">            url = destiny.css(<span class="string">"::attr(href)"</span>).extract()[<span class="number">0</span>]</div><div class="line">            destiny_url = response.urljoin(url)  <span class="comment"># 此处是分类列表的url</span></div><div class="line">            <span class="comment"># item['url'] = full_url</span></div><div class="line">            destiny_text = destiny.css(<span class="string">"::text"</span>).extract()[<span class="number">0</span>]</div><div class="line">            <span class="keyword">yield</span> scrapy.Request(destiny_url, meta=&#123;<span class="string">"destiny"</span>: destiny_text&#125;, callback=self.get_lists)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_lists</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="comment"># 爬当前页的所有诗词的url，title，作者，并进入下一级调爬诗文内容；爬到“下一页”url后交给get_lists处理</span></div><div class="line">        destiny = response.meta[<span class="string">'destiny'</span>]</div><div class="line">        divs = response.css(<span class="string">"div.sons"</span>)</div><div class="line">        <span class="keyword">for</span> div <span class="keyword">in</span> divs:</div><div class="line">            title = div.css(<span class="string">'p &gt; a[target]::text'</span>).extract()[<span class="number">0</span>]</div><div class="line">            full_url = response.urljoin(div.css(<span class="string">'p &gt; a[target]::attr(href)'</span>).extract()[<span class="number">0</span>])</div><div class="line">            author = div.xpath(<span class="string">"p[2]/text()"</span>).extract()[<span class="number">0</span>]</div><div class="line">            <span class="comment"># score = response.re(u'(\d+\.\d+)')[0]</span></div><div class="line">            <span class="keyword">yield</span> scrapy.Request(full_url, meta=&#123;<span class="string">'title'</span>: title, <span class="string">'url'</span>: full_url, <span class="string">'author'</span>: author,</div><div class="line">                                                 <span class="string">'destiny'</span>: destiny&#125;, callback=self.get_contents)</div><div class="line">        <span class="comment"># 递归爬下一页的诗词url，入口是网页中的下一页标签url</span></div><div class="line">        next_urls = response.xpath(<span class="string">'//a[@style="width:60px;"]'</span>).css(<span class="string">"::attr(href)"</span>).extract()</div><div class="line">        <span class="keyword">for</span> next_url <span class="keyword">in</span> next_urls:</div><div class="line">            next_page = response.urljoin(next_url)</div><div class="line">            <span class="keyword">yield</span> scrapy.Request(next_page, meta=&#123;<span class="string">"destiny"</span>: destiny&#125;, callback=self.get_lists)</div><div class="line"></div><div class="line">    <span class="comment"># 获取诗词的评分，文本，翻译页的url，接收父级页面解析出来的标题，作者，朝代，创建item</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_contents</span><span class="params">(self, response)</span>:</span></div><div class="line">        item = GushiciItem()</div><div class="line">        item[<span class="string">'title'</span>] = response.meta[<span class="string">'title'</span>]</div><div class="line">        item[<span class="string">'url'</span>] = response.meta[<span class="string">'url'</span>]</div><div class="line">        item[<span class="string">'destiny'</span>] = response.meta[<span class="string">'destiny'</span>]</div><div class="line">        item[<span class="string">'author'</span>] = response.meta[<span class="string">'author'</span>]</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            item[<span class="string">'score'</span>] = response.xpath(<span class="string">'//div[@class="pingfen"]//div[@class="line1"]/span/text()'</span>).extract()[<span class="number">0</span>]</div><div class="line">        <span class="keyword">except</span> Exception:</div><div class="line">            item[<span class="string">'score'</span>] = <span class="string">u'评分不足10人'</span></div><div class="line">        ps = response.xpath(<span class="string">"//div[@class='son2']/p"</span>)</div><div class="line">        text = <span class="string">""</span></div><div class="line">        <span class="keyword">if</span> len(ps) &gt; <span class="number">3</span>:</div><div class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> ps[<span class="number">3</span>:]:</div><div class="line">                text += <span class="string">''</span>.join(p.css(<span class="string">"::text"</span>).extract()) + <span class="string">'\n'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            text += <span class="string">''</span>.join(response.xpath(<span class="string">"//div[@class='son2']/text()"</span>).extract()).replace(<span class="string">'\n'</span>, <span class="string">''</span>)</div><div class="line">        item[<span class="string">'text'</span>] = text</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            fanyi_url = response.xpath(<span class="string">"//div[@class='son5']/p/a"</span>).css(<span class="string">"::attr(href)"</span>).extract()[<span class="number">0</span>]</div><div class="line">            fanyi_url = response.urljoin(fanyi_url)</div><div class="line">            <span class="keyword">yield</span> scrapy.Request(fanyi_url, callback=self.get_fanyi, meta=&#123;<span class="string">'item'</span>: item&#125;)</div><div class="line">        <span class="keyword">except</span> Exception:</div><div class="line">            item[<span class="string">'translate'</span>] = <span class="string">''</span></div><div class="line">            <span class="keyword">yield</span> item</div><div class="line"></div><div class="line">    <span class="comment"># 获取翻译文本</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_fanyi</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="comment"># 前面是利用meta字典传递已抓到的内容，这里是将item对象装入meta传递</span></div><div class="line">        item = response.meta[<span class="string">'item'</span>]</div><div class="line">        ps = response.xpath(<span class="string">'//div[@class="shangxicont"]/p'</span>)</div><div class="line">        fanyi = <span class="string">''</span></div><div class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> ps[:<span class="number">-1</span>]:</div><div class="line">            fanyi += <span class="string">''</span>.join(p.css(<span class="string">"::text"</span>).extract()) + <span class="string">'\n'</span></div><div class="line">        item[<span class="string">'translate'</span>] = fanyi</div><div class="line">        <span class="keyword">yield</span> item</div></pre></td></tr></table></figure>
</li>
</ul>
<p>​     网站没有反扒措施，但这个爬虫最终抓到7795条文章，像宋词至少有1万+，但在该分类下200页后的内容就是空的，也就是说web只给我们提供了200页的宋词。</p>
<ul>
<li><p>基于crawl模板的爬虫</p>
<p>crawl类的爬虫更强大一点，Rule方法可以根据正则匹配所有满足条件的url，并调用相应回调函数处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</div><div class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule</div><div class="line"><span class="keyword">from</span> gushici.items <span class="keyword">import</span> GushiciItem</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SongciSpider</span><span class="params">(CrawlSpider)</span>:</span></div><div class="line">    name = <span class="string">'songci'</span></div><div class="line">    allowed_domains = [<span class="string">'so.gushiwen.org'</span>]</div><div class="line">    start_urls = [<span class="string">'http://so.gushiwen.org/type.aspx'</span>]</div><div class="line"></div><div class="line">    rules = (</div><div class="line">        <span class="comment"># 这是分类页的url，全部加入到抓取列表中</span></div><div class="line">        Rule(LinkExtractor(allow=<span class="string">r"http://so\.gushiwen\.org/type\.aspx\?p=\d+&amp;c=.+?"</span>)),</div><div class="line">        <span class="comment"># 这是诗文详情页url，全部调用parse_item解析</span></div><div class="line">        Rule(LinkExtractor(allow=<span class="string">r'http://so\.gushiwen\.org/view_\d+\.aspx'</span>), callback=<span class="string">'parse_item'</span>, follow=<span class="keyword">True</span>),</div><div class="line">    )</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></div><div class="line">        item = GushiciItem()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            item[<span class="string">'title'</span>] = response.xpath(<span class="string">'//h1/text()'</span>).extract()[<span class="number">0</span>]</div><div class="line">            item[<span class="string">'url'</span>] = response.url</div><div class="line">            item[<span class="string">'destiny'</span>] = response.xpath(<span class="string">'//div[@class="son2"]/p[1]//text()'</span>).extract()[<span class="number">-1</span>]</div><div class="line">            item[<span class="string">'author'</span>] = response.xpath(<span class="string">'//div[@class="son2"]/p[2]//text()'</span>).extract()[<span class="number">-1</span>]</div><div class="line">        <span class="keyword">except</span> Exception:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            item[<span class="string">'score'</span>] = response.xpath(<span class="string">'//div[@class="pingfen"]//div[@class="line1"]/span/text()'</span>).extract()[<span class="number">0</span>]</div><div class="line">        <span class="keyword">except</span> Exception:</div><div class="line">            item[<span class="string">'score'</span>] = <span class="string">u'评分不足10人'</span></div><div class="line">        ps = response.xpath(<span class="string">"//div[@class='son2']/p"</span>)</div><div class="line">        text = <span class="string">""</span></div><div class="line">        <span class="keyword">if</span> len(ps) &gt; <span class="number">3</span>:</div><div class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> ps[<span class="number">3</span>:]:</div><div class="line">                text += <span class="string">''</span>.join(p.css(<span class="string">"::text"</span>).extract()) + <span class="string">'\n'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            text += <span class="string">''</span>.join(response.xpath(<span class="string">"//div[@class='son2']/text()"</span>).extract()).replace(<span class="string">'\n'</span>, <span class="string">''</span>)</div><div class="line">        item[<span class="string">'text'</span>] = text</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            fanyi_url = response.xpath(<span class="string">"//div[@class='son5']/p/a"</span>).css(<span class="string">"::attr(href)"</span>).extract()[<span class="number">0</span>]</div><div class="line">            fanyi_url = response.urljoin(fanyi_url)</div><div class="line">            <span class="keyword">yield</span> scrapy.Request(fanyi_url, callback=self.get_fanyi, meta=&#123;<span class="string">'item'</span>: item&#125;)</div><div class="line">        <span class="keyword">except</span> Exception:</div><div class="line">            item[<span class="string">'translate'</span>] = <span class="string">''</span></div><div class="line">            <span class="keyword">yield</span> item</div><div class="line"></div><div class="line">    <span class="comment"># 获取翻译文本</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_fanyi</span><span class="params">(self, response)</span>:</span></div><div class="line">        item = response.meta[<span class="string">'item'</span>]</div><div class="line">        ps = response.xpath(<span class="string">'//div[@class="shangxicont"]/p'</span>)</div><div class="line">        fanyi = <span class="string">''</span></div><div class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> ps[:<span class="number">-1</span>]:</div><div class="line">            fanyi += <span class="string">''</span>.join(p.css(<span class="string">"::text"</span>).extract()) + <span class="string">'\n'</span></div><div class="line">        item[<span class="string">'translate'</span>] = fanyi</div><div class="line">        <span class="keyword">yield</span> item</div></pre></td></tr></table></figure>
<p>basic爬虫是循环查找下一页的url来抓取，这里crawl爬虫我们直接用正则匹配列表页url和诗文详情页url，另外“标题文本朝代作者”也都改为在详情页获取了，“翻译”仍需从下一级网页获取。crawl爬了8700条数据，我在settings设置了download_delay为0.5秒，爬取效果是100秒约90条数据，一共用了2h48m。</p>
</li>
<li><p>pipelines的Dropitem</p>
<p>我先把basic抓到的放入mongodb了，再用crawl爬虫时，我改写了pipelines，如果item在数据库中，就丢弃，否则存入monggodb，避免数据重复。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> DropItem</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></div><div class="line">        data = self.db[self.collection_name].find(&#123;&#125;, &#123;<span class="string">'_id'</span>: <span class="number">0</span>, <span class="string">'url'</span>: <span class="number">1</span>&#125;)</div><div class="line">        url_finished = set(x[<span class="string">'url'</span>] <span class="keyword">for</span> x <span class="keyword">in</span> data)  <span class="comment"># 获取已爬url的集合</span></div><div class="line">        <span class="keyword">if</span> item[<span class="string">'url'</span>] <span class="keyword">in</span> url_finished:</div><div class="line">            <span class="keyword">raise</span> DropItem(<span class="string">"%s has been crawled!"</span> % item)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.db[self.collection_name].insert(dict(item))</div><div class="line">            <span class="keyword">return</span> item</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<h3 id="5、Scrapy框架解读"><a href="#5、Scrapy框架解读" class="headerlink" title="5、Scrapy框架解读"></a>5、Scrapy框架解读</h3><blockquote>
<p>Scrapy基于Twisted异步网络库处理网络通信</p>
</blockquote>
<h4 id="5-1、整体框架"><a href="#5-1、整体框架" class="headerlink" title="5.1、整体框架"></a>5.1、整体框架</h4><p><img src="http://jason-images.qiniudn.com/@/python/scrapy/intro/scrapy_backbone.png" alt=""></p>
<p>各组件及功能：</p>
<ul>
<li><p>Scrapy Engine: 用来处理整个系统的数据流处理, 触发事务(框架核心)</p>
</li>
<li><p>Scheduler: 调度器，接收引擎发过来的Request, 压入队列中, 由引擎调度，将Request发送给Downloader。 可以理解为要爬取URL的优先队列, 由它来决定下一个要抓取的网址是什么, 同时去除重复的网址</p>
</li>
<li><p>Downloader: 根据Scheduler给出的Request，去下载网页内容, 并将网页内容返回给Spiders解析。Scrapy下载器是基于twisted的异步模型，因此网页下载的结果并不是有序的。</p>
</li>
<li><p>Spiders: 爬虫有2个作用：从网页中提取自己需要的信息实体(Item)，并将item发送到item pipeline进行后续处理；从中网页提取出进一步爬取的URL,并发送给Scheduler。</p>
</li>
<li><p>Pipeline: 负责处理爬虫从网页中抽取的实体：数据清洗(整理、查重、验证有效性)、数据保存等。</p>
</li>
<li><p>Downloader Middlewares: 位于Scrapy引擎和下载器之间的中间件，主要是处理Scrapy引擎与下载器之间的请求及响应。可以在此处设置请求的代理、cookie？</p>
</li>
<li><p>Spider Middlewares: 介于Scrapy引擎和爬虫之间的框架，主要工作是处理蜘蛛的响应输入和请求输出。</p>
</li>
<li><p>Scheduler Middewares: 介于Scrapy引擎和调度之间的中间件，从Scrapy引擎发送到调度的请求和响应。</p>
<p>​</p>
</li>
</ul>
<h4 id="5-2、主要对象"><a href="#5-2、主要对象" class="headerlink" title="5.2、主要对象"></a>5.2、主要对象</h4><ul>
<li><p>Spider</p>
</li>
<li><p>Selector</p>
</li>
<li><p>Items &amp; Item Pipeline &amp; Feed exports</p>
</li>
<li><p>Requests</p>
</li>
<li><p>Responses</p>
</li>
<li><p>Logging</p>
<p> 日志模块，使用python内置的logging模块，<code>logging.log(logging.WARNING, &quot;This is a warning&quot;)</code>,可以在setting中配置logging属性。</p>
<p> 同时Spider对象含有logger对象，spider内也可使用<code>self.logger.info(&#39;msg&#39;)</code> <code>self.logger.warning(&#39;msg&#39;)</code></p>
</li>
<li><p>statscollectors</p>
</li>
<li><p>MailSender</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> scrapy.mail <span class="keyword">import</span> MailSender</div><div class="line"><span class="keyword">from</span> xxx <span class="keyword">import</span> settings</div><div class="line"><span class="comment">#------ spider文件，在spider对象close时发邮件，重写close方法</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self, spider, reason)</span>:</span></div><div class="line">        mailer = MailSender.from_settings(settings)</div><div class="line">        mailer.send(to=[<span class="string">'xx@xx.com'</span>], subject=<span class="string">u'爬虫结束'</span>, body=<span class="string">'test!'</span>+str(reason))</div><div class="line"><span class="comment">#-----settings文件</span></div><div class="line"><span class="comment"># 下面是在settings文件中配置邮件服务器</span></div><div class="line"><span class="comment"># 发送邮件</span></div><div class="line">MAIL_FROM = <span class="string">'xxx@xxx.com'</span>  <span class="comment">#邮件中的from</span></div><div class="line">MAIL_HOST = <span class="string">'smtp.xxx.com'</span>  <span class="comment">#邮件服务器地址，端口</span></div><div class="line">MAIL_PORT = <span class="number">25</span></div><div class="line">MAIL_USER = <span class="string">'登录名'</span></div><div class="line">MAIL_PASS = <span class="string">'密码'</span></div><div class="line">MAIL_TLS = <span class="keyword">False</span>   <span class="comment"># 默认邮件服务器不开启TLS SSL安全连接</span></div><div class="line">MAIL_SSL = <span class="keyword">False</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="6、下载图片和文件"><a href="#6、下载图片和文件" class="headerlink" title="6、下载图片和文件"></a>6、下载图片和文件</h3><h4 id="6-1、激活Media-pipeline"><a href="#6-1、激活Media-pipeline" class="headerlink" title="6.1、激活Media pipeline"></a>6.1、激活Media pipeline</h4><p>在settings中设置如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启用pipeline</span></div><div class="line">ITEM_PIPELINES = &#123;<span class="string">'scrapy.pipelines.images.ImagesPipeline'</span>: <span class="number">1</span>,</div><div class="line">  <span class="string">'scrapy.pipelines.files.FilesPipeline'</span>: <span class="number">1</span>&#125;</div><div class="line"><span class="comment"># 1.2版默认存放在./full，路径是相对.cfg配置文件</span></div><div class="line"><span class="comment"># 即使指定存储位置，也会在该目录下生成full子文件夹</span></div><div class="line">IMAGES_STORE = <span class="string">'/path/to/valid/dir'</span></div><div class="line"><span class="comment"># 定义图片url的item域</span></div><div class="line">IMAGES_URLS_FIELD = <span class="string">'field_name_for_your_images_urls'</span></div><div class="line"><span class="comment"># 定义图片下载结果存放的item域</span></div><div class="line">IMAGES_RESULT_FIELD = <span class="string">'field_name_for_your_processed_images'</span></div><div class="line"><span class="comment"># 文件和图片定义类似</span></div><div class="line">FILES_STORE = <span class="string">'/path/to/valid/dir'</span></div><div class="line">FILES_URLS_FIELD = <span class="string">'field_name_for_your_files_urls'</span></div><div class="line">FILES_RESULT_FIELD = <span class="string">'field_name_for_your_processed_files'</span></div></pre></td></tr></table></figure>
<h4 id="6-2、items中定义"><a href="#6-2、items中定义" class="headerlink" title="6.2、items中定义"></a>6.2、items中定义</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> scrapy</div><div class="line">image_url = scrapy.Field()</div><div class="line">download_success = scrapy.Field()</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：image_url 的接收对象是image url的列表。</p>
<p>download_success:包含字典的列表，由ImagePipeline自动填充，包含image的url，本地存储位置，文件校验值：</p>
<p><code>[{&#39;url&#39;: &#39;http://img.tupianzj.com/uploads/allimg/161226/9-161226154443.jpg&#39;, &#39;path&#39;: &#39;full/46ae5ec4f4c0905e48a41d569abe8e1aaa832f29.jpg&#39;, &#39;checksum&#39;: &#39;c35693197b1217ac8cafd7f7f318ef33&#39;}]</code></p>
<h4 id="6-3、spiders编写"><a href="#6-3、spiders编写" class="headerlink" title="6.3、spiders编写"></a>6.3、spiders编写</h4><blockquote>
<p>只需要给item[‘image_url’]传url的列表，并将item返回</p>
</blockquote>
<p>这是爬<a href="http://www.tupianzj.com/gaoxiao/biaoqing" target="_blank" rel="external">图片之家</a>QQ表情图的一个例子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</div><div class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule</div><div class="line"><span class="keyword">from</span> gaoxiao_pic.items <span class="keyword">import</span> GaoxiaoPicItem</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FunPicSpider</span><span class="params">(CrawlSpider)</span>:</span></div><div class="line">    name = <span class="string">'fun_pic'</span></div><div class="line">    allowed_domains = [<span class="string">'tupianzj.com'</span>]</div><div class="line">    start_urls = [<span class="string">'http://www.tupianzj.com/gaoxiao/biaoqing/'</span>, ]</div><div class="line"></div><div class="line">    rules = (</div><div class="line">        Rule(LinkExtractor(allow=<span class="string">r'http://www\.tupianzj\.com/gaoxiao/gx/biaoqing\.html'</span>)),</div><div class="line">        Rule(LinkExtractor(allow=<span class="string">r'http://www\.tupianzj\.com/gaoxiao/biaoqing/list[_\d]+\.html'</span>)),</div><div class="line">        Rule(LinkExtractor(allow=<span class="string">r'http://img\.tupianzj\.com/uploads/allimg/\d+/.+\.(?:gif|jpg|png|bmp)'</span>),</div><div class="line">             callback=<span class="string">'parse_item'</span>),</div><div class="line">        Rule(LinkExtractor(allow=<span class="string">r'http://www\.tupianzj\.com/gaoxiao/biaoqing/\d+/[_\d]+.html'</span>),</div><div class="line">             callback=<span class="string">'parse_item'</span>, follow=<span class="keyword">True</span>),</div><div class="line">    )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></div><div class="line">        i = GaoxiaoPicItem()</div><div class="line">        <span class="keyword">if</span> str(response.url).split(<span class="string">'.'</span>)[<span class="number">-1</span>].lower() <span class="keyword">in</span> [<span class="string">'jpg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'jpeg'</span>, <span class="string">'bmp'</span>]:</div><div class="line">            i[<span class="string">'image_url'</span>] = [response.url]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                url = response.xpath(<span class="string">"//div[@id='bigpic']/a/img/@src"</span>).extract()[<span class="number">0</span>]</div><div class="line">                i[<span class="string">'image_url'</span>] = [response.urljoin(url)]  <span class="comment"># 这里每个页面只有一张图片,</span></div><div class="line">                <span class="keyword">print</span> i[<span class="string">'image_url'</span>]</div><div class="line">            <span class="keyword">except</span> Exception, e:</div><div class="line">                <span class="keyword">print</span> e.message</div><div class="line">        <span class="keyword">return</span> i</div></pre></td></tr></table></figure>
<p>items.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GaoxiaoPicItem</span><span class="params">(scrapy.Item)</span>:</span></div><div class="line">    image_url = scrapy.Field()</div><div class="line">    download_success = scrapy.Field()</div></pre></td></tr></table></figure>
<p>settings.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启用pipeline</span></div><div class="line">ITEM_PIPELINES = &#123;<span class="string">'scrapy.pipelines.images.ImagesPipeline'</span>: <span class="number">1</span>,</div><div class="line">                  <span class="comment"># 'scrapy.pipelines.files.FilesPipeline': 1</span></div><div class="line">                  &#125;</div><div class="line"><span class="comment"># 定义图片存储位置（必须）</span></div><div class="line">IMAGES_STORE = <span class="string">'.'</span></div><div class="line"><span class="comment"># 定义图片url的item域</span></div><div class="line">IMAGES_URLS_FIELD = <span class="string">'image_url'</span></div><div class="line"><span class="comment"># 存储下载结果</span></div><div class="line">IMAGES_RESULT_FIELD = <span class="string">'download_success'</span></div></pre></td></tr></table></figure>
<h3 id="7、设置headers"><a href="#7、设置headers" class="headerlink" title="7、设置headers"></a>7、设置headers</h3><h4 id="7-1、设置默认headers"><a href="#7-1、设置默认headers" class="headerlink" title="7.1、设置默认headers"></a>7.1、设置默认headers</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># settings中可以设置浏览器默认headers，</span></div><div class="line">DEFAULT_REQUEST_HEADERS = &#123;</div><div class="line"></div><div class="line">    <span class="string">'accept'</span>: <span class="string">'image/webp,/;q=0.8'</span>,</div><div class="line"></div><div class="line">    <span class="string">'accept-language'</span>: <span class="string">'zh-CN,zh;q=0.8'</span>,</div><div class="line"></div><div class="line">    <span class="string">'referer'</span>: <span class="string">'https://www.baidu.com/'</span>,</div><div class="line"></div><div class="line">    <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36'</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="7-2、为每个download-分配随机UA和代理"><a href="#7-2、为每个download-分配随机UA和代理" class="headerlink" title="7.2、为每个download 分配随机UA和代理"></a>7.2、为每个download 分配随机UA和代理</h4><ul>
<li><p>UA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># --------------settings.py--------------------</span></div><div class="line">DOWNLOADER_MIDDLEWARES = &#123;</div><div class="line">    <span class="string">'xxx.middlewares.RandomUserAgentMiddleware'</span>: <span class="number">400</span>,</div><div class="line">      <span class="string">'scrapy.contrib.downloadermiddleware.useragent.UserAgentMiddleware'</span>: <span class="keyword">None</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># ------创建middlewares.py ----------------------</span></div><div class="line"><span class="keyword">import</span> faker</div><div class="line">f = faker.Factory().create()</div><div class="line"><span class="comment"># user_agent = f.user_agent() # 随机生成的浏览器UA，都次调用返回结果都不同</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomUserAgentMiddleware</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request, spider)</span>:</span></div><div class="line">        request.headers.setdefault(<span class="string">'User-Agent'</span>, f.user_agent())</div><div class="line">        <span class="comment">#log.msg('&gt;&gt;&gt;&gt; UA %s'%request.headers)</span></div></pre></td></tr></table></figure>
</li>
<li><p>代理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -------------------settings.py--------</span></div><div class="line"><span class="comment"># 启用代理</span></div><div class="line">DOWNLOADER_MIDDLEWARES = &#123;</div><div class="line">    <span class="string">'scrapy.contrib.downloadermiddleware.httpproxy.HttpProxyMiddleware'</span>: <span class="number">110</span>,</div><div class="line">    <span class="string">'xxx.middlewares.ProxyMiddleware'</span>: <span class="number">100</span>,</div><div class="line">&#125;</div><div class="line"><span class="comment"># 在setting中写死了代理列表，实际环境在需要代理时可以从数据库代理池获取</span></div><div class="line">PROXY_LIST = [</div><div class="line">	&#123;<span class="string">'ip_port'</span>: <span class="string">'111.11.228.75:80'</span>, <span class="string">'user_pass'</span>: <span class="string">''</span>&#125;,</div><div class="line">	&#123;<span class="string">'ip_port'</span>: <span class="string">'120.198.243.22:80'</span>, <span class="string">'user_pass'</span>: <span class="string">''</span>&#125;,</div><div class="line">	&#123;<span class="string">'ip_port'</span>: <span class="string">'111.8.60.9:8123'</span>, <span class="string">'user_pass'</span>: <span class="string">''</span>&#125;,</div><div class="line">	&#123;<span class="string">'ip_port'</span>: <span class="string">'101.71.27.120:80'</span>, <span class="string">'user_pass'</span>: <span class="string">''</span>&#125;,</div><div class="line">	&#123;<span class="string">'ip_port'</span>: <span class="string">'122.96.59.104:80'</span>, <span class="string">'user_pass'</span>: <span class="string">''</span>&#125;,</div><div class="line">	&#123;<span class="string">'ip_port'</span>: <span class="string">'122.224.249.122:8088'</span>, <span class="string">'user_pass'</span>: <span class="string">''</span>&#125;,</div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment"># -----创建middlewares.py, 配置代理-----------------</span></div><div class="line"><span class="keyword">from</span> xxx.settings <span class="keyword">import</span> PROXY_LIST</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> base64</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyMiddleware</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request, spider)</span>:</span></div><div class="line">		proxy = random.choice(PROXIES_LIST)</div><div class="line">		<span class="keyword">if</span> proxy[<span class="string">'user_pass'</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">			request.meta[<span class="string">'proxy'</span>] = <span class="string">"http://%s"</span> % proxy[<span class="string">'ip_port'</span>]</div><div class="line">			encoded_user_pass = base64.encodestring(proxy[<span class="string">'user_pass'</span>])</div><div class="line">			request.headers[<span class="string">'Proxy-Authorization'</span>] = <span class="string">'Basic '</span> + encoded_user_pass</div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			request.meta[<span class="string">'proxy'</span>] = <span class="string">"http://%s"</span> % proxy[<span class="string">'ip_port'</span>]</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="8、登陆Post和Cookie"><a href="#8、登陆Post和Cookie" class="headerlink" title="8、登陆Post和Cookie"></a>8、登陆Post和Cookie</h3><h4 id="8-1、POST表单登陆豆瓣"><a href="#8-1、POST表单登陆豆瓣" class="headerlink" title="8.1、POST表单登陆豆瓣"></a>8.1、POST表单登陆豆瓣</h4><p>登陆页面有验证码比无验证时post表单提交的数据多了captcha-id和captcha-solution。有验证码时下载图片，手动输入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</div><div class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule</div><div class="line"><span class="keyword">from</span> scrapy.http <span class="keyword">import</span> Request, FormRequest, HtmlResponse</div><div class="line"><span class="keyword">from</span> douban.items <span class="keyword">import</span> DoubanItem</div><div class="line"><span class="keyword">import</span> faker, requests, os</div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubanSpiderSpider</span><span class="params">(CrawlSpider)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_requests_to_follow</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="string">"""重写加入cookiejar的更新"""</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(response, HtmlResponse):</div><div class="line">            <span class="keyword">return</span></div><div class="line">        seen = set()</div><div class="line">        <span class="keyword">for</span> n, rule <span class="keyword">in</span> enumerate(self._rules):</div><div class="line">            links = [l <span class="keyword">for</span> l <span class="keyword">in</span> rule.link_extractor.extract_links(response) <span class="keyword">if</span> l <span class="keyword">not</span> <span class="keyword">in</span> seen]</div><div class="line">            <span class="keyword">if</span> links <span class="keyword">and</span> rule.process_links:</div><div class="line">                links = rule.process_links(links)</div><div class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> links:</div><div class="line">                seen.add(link)</div><div class="line">                r = Request(url=link.url, callback=self._response_downloaded)</div><div class="line">                <span class="comment"># 下面这句是我重写的</span></div><div class="line">                r.meta.update(rule=n, link_text=link.text, cookiejar=response.meta[<span class="string">'cookiejar'</span>])</div><div class="line">                <span class="keyword">yield</span> rule.process_request(r)</div><div class="line"></div><div class="line">    name = <span class="string">'douban_spider'</span></div><div class="line">    allowed_domains = [<span class="string">'douban.com'</span>]</div><div class="line">    start_urls = [<span class="string">'https://www.douban.com/'</span>]</div><div class="line"></div><div class="line">    rules = (</div><div class="line">        Rule(LinkExtractor(allow=<span class="string">r'Items/'</span>), callback=<span class="string">'parse_item'</span>, follow=<span class="keyword">True</span>),</div><div class="line">    )</div><div class="line">    f = faker.Factory().create()</div><div class="line">    user_agent = f.user_agent() <span class="comment"># 随机生成的浏览器UA，都次调用返回结果都不同</span></div><div class="line">    headers = &#123;<span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</div><div class="line">               <span class="string">'Cache-Control'</span>: <span class="string">'max-age=0'</span>,</div><div class="line">               <span class="string">'Referer'</span>: <span class="string">'https://www.douban.com'</span>,</div><div class="line">               <span class="string">'User-Agent'</span>: user_agent,</div><div class="line">        <span class="comment"># 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.87 Safari/537.36',</span></div><div class="line">               <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate, sdch, br'</span>,</div><div class="line">               <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.8'</span>,</div><div class="line">               <span class="string">'Host'</span>: <span class="string">'accounts.douban.com'</span>,</div><div class="line">               <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span></div><div class="line">               &#125;</div><div class="line">    your_email = <span class="string">'1XXX'</span></div><div class="line">    your_password = <span class="string">'XXXX'</span></div><div class="line">    postdata = &#123;<span class="string">'source'</span>: <span class="string">'None'</span>,</div><div class="line">                <span class="string">'redir'</span>: <span class="string">'https://www.douban.com/'</span>,</div><div class="line">                <span class="string">'form_email'</span>: your_email,</div><div class="line">                <span class="string">'form_password'</span>: your_password,</div><div class="line">                <span class="comment"># 'captcha-solution': vcode,</span></div><div class="line">                <span class="comment"># 'captcha-id': captcha,</span></div><div class="line">                <span class="string">'login'</span>: <span class="string">'登录'</span></div><div class="line">                &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 访问登录页面</span></div><div class="line">        <span class="comment"># Scrapy通过使用meta['cookiejar']来支持单spider追踪多cookie session。默认情况下其使用一个cookie jar(session)，不过可以传递一个标示符来使用多个。如meta=&#123;'cookiejar': 1&#125;这句，后面那个1就是标示符。</span></div><div class="line">        <span class="keyword">return</span> [Request(url=<span class="string">'https://www.douban.com/accounts/login'</span>, headers=self.headers,</div><div class="line">                        meta=&#123;<span class="string">'cookiejar'</span>: <span class="number">1</span>&#125;, callback=self.post_login)]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post_login</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'Preparing login===='</span>, response.url</div><div class="line">        <span class="comment"># 如果登陆要验证码，则post数据中加入验证码的id和值</span></div><div class="line">        <span class="keyword">if</span> response.body.find(<span class="string">'captcha_image'</span>) &gt; <span class="number">0</span>:</div><div class="line">            captcha_url = response.xpath(<span class="string">'//img[@id="captcha_image"]/@src'</span>).extract()[<span class="number">0</span>]</div><div class="line">            <span class="keyword">print</span> <span class="string">u'验证码的URL：%s'</span> % captcha_url</div><div class="line">            <span class="keyword">with</span> open(<span class="string">'v.jpg'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</div><div class="line">                f.write(requests.get(captcha_url, verify=<span class="keyword">False</span>).content)</div><div class="line">            <span class="keyword">with</span> open(<span class="string">'v.jpg'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</div><div class="line">                image = Image.open(f)</div><div class="line">                image.show()</div><div class="line">            self.postdata[<span class="string">'captcha-solution'</span>] = raw_input(<span class="string">'请输入图片验证码:\n'</span>)</div><div class="line">            os.remove(<span class="string">'v.jpg'</span>)</div><div class="line">            self.postdata[<span class="string">'captcha-id'</span>] = response.xpath(<span class="string">'//input[@name="captcha-id"]/@value'</span>).extract()[<span class="number">0</span>]</div><div class="line">            <span class="keyword">print</span> self.postdata</div><div class="line">        <span class="keyword">return</span> [FormRequest.from_response(response,</div><div class="line">                                          headers=self.headers,</div><div class="line">                                          meta=&#123;<span class="string">'cookiejar'</span>: response.meta[<span class="string">'cookiejar'</span>]&#125;,</div><div class="line">                                          formdata=self.postdata,</div><div class="line">                                          callback=self.after_login,</div><div class="line">                                          )]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">after_login</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="comment"># 登陆之后,访问的网页内容应该会包含用户信息</span></div><div class="line">        self.headers[<span class="string">'Host'</span>] = <span class="string">'www.douban.com'</span></div><div class="line">        <span class="keyword">print</span> response.body</div><div class="line">        <span class="keyword">with</span> open(<span class="string">'a.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(response.body)</div><div class="line">        item = DoubanItem()</div><div class="line">        item[<span class="string">'main_page'</span>] = response.body</div><div class="line">        <span class="keyword">return</span> Request(<span class="string">'https://www.douban.com/doumail/'</span>, headers=self.headers,</div><div class="line">                       meta=&#123;<span class="string">'cookiejar'</span>: response.meta[<span class="string">'cookiejar'</span>], <span class="string">'item'</span>: item&#125;,</div><div class="line">                       callback=self.openfile)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(self, response)</span>:</span></div><div class="line">        item[<span class="string">'doumail_page'</span>] = response.body</div><div class="line">        <span class="keyword">return</span> item</div></pre></td></tr></table></figure>
<h4 id="8-2、使用Cookie登陆豆瓣"><a href="#8-2、使用Cookie登陆豆瓣" class="headerlink" title="8.2、使用Cookie登陆豆瓣"></a>8.2、使用Cookie登陆豆瓣</h4><p>使用浏览器或requests模拟登陆，然后将cookie传进scrapy的spider。</p>
<p>由于每次从浏览器复制出来的cookies或headers都是字符串形式，手工改成字典太累了，写个小程序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 从chrome浏览器的Request Header中，点击view source，然后复制header字符串</span></div><div class="line">headers_str = <span class="string">'''Host: www.douban.com</span></div><div class="line"><span class="string">Connection: keep-alive</span></div><div class="line"><span class="string">Cache-Control: max-age=0</span></div><div class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span></div><div class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></div><div class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.87 Safari/537.36</span></div><div class="line"><span class="string">Referer: https://www.douban.com/people/108243932/</span></div><div class="line"><span class="string">Accept-Encoding: gzip, deflate, sdch, br</span></div><div class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.8</span></div><div class="line"><span class="string">Cookie: viewed="1770782"; bid=SrGB-eJRKEE; gr_user_id=a37ff9ef-33cc-4de7-971b-c161f747a77b; ll="118254"; ps=y; dbcl2="108243932:kVKKGRcAZVg"; _ga=GA1.2.1495924407.1465701053; ck=LRet; _pk_ref.100001.8cb4=%5B%22%22%2C%22%22%2C1483063011%2C%22https%3A%2F%2Faccounts.douban.com%2Fregister%22%5D; __utmt=1; ap=1; push_noty_num=0; push_doumail_num=0; _pk_id.100001.8cb4=438cca0c1cd12666.1482926660.4.1483063910.1483060769.; _pk_ses.100001.8cb4=*; __utma=30149280.1495924407.1465701053.1483060678.1483063011.6; __utmb=30149280.24.9.1483063909873; __utmc=30149280; __utmz=30149280.1483021458.4.3.utmcsr=accounts.douban.com|utmccn=(referral)|utmcmd=referral|utmcct=/register; __utmv=30149280.10824; _vwo_uuid_v2=02A1FB5802A3379A6C48F734CB328D35|33e02434e1d90a57e4c63094703cde0f'''</span></div><div class="line">headers = &#123;&#125;</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> headers_str.split(<span class="string">'\n'</span>):</div><div class="line">    j = i.replace(<span class="string">': '</span>, <span class="string">':'</span>, <span class="number">1</span>).split(<span class="string">':'</span>, <span class="number">1</span>)</div><div class="line">    headers[j[<span class="number">0</span>]] = j[<span class="number">1</span>]</div><div class="line"><span class="keyword">if</span> <span class="string">'Cookie'</span> <span class="keyword">in</span> headers:</div><div class="line">    cookies_str = headers[<span class="string">'Cookie'</span>]</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="comment"># 把cookie字符串从浏览器copy进来</span></div><div class="line">    cookies_str = <span class="string">''' '''</span></div><div class="line">cookies = &#123;&#125;</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cookies_str.split(<span class="string">';'</span>):</div><div class="line">    q = i.split(<span class="string">'='</span>)</div><div class="line">    key = q[<span class="number">0</span>].replace(<span class="string">' '</span>, <span class="string">''</span>, <span class="number">1</span>)</div><div class="line">    value = q[<span class="number">1</span>].replace(<span class="string">' '</span>, <span class="string">''</span>, <span class="number">1</span>)</div><div class="line">    cookies[key] = value</div><div class="line"><span class="comment"># print cookies</span></div><div class="line"><span class="keyword">print</span> headers.pop(<span class="string">'Cookie'</span>)</div><div class="line"><span class="keyword">print</span> headers</div></pre></td></tr></table></figure>
<p>使用cookie登陆豆瓣：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</div><div class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubanCookieSpider</span><span class="params">(CrawlSpider)</span>:</span></div><div class="line">    name = <span class="string">'douban_cookie'</span></div><div class="line">    allowed_domains = [<span class="string">'douban.com'</span>]</div><div class="line">    start_urls = [<span class="string">'https://www.douban.com/mine/'</span>,</div><div class="line">                  <span class="string">'https://www.douban.com/doumail/'</span>,</div><div class="line">                  <span class="string">'https://www.douban.com/people/108243932/'</span>,</div><div class="line">                  <span class="string">'https://www.douban.com/mine/orders/'</span></div><div class="line">                  ]</div><div class="line">    cookies = &#123;<span class="string">'ck'</span>: <span class="string">'LRet'</span>, <span class="string">'ps'</span>: <span class="string">'y'</span>, <span class="string">'__utmz'</span>: <span class="string">'30149280.1483021458.4.3.utmcsr'</span>, <span class="string">'__utmv'</span>: <span class="string">'30149280.10824'</span>,</div><div class="line">     <span class="string">'push_doumail_num'</span>: <span class="string">'0'</span>, <span class="string">'__utmt'</span>: <span class="string">'1'</span>, <span class="string">'bid'</span>: <span class="string">'SrGB-eJRKEE'</span>, <span class="string">'push_noty_num'</span>: <span class="string">'0'</span>,</div><div class="line">     <span class="string">'_ga'</span>: <span class="string">'GA1.2.1495924407.1465701053'</span>,</div><div class="line">     <span class="string">'_pk_ref.100001.8cb4'</span>: <span class="string">'%5B%22%22%2C%22%22%2C1483063011%2C%22https%3A%2F%2Faccounts.douban.com%2Fregister%22%5D'</span>,</div><div class="line">     <span class="string">'_vwo_uuid_v2'</span>: <span class="string">'02A1FB5802A3379A6C48F734CB328D35|33e02434e1d90a57e4c63094703cde0f'</span>, <span class="string">'ap'</span>: <span class="string">'1'</span>,</div><div class="line">     <span class="string">'dbcl2'</span>: <span class="string">'"108243932:kVKKGRcAZVg"'</span>, <span class="string">'_pk_id.100001.8cb4'</span>: <span class="string">'438cca0c1cd12666.1482926660.4.1483063910.1483060769.'</span>,</div><div class="line">     <span class="string">'_pk_ses.100001.8cb4'</span>: <span class="string">'*'</span>, <span class="string">'gr_user_id'</span>: <span class="string">'a37ff9ef-33cc-4de7-971b-c161f747a77b'</span>,</div><div class="line">     <span class="string">'__utma'</span>: <span class="string">'30149280.1495924407.1465701053.1483060678.1483063011.6'</span>, <span class="string">'__utmb'</span>: <span class="string">'30149280.24.9.1483063909873'</span>,</div><div class="line">     <span class="string">'__utmc'</span>: <span class="string">'30149280'</span>, <span class="string">'ll'</span>: <span class="string">'"118254"'</span>, <span class="string">'viewed'</span>: <span class="string">'"1770782"'</span>&#125;</div><div class="line">    headers = &#123;<span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.8'</span>, <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate, sdch, br'</span>, <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span>,</div><div class="line">                 <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</div><div class="line">                <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.87 Safari/537.36'</span>,</div><div class="line">                 <span class="string">'Host'</span>: <span class="string">'www.douban.com'</span>,</div><div class="line">               	<span class="string">'Referer'</span>: <span class="string">'https://www.douban.com/'</span>, <span class="string">'Cache-Control'</span>: <span class="string">'max-age=0'</span>,</div><div class="line">                 <span class="string">'Upgrade-Insecure-Requests'</span>: <span class="string">'1'</span>&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> [scrapy.Request(<span class="string">'https://www.douban.com/'</span>, headers=self.headers, cookies=self.cookies, meta=&#123;<span class="string">'cookiejar'</span>: <span class="number">1</span>&#125;, callback=self.after_set_cookie)]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">after_set_cookie</span><span class="params">(self, response)</span>:</span></div><div class="line">        req = []</div><div class="line">        self.headers[<span class="string">'Referer'</span>] = response.url</div><div class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> self.start_urls:</div><div class="line">            req.append(scrapy.Request(url=url, headers=self.headers, meta=&#123;<span class="string">'cookiejar'</span>: response.meta[<span class="string">'cookiejar'</span>]&#125;, callback=self.parse_item))</div><div class="line">        <span class="keyword">return</span> req</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="keyword">print</span> response.url</div><div class="line">        filename = response.url.split(<span class="string">'/'</span>)[<span class="number">-2</span>] + <span class="string">'.html'</span></div><div class="line">        <span class="keyword">with</span> open(filename, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(response.body)  <span class="comment"># 保存的网页中应该有登陆账号后的个人信息</span></div></pre></td></tr></table></figure>
<h3 id="9、JS-、XHR分析"><a href="#9、JS-、XHR分析" class="headerlink" title="9、JS 、XHR分析"></a>9、JS 、XHR分析</h3><blockquote>
<p>主要是分析js请求的url。挖个坑，暂时不打算填。</p>
<p>不好解决的话，还是用selenium + phantomjs吧</p>
</blockquote>
<h3 id="10、Scrapy-Redis分布式爬虫"><a href="#10、Scrapy-Redis分布式爬虫" class="headerlink" title="10、Scrapy Redis分布式爬虫"></a>10、Scrapy Redis分布式爬虫</h3><h4 id="10-1、安装redis"><a href="#10-1、安装redis" class="headerlink" title="10.1、安装redis"></a>10.1、安装redis</h4><ul>
<li>windows</li>
</ul>
<p>下载地址：<a href="https://github.com/rgl/redis/downloads" target="_blank" rel="external">https://github.com/rgl/redis/downloads</a></p>
<p>安装完成后，</p>
<p>运行redis服务器的命令：安装目录下的redis-server.exe</p>
<p>运行redis客户端的命令：安装目录下的redis-cli.exe</p>
<ul>
<li>Linux</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash">sudo apt-get install redis-server</span></div><div class="line"><span class="meta">#</span><span class="bash"> 启动 Redis</span></div><div class="line"><span class="meta">$</span><span class="bash"> redis-server &amp;</span></div><div class="line"><span class="meta">#</span><span class="bash"> 或者</span></div><div class="line"><span class="meta">$</span><span class="bash"> service redis-server start</span></div><div class="line"><span class="meta">#</span><span class="bash"> 查看 redis 是否启动？</span></div><div class="line"><span class="meta">$</span><span class="bash"> redis-cli</span></div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/redis/redis.conf</span></div><div class="line"><span class="meta">#</span><span class="bash">注释<span class="built_in">bind</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="built_in">bind</span> 127.0.0.1</span></div><div class="line"><span class="meta">#</span><span class="bash"> 如果要设置密码，取消注释requirepass</span></div><div class="line">requirepass mypasswd</div></pre></td></tr></table></figure>
<p>修改配置文件后，要重启服务生效。有密码的连接方式，<code>redis-cli -a mypasswd -h 172.16.28.24 -p 6379</code></p>
<p>还是单开一篇笔记来写吧！</p>
<h3 id="11、记录一些error"><a href="#11、记录一些error" class="headerlink" title="11、记录一些error"></a>11、记录一些error</h3><h4 id="11-1、url相关"><a href="#11-1、url相关" class="headerlink" title="11.1、url相关"></a>11.1、url相关</h4><ul>
<li>ValueError: Missing scheme in request url: h</li>
</ul>
<p>这种问题一般是url出错了，要以http开头，如果是从网页解析的url，可以用 <code>response.urljoin(relative_url)</code> 生成绝对路径。</p>
<p>如果在下载图片中出错，是因为image_field必须是图片url的列表，只存了一个url字符串的话，scrapy遍历url时取出的第一个对象是http url的第一个字符h，故报错h是非法url。</p>
<p>太坑了，花了半个小时才发现原因。</p>
<ul>
<li>注意twisted库的版本，在conda中先装twisted再装scrapy</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-12-13T16:00:00.000Z"><a href="/2016/12/14/技术/linux-snmp-server/">2016-12-14</a></time>
      
      
  
    <h1 class="title"><a href="/2016/12/14/技术/linux-snmp-server/">Linux 配置SNMP服务</a></h1>
  

    </header>
    <div class="entry">
         
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux服务器配置snmp服务"><span class="toc-text">Linux服务器配置snmp服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装snmp-server"><span class="toc-text">安装snmp server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改snmp配置文件"><span class="toc-text">修改snmp配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开启防火墙161端口"><span class="toc-text">开启防火墙161端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用Linux监控OID"><span class="toc-text">常用Linux监控OID</span></a></li></ol></li></ol>
    </div>

      
        <h2 id="Linux服务器配置snmp服务"><a href="#Linux服务器配置snmp服务" class="headerlink" title="Linux服务器配置snmp服务"></a>Linux服务器配置snmp服务</h2><h3 id="安装snmp-server"><a href="#安装snmp-server" class="headerlink" title="安装snmp server"></a>安装snmp server</h3><ul>
<li><p>安装snmp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get install snmp snmpd</div></pre></td></tr></table></figure>
</li>
<li><p>安装mib库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get install snmp-mibs-downloader</div></pre></td></tr></table></figure>
</li>
</ul>
<p><a href="https://wiki.debian.org/SNMP" target="_blank" rel="external">参考debian-wiki-snmp</a></p>
<ul>
<li><p>查看默认配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cat /etc/snmp/snmpd.conf </div><div class="line">cat /etc/snmp/snmp.conf</div></pre></td></tr></table></figure>
</li>
<li><p>启动SNMP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># service snmpd start</div><div class="line"># snmpd -C -c /etc/snmp/myconfig.conf  ### -C不适用默认配置文件 -c指定自定义配置文件</div></pre></td></tr></table></figure>
</li>
<li><p>如有需要，安装net-snmp</p>
<ul>
<li><p><a href="http://www.net-snmp.org/download.html" target="_blank" rel="external">源码下载地址</a></p>
</li>
<li><p>编译</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># tar -zxvf net-snmp-5.7.3.tar.gz    ###  解压源码</div><div class="line"># ./configure --help		### 查看编译配置</div><div class="line"># ./configure 				### 开始编译</div><div class="line"># make</div><div class="line"># make install</div></pre></td></tr></table></figure>
<p>如果编译报错lperl，使用 <code>apt-get install libperl-dev</code></p>
<ul>
<li><p>使用net-snmp工具</p>
<p>查询到主机CPU空闲率为99%</p>
<pre><code># snmpwalk -v 2c -c public localhost 1.3.6.1.4.1.2021.11.11.0

UCD-SNMP-MIB::ssCpuIdle.0 = INTEGER: 99    
</code></pre></li>
</ul>
</li>
</ul>
<h3 id="修改snmp配置文件"><a href="#修改snmp配置文件" class="headerlink" title="修改snmp配置文件"></a>修改snmp配置文件</h3><pre><code>/etc/snmp/snmpd.conf
配置允许网络访问,找到【AGENT BEHAVIOUR】，注释掉`agentAddress udp:127.0.0.1：161`,添加一行`agentAddress udp:161`
 选择SNMPv2C协议版本,找到【ACTIVE MONITORING】，注释掉`trapsink     localhost public`，添加`trap2sink localhost public`
 设置访问权限,找到【ACCESS CONTROL】,注释掉`rocommunity public  default    -V systemonly`，添加`rocommunity public  default    `,允许所有访问请求。

/etc/snmp/snmp.conf
注释掉开头第一行
</code></pre><h3 id="开启防火墙161端口"><a href="#开启防火墙161端口" class="headerlink" title="开启防火墙161端口"></a>开启防火墙161端口</h3><ul>
<li><p>查看防火墙规则</p>
<p><code>iptables –L –n</code></p>
</li>
<li><p>添加规则</p>
<p><code>iptables -I INPUT -p udp --dport 161 -j ACCEPT</code></p>
</li>
<li><p>保存生效</p>
<p><code>iptables-save</code>  Debian</p>
<p><code>iptables -save</code>  ubuntu</p>
</li>
</ul>
<h3 id="常用Linux监控OID"><a href="#常用Linux监控OID" class="headerlink" title="常用Linux监控OID"></a>常用Linux监控OID</h3><ul>
<li>系统信息</li>
</ul>
<p><img src="http://ww2.sinaimg.cn/large/af9df239jw1f5si8iqsrmj20h60cyaba.jpg" alt="系统信息"></p>
<ul>
<li>网络接口</li>
</ul>
<p><img src="http://ww3.sinaimg.cn/large/af9df239jw1f5sid6wbk4j20d70ed75i.jpg" alt="网络接口"></p>
<ul>
<li>CPU及负载</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/af9df239gw1f5siez19moj20dg0gf3zo.jpg" alt="CPU及负载"></p>
<ul>
<li>内存及磁盘</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/af9df239gw1f5sifd7v5tj20d20gggn4.jpg" alt="内存及磁盘"></p>
<ul>
<li><p>System Group</p>
<p>  sysDescr 1.3.6.1.2.1.1.1</p>
<p>  sysObjectID 1.3.6.1.2.1.1.2</p>
<p>  sysUpTime 1.3.6.1.2.1.1.3</p>
<p>  sysContact 1.3.6.1.2.1.1.4</p>
<p>  sysName 1.3.6.1.2.1.1.5</p>
<p>  sysLocation 1.3.6.1.2.1.1.6</p>
<p>  sysServices 1.3.6.1.2.1.1.7</p>
</li>
<li><p>Interfaces Group</p>
<p>  ifNumber 1.3.6.1.2.1.2.1</p>
<p>  ifTable 1.3.6.1.2.1.2.2</p>
<p>  ifEntry 1.3.6.1.2.1.2.2.1</p>
<p>  ifIndex 1.3.6.1.2.1.2.2.1.1</p>
<p>  ifDescr 1.3.6.1.2.1.2.2.1.2</p>
<p>  ifType 1.3.6.1.2.1.2.2.1.3</p>
<p>  ifMtu 1.3.6.1.2.1.2.2.1.4</p>
<p>  ifSpeed 1.3.6.1.2.1.2.2.1.5</p>
<p>  ifPhysAddress 1.3.6.1.2.1.2.2.1.6</p>
<p>  ifAdminStatus 1.3.6.1.2.1.2.2.1.7</p>
<p>  ifOperStatus 1.3.6.1.2.1.2.2.1.8</p>
<p>  ifLastChange 1.3.6.1.2.1.2.2.1.9</p>
<p>  ifInOctets 1.3.6.1.2.1.2.2.1.10</p>
<p>  ifInUcastPkts 1.3.6.1.2.1.2.2.1.11</p>
<p>  ifInNUcastPkts 1.3.6.1.2.1.2.2.1.12</p>
<p>  ifInDiscards 1.3.6.1.2.1.2.2.1.13</p>
<p>  ifInErrors 1.3.6.1.2.1.2.2.1.14</p>
<p>  ifInUnknownProtos 1.3.6.1.2.1.2.2.1.15</p>
<p>  ifOutOctets 1.3.6.1.2.1.2.2.1.16</p>
<p>  ifOutUcastPkts 1.3.6.1.2.1.2.2.1.17</p>
<p>  ifOutNUcastPkts 1.3.6.1.2.1.2.2.1.18</p>
<p>  ifOutDiscards 1.3.6.1.2.1.2.2.1.19</p>
<p>  ifOutErrors 1.3.6.1.2.1.2.2.1.20</p>
<p>  ifOutQLen 1.3.6.1.2.1.2.2.1.21</p>
<p>  ifSpecific 1.3.6.1.2.1.2.2.1.22</p>
</li>
<li><p>IP Group</p>
<p>  ipForwarding 1.3.6.1.2.1.4.1</p>
<p>  ipDefaultTTL 1.3.6.1.2.1.4.2</p>
<p>  ipInReceives 1.3.6.1.2.1.4.3</p>
<p>  ipInHdrErrors 1.3.6.1.2.1.4.4</p>
<p>  ipInAddrErrors 1.3.6.1.2.1.4.5</p>
<p>  ipForwDatagrams 1.3.6.1.2.1.4.6</p>
<p>  ipInUnknownProtos 1.3.6.1.2.1.4.7</p>
<p>  ipInDiscards 1.3.6.1.2.1.4.8</p>
<p>  ipInDelivers 1.3.6.1.2.1.4.9</p>
<p>  ipOutRequests 1.3.6.1.2.1.4.10</p>
<p>  ipOutDiscards 1.3.6.1.2.1.4.11</p>
<p>  ipOutNoRoutes 1.3.6.1.2.1.4.12</p>
<p>  ipReasmTimeout 1.3.6.1.2.1.4.13</p>
<p>  ipReasmReqds 1.3.6.1.2.1.4.14</p>
<p>  ipReasmOKs 1.3.6.1.2.1.4.15</p>
<p>  ipReasmFails 1.3.6.1.2.1.4.16</p>
<p>  ipFragsOKs 1.3.6.1.2.1.4.17</p>
<p>  ipFragsFails 1.3.6.1.2.1.4.18</p>
<p>  ipFragCreates 1.3.6.1.2.1.4.19</p>
<p>  ipAddrTable 1.3.6.1.2.1.4.20</p>
<p>  ipAddrEntry 1.3.6.1.2.1.4.20.1</p>
<p>  ipAdEntAddr 1.3.6.1.2.1.4.20.1.1</p>
<p>  ipAdEntIfIndex 1.3.6.1.2.1.4.20.1.2</p>
<p>  ipAdEntNetMask 1.3.6.1.2.1.4.20.1.3</p>
<p>  ipAdEntBcastAddr 1.3.6.1.2.1.4.20.1.4</p>
<p>  ipAdEntReasmMaxSize 1.3.6.1.2.1.4.20.1.5</p>
</li>
<li><p>ICMP Group</p>
<p>  icmpInMsgs 1.3.6.1.2.1.5.1</p>
<p>  icmpInErrors 1.3.6.1.2.1.5.2</p>
<p>  icmpInDestUnreachs 1.3.6.1.2.1.5.3</p>
<p>  icmpInTimeExcds 1.3.6.1.2.1.5.4</p>
<p>  icmpInParmProbs 1.3.6.1.2.1.5.5</p>
<p>  icmpInSrcQuenchs 1.3.6.1.2.1.5.6</p>
<p>  icmpInRedirects 1.3.6.1.2.1.5.7</p>
<p>  icmpInEchos 1.3.6.1.2.1.5.8</p>
<p>  icmpInEchoReps 1.3.6.1.2.1.5.9</p>
<p>  icmpInTimestamps 1.3.6.1.2.1.5.10</p>
<p>  icmpInTimestampReps 1.3.6.1.2.1.5.11</p>
<p>  icmpInAddrMasks 1.3.6.1.2.1.5.12</p>
<p>  icmpInAddrMaskReps 1.3.6.1.2.1.5.13</p>
<p>  icmpOutMsgs 1.3.6.1.2.1.5.14</p>
<p>  icmpOutErrors 1.3.6.1.2.1.5.15</p>
<p>  icmpOutDestUnreachs 1.3.6.1.2.1.5.16</p>
<p>  icmpOutTimeExcds 1.3.6.1.2.1.5.17</p>
<p>  icmpOutParmProbs 1.3.6.1.2.1.5.18</p>
<p>  icmpOutSrcQuenchs 1.3.6.1.2.1.5.19</p>
<p>  icmpOutRedirects 1.3.6.1.2.1.5.20</p>
<p>  icmpOutEchos 1.3.6.1.2.1.5.21</p>
<p>  icmpOutEchoReps 1.3.6.1.2.1.5.22</p>
<p>  icmpOutTimestamps 1.3.6.1.2.1.5.23</p>
<p>  icmpOutTimestampReps 1.3.6.1.2.1.5.24</p>
<p>  icmpOutAddrMasks 1.3.6.1.2.1.5.25</p>
<p>  icmpOutAddrMaskReps 1.3.6.1.2.1.5.26</p>
</li>
<li><p>TCP Group</p>
<p> tcpRtoAlgorithm 1.3.6.1.2.1.6.1</p>
<p> tcpRtoMin 1.3.6.1.2.1.6.2</p>
<p> tcpRtoMax 1.3.6.1.2.1.6.3</p>
<p> tcpMaxConn 1.3.6.1.2.1.6.4</p>
<p> tcpActiveOpens 1.3.6.1.2.1.6.5</p>
<p> tcpPassiveOpens 1.3.6.1.2.1.6.6</p>
<p> tcpAttemptFails 1.3.6.1.2.1.6.7</p>
<p> tcpEstabResets 1.3.6.1.2.1.6.8</p>
<p> tcpCurrEstab 1.3.6.1.2.1.6.9</p>
<p> tcpInSegs 1.3.6.1.2.1.6.10</p>
<p> tcpOutSegs 1.3.6.1.2.1.6.11</p>
<p> tcpRetransSegs 1.3.6.1.2.1.6.12</p>
<p> tcpConnTable 1.3.6.1.2.1.6.13</p>
<p> tcpConnEntry 1.3.6.1.2.1.6.13.1</p>
<p> tcpConnState 1.3.6.1.2.1.6.13.1.1</p>
<p> tcpConnLocalAddress 1.3.6.1.2.1.6.13.1.2</p>
<p> tcpConnLocalPort 1.3.6.1.2.1.6.13.1.3</p>
<p> tcpConnRemAddress 1.3.6.1.2.1.6.13.1.4</p>
<p> tcpConnRemPort 1.3.6.1.2.1.6.13.1.5</p>
<p> tcpInErrs 1.3.6.1.2.1.6.14</p>
<p> tcpOutRsts 1.3.6.1.2.1.6.15</p>
</li>
<li><p>UDP Group</p>
<p>  udpInDatagrams 1.3.6.1.2.1.7.1</p>
<p>  udpNoPorts 1.3.6.1.2.1.7.2</p>
<p>  udpInErrors 1.3.6.1.2.1.7.3</p>
<p>  udpOutDatagrams 1.3.6.1.2.1.7.4</p>
<p>  udpTable 1.3.6.1.2.1.7.5</p>
<p>  udpEntry 1.3.6.1.2.1.7.5.1</p>
<p>  udpLocalAddress 1.3.6.1.2.1.7.5.1.1</p>
<p>  udpLocalPort 1.3.6.1.2.1.7.5.1.2</p>
</li>
<li><p>SNMP Group</p>
<p>  snmpInPkts 1.3.6.1.2.1.11.1</p>
<p>  snmpOutPkts 1.3.6.1.2.1.11.2</p>
<p>  snmpInBadVersions 1.3.6.1.2.1.11.3</p>
<p>  snmpInBadCommunityNames 1.3.6.1.2.1.11.4</p>
<p>  snmpInBadCommunityUses 1.3.6.1.2.1.11.5</p>
<p>  snmpInASNParseErrs 1.3.6.1.2.1.11.6</p>
<p>  NOT USED 1.3.6.1.2.1.11.7</p>
<p>  snmpInTooBigs 1.3.6.1.2.1.11.8</p>
<p>  snmpInNoSuchNames 1.3.6.1.2.1.11.9</p>
<p>  snmpInBadValues 1.3.6.1.2.1.11.10</p>
<p>  snmpInReadOnlys 1.3.6.1.2.1.11.11</p>
<p>  snmpInGenErrs 1.3.6.1.2.1.11.12</p>
<p>  snmpInTotalReqVars 1.3.6.1.2.1.11.13</p>
<p>  snmpInTotalSetVars 1.3.6.1.2.1.11.14</p>
<p>  snmpInGetRequests 1.3.6.1.2.1.11.15</p>
<p>  snmpInGetNexts 1.3.6.1.2.1.11.16</p>
<p>  snmpInSetRequests 1.3.6.1.2.1.11.17</p>
<p>  snmpInGetResponses 1.3.6.1.2.1.11.18</p>
<p>  snmpInTraps 1.3.6.1.2.1.11.19</p>
<p>  snmpOutTooBigs 1.3.6.1.2.1.11.20</p>
<p>  snmpOutNoSuchNames 1.3.6.1.2.1.11.21</p>
<p>  snmpOutBadValues 1.3.6.1.2.1.11.22</p>
<p>  NOT USED 1.3.6.1.2.1.11.23</p>
<p>  snmpOutGenErrs 1.3.6.1.2.1.11.24</p>
<p>  snmpOutGetRequests 1.3.6.1.2.1.11.25</p>
<p>  snmpOutGetNexts 1.3.6.1.2.1.11.26</p>
<p>  snmpOutSetRequests 1.3.6.1.2.1.11.27</p>
<p>  snmpOutGetResponses 1.3.6.1.2.1.11.28</p>
<p>  snmpOutTraps 1.3.6.1.2.1.11.29</p>
<p>  snmpEnableAuthenTraps 1.3.6.1.2.1.11.30 </p>
</li>
</ul>

      
    </div>
    <footer>
      
        
		<!--  livere评论支持 -->
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
    <a href="/page/3/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/5/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  
<div>
<a href="javascript:;" class="popup-trigger">      
      <i class="menu-item-icon fa fa-search fa-fw"></i>        
   搜索
</a>
</div>


<div class="site-search">
<div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>
</div>

<script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
     
  var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';
                var str1=str                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>';
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
					else { isMatch=false; } //更新此处
					
					//更新此处
					
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ "> " + data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 20;
                            var end = first_occur + 30;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
							//console.log(match_content)
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                    }
                })
                //修改
				if (str1==str){
					str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';
					}
				
				$resultContent.innerHTML = str;
            })
        }
    })
}
    // search function;
 </script>
<script>

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
	  proceedsearch();
	  //添加的
	  document.getElementById("local-search-result").innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>';
     
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>
  
<script type="text/javascript">      
     var search_path = "search.xml";
     if (search_path.length == 0) {
     	search_path = "search.xml";
     }
     var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
</script>





  
<div class="widget tag">
  <h3 class="title" id="categories">分类</h3>
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a><span class="category-list-count">43</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/django/">django</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/git/">git</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/latex/">latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/linux/">linux</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/mongodb/">mongodb</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/numpy/">numpy</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/pandas/">pandas</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/python/">python</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/python-爬虫/">python 爬虫</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/redis/">redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/scrapy/">scrapy</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/其他/">其他</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/生活/游戏/">游戏</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/读书/">读书</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/科研/">科研</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/资源/">资源</a><span class="category-list-count">3</span></li></ul> 
</div>
 

  <div class="widget tag">
<h3 class="title">简介</h3>
<ul class="entry">
<li>博主：帅羊羊</li>
<li>现状：武大CS在读研究生</li>
<li>Theme: <a href="https://github.com/zippera/lightum">Lightum</a>
<!-- <li>想交友的朋友请<a href="http://zipperary.com/about">联系我</a>！</li> -->
<li>QQ 号：2Ol896963</li>
<li>博客: 记录个人生活学习的点滴</li>
<!-- <font color="red">Hexo 交流群：287306637</font> -->
</ul>
</div>



  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=0&uid=2946363961&verifier=371067b2&dpc=1"></iframe>

  <div class="widget tag">
<h3 class="title">打赏</h3>
<ul class="entry">
<li>支付宝扫一扫，捐助支持，谢谢！</li>
<li><a href="http://o8i01ajlj.bkt.clouddn.com/blog/171004/LikDAfKDg0.png" title="" class="fancybox" rel="gallery3"><img width="100%" src="http://o8i01ajlj.bkt.clouddn.com/blog/171004/LikDAfKDg0.png"></a></li>
</ul>
</div>

  <div class="widget tag">
  <h3 class="title">日历云</h3>
  <div id="calendar"></div>
</div>

  
  <div class="widget tag">
    <h3 class="title">归档</h3>
	<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">2017年09月</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">2017年05月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">2017年04月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">2017年03月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">2017年02月</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">2016年12月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">2016年11月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">2016年10月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">2016年09月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">2016年08月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">2016年07月</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">2016年05月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">2016年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">2015年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">2014年12月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">2014年09月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">2014年08月</a><span class="archive-list-count">1</span></li></ul>
  </div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><section>
Theme of <a href="https://github.com/zippera/lightum">Lightum</a>, Improved from <a href="https://github.com/hexojs/hexo-theme-light">Light</a>, by <a href="/">zippera</a> 
</section>
<div class="clearfix"></div>
</footer>
  <script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<!-- add calendar widget -->

  <script src="/js/calendar.js"></script>
  <script src="/js/languages.js"></script>
  <script type="text/javascript">
    $(function() {
    
      $('#calendar').aCalendar('zh-CN',{single:true, root:'calendar/'});
    
    });
  </script>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>


<a href="https://github.com/shuaiyy" target="_blank"><img style="position: absolute; top: 0; left: 0; border: 0;" src="/imgs/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>
